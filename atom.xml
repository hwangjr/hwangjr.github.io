<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  
  <title><![CDATA[HwangJR's Blog]]></title>
  <subtitle><![CDATA[Life is wonderful!]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="https://hwangjr.github.io//"/>
  <updated>2016-03-02T12:15:17.391Z</updated>
  <id>https://hwangjr.github.io//</id>
  
  <author>
    <name><![CDATA[HwangJR]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Android HotFix方案]]></title>
    <link href="https://hwangjr.github.io/2016/03/02/Android-HotFix%E6%96%B9%E6%A1%88/"/>
    <id>https://hwangjr.github.io/2016/03/02/Android-HotFix方案/</id>
    <published>2016-03-02T12:14:44.000Z</published>
    <updated>2016-03-02T12:15:17.391Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>随着开发需求的不断迫切，目前开源已经涌现了很多Hot Fix项目，但是从方案上来说，主要是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的<a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>；以方法hook，从Field切入的<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">AndFix</a>；<a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">Dex分包</a>的<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>。而相同原理的不同实现有很多，这里就不再累赘。这三个实现原理截然不同，各有各自优缺点，让我们走近这几个方案。</p>
<h1 id="方案揭秘">方案揭秘</h1><h2 id="Dexposed">Dexposed</h2><p><a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的AOP框架，方法级别粒度，而且不仅可以Hot Fix，还可进行AOP编程、插桩、Hook等功能。</p>
<p>Xposed是需要ROOT权限，因为其要修改其他应用及系统行为，而对于单个应用而言，不需要ROOT。Xposed基本原理是：通过修改Dalvik运行时的Zygote进程，使用Xposed Bridge来hook方法并注入自身代码，实现非侵入式的Runtime修改。包括小米（<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_dalvik.cpp" target="_blank" rel="external">onVmCreated方法</a>），也利用此特性，做了自定义主题、沉浸式状态栏等功能。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called very early during VM startup. */</span></span><br><span class="line"><span class="literal">void</span> onVmCreated(JNIEnv* env) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="subst">!</span>initMemberOffsets(env))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    jclass classMiuiResources = env<span class="subst">-&gt;</span>FindClass(CLASS_MIUI_RESOURCES);</span><br><span class="line">    <span class="keyword">if</span> (classMiuiResources != <span class="built_in">NULL</span>) &#123;</span><br><span class="line">        ClassObject* clazz = (ClassObject*)dvmDecodeIndirectRef(dvmThreadSelf(), classMiuiResources);</span><br><span class="line">        <span class="keyword">if</span> (dvmIsFinalClass(clazz)) &#123;</span><br><span class="line">            ALOGD(<span class="string">"Removing final flag for class '%s'"</span>, CLASS_MIUI_RESOURCES);</span><br><span class="line">            clazz<span class="subst">-&gt;</span>accessFlags <span class="subst">&amp;</span>= ~ACC_FINAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    env<span class="subst">-&gt;</span>ExceptionClear();</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>应用启动时，会fork zygote进程，装载class和invoke各种初始化方法，Xposed就是在这个过程替换了app_process，hook各个入口方法，加载XposedBridge.jar提供动态hook基础，具体查看<a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="external">XposedBridge</a>。</p>
<p>具体的Native实现则是在<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_common.cpp" target="_blank" rel="external">libxposed_common.cpp</a>里面，根据系统版本进行分发到libxposed_dalvik或libxposed_art，记录下原来方法信息，将方法指针指向hookedMethodCallback，从而达到劫持目的。</p>
<p>此方式只能对JAVA方法做拦截，不支持C方法。如果线上RELEASE版本进行混淆，patch也是一个痛苦事情，反射和内部类、包名和内部类冲突等处理很繁琐。</p>
<p>针对Xposed<strong>不支持ART</strong>这个事情，现在应该已经解决了，具体移步<a href="https://github.com/rovo89/android_art" target="_blank" rel="external">rovo89/android_art</a>。</p>
<h2 id="AndFix">AndFix</h2><p>简单来说，主要通过补丁工具，利用注解等，描述其与要打补丁的类和方法的对应关系，之后在应用中，加载并替换方法的信息和指针，从而达到热修复目的。里面的实现可能还涉及到其他的部分，比如Security检查、PATCH覆盖等。</p>
<p>化繁为简，直接上核心代码，先以ART（不同版本差异不大，以6.0为例）为例：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> replace_6_0(JNIEnv* env, jobject src, jobject dest) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* smeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(src);</span><br><span class="line"></span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* dmeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(dest);</span><br><span class="line"></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_; <span class="comment">//for plugin classloader</span></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_;</span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_ = smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改原方法属性为补丁方法</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>declaring_class_ = dmeth<span class="subst">-&gt;</span>declaring_class_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_types_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_types_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>access_flags_ = dmeth<span class="subst">-&gt;</span>access_flags_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_code_item_offset_ = dmeth<span class="subst">-&gt;</span>dex_code_item_offset_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>method_index_ = dmeth<span class="subst">-&gt;</span>method_index_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_method_index_ = dmeth<span class="subst">-&gt;</span>dex_method_index_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改实现指针</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_;</span><br><span class="line"></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_;</span><br><span class="line"></span><br><span class="line">	LOGD(<span class="string">"replace_6_0: %d , %d"</span>,</span><br><span class="line">			smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_,</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将方法修改为PUBLIC</span></span><br><span class="line"><span class="literal">void</span> setFieldFlag_6_0(JNIEnv* env, jobject field) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtField</span>* artField =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtField</span>*) env<span class="subst">-&gt;</span>FromReflectedField(field);</span><br><span class="line">	artField<span class="subst">-&gt;</span>access_flags_ = artField<span class="subst">-&gt;</span>access_flags_ <span class="subst">&amp;</span> (~<span class="number">0x0002</span>) | <span class="number">0x0001</span>;</span><br><span class="line">	LOGD(<span class="string">"setFieldFlag_6_0: %d "</span>, artField<span class="subst">-&gt;</span>access_flags_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Dalvik上的实现略有不同，先指向到<code>dalvik_dispatcher</code>，之后在里面进行补丁方法的调用和返回，也就是通过JNI Bridge来指向补丁方法。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="type">void</span> __attribute__ ((visibility (<span class="string">"hidden"</span>))) dalvik_replaceMethod(</span><br><span class="line">		<span class="type">JNIEnv</span>* env, jobject src, jobject dest) &#123;</span><br><span class="line">	jobject clazz = env-&gt;<span class="type">CallObjectMethod</span>(dest, jClassMethod);</span><br><span class="line">	<span class="type">ClassObject</span>* clz = (<span class="type">ClassObject</span>*) dvmDecodeIndirectRef_fnPtr(</span><br><span class="line">			dvmThreadSelf_fnPtr(), clazz);</span><br><span class="line">	clz-&gt;status = <span class="type">CLASS_INITIALIZED</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(src);</span><br><span class="line">	<span class="type">Method</span>* target = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(dest);</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvikMethod: %s"</span>, meth-&gt;name);</span><br><span class="line"></span><br><span class="line">	meth-&gt;jniArgInfo = <span class="number">0x80000000</span>;</span><br><span class="line">	meth-&gt;accessFlags |= <span class="type">ACC_NATIVE</span>;</span><br><span class="line"></span><br><span class="line">    // 将目标方法赋值到附带值上</span><br><span class="line">	<span class="type">int</span> argsSize = dvmComputeMethodArgsSize_fnPtr(meth);</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth))</span><br><span class="line">		argsSize++;</span><br><span class="line">	meth-&gt;registersSize = meth-&gt;insSize = argsSize;</span><br><span class="line">	meth-&gt;insns = (<span class="type">void</span>*) target;</span><br><span class="line"></span><br><span class="line">    // 指向本地的dispatcher方法</span><br><span class="line">	meth-&gt;nativeFunc = dalvik_dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> dalvik_dispatcher(<span class="keyword">const</span> u4* args, jvalue* pResult,</span><br><span class="line">		<span class="keyword">const</span> <span class="type">Method</span>* <span class="keyword">method</span>, <span class="type">void</span>* self) &#123;</span><br><span class="line">	<span class="type">ClassObject</span>* returnType;</span><br><span class="line">	jvalue <span class="literal">result</span>;</span><br><span class="line">	<span class="type">ArrayObject</span>* argArray;</span><br><span class="line"></span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher source method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) <span class="keyword">method</span>-&gt;insns;</span><br><span class="line">	meth-&gt;accessFlags = meth-&gt;accessFlags | <span class="type">ACC_PUBLIC</span>;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher target method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line"></span><br><span class="line">	returnType = dvmGetBoxedReturnType_fnPtr(<span class="keyword">method</span>);</span><br><span class="line">	<span class="keyword">if</span> (returnType == <span class="type">NULL</span>) &#123;</span><br><span class="line">		assert(dvmCheckException_fnPtr(self));</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher start call-&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    // 是否静态方法</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth)) &#123;</span><br><span class="line">		<span class="type">Object</span>* thisObj = (<span class="type">Object</span>*) args[<span class="number">0</span>];</span><br><span class="line">		<span class="type">ClassObject</span>* tmp = thisObj-&gt;clazz;</span><br><span class="line">		thisObj-&gt;clazz = meth-&gt;clazz;</span><br><span class="line">		argArray = boxMethodArgs(meth, args + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line"></span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, thisObj,</span><br><span class="line">				argArray);</span><br><span class="line"></span><br><span class="line">		thisObj-&gt;clazz = tmp;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		argArray = boxMethodArgs(meth, args);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, <span class="type">NULL</span>,</span><br><span class="line">				argArray);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dvmCheckException_fnPtr(self)) &#123;</span><br><span class="line">		<span class="type">Object</span>* excep = dvmGetException_fnPtr(self);</span><br><span class="line">		jni_env-&gt;<span class="type">Throw</span>((jthrowable) excep);</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (returnType-&gt;primitiveType == <span class="type">PRIM_VOID</span>) &#123;</span><br><span class="line">		<span class="type">LOGD</span>(<span class="string">"+++ ignoring return to void"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">result</span>.l == <span class="type">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (dvmIsPrimitiveClass(returnType)) &#123;</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">NPEClazz</span>, <span class="string">"null result when primitive expected"</span>);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">		pResult-&gt;l = <span class="type">NULL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!dvmUnboxPrimitive_fnPtr(<span class="literal">result</span>.l, returnType, pResult)) &#123;</span><br><span class="line">			<span class="type">char</span> msg[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			snprintf(msg, sizeof(msg) - <span class="number">1</span>, <span class="string">"%s!=%s\0"</span>,</span><br><span class="line">					((<span class="type">Object</span>*) <span class="literal">result</span>.l)-&gt;clazz-&gt;descriptor,</span><br><span class="line">					returnType-&gt;descriptor);</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">CastEClazz</span>, msg);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bail: dvmReleaseTrackedAlloc_fnPtr((<span class="type">Object</span>*) argArray, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Multiple_Dex">Multiple Dex</h2><p>Multiple Dex的方案原来是为了突破65535的限制，其就是将多个Dex放到应用的ClassLoader之中，从而使所有的Dex的类都能被找到。实际上，在<code>findClass</code>过程中，如果重复的类，参照下面的类加载的实现，是会使用第一个找到的类。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">Class</span> <span class="title">findClass</span>(<span class="title">String</span> <span class="title">name</span>, <span class="title">List</span>&lt;<span class="title">Throwable</span>&gt; <span class="title">suppressed</span>) &#123;  </span></span><br><span class="line">    <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">        DexFile dex = element.dexFile;</span><br><span class="line">        <span class="keyword">if</span> (dex != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">Class</span> <span class="title">clazz</span> = <span class="title">dex</span>.<span class="title">loadClassBinaryName</span>(<span class="title">name</span>, <span class="title">definingContext</span>, <span class="title">suppressed</span>);</span></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="literal">null</span>) &#123;  </span><br><span class="line">        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而方法过多的原因其实也很明显：因为在Dalvik指令集里，调用方法的<code>invoke-kind</code>指令中，method reference index只给了16bits，最多能调用65535个方法，所以在生成Dex文件的过程中，当方法数超过65535就会报错。</p>
<blockquote>
<p>This number is significant in that it represents the total number of references that can be invoked by the code within a single Dalvik Executable (dex) bytecode file.</p>
</blockquote>
<p>该方法就是从这入手，将问题修复后，放到一个单独的Dex中，通过反射插入到<code>dexElements</code>数组的最前面，完成虚拟机打补丁的操作。</p>
<p>在此方案中，有一个问题就是，在运行加载类的时候会报<code>preverified</code>错误，在<code>DexPrepare.cpp</code>中，将Dex转化为ODex过程中，会在<code>DexVerify.cpp</code>中进行校验，验证如果直接引用到的类和clazz是否在同一个Dex，如果是则会打上<code>CLASS_ISPREVERIFIED</code>标志。通过在所有类（Application除外，此时还没加载自定义代码）的构造函数中插入一个对在单独Dex类的引用，来解决此问题。在空间中，是使用<code>javaassist</code>进行编译时字节码插入。</p>
<blockquote>
<p>当一个apk在安装的时候，apk中的classes.dex会被虚拟机(dexopt)优化成odex文件，然后才会拿去执行。<br>虚拟机在启动的时候，会有许多的启动参数，其中一项就是verify选项，当verify选项被打开的时候，就会执行dvmVerifyClass进行类的校验，如果dvmVerifyClass校验类成功，那么这个类会被打上CLASS_ISPREVERIFIED的标志。<br>怎么样算是校验类成功？如果static方法、private方法、构造函数等，其中的直接引用（第一层关系）到的类都在同一个Dex文件中，那么该类就会被打上CLASS_ISPREVERIFIED标志。<br>我们要做的就是，阻止该类打上CLASS_ISPREVERIFIED的标志。否则加载其他Dex的时候会报错。<br>注意下，是阻止引用者的类，也就是说，假设你的app里面有个类叫做LoadBugClass，再其内部引用了BugClass。发布过程中发现BugClass有编写错误，那么想要发布一个新的BugClass类，那么你就要阻止LoadBugClass这个类打上CLASS_ISPREVERIFIED的标志。<br>你在生成apk之前，就需要阻止相关类打上CLASS_ISPREVERIFIED的标志了。对于如何阻止，可让LoadBugClass在构造方法中，去引用别的dex文件，比如：hack.dex中的某个类即可。<br>空间使用的是在字节码插入代码,而不是源代码插入，使用的是javaassist库来进行字节码插入的。</p>
</blockquote>
<p>需要做的两件事：1、动态改变BaseDexClassLoader对象间接引用的dexElements；2、在app打包的时候，阻止相关类去打上CLASS_ISPREVERIFIED标志。</p>
<p>另外混淆问题，需要保存每个版本的<code>mapping</code>混淆文件，后续编译用相同的<code>mapping</code>文件，保证混淆过后类名始终一致。</p>
<p>此方式无法在已经加载好的类中实现动态替换，所以需要在类加载之前替换。也就是补丁下载下来之后，需要等待用户重启应用才可完成补丁效果。</p>
<p>目前开源实现有：<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>，<a href="https://github.com/dodola/HotFix" target="_blank" rel="external">HotFix</a>，<a href="https://github.com/bunnyblue/DroidFix" target="_blank" rel="external">DroidFix</a>，其各个版本也有做相应的兼容。</p>
<h1 id="方案对比">方案对比</h1><ol>
<li>Dexposed方法生成补丁难度较大，需要反射写混淆后的代码，粒度太细，如果替换方法很多的话，工作量巨大。</li>
<li>AndFix支持2.3 - 6.0系统，但JNI不像JAVA那样标准，所以偶尔会有未知的机型异常。从实现来说，类似Dexposed，通过JNI来替代方法，更加简洁的完成补丁修复，应用PATCH不需要重启。但由于实现上直接跳过了类初始化，设置为初始化完毕，所以静态函数、静态成员、构造函数都会出现问题，复杂的类<code>Class.forName</code>很可能直接崩溃。</li>
<li>Multiple Dex方案支持2.3 - 6.0系统，对启动速度会有略微影响，而且只能下次启动生效。</li>
</ol>
<p>相比而言，Multiple Dex方案较为可靠，但是如果Dex文件较为庞大，启动速度会变慢；而AndFix则适用于应用不重启即可修复，且方法够简单；Dexposed方案较为复杂，暂不考虑。</p>
<h1 id="REF">REF</h1><p><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=63&amp;highlight=ClassLoader" target="_blank" rel="external">当dex分包遇上NoClassDefFoundError&amp;ClassNotFoundException</a><br><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">让App像Web一样发布新版本</a><br><a href="http://blog.zhaiyifan.cn/2015/11/20/HotPatchCompare/" target="_blank" rel="external">各大热补丁方案分析和比较</a><br><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a&amp;scene=1&amp;srcid=1106Imu9ZgwybID13e7y2nEi#wechat_redirect" target="_blank" rel="external">安卓App热补丁动态修复技术介绍</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/49883661" target="_blank" rel="external">Android 热补丁动态修复框架小结</a><br><a href="https://github.com/dodola/HotFix" target="_blank" rel="external">dodola/HotFix: 安卓App热补丁动态修复框架</a><br><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external">美团Android DEX自动拆包及动态加载简介</a><br><a href="https://m.oschina.net/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="http://www.gitzx.com/android-inject-hook/" target="_blank" rel="external">Android下的挂钩(hook)和代码注入(inject)</a></p>
]]></content>
    <summary type="html">
    <![CDATA[目前关于Android的Hot Fix方案大概有三种，主要是基于[rovo89/Xposed](https://github.com/rovo89/Xposed)的[alibaba/dexposed](https://github.com/alibaba/dexposed)；以方法hook，从Field切入的[AndFix](https://github.com/alibaba/AndFix)；[Dex分包](http://bugly.qq.com/bbs/forum.php?mod=viewthread&tid=16)的[Nuwa](https://github.com/jasonross/Nuwa)等。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[调试Android应用]]></title>
    <link href="https://hwangjr.github.io/2016/01/27/%E8%B0%83%E8%AF%95Android%E5%BA%94%E7%94%A8/"/>
    <id>https://hwangjr.github.io/2016/01/27/调试Android应用/</id>
    <published>2016-01-27T02:05:43.000Z</published>
    <updated>2016-01-27T02:06:12.907Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>需要针对已经发布的Release包进行调试，而要调试应用程序，需要满足：</p>
<ol>
<li>应用Manifest文件中Application标签包含属性<code>android:debuggable=&quot;true&quot;</code></li>
<li><code>/default.prop</code>中<code>ro.debuggable</code>值为1</li>
</ol>
<p>针对上面限制，可选方案有：</p>
<ol>
<li>反编译应用修改Manifest，插入<code>android:debuggable=&quot;true&quot;</code></li>
<li>修改<code>boot.img</code>，将<code>ro.debuggable</code>修改为1</li>
<li>利用<a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed</a>进行hook并debug应用</li>
</ol>
<h1 id="实践">实践</h1><h2 id="使用Debuggable属性">使用<code>Debuggable</code>属性</h2><p>从官方文档可以看出（<a href="http://developer.android.com/intl/zh-cn/guide/topics/manifest/application-element.html#debug" target="_blank" rel="external">application</a>）：</p>
<blockquote>
<p>android:debuggable<br>Whether or not the application can be debugged, even when running on a device in user mode — “true” if it can be, and “false” if not. The default value is “false”.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">application</span></span><br><span class="line">	<span class="attribute">android:icon</span>=<span class="value">"@drawable/ic_launcher"</span></span><br><span class="line">	<span class="attribute">android:label</span>=<span class="value">"@string/app_name"</span></span><br><span class="line">	<span class="attribute">android:theme</span>=<span class="value">"@style/AppTheme"</span> </span><br><span class="line">	<span class="attribute">android:debuggable</span>=<span class="value">"true"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>正常情况下，IDE会根据自身的打包来配置debug属性，因此在Manifest中最好<strong>不</strong>设置<code>debuggable</code>属性，而由打包方式来决定。查看具体的APK的信息：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 查看应用信息，可查看android:debuggable，<span class="number">0x0</span>为false，<span class="number">0xffffffff</span>为true</span></span><br><span class="line">aapt <span class="built_in">list</span> -v -a apk.apk</span><br></pre></td></tr></table></figure></p>
<p>在应用中也可判断是否<code>debug</code>状态：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 自身应用</span><br><span class="line">public static boolean isDebuggable(Context context) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		ApplicationInfo info = context.getApplicationInfo();</span><br><span class="line">		return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 其他应用</span><br><span class="line">public static boolean isDebuggable(Context context,String packageName) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		PackageInfo pkgInfo = context.getPackageManager().getPackageInfo(packageName, 1);</span><br><span class="line">		if (pkgInfo != null ) &#123;</span><br><span class="line">			ApplicationInfo info = pkgInfo.applicationInfo;</span><br><span class="line">			return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>有的时候，我们还需要一些其他的方式或手段：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反编译apk，可修改smali及资源等</span></span><br><span class="line">apktool d apk.apk</span><br><span class="line"><span class="comment"># 修改Manifest，新增debuggable</span></span><br><span class="line">vim apk/AndroidManifest.xml</span><br><span class="line"><span class="comment"># 重新打包，apk文件在dist目录中，也可指定apk文件</span></span><br><span class="line">apktool b apk</span><br><span class="line"><span class="comment"># 更多信息</span></span><br><span class="line">apktool -h</span><br><span class="line"><span class="comment"># debug签名，也可自行指定签名，密码android</span></span><br><span class="line">jarsigner -verbose -keystore ~/.android/debug.keystore -signedjar new.apk apk.apk androiddebugkey</span><br><span class="line"><span class="comment"># 查看签名</span></span><br><span class="line">keytool -list -alias androiddebugkey -keystore &lt;path_to_debug_keystore&gt;.keystore -storepass android -keypass android</span><br><span class="line"><span class="comment"># 有时需要系统签名，系统签名官方git有提供([security at master · android](https://github.com/android/platform_build/tree/master/target/product/security))</span></span><br><span class="line">java -jar signapk.jar platform.x509.pem platform.pk8 apk/dist/apk.apk new_sys.apk</span><br></pre></td></tr></table></figure></p>
<h2 id="使用build-prop属性">使用<code>build.prop</code>属性</h2><p>有一种是重新打包<code>boot.img</code>，简单思路就是解包<code>boot.img</code>，修改<code>ramdisk</code>中的<code>default.prop</code>，再打包并刷机。因为<code>boot.img</code>会在开机自动覆盖，所以只能通过刷<code>boot</code>来搞定。具体可以搜索相关解包教程。</p>
<p>另外一种要涉及重新编译<code>boot.img</code>，不同的版本源码编译不一样。更多可以参考：<a href="https://source.android.com/" target="_blank" rel="external">Android Open Source Project</a>。<br>ADB权限管理：</p>
<ol>
<li>4.2.2版本，针对连接设备需要使用者进行确认，且分设备与MAC进行管理</li>
<li>4.2等设备有针对ADB管理的开发者模式，通过该模式对ADB的DEBUG进行权限管理</li>
<li>开源版本，针对<code>eng/userdebug/user</code>进行管理与开放adb权限</li>
</ol>
<p>从系统编译和编译环境控制来说，通过property进行管理，主要为<code>ro.debuggable</code>和<code>system/core/rootdir/init.usb.rc</code>中<code>sys.usb.config</code>里包含对adb选项。</p>
<p>简单编译可通过查找：</p>
<ol>
<li><code>ro.debuggable</code>相关的环境变量，比如<code>enable_target_debugging</code></li>
<li>查找init.rc中权限改变</li>
<li>添加开发者模式进行管理</li>
</ol>
<p>在系统编译时，有几个编译选项：</p>
<ol>
<li>eng：编译时默认选项</li>
<li>user：产品生成发布版</li>
<li>userdebug：与user版本相同，添加adb服务</li>
</ol>
<p>在4.4源码上进行相关参数的搜索（<code>ro.secure</code>，<code>ro.debuggable</code>，<code>ro.kernel.android.checkjni</code>）：<br><strong><code>ro.secure</code></strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/services/</span>java<span class="regexp">/com/</span>android<span class="regexp">/server/</span>wm/WindowManagerService.<span class="string">java:</span>    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_SECURE = <span class="string">"ro.secure"</span>;</span><br><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>net<span class="regexp">/http/</span>AndroidHttpClient.<span class="string">java:</span>                <span class="comment">// Never print auth token -- we used to check ro.secure=0 to</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> * binary tree.  For instance, <span class="string">"ro.secure"</span>=<span class="string">"1"</span> could be stored <span class="keyword">as</span> <span class="string">follows:</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> *                     v        v            v     +--------&gt;| ro.secure |</span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">1</span></span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">0</span></span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=0&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=1&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/system/</span>core<span class="regexp">/adb/</span>adb.<span class="string">c:</span>   <span class="comment">/* run adbd in secure mode if ro.secure is set and</span><br><span class="line">./system/core/adb/adb.c:        property_get("ro.secure", value, "1");</span><br><span class="line">./system/core/adb/adb.c:            // don't run as root if ro.secure is set...</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>build/xxx：环境设置</li>
<li>system/xxx/adb.c：如果=1,adb root将无法成功. 还有其它的附加条件除外.</li>
<li>WindowManagerService：用于管理viewserver(Hierarchy Viewer)</li>
<li>AndroidHttpClient：在=1时,不会在log中dump auth token</li>
<li>bionic/xxx/system_properties.c：介绍properties存储结构时用的例子</li>
</ul>
<p><strong><code>ro.debuggable</code></strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">./bootable/recovery/adb_install.cpp:    int len = property_get("ro.debuggable", value, NULL);</span><br><span class="line">./bootable/recovery/etc/init.rc:on property:ro.debuggable=1</span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=0<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0</span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1</span><br><span class="line">./build/tools/post_process_props.py:  # If ro.debuggable is 1, then enable adb on USB by default</span><br><span class="line">./build/tools/post_process_props.py:  if prop.get("ro.debuggable") == "1":</span><br><span class="line">./dalvik/docs/debugger.html:for all applications when the system property <span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./dalvik/docs/debugger.html:is set to <span class="tag">&lt;/<span class="title">code</span>&gt;</span>1<span class="tag">&lt;/<span class="title">code</span>&gt;</span> (use <span class="tag">&lt;<span class="title">code</span>&gt;</span>adb shell getprop ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./device/samsung/manta/init.manta.rc:on property:ro.debuggable=1</span><br><span class="line">./external/libnfc-nxp/Linux_x86/phDal4Nfc.c:    property_get("ro.debuggable", value, "");</span><br><span class="line">./external/openssh/servconf.c:  /* Allow root login if ro.debuggable is set */</span><br><span class="line">./external/openssh/servconf.c:  property_get("ro.debuggable", value, "");</span><br><span class="line">./frameworks/av/services/audioflinger/AudioFlinger.cpp:    (void) property_get("ro.debuggable", value, "0");</span><br><span class="line">./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java:        return "1".equals(SystemProperties.get("ro.debuggable")) &amp;&amp;</span><br><span class="line">./frameworks/base/core/java/android/os/Build.java:            SystemProperties.getInt("ro.debuggable", 0) == 1;</span><br><span class="line">./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java:        if ("1".equals(SystemProperties.get("ro.debuggable"))) </span><span class="expression">&#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/core</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/os</span><span class="end-block">/ZygoteConnection.java</span>:     * <span class="variable"><span class="keyword">If</span></span> <span class="string">"ro.debuggable"</span> <span class="variable">is</span> <span class="string">"1"</span>, <span class="variable">all</span> <span class="variable">apps</span> <span class="variable">are</span> <span class="variable">debuggable.</span> <span class="variable">Otherwise</span>,</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/policy</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/policy</span><span class="end-block">/impl</span><span class="end-block">/PhoneWindowManager.java</span>:        <span class="variable">mEnableShiftMenuBugReports</span> = <span class="string">"1"</span><span class="variable">.equals</span>(<span class="variable">SystemProperties.get</span>(<span class="string">"ro.debuggable"</span>));</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/BootReceiver.java</span>:        <span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1 ? 98304 : 65536;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/am</span><span class="end-block">/ActivityManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/wm</span><span class="end-block">/WindowManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/native</span><span class="end-block">/opengl</span><span class="end-block">/libs</span><span class="end-block">/EGL</span><span class="end-block">/egl.cpp</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/AudioRouter.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothPhoneService.java</span>:            &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallCommandService.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallController.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallHandlerServiceProxy.java</span>:            <span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallLogger.java</span>:        (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallModeler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallNotifier.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallStateMonitor.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCache.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCacheUpdateReceiver.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CdmaDisplayInfo.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">boolean</span> <span class="variable">DBG</span> = (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:                    &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)) &#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/NotificationMgr.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/OutgoingCallBroadcaster.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   (<span class="variable">PhoneApp.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   1 <span class="variable">-</span> <span class="variable">normal</span> <span class="variable">debug</span> <span class="variable">logging</span> <span class="variable"><span class="keyword">if</span></span> <span class="variable">ro.debuggable</span> <span class="variable">is</span> <span class="variable">set</span> (<span class="variable">which</span> <span class="variable">is</span> <span class="variable">true</span> <span class="variable">in</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/RespondViaSmsManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/Ringer.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/SipCallOptionHandler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/WiredHeadsetManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/sdk</span><span class="end-block">/eclipse</span><span class="end-block">/plugins</span><span class="end-block">/com.android.ide.eclipse.adt</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/ide</span><span class="end-block">/eclipse</span><span class="end-block">/adt</span><span class="end-block">/internal</span><span class="end-block">/launch</span><span class="end-block">/AndroidLaunchController.java</span>:                        /<span class="end-block">/ because am -D does not check for ro.debuggable and the</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:            <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/services.c</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/debuggerd</span><span class="end-block">/tombstone.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/include</span><span class="end-block">/cutils</span><span class="end-block">/trace.h</span>: * <span class="variable">level</span> <span class="variable">tracing</span> <span class="variable">is</span> <span class="variable">not</span> <span class="variable">allowed</span> <span class="variable">unless</span> <span class="variable">the</span> <span class="variable">ro.debuggable</span> <span class="variable">system</span> <span class="variable">property</span> <span class="variable">is</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/init</span><span class="end-block">/property</span>_<span class="variable">service.c</span>:    <span class="variable">ret</span> = <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">debuggable</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:/<span class="end-block">/ application-level tracing is allowed when the ro.debuggable system property</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/rootdir</span><span class="end-block">/init.rc</span>:<span class="variable">on</span> <span class="variable">property</span>:<span class="variable">ro.debuggable</span>=1</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./bootable/recovery/adb_install.cpp：debuggable 开启时,才可以成功重启adb</li>
<li>./build/xxxx：debuggable 数据设置</li>
<li>./dalvik/xxx：在dalvik中,如果debuggable为0, 仅AndroidManifest.xml中含有debuggable 才会支持jdwp调试</li>
<li>./external/libnfc-nxp/Linux_x86/phDal4Nfc.c：NFC调试支持开关</li>
<li>./external/openssh/servconf.c：openssh 允许root访问开关</li>
<li>./frameworks/av/services/audioflinger/AudioFlinger.cpp：Audio Debug 开关</li>
<li>./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java：SSL check 开关</li>
<li>./frameworks/base/core/java/android/os/Build.java：IS_DEBUGGABLE环境变量控制</li>
<li>./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java：App debuggable 开关, 如果=1, 所有应用都将进行debug支持</li>
<li>./frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java：mEnableShiftMenuBugReports 支持</li>
<li>./frameworks/base/services/java/com/android/server/BootReceiver.java：logged event size 控制, =1 存储量大</li>
<li>./frameworks/base/services/java/com/android/server/am/ActivityManagerService.java：系统DEBUG状态，包括do bug report, OpenGLTrace, App Profile, App Heap Dump</li>
<li>./frameworks/base/services/java/com/android/server/wm/WindowManagerService.java：系统DEBUG状态，与ro.secure 一起管理viewserver</li>
<li>./frameworks/native/opengl/libs/EGL/egl.cpp：EGL debug</li>
<li>LOGD 开关：<br>./packages/services/Telephony/src/com/android/phone/AudioRouter.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothManager.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothPhoneService.java<br>./packages/services/Telephony/src/com/android/phone/CallCommandService.java<br>./packages/services/Telephony/src/com/android/phone/CallController.java<br>./packages/services/Telephony/src/com/android/phone/CallHandlerServiceProxy.java<br>./packages/services/Telephony/src/com/android/phone/CallLogger.java<br>./packages/services/Telephony/src/com/android/phone/CallModeler.java<br>./packages/services/Telephony/src/com/android/phone/CallNotifier.java<br>./packages/services/Telephony/src/com/android/phone/CallStateMonitor.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCache.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCacheUpdateReceiver.java<br>./packages/services/Telephony/src/com/android/phone/CdmaDisplayInfo.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/NotificationMgr.java<br>./packages/services/Telephony/src/com/android/phone/OutgoingCallBroadcaster.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/RespondViaSmsManager.java<br>./packages/services/Telephony/src/com/android/phone/Ringer.java<br>./packages/services/Telephony/src/com/android/phone/SipCallOptionHandler.java<br>./packages/services/Telephony/src/com/android/phone/WiredHeadsetManager.java</li>
<li>./sdk/eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/launch/AndroidLaunchController.java：ADT app debug launcher 支持</li>
<li>./system/core/adb/adb.c：adb root permission</li>
<li>./system/core/adb/services.c：adb root permission</li>
<li>./system/core/debuggerd/tombstone.c：dump_crash want log if =1</li>
<li>./system/core/init/property_service.c：Allow local property overwrite ro.debuggerd value</li>
<li>./system/core/libcutils/trace.c：app trace on/off</li>
<li>./system/core/rootdir/init.rc：adbd服务开启控制</li>
</ul>
<p><strong><code>ro.kernel.android.checkjni</code></strong><br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./frameworks/<span class="keyword">base/core/jni/AndroidRuntime.cpp: </span>       property_get(<span class="string">"ro.kernel.android.checkjni"</span>, propBuf, <span class="string">""</span>)<span class="comment">;</span></span><br><span class="line">./dalvik/docs/embedded-vm-control.html:first is &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;. </span> This is set <span class="keyword">by </span>the</span><br><span class="line">./dalvik/docs/embedded-vm-control.html:of this overrides the value from &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;.</span><br><span class="line"></span>./<span class="keyword">build/core/main.mk: </span> <span class="keyword">ADDITIONAL_BUILD_PROPERTIES </span>+= ro.kernel.<span class="keyword">android.checkjni=1</span><br><span class="line"></span>./<span class="keyword">build/core/build-system.html: </span>       &lt;li&gt;&lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni=1&lt;/code&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./frameworks/base/core/jni/AndroidRuntime.cpp：checkJNI value load</li>
<li>dalvik/xxx：Java VM CheckJNI on/off</li>
<li>build/xxx：checkJNI 状态设置</li>
</ul>
<p>基本来说，<code>ro.secure</code>主要是系统安全相关属性开关，包括：</p>
<ul>
<li>adb的root权限</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统各个模块的敏感信息输出</li>
</ul>
<p><code>ro.debuggable</code>主要是系统debug信息开关，包括：</p>
<ul>
<li>adb管理，是否可root，是否开机运行</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统debug信息开关，包括应用内部log、audio debug, ssl check, nfc, opengl elg等信息打印、系统各应用级别状态，包括profile, jdwp-debug, heap dump, opengl trace等</li>
</ul>
<p><code>ro.kernel.android.checkjni</code>主要是Java VM checkJNI的开关</p>
<h2 id="Xposed进行HOOK"><code>Xposed</code>进行HOOK</h2><p>从上面的两个方案来看，debug都太过麻烦，还有一个简单的方式，那就是利用开源的Xposed框架进行hook。使用这一利器之前需要先root系统。用一句话来解释Xposed：</p>
<blockquote>
<p>利用JNI作为一个中转，将所有对于被hook的方法统一进入Xposed管理器，管理器再进行hook的前后调用。Xposed 调用非JVM JNI标准接口，需要准确调用dalvik/art中的方法调用，完成对原函数的调用。</p>
</blockquote>
<p>当我们设置<code>android:debuggable=&quot;true&quot;</code>时候，应用即可进行调试，而且可以进行JDWP连接进行调试。开启新应用时，Dalvik VM会forked/started新的线程，并开启debug，这时JDWP线程知道是否开启。我们跟踪<code>android.os.Process.start()</code>方法会发现，这是一个<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ProcessStartResult start(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span><br><span class="line">                              <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span><br><span class="line">                              <span class="built_in">int</span> uid, <span class="built_in">int</span> gid, <span class="built_in">int</span>[] gids,</span><br><span class="line">                              <span class="built_in">int</span> debugFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">                              <span class="built_in">int</span> targetSdkVersion,</span><br><span class="line">                              <span class="keyword">String</span> seInfo,</span><br><span class="line">                              <span class="keyword">String</span>[] zygoteArgs) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids, debugFlags, mountExternal, targetSdkVersion, seInfo, zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.e(LOG_TAG,</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟踪会发现，在<code>startViaZygote</code>方法中对<code>DEBUG_ENABLE_DEBUGGER</code>进行判断：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="number">0</span>) &#123;</span><br><span class="line">	argsForZygote.add(<span class="string">"--enable-debugger"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来就简单了，利用反射获得这个<code>start</code>的方法，并进行hook即可，代码为（完整项目查看<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里演示了两个hook的方式，更多可以参阅文档</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneDebug</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> debugApps = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_ENABLE_DEBUGGER = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- handle package: "</span> + loadPackageParam.packageName + <span class="string">" process: "</span> + loadPackageParam.processName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (loadPackageParam.appInfo == <span class="keyword">null</span> ||</span><br><span class="line">                (loadPackageParam.appInfo.flags &amp; (ApplicationInfo.FLAG_SYSTEM | ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method start = Process.class.getMethod(</span><br><span class="line">                    <span class="string">"start"</span>, String.class, String.class, Integer.TYPE, Integer.TYPE, <span class="keyword">int</span>[].class,</span><br><span class="line">                    Integer.TYPE, Integer.TYPE, Integer.TYPE, String.class, String[].class);</span><br><span class="line">            XposedBridge.log(<span class="string">"-- start hook, appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            XposedBridge.hookMethod(start, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (debugApps) &#123;</span><br><span class="line">                        <span class="keyword">int</span> id = <span class="number">5</span>;</span><br><span class="line">                        <span class="keyword">int</span> flags = (Integer) methodHookParam.args[id];</span><br><span class="line">                        <span class="keyword">if</span> ((flags &amp; DEBUG_ENABLE_DEBUGGER) == <span class="number">0</span>) &#123;</span><br><span class="line">                            flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                        &#125;</span><br><span class="line">                        methodHookParam.args[id] = flags;</span><br><span class="line">                        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">                            XposedBridge.log(<span class="string">"set debuggable flags to: "</span> + flags);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">        XposedBridge.hookAllMethods(Process.class, "start", new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                if (debugApps) &#123;</span><br><span class="line">                    int id = 5;</span><br><span class="line">                    int flags = (Integer) param.args[id];</span><br><span class="line">                    if ((flags &amp; DEBUG_ENABLE_DEBUGGER) == 0) &#123;</span><br><span class="line">                        flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                    &#125;</span><br><span class="line">                    param.args[id] = flags;</span><br><span class="line">                    if (BuildConfig.DEBUG) &#123;</span><br><span class="line">                        XposedBridge.log("set debuggable flags to: " + flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);*/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简要介绍Xposed插件开发流程">简要介绍Xposed插件开发流程</h3><p>在Android Studio上大概过程为（完整代码：<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：</p>
<ol>
<li>创建工程，可以无Activity</li>
<li>下载<a href="http://forum.xda-developers.com/xposed/xposed-api-changelog-developer-news-t2714067" target="_blank" rel="external">Xposed API</a> XposedBridgeApi-xx.jar，并将其放入<code>libs</code>目录</li>
<li>修改Manifest，新增三个<code>meta-data</code>标签（详细看下面代码）</li>
<li>实现<code>IXposedHookLoadPackage</code>接口及具体hook逻辑</li>
<li>在<code>assets/xposed_init</code>配置声明需要加载到<code>XposedInstaller</code>的入口</li>
<li>ALL DONE。<br>更多可以查看<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial" target="_blank" rel="external">Development tutorial</a>。</li>
</ol>
<p>运行Xposed插件，需要：</p>
<ol>
<li>安装<a href="http://repo.xposed.info/module/de.robv.android.xposed.installer" target="_blank" rel="external">Xposed Installer</a></li>
<li>手机root</li>
</ol>
<p>AndroidManifest.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">package</span>=<span class="value">"com.hwangjr.xposed.mods.phonedebug"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span></span><br><span class="line">        <span class="attribute">android:allowBackup</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:supportsRtl</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedmodule"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposeddescription"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"Phone Debugger! (ro.debuggable or android:debuggable)"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedminversion"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"54"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>assets/xposed_init</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="class">.hwangjr</span><span class="class">.xposed</span><span class="class">.mods</span><span class="class">.phonedebug</span><span class="class">.PhoneDebug</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed Module Repository</a><br><a href="https://labs.mwrinfosecurity.com/blog/2013/11/29/debug-all-the-android-things/" target="_blank" rel="external">Debug All the Android Things - mwrlabs</a><br><a href="http://blog.csdn.net/hunanwy/article/details/9200673" target="_blank" rel="external">Android USER 版本与ENG 版本的差异—MTK官方解释 - hunanwy的专栏 - 博客频道 - CSDN.NET</a><br><a href="http://www.codefrom.com/c/49" target="_blank" rel="external">Xposed插件开发基础篇｜码源</a><br><a href="http://forum.xda-developers.com/" target="_blank" rel="external">Android Forum for Mobile Phones, Tablets, Watches &amp; Android App Development - XDA Forums</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在实际过程中，经常需要调试应用，而应用的调试手段是需要多样，这里进行总结，Xposed完整项目查看[AndroidKnife/XposedDebug](https://github.com/AndroidKnife/XposedDebug)。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Git设置白名单]]></title>
    <link href="https://hwangjr.github.io/2016/01/14/Git%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95/"/>
    <id>https://hwangjr.github.io/2016/01/14/Git设置白名单/</id>
    <published>2016-01-14T11:20:39.000Z</published>
    <updated>2016-01-14T11:21:10.703Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p><code>.gitignore</code>可以设置过滤文件，此文件还可以用来设置白名单。</p>
<h1 id="白名单">白名单</h1><p>简单粗暴上菜（要解决此目录下的子目录也要过滤问题）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore everything</span></span><br><span class="line"><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># white list anything that's a directort</span></span><br><span class="line">!<span class="keyword">*</span>/</span><br><span class="line"><span class="comment"># add all the file types you don't want miss</span></span><br><span class="line">!<span class="keyword">*</span>.txt</span><br><span class="line">!<span class="keyword">*</span>.etc</span><br></pre></td></tr></table></figure></p>
<p>ALL DONE!</p>
]]></content>
    <summary type="html">
    <![CDATA[在Git中存在`.gitignore`文件来对文件进行过滤，那么如何利用此文件进行白名单设置呢。]]>
    
    </summary>
    
      <category term="Git" scheme="https://hwangjr.github.io/tags/Git/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Git" scheme="https://hwangjr.github.io/categories/Git/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Git无法提交目录]]></title>
    <link href="https://hwangjr.github.io/2016/01/14/Git%E6%97%A0%E6%B3%95%E6%8F%90%E4%BA%A4%E7%9B%AE%E5%BD%95/"/>
    <id>https://hwangjr.github.io/2016/01/14/Git无法提交目录/</id>
    <published>2016-01-14T11:18:16.000Z</published>
    <updated>2016-01-14T11:18:32.799Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>初始化时，可能需要提交空目录，但是Git是针对文件变动进行跟踪，不对目录进行跟踪。所以一个目录如果没有文件，即使<code>git add</code>此目录，也无法进行提交。</p>
<h1 id="Solution">Solution</h1><p>简单做法是，在空目录下新建一个文件。此文件可能是：</p>
<ol>
<li><code>.gitignore</code>文件</li>
<li><code>.gitkeep</code>或<code>.keep</code>文件</li>
<li>其他空文件</li>
</ol>
<p><code>.gitignore</code>文件内容可以是：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 忽略所有文件</span></span><br><span class="line">*</span><br><span class="line"><span class="preprocessor"># 除了gitignore文件</span></span><br><span class="line">!.gitignore</span><br></pre></td></tr></table></figure></p>
<p>之后进行<code>git add</code>即可。</p>
<h1 id="脚本">脚本</h1><p>懒人脚本，其实就是一行命令，查找当前目录，如果为空则添加空文件（忽略.git目录）：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . <span class="string">\(</span> -type d -empty <span class="string">\)</span> -<span class="keyword">and</span> <span class="string">\(</span> -<span class="keyword">not</span> -regex .<span class="pi">/\.git.* \) -exec touch &#123;&#125;/</span>.gitkeep <span class="string">\;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://blog.csdn.net/zhaodezhong/article/details/7774869" target="_blank" rel="external">git 保存空目录</a><br><a href="http://www.oschina.net/question/114628_125642" target="_blank" rel="external">eclipse 工程下新建文件夹无法上传至Git仓库</a><br><a href="https://segmentfault.com/q/1010000000663317" target="_blank" rel="external">gitignore 添加空目录</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在Git中提交空目录。]]>
    
    </summary>
    
      <category term="Git" scheme="https://hwangjr.github.io/tags/Git/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Git" scheme="https://hwangjr.github.io/categories/Git/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Git多个远程仓库进行管理]]></title>
    <link href="https://hwangjr.github.io/2016/01/14/Git%E5%A4%9A%E4%B8%AA%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%AE%A1%E7%90%86/"/>
    <id>https://hwangjr.github.io/2016/01/14/Git多个远程仓库进行管理/</id>
    <published>2016-01-14T11:17:39.000Z</published>
    <updated>2016-01-14T11:17:57.423Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>现在免费代码托管平台很多，有时需要多个远程库同时进行PUSH，这时如何处理。</p>
<p>举个糖炒栗子，本地创建git仓库后，在GitHub上创建一个仓库，并在GitCoffee上也有远程仓库，此时如何同步，狡兔三窟。可作为代码备份和远程协作。</p>
<h1 id="新增远程仓库">新增远程仓库</h1><h2 id="一次PUSH多个仓库更新">一次PUSH多个仓库更新</h2><p>直接在<code>origin</code>或现有远程仓库上添加远程仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 远程仓库</span><br></pre></td></tr></table></figure></p>
<p>如果提示<code>fatal: remote origin already exists</code>，先删除再添加：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="comment"># 不推荐此方法</span></span><br><span class="line">git remote rm origin</span><br></pre></td></tr></table></figure></p>
<p>也可以直接修改config方法，修改<code>.git/config</code>文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">url = 远程仓库</span><br></pre></td></tr></table></figure></p>
<h2 id="分开PUSH管理多个仓库">分开PUSH管理多个仓库</h2><p>上面那个方法比较方便，可以PUSH到多个URL上。但是有时我们的RSA KEY不一样，会导致无法PUSH，这时可以新增一个远程仓库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增</span></span><br><span class="line">git remote add newpush 远程仓库</span><br><span class="line"><span class="comment"># push到新增远程仓库的master分支</span></span><br><span class="line">git push newpush master</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br></pre></td></tr></table></figure></p>
<p>直接编辑<code>.git/config</code>也是一个方式。</p>
<h2 id="脚本">脚本</h2><p>也就诞生了懒人脚本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to origin master'</span></span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to newpush master'</span></span><br><span class="line">git push newpush master</span><br></pre></td></tr></table></figure></p>
<h1 id="REF">REF</h1><p><a href="http://www.xiaoleilu.com/push-multi-repo/" target="_blank" rel="external">Git push到多个远程库</a><br><a href="http://higrid.net/hi/docs/git-pull-push-from-multiple-remote-locations" target="_blank" rel="external">git与多个远程仓库同步</a><br><a href="http://www.v2ex.com/t/37919#reply8" target="_blank" rel="external">有没有可能同时把代码提交到两个git代码托管的服务器上？ - V2EX</a></p>
]]></content>
    <summary type="html">
    <![CDATA[对多个远程仓库进行管理。]]>
    
    </summary>
    
      <category term="Git" scheme="https://hwangjr.github.io/tags/Git/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Git" scheme="https://hwangjr.github.io/categories/Git/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[使用Gitolite搭建Git服务器]]></title>
    <link href="https://hwangjr.github.io/2016/01/14/%E4%BD%BF%E7%94%A8Gitolite%E6%90%AD%E5%BB%BAGit%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://hwangjr.github.io/2016/01/14/使用Gitolite搭建Git服务器/</id>
    <published>2016-01-14T11:16:25.000Z</published>
    <updated>2016-01-14T11:17:17.279Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>搭建Git服务器作为代码管理工具。</p>
<h1 id="搭建">搭建</h1><h2 id="软件安装">软件安装</h2><p>基于：</p>
<ul>
<li>CentOS 7</li>
<li>Git 1.8.3<br>直接用yum安装，如果需要最新版本，请编译安装。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git -y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="添加用户">添加用户</h2><p>添加一个新用户来跑git服务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adduser git</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">useradd <span class="operator">-s</span> /sbin/nologin -g git git</span><br><span class="line"><span class="comment"># /etc/passwd can checkout the users and group</span></span><br><span class="line">w git</span><br><span class="line">groups git</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化仓库">初始化仓库</h2><p>选择目录并初始化仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> path/git</span><br><span class="line">git init --bare project.git</span><br><span class="line">chown -R git project.git</span><br></pre></td></tr></table></figure></p>
<h2 id="禁用远程登陆">禁用远程登陆</h2><p>禁止用户通过git账户登陆。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/passwd</span><br><span class="line"><span class="comment"># modify the bash</span></span><br><span class="line">git:xxxxxxxxx:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure></p>
<h2 id="配置客户端key">配置客户端key</h2><p>客户端生成rsa key：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">cat .ssh/id_rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>将生成的<code>id_rsa.pub</code>复制到服务器上，修改<code>.ssh/authorized_keys</code>文件。</p>
<h2 id="DONE">DONE</h2><p>现在即可在本地进行<code>check out</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@ip:/path/git/project.git</span><br></pre></td></tr></table></figure></p>
<h1 id="使用Gitolite">使用Gitolite</h1><h2 id="背景-1">背景</h2><p>这是Git服务器管理软件，还有很多选择，自己决定。这里使用<a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>。</p>
<blockquote>
<p><a href="https://about.gitlab.com/" target="_blank" rel="external">GitLab</a> : GitLab includes git repository management, code reviews, issue tracking, wikis and much more. GitLab comes with GitLab CI, an easy to use continuous integration and deployment tool.<br><a href="https://www.scm-manager.org/" target="_blank" rel="external">SCM-Manager</a> : The easiest way to share and manage your Git, Mercurial and Subversion repositories over http.<br><a href="https://www.gerritcodereview.com/" target="_blank" rel="external">Gerrit Code Review</a> + <a href="http://gitblit.com/" target="_blank" rel="external">Gitblit</a> : Gerrit provides web based code review and repository management for the Git version control system. Gitblit is an open-source, pure Java stack for managing, viewing, and serving Git repositories. It’s designed primarily as a tool for small workgroups who want to host centralized repositories.<br><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a> + <a href="http://git-scm.com/book/ch4-6.html" target="_blank" rel="external">Git - Smart HTTP</a> : Gitolite allows you to setup git hosting on a central server, with fine-grained access control and many more powerful features.<br><a href="https://gogs.io/" target="_blank" rel="external">Gogs</a> : Gogs (Go Git Service) is a painless self-hosted Git service.<br><a href="http://www.getgitorious.com/" target="_blank" rel="external">Gitorious</a> : Run Gitorious yourself — get started with free, open source Git hosting and collaboration today.<br><a href="https://tuleap.net/" target="_blank" rel="external">Tuleap</a> OR <a href="https://github.com/Enalean/tuleap" target="_blank" rel="external">Tuleap Github</a> : Traditional development, Requirement Management, Agile Development, IT Service management… Tuleap makes software projects more productive, collaborative and industrialized.<br><a href="http://phabricator.org/" target="_blank" rel="external">Phabricator</a> OR <a href="https://github.com/phacility/phabricator" target="_blank" rel="external">phacility/phabricator</a> : Phabricator is a collection of open source web applications that help software companies build better software.<br><a href="https://github.com/gitbucket/gitbucket" target="_blank" rel="external">gitbucket/gitbucket</a> : GitBucket is a GitHub clone powered by Scala which has easy installation and high extensibility.<br><a href="http://gitlist.org/" target="_blank" rel="external">GitList</a> OR <a href="https://github.com/klaussilveira/gitlist" target="_blank" rel="external">klaussilveira/gitlist</a> : GitList allows you to browse repositories using your favorite browser, viewing files under different revisions, commit history and diffs. GitList is free and open source software, written in PHP, on top of Silex and the Twig template engine.<br><a href="http://git.zx2c4.com/cgit/about/" target="_blank" rel="external">cgit</a> : A hyperfast web frontend for git repositories written in C.<br><a href="https://github.com/mensi/cydra/" target="_blank" rel="external">mensi/cydra</a> : <strong>SEEMS DEAD</strong>. Cydra is a platform for project hosting written in Python. It has an extensible architecture to facilitate integration of 3rd party software such as version control systems and project management tools.<br><a href="https://github.com/tv42/gitosis" target="_blank" rel="external">tv42/gitosis</a> : <strong>SEEMS DEAD</strong>. Manage git repositories, provide access to them over SSH, with tight access control and not needing shell accounts.<br><a href="https://github.com/jakubgarfield/Bonobo-Git-Server" target="_blank" rel="external">jakubgarfield/Bonobo-Git-Server</a> : Bonobo Git Server for Windows is a web application you can install on your IIS and easily manage and connect to your git repositories.</p>
</blockquote>
<h2 id="安装前">安装前</h2><ol>
<li>安装git</li>
<li>创建git用户组和git用户</li>
<li>创建管理员密钥</li>
<li>将公钥上传到git服务器中</li>
</ol>
<p>其中，创建管理员密钥：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"git-admin"</span></span><br></pre></td></tr></table></figure></p>
<p>并将git-admin.pub上传到服务器（可使用<code>scp</code>，如有问题，可能是firewall问题）。</p>
<h2 id="安装">安装</h2><ol>
<li>创建git用户下bin目录</li>
<li>clone gitolite并安装</li>
<li>使用公钥初始化gitolite</li>
</ol>
<p><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>安装很简单，可以查看官方文档：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su git</span><br><span class="line">mkdir -p ~/bin</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/sitaramc/gitolite</span><br><span class="line">gitolite/install --help</span><br><span class="line">gitolite/install -ln ~/bin</span><br><span class="line"><span class="comment"># make sure you have the path in $HOME/bin</span></span><br><span class="line"><span class="built_in">source</span> .bash_profile</span><br></pre></td></tr></table></figure></p>
<p>初始化gitolite：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitolite setup -pk git-admin.pub</span><br></pre></td></tr></table></figure></p>
<h2 id="添加gitolite用户和仓库">添加gitolite用户和仓库</h2><p>不需要手动在<code>git</code>服务器中添加新用户或新仓库。因为gitolite的用户，仓库和权限规则是使用一个名为<code>gitolite-admin</code>的特殊仓库进行维护，需通过修改该仓库并合并<code>push</code>到服务器中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@host:gitolite-admin</span><br></pre></td></tr></table></figure></p>
<p>Clone后，看到两个目录<code>conf</code>和<code>keydir</code>，<code>conf/gitolite.conf</code>用于修改仓库及用户权限，<code>keydir</code>用于存放用户公钥。<br>新增<code>hwangjr</code>用户：</p>
<ol>
<li>将其公钥（hwangjr.pub）添加到<code>keydir</code>目录</li>
<li>修改<code>conf/gitolite.conf</code>文件，新增仓库和用户权限：<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repo <span class="keyword">project</span></span><br><span class="line">	RW+ = hwangjr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用其他权限：RW, R等</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>修改完上传服务器即可：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_ins">add</span> conf</span><br><span class="line">git <span class="built_ins">add</span> keydir</span><br><span class="line">git commit -m '<span class="built_ins">add</span> repo project, <span class="built_ins">add</span> <span class="built_ins">user</span> hwangjr'</span><br><span class="line">git push</span><br></pre></td></tr></table></figure></p>
<p><code>PUSH</code>成功之后，服务器会自动创建新的仓库并将用户密钥加入<code>.ssh/authorized_keys</code>文件中。</p>
<h2 id="更多配置">更多配置</h2><p><code>gitolite</code>权限管理很完备，在此给出一些配置方案：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repo project</span><br><span class="line">    RW+                     =   hwangjr</span><br><span class="line">    -   master              =   hwangjr</span><br><span class="line">    -   refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    RW                      =   hwangjr</span><br><span class="line">    RW  refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    R                       =   hwangjr</span><br></pre></td></tr></table></figure></p>
<p>上面配置即：</p>
<ul>
<li>RW+ ： 能够对仓库进行所有的操作。</li>
<li><ul>
<li>master : 能够创建和推送任何名字不为master的分支，并能够添加任何不以v+数字开头的tag。</li>
</ul>
</li>
<li><ul>
<li>refs/tags/v[0-9] : 能够添加任何以v+数字开头的tag。</li>
</ul>
</li>
<li>R : 能够进行clone和fetch操作。</li>
</ul>
<p>还可以添加组进行管理（<strong>@all</strong>为特殊组，表示所有用户）：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@staff</span>      =   hwangjr hwangjr1 hwangjr2</span><br><span class="line"><span class="variable">@interns</span>    =   hwangjr</span><br><span class="line"><span class="variable">@all-devs</span>   =   <span class="variable">@staff</span> <span class="variable">@interns</span></span><br><span class="line"></span><br><span class="line">repo secret</span><br><span class="line">    RW      =   <span class="variable">@staff</span></span><br><span class="line"></span><br><span class="line">repo project</span><br><span class="line">    RW+     =   <span class="variable">@staff</span></span><br><span class="line">    RW      =   <span class="variable">@interns</span></span><br></pre></td></tr></table></figure></p>
<p>更多查看：<a href="http://gitolite.com/gitolite/gitolite.html" target="_blank" rel="external">gitolite all-in-one page</a>。</p>
<h1 id="QUESTION">QUESTION</h1><h2 id="安装过程遇到cant_locate_Data/Dumper-pm">安装过程遇到cant locate Data/Dumper.pm</h2><p>在安装过程中，可能会遇到错误：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gitolite/install -h</span><br><span class="line">Can't locate Data/Dumper.pm <span class="keyword">in</span> @INC (@INC <span class="keyword">contains</span>: /home/git/gitolite/src/lib /usr/<span class="keyword">local</span>/lib64/perl5 /usr/<span class="keyword">local</span>/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) <span class="keyword">at</span> /home/git/gitolite/src/lib/Gitolite/Common.pm line <span class="number">61.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at /home/git/gitolite/src/lib/Gitolite/Common.pm line 61.</span></span><br><span class="line">Compilation failed <span class="keyword">in</span> require <span class="keyword">at</span> gitolite/install line <span class="number">15.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at gitolite/install line 15.</span></span><br></pre></td></tr></table></figure></p>
<p>这是因为缺少包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install perl-Data-Dumper</span><br></pre></td></tr></table></figure></p>
<h2 id="Clone_gitolite-admin时提示需要输入密码">Clone gitolite-admin时提示需要输入密码</h2><p>在clone gitolite-admin时，会提示输入密码：</p>
<ol>
<li>在服务端生成rsa key</li>
<li>在服务端进行clone</li>
</ol>
<p>此时会出现此错误，使用其他机器即可（需要复制rsa key到其他机器）。</p>
<h1 id="Ref">Ref</h1><p><a href="http://wenzhiquan.github.io/blog/2014/10/14/fedora_20_install_gitolite/" target="_blank" rel="external">Fedora 20 安装gitolite</a><br><a href="https://github.com/sitaramc/gitolite" target="_blank" rel="external">sitaramc/gitolite</a><br><a href="http://gitolite.com/gitolite/install.html" target="_blank" rel="external">install and setup</a><br><a href="http://www.loushi135.com/articles/2015/09/21/1442848708235.html" target="_blank" rel="external">centos git服务器安装与gitolite用户权限管理 - 思迁</a></p>
]]></content>
    <summary type="html">
    <![CDATA[搭建Git服务器，并用gitolite管理。]]>
    
    </summary>
    
      <category term="Git" scheme="https://hwangjr.github.io/tags/Git/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Git" scheme="https://hwangjr.github.io/categories/Git/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[自动清理tmp文件]]></title>
    <link href="https://hwangjr.github.io/2015/12/23/%E8%87%AA%E5%8A%A8%E6%B8%85%E7%90%86tmp%E6%96%87%E4%BB%B6/"/>
    <id>https://hwangjr.github.io/2015/12/23/自动清理tmp文件/</id>
    <published>2015-12-23T11:03:26.000Z</published>
    <updated>2015-12-23T11:04:17.303Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>在<code>supervisor</code>默认配置中，其启动的<code>sock</code>等都会放到<code>tmp</code>目录，而<code>tmp</code>目录会自动清理导致无法使用<code>supervisorctl</code>命令，此时：</p>
<ol>
<li>修改<code>supervisor.conf</code>文件，修改到<code>/var/run/</code>及<code>/var/log/</code>目录，具体配置就不进行贴了，简单直接搜索<code>tmp</code>进行修改即可。</li>
<li>重启<code>supervisor</code>服务，记得<code>kill</code>原来服务。</li>
</ol>
<p>但是，为什么系统会自动清理<code>tmp</code>目录呢？</p>
<h1 id="RHEL\CentOS\Fedora系统">RHEL\CentOS\Fedora系统</h1><p>在<code>CentOS 6</code>中，使用<code>tmpwatch</code>命令进行删除。</p>
<blockquote>
<p>tmpwatch - removes files which haven’t been accessed for a period of time</p>
<p>tmpwatch [-u|-m|-c] [-MUadfqstvx] [—verbose] [—force] [—all] [—nodirs] [—nosymlinks] [—test] [—fuser] [—quiet] [—atime|—mtime|—ctime] [—dirmtime] [—exclude path] [—exclude-user user] time dirs</p>
</blockquote>
<p>在<code>/etc/cron.daily/</code>目录下会生成<code>tmpwatch</code>文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh&#10;flags=-umc&#10;/usr/sbin/tmpwatch &#34;$flags&#34; -x /tmp/.X11-unix -x /tmp/.XIM-unix \&#10;        -x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix \&#10;        -X &#39;/tmp/hsperfdata_*&#39; 10d /tmp&#10;/usr/sbin/tmpwatch &#34;$flags&#34; 30d /var/tmp&#10;for d in /var/&#123;cache/man,catman&#125;/&#123;cat?,X11R6/cat?,local/cat?&#125;; do&#10;    if [ -d &#34;$d&#34; ]; then&#10;        /usr/sbin/tmpwatch &#34;$flags&#34; -f 30d &#34;$d&#34;&#10;    fi&#10;done</span><br></pre></td></tr></table></figure></p>
<p>将自动删除240小时未访问文件，<code>tmpwatch</code>工具可以从指定目录递归搜索并删除一段时间未访问文件。<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">u, --atime 基于访问时间来删除文件，默认的。</span><br><span class="line"></span>-<span class="ruby">m, --mtime 基于修改时间来删除文件。</span><br><span class="line"></span>-<span class="ruby">c, --ctime 基于创建时间来删除文件，对于目录，基于mtime。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">M</span>, --dirmtime 删除目录基于目录的修改时间而不是访问时间。</span><br><span class="line"></span>-<span class="ruby">a, --all 删除所有的文件类型，不只是普通文件，符号链接和目录。</span><br><span class="line"></span>-<span class="ruby">d, --nodirs 不尝试删除目录，即使是空目录。</span><br><span class="line"></span>-<span class="ruby">d, --nosymlinks 不尝试删除符号链接。</span><br><span class="line"></span>-<span class="ruby">f, --force 强制删除。</span><br><span class="line"></span>-<span class="ruby">q, --quiet 只报告错误信息。</span><br><span class="line"></span>-<span class="ruby">s, --fuser 如果文件已经是打开状态在删除前，尝试使用“定影”命令。默认不启用。</span><br><span class="line"></span>-<span class="ruby">t, --test 仅作测试，并不真的删除文件或目录。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">U</span>, --exclude-user=user 不删除属于谁的文件。</span><br><span class="line"></span>-<span class="ruby">v, --verbose 打印详细信息。</span><br><span class="line"></span>-<span class="ruby">x, --exclude=path 排除路径，如果路径是一个目录，它包含的所有文件被排除了。如果路径不存在，它必须是一个绝对路径不包含符号链接。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">X</span>, --exclude-pattern=pattern 排除某规则下的路径。</span></span><br></pre></td></tr></table></figure></p>
<h2 id="CentOS_7">CentOS 7</h2><p>在<code>CentOS 7</code>中会注意到一点，在系统中默认会清理<code>tmp</code>目录，而且没有安装<code>tmpwatch</code>，那么<code>CentOS 7</code>中是通过什么来实现的呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># systemctl status systemd-tmpfiles-clean.service</span></span><br><span class="line">systemd-tmpfiles-clean.service - Cleanup of Temporary Directories</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/systemd-tmpfiles-clean.service; <span class="keyword">static</span>)</span><br><span class="line">   Active: inactive (dead) since Thu <span class="number">2015</span>-<span class="number">12</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> HKT; <span class="number">5</span>h <span class="number">12</span>min ago</span><br><span class="line">     Docs: man:tmpfiles.d(<span class="number">5</span>)</span><br><span class="line">           man:systemd-tmpfiles(<span class="number">8</span>)</span><br><span class="line">  Process: <span class="number">6523</span> ExecStart=/usr/bin/systemd-tmpfiles --clean (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">6523</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"></span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Starting Cleanup of Temporary Directories...</span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Started Cleanup of Temporary Directories.</span><br></pre></td></tr></table></figure></p>
<p>没错，就是通过这个服务来实现的，此服务为<code>/usr/lib/systemd/system/systemd-tmpfiles-clean.service</code>。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.service </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="setting">DefaultDependencies=<span class="value"><span class="keyword">no</span></span></span></span><br><span class="line"><span class="setting">Wants=<span class="value">local-fs.target</span></span></span><br><span class="line"><span class="setting">After=<span class="value">systemd-readahead-collect.service systemd-readahead-replay.service local-fs.target</span></span></span><br><span class="line"><span class="setting">Before=<span class="value">sysinit.target shutdown.target</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/local/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/etc/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/run/tmpfiles.d</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Type=<span class="value">oneshot</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/bin/systemd-tmpfiles --clean</span></span></span><br><span class="line"><span class="setting">IOSchedulingClass=<span class="value">idle</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.timer </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Daily Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Timer]</span></span><br><span class="line"><span class="setting">OnBootSec=<span class="value"><span class="number">15</span>min</span></span></span><br><span class="line"><span class="setting">OnUnitActiveSec=<span class="value"><span class="number">1</span>d</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到在启动15分钟之后会清理，每隔1天清理一次。更多详细信息<a href="http://www.freedesktop.org/software/systemd/man/systemd-tmpfiles.html" target="_blank" rel="external">systemd-tmpfiles</a>。</p>
<h1 id="Debian\Ubuntu系统">Debian\Ubuntu系统</h1><p>在<code>Ubuntu</code>系统中每次开机会进行清除，具体配置为<code>rcS</code>文件的<code>TMPTIME</code>值。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/<span class="keyword">default</span>/rcS</span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># /etc/default/rcS</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Default settings for the scripts in /etc/rcS.d/</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For information about these variables see the rcS(5) manual page.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># This file belongs to the "initscripts" package.</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># delete files in /tmp during boot older than x days.</span></span><br><span class="line"><span class="preprocessor"># '0' means always, -1 or 'infinite' disables the feature</span></span><br><span class="line"><span class="preprocessor">#TMPTIME=0</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># spawn sulogin during boot, continue normal boot if not used in 30 seconds</span></span><br><span class="line"><span class="preprocessor">#SULOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># do not allow users to log in until the boot has completed</span></span><br><span class="line"><span class="preprocessor">#DELAYLOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># assume that the BIOS clock is set to UTC time (recommended)</span></span><br><span class="line">UTC=yes</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># be more verbose during the boot process</span></span><br><span class="line"><span class="preprocessor">#VERBOSE=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># automatically repair filesystems with inconsistencies during boot</span></span><br><span class="line"><span class="preprocessor">#FSCKFIX=no</span></span><br></pre></td></tr></table></figure></p>
<p>也就是在x天启动之后会自动清理<code>tmp</code>目录，0代表一直清理，-1代表取消此特性。</p>
<h1 id="注意点">注意点</h1><h2 id="supervisor">supervisor</h2><p>修改默认配置的<code>/tmp/</code>目录为<code>/var/run/</code>和<code>/var/log</code>目录。</p>
<h2 id="mysql">mysql</h2><p>默认将<code>pid</code>和<code>socket</code>创建在<code>tmp</code>目录，将两个此文件排除在外，否则<code>mysql</code>重启或使用<code>socket</code>登陆时提示找不到文件，可通过<code>-U mysql</code>。</p>
<h1 id="REF">REF</h1><p><a href="http://www.oss4aix.org/download/SRPMS/tmpwatch/" target="_blank" rel="external">Index of /download/SRPMS/tmpwatch</a><br><a href="https://git.centos.org/summary/?r=rpms/tmpwatch" target="_blank" rel="external">rpms/tmpwatch - git.centos.org</a><br><a href="http://www.ttlsa.com/linux/the-tmp-directory-is-automatically-cleared-and-the-tmpwatch-command/" target="_blank" rel="external">tmp目录自动清除和tmpwatch命令 - 运维生存时间</a><br><a href="http://www.opsers.org/base/clean-up-on-the-linux-system-tmp-folder-you-may-want-to-know.html" target="_blank" rel="external">关于Linux系统清理/tmp/文件夹，你可能想知道的 | 羽飞博客</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在CentOS 6系统中会自动定期清理tmp目录，其主要是根据tmpwatch和crontab来实现，而CentOS 7中则是根据systemd-tmpfiles-clean.service服务来清理。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android中的CheckStyle]]></title>
    <link href="https://hwangjr.github.io/2015/12/23/Android%E4%B8%AD%E7%9A%84CheckStyle/"/>
    <id>https://hwangjr.github.io/2015/12/23/Android中的CheckStyle/</id>
    <published>2015-12-23T11:02:08.000Z</published>
    <updated>2015-12-23T11:02:32.755Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>简单一句话：CheckStyle解放了团队编码规范的审核。</p>
<p>CheckStyle主要实现了事实检测代码是否符合已经定义的规范，比如静态变量需要大写，函数名不超过20字符等。当发现这些检测不符合规范，则发出警告或错误。</p>
<p>简单来说，checkstyle检测了（更多信息：<a href="http://checkstyle.sourceforge.net/checks.html" target="_blank" rel="external">checkstyle</a>）：</p>
<blockquote>
<p>Annotations<br>Block Checks<br>Class Design<br>Coding<br>Headers<br>Imports<br>Javadoc Comments<br>Metrics<br>Miscellaneous<br>Modifiers<br>Naming Conventions<br>Regexp<br>Size Violations<br>Whitespace</p>
</blockquote>
<h1 id="Android中的配置">Android中的配置</h1><p>由于checkstyle功能丰富，如果自行配置，相对较为复杂，所以在其官网谷歌、sun都有提供范例。接下来简要介绍如何在gradle中配置checkstyle。</p>
<h2 id="配置plugin">配置plugin</h2><p>在<code>build.gradle</code>中，新增插件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'checkstyle'</span></span><br></pre></td></tr></table></figure></p>
<p>默认checkstyle的版本为<code>5.9</code>，如果觉得版本较老，可以配置版本（目前最新版本为<code>6.13</code>，但是不兼容，最高可用版本为<code>6.1.1</code>）：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkstyle &#123;</span><br><span class="line">	toolVersion <span class="string">'6.1.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测任务">检测任务</h2><p>在添加完插件之后，需要添加检测的任务：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task checkstyle(<span class="string">type:</span> Checkstyle) &#123;</span><br><span class="line">    configFile rootProject.file(<span class="string">'checkstyle.xml'</span>)</span><br><span class="line">    <span class="comment">// source fileTree('src')</span></span><br><span class="line">    source <span class="string">'src/main/java'</span></span><br><span class="line">    ignoreFailures <span class="literal">false</span></span><br><span class="line">    showViolations <span class="literal">true</span></span><br><span class="line">    include <span class="string">'**/*.java'</span></span><br><span class="line">    exclude <span class="string">'**/gen/**'</span></span><br><span class="line"></span><br><span class="line">    classpath = files()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测配置">检测配置</h2><p>可以看到上一个步骤有<code>checkstyle.xml</code>文件，这个文件就是检测配置文件，里面包含了检测的规则，可以参考<a href="https://github.com/AndroidKnife/check" target="_blank" rel="external">AndroidKnife/check</a>这里的配置。</p>
<h2 id="检测插件">检测插件</h2><p>如果是使用studio的话，有一系列插件可以方便检测，输入<code>QAPlug</code>并进行搜索即可安装，其中包括<code>check style</code>、<code>FindBugs</code>、<code>PMD</code>、<code>Hammurapi</code>。</p>
<h1 id="Ref">Ref</h1><p><a href="https://github.com/checkstyle/checkstyle" target="_blank" rel="external">checkstyle/checkstyle</a><br><a href="https://google.github.io/styleguide/javaguide.html" target="_blank" rel="external">Google Java Style</a><br><a href="http://www.oracle.com/technetwork/java/codeconvtoc-136057.html" target="_blank" rel="external">Code Conventions for the Java Programming Language</a><br><a href="https://rockeyhoo.gitbooks.io/dianping_codestyle/content/source/BeautyStyle.xml" target="_blank" rel="external">BeautyStyle</a></p>
<p>顺便带上目前使用的<code>check style</code>，可在<a href="https://github.com/AndroidKnife/Utils" target="_blank" rel="external">AndroidKnife/Utils</a>找到：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0"?&gt;</span><span class="doctype">&lt;!DOCTYPE module PUBLIC</span><br><span class="line">    "-//Puppy Crawl//DTD Check Configuration 1.2//EN"</span><br><span class="line">    "http://www.puppycrawl.com/dtds/configuration_1_2.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"Checker"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--module name="NewlineAtEndOfFile"/--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileLength"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileTabCharacter"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Trailing spaces --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"\s+$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Line has trailing spaces."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Space after 'for' and 'if' --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*(for|if)\("</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed before opening parenthesis."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- For each spacing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*for \(.*?([^ ]:|:[^ ])"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed around ':' character."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TreeWalker"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name="cacheFile" value="$&#123;checkstyle.cache.file&#125;"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Javadoc comments.                     --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_javadoc.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocMethod"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocType"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocVariable"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocStyle"/--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Naming Conventions.                  --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_naming.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ConstantName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalFinalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MemberName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[a-z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"PackageName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"StaticVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypeName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[A-Z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for imports                              --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_import.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidStarImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UnusedImports"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"processJavadoc"</span> <span class="attribute">value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Size Violations.                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_sizes.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LineLength"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"max"</span> <span class="attribute">value</span>=<span class="value">"150"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"ignorePattern"</span></span><br><span class="line">                <span class="attribute">value</span>=<span class="value">"^package.*|^import.*|a href|href|http://|https://|ftp://"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodLength"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterNumber"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for whitespace                               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_whitespace.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"GenericWhitespace"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyForIteratorPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodParamPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceBefore"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"OperatorWrap"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypecastParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAround"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Modifier Checks                                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_modifiers.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="ModifierOrder"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantModifier"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for blocks. You know, those &#123;&#125;'s         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_blocks.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidNestedBlocks"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyBlock"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LeftCurly"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NeedBraces"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RightCurly"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for common coding problems               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_coding.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="AvoidInlineConditionals"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"CovariantEquals"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyStatement"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsAvoidNull"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsHashCode"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="HiddenField"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalInstantiation"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InnerAssignment"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="MagicNumber"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MissingSwitchDefault"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantThrows"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanExpression"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanReturn"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for class design                         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_design.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="DesignForExtension"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalClass"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"HideUtilityClassConstructor"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InterfaceIsType"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="VisibilityModifier"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Miscellaneous other checks.                   --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_misc.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ArrayTypeStyle"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalParameters"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TodoComment"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UpperEll"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
]]></content>
    <summary type="html">
    <![CDATA[利用check style可以很好的对代码进行静态检测。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ProGuard 精粹]]></title>
    <link href="https://hwangjr.github.io/2015/12/03/ProGuard-%E7%B2%BE%E7%B2%B9/"/>
    <id>https://hwangjr.github.io/2015/12/03/ProGuard-精粹/</id>
    <published>2015-12-03T07:01:25.000Z</published>
    <updated>2015-12-03T07:01:46.322Z</updated>
    <content type="html"><![CDATA[<h1 id="背景">背景</h1><p>总结ProGuard混淆日常的使用方式，常见的混淆片段等。</p>
<p>更多内容<a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a></p>
<blockquote>
<p>ProGuard is a free Java class file shrinker, optimizer, obfuscator, and preverifier. It detects and removes unused classes, fields, methods, and attributes. It optimizes bytecode and removes unused instructions. It renames the remaining classes, fields, and methods using short meaningless names. Finally, it preverifies the processed code for Java 6 or higher, or for Java Micro Edition.<br><strong>Some uses of ProGuard are:</strong><br>Creating more compact code, for smaller code archives, faster transfer across networks, faster loading, and smaller memory footprints.<br>Making programs and libraries harder to reverse-engineer.<br>Listing dead code, so it can be removed from the source code.<br>Retargeting and preverifying existing class files for Java 6 or higher, to take full advantage of their faster class loading.</p>
</blockquote>
<h1 id="原则">原则</h1><p>现在面向对象都讲究原则，做事也讲究原则。</p>
<ul>
<li>反射用到的类不混淆</li>
<li>JNI方法不混淆</li>
<li>Manifest中类不混淆</li>
<li>四大组件和Application子类、Framework层下所有类默认不混淆</li>
<li>Parcelable子类和Creator静态成员变量不混淆（BadParcelableException，怕了吧）</li>
<li>GSon、FastJson等库时，Json对象不混淆（注解可解决此问题）</li>
<li>第三方开源库或引用其他第三方SDK，加入对应混淆规则（或者库在打包aar时有指定<code>consumerProguardFiles</code>）</li>
<li>WebView的JS调用接口不混淆</li>
</ul>
<h1 id="使用">使用</h1><h2 id="AndroidStudio">AndroidStudio</h2><p>新建项目后，默认会在模块目录下新建<code>build.gradle</code>和<code>proguard-rules.pro</code>文件，修改<code>build.gradle</code>文件中的<code>proguardFiles</code>配置：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    debug &#123;</span><br><span class="line">        versionNameSuffix <span class="string">"-debug"</span></span><br><span class="line">        minifyEnabled <span class="literal">false</span></span><br><span class="line">        zipAlignEnabled <span class="literal">false</span></span><br><span class="line">        shrinkResources <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span></span><br><span class="line">        zipAlignEnabled <span class="literal">true</span></span><br><span class="line">        shrinkResources <span class="literal">true</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        signingConfig signingConfigs.xxx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你是引用库，那么不要忘了给库配上混淆，详细参考<a href="http://blog.hwangjr.com/2015/11/25/%E6%90%9E%E5%AE%9AAndroid-Proguard/" target="_blank" rel="external">搞定Android Proguard</a>或者<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumerProguardFiles</span><br></pre></td></tr></table></figure></p>
<h2 id="其他方式">其他方式</h2><p>在SDK目录下，有<code>tools/proguard/</code>，这里即<code>proguard</code>的大本营，包括上面的<code>getDefaultProguardFile</code>方法也是到此目录获取<code>proguard-android.txt</code>文件。</p>
<p>在<code>proguard</code>目录下有<code>bin</code>目录，可以直接启动界面配置，当然也可以保存配置等。</p>
<p>其他类似<code>ANT</code>或者<code>IDE</code>类似<code>Eclipse</code>等，基本大同小异，自行摸索。</p>
<h1 id="配置">配置</h1><h2 id="基本配置">基本配置</h2><p>常用语法：</p>
<ul>
<li><code>-libraryjars class_path</code>：应用的依赖包，如<code>android-support-v4</code></li>
<li>-keep [,modifier,…] class_specification`：不混淆某些类</li>
<li><code>-keepclassmembers [,modifier,...] class_specification</code>：不混淆类的成员</li>
<li><code>-keepclasseswithmembers [,modifier,...] class_specification</code>：不混淆类及其成员</li>
<li><code>-keepnames class_specification</code>：不混淆类及其成员名</li>
<li><code>-keepclassmembernames class_specification</code>：不混淆类的成员名</li>
<li><code>-keepclasseswithmembernames class_specification</code>：不混淆类及其成员名</li>
<li><code>-assumenosideeffects class_specification</code>：假设调用不产生任何影响，在代码优化时会将该调用<code>remove</code>掉。如<code>system.out.println</code>和<code>Log.v</code>等等</li>
<li><code>-dontwarn [class_filter]</code>：不提示warnning</li>
</ul>
<p>更多关于ProGuard混淆规则和语法，参考<a href="http://proguard.sourceforge.net/index.html#manual/usage.html" target="_blank" rel="external">ProGuard</a>。</p>
<h2 id="常见使用">常见使用</h2><p><strong>不混淆类构造方法，需指定函数参数类型：</strong><br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(<span class="keyword">int</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个包所有/某个类、接口：</strong><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.hwangjr.utils.<span class="keyword">*</span><span class="keyword">*</span> &#123; <span class="keyword">*</span>; &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个方法：</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    public <span class="built_in">String</span> getTelephone(java.lang.<span class="built_in">String</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆Parcelable子类：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用assumenosideeffects移除代码：</strong><br>正常可通过BuildConfig.DEBUG变量控制日志输出，DEBUG模式可查看到日志。但ProGuard也可压缩和优化不必要的代码，包括debug日志，在发布时，会自动从源码中删除。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-assumenosideeffects <span class="keyword">class</span> android.util.Log &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">v</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">i</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">d</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">w</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">e</span><span class="params">(...)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 反射：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepattributes <span class="constant">Signature</span></span><br><span class="line"></span>-<span class="ruby">keepattributes <span class="constant">EnclosingMethod</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>Serializable类：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.io.ObjectStreamField[] serialPersistentFields;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream)</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">writeReplace</span><span class="params">()</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">readResolve</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>JS接口：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">fqcn</span>.<span class="title">of</span>.<span class="title">javascript</span>.<span class="title">interface</span>.<span class="title">for</span>.<span class="title">webview</span> &#123;</span></span><br><span class="line"></span>    public *;</span><br><span class="line">&#125;</span><br><span class="line">-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">package</span>.<span class="title">name</span>.** &#123; *;</span> &#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="混淆后">混淆后</h1><h2 id="混淆后文件">混淆后文件</h2><p>Android Studio发布版本之后，会自动生成混淆之后文件（build/outputs/mapping/channel/release/）：<br><code>mapping.txt</code>：混淆前后代码对照，在混淆之后如果出现问题，需要查找此文件进行定位。<br><code>dump.txt</code>：APK内所有class文件结构<br><code>seeds.txt</code>：没有被混淆的类和成员<br><code>usage.txt</code>：源代码中被删除的代码</p>
<p><strong>所以，养成保存<code>mapping.txt</code>文件的习惯。</strong></p>
<h2 id="混淆后验证">混淆后验证</h2><p>反编译应用，大部分都变成<code>abc...</code>。</p>
<h2 id="混淆后调试">混淆后调试</h2><p>问题分为代码问题和混淆问题。</p>
<p><strong>代码问题</strong><br>通过查看<code>mapping.txt</code>文件，反推定位对应代码问题来进行解决。混淆后<code>$</code>为匿名内部类。</p>
<p><strong>混淆问题</strong><br>最常见<code>ClassNotFoundException</code>、<code>BadParcelableException</code>及JSON解析错误。<br><code>ClassNotFoundException</code>通过mapping逆推找到类，在混淆中加入不混淆此类即可：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="type">class</span> package.<span class="property">name</span>.<span class="type">class</span> &#123; *; &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Parcelable</code>混淆错误加入：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>V4</code>包、<code>V7</code>包等包混淆问题（<code>sdk/tools/proguard/proguard-android.txt</code>中已经明确）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>更多问题可以参考：<a href="http://proguard.sourceforge.net/index.html#manual/troubleshooting.html" target="_blank" rel="external">ProGuard TroubleShooting</a></p>
<h1 id="ProGuard-Android">ProGuard-Android</h1><p>参考示例<code>sdk/tools/proguard/proguard-android.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimization is turned off by default. Dex does not like code run</span></span><br><span class="line"><span class="comment"># through the ProGuard optimize and preverify steps (and performs some</span></span><br><span class="line"><span class="comment"># of these optimizations on its own).</span></span><br><span class="line">-dontoptimize</span><br><span class="line">-dontpreverify</span><br><span class="line"><span class="comment"># Note that if you want to enable optimization, you cannot just</span></span><br><span class="line"><span class="comment"># include optimization flags in your own project configuration file;</span></span><br><span class="line"><span class="comment"># instead you will need to point to the</span></span><br><span class="line"><span class="comment"># "proguard-android-optimize.txt" file instead of this one from your</span></span><br><span class="line"><span class="comment"># project.properties file.</span></span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考示例<code>sdk/tools/proguard/proguard-android-optimize.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimizations: If you don't want to optimize, use the</span></span><br><span class="line"><span class="comment"># proguard-android.txt configuration file instead of this one, which</span></span><br><span class="line"><span class="comment"># turns off the optimization flags.  Adding optimization introduces</span></span><br><span class="line"><span class="comment"># certain risks, since for example not all optimizations performed by</span></span><br><span class="line"><span class="comment"># ProGuard works on all versions of Dalvik.  The following flags turn</span></span><br><span class="line"><span class="comment"># off various optimizations known to have issues, but the list may not</span></span><br><span class="line"><span class="comment"># be complete or up to date. (The "arithmetic" optimization can be</span></span><br><span class="line"><span class="comment"># used if you are only targeting Android 2.0 or later.)  Make sure you</span></span><br><span class="line"><span class="comment"># test thoroughly if you go this route.</span></span><br><span class="line">-optimizations !code/simplification/arithmetic,!code/simplification/cast,!field/<span class="keyword">*</span>,!class/merging/<span class="keyword">*</span></span><br><span class="line">-optimizationpasses 5</span><br><span class="line">-allowaccessmodification</span><br><span class="line">-dontpreverify</span><br><span class="line"></span><br><span class="line"><span class="comment"># The remainder of this file is identical to the non-optimized version</span></span><br><span class="line"><span class="comment"># of the Proguard configuration file (except that the other file has</span></span><br><span class="line"><span class="comment"># flags to turn off optimization).</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考<code>sdk/tools/proguard/proguard-project.txt</code>：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># To enable ProGuard in your project, edit project.properties</span></span><br><span class="line"><span class="preprocessor"># to define the proguard.config property as described in that file.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Add project specific ProGuard rules here.</span></span><br><span class="line"><span class="preprocessor"># By default, the flags in this file are appended to flags specified</span></span><br><span class="line"><span class="preprocessor"># in $&#123;sdk.dir&#125;/tools/proguard/proguard-android.txt</span></span><br><span class="line"><span class="preprocessor"># You can edit the include path and order by changing the ProGuard</span></span><br><span class="line"><span class="preprocessor"># include property in project.properties.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For more details, see</span></span><br><span class="line"><span class="preprocessor">#   http://developer.android.com/guide/developing/tools/proguard.html</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Add any project specific keep options here:</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># If your project uses WebView with JS, uncomment the following</span></span><br><span class="line"><span class="preprocessor"># and specify the fully qualified class name to the JavaScript interface</span></span><br><span class="line"><span class="preprocessor"># class:</span></span><br><span class="line"><span class="preprocessor">#-keepclassmembers class fqcn.of.javascript.interface.for.webview &#123;</span></span><br><span class="line"><span class="preprocessor">#   public *;</span></span><br><span class="line"><span class="preprocessor">#&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Ref">Ref</h2><p><a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a><br><a href="http://developer.android.com/intl/zh-cn/tools/help/proguard.html" target="_blank" rel="external">ProGuard | Android Developers</a><br><a href="http://www.trinea.cn/android/proguard-use/" target="_blank" rel="external">ProGuard的作用</a><br><a href="https://github.com/D-clock/Doc/blob/master/Gradle/4_AndroidStudio%E4%B8%8BProGuard%E6%B7%B7%E6%B7%86%E6%89%93%E5%8C%85.md" target="_blank" rel="external">AndroidStudio下ProGuard混淆打包.md</a></p>
]]></content>
    <summary type="html">
    <![CDATA[总结ProGuard使用及日常，主要针对Android及Java的混淆。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[搞定Android Proguard]]></title>
    <link href="https://hwangjr.github.io/2015/11/25/%E6%90%9E%E5%AE%9AAndroid-Proguard/"/>
    <id>https://hwangjr.github.io/2015/11/25/搞定Android-Proguard/</id>
    <published>2015-11-25T10:23:19.000Z</published>
    <updated>2015-11-25T10:23:44.277Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>各种引用库，各种混淆，心好累。<br>所以，有了<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>。</p>
<h2 id="混淆设置">混淆设置</h2><p>Android中采用Proguard进行代码混淆。每次混淆，都会开始找寻混淆配置，在此开源库中，你可以找到你想要的，如果没找到，没关系，可以PULL REQUEST。</p>
<h3 id="build-gradle">build.gradle</h3><p>正常在<code>build.gradle</code>中加入混淆配置文件即可：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            zipAlignEnabled <span class="keyword">true</span></span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// specific proguard files</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span>, <span class="string">'proguard-gson.pro'</span></span><br><span class="line">            proguardFile <span class="string">'proguard-square-okio.pro'</span></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// As of Gradle Android plugin 1.1.0, the test APK has a separate config</span></span><br><span class="line">            testProguardFile <span class="string">'proguard-rules-test.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="proguard-rules-pro">proguard-rules.pro</h3><p>将混淆设置加入<code>proguard-rules.pro</code>文件也是一种方式：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="keyword">include</span> xxx</span></span><br></pre></td></tr></table></figure></p>
<h3 id="consumerProguardFiles">consumerProguardFiles</h3><p>开源库中可以依赖此标志来指定库的混淆方式，此会将<code>*.pro</code>文件打包进入<code>aar</code>中，库混淆时候会自动使用此混淆配置文件。</p>
<p>需要注意的是，以<code>consumerProguardFiles</code>方式加入的混淆具有以下特性：</p>
<ul>
<li><code>*.pro</code>文件会包含在<code>aar</code>文件中</li>
<li>这些<code>pro</code>配置会在混淆的时候被使用</li>
<li>此配置针对此<code>aar</code>进行混淆配置</li>
<li>此配置只对库文件有效，对应用程序无效</li>
</ul>
<p>所以以<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>开源库，只要一行代码即可搞定外部混淆：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.hwangjr.proguard:proguardconfig:1.0.1@aar'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>使用此库大善，欢迎pull request。</p>
]]></content>
    <summary type="html">
    <![CDATA[引用各种库，然后各种的混淆，心好累。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[发布开源项目到Maven（Gradle + Sonatype）]]></title>
    <link href="https://hwangjr.github.io/2015/11/24/%E5%8F%91%E5%B8%83%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%B0Maven%EF%BC%88Gradle-Sonatype%EF%BC%89/"/>
    <id>https://hwangjr.github.io/2015/11/24/发布开源项目到Maven（Gradle-Sonatype）/</id>
    <published>2015-11-24T10:43:22.000Z</published>
    <updated>2015-11-24T10:43:47.007Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>最近整理Android开发工具，想跟其他人分享，就有了将其发布到maven想法，所以考虑将库发布到maven，目前Android官方使用jCenter，比这个简单，后续补充（jCenter会自动同步Maven Center中的库）。<br>顺带避免：</p>
<blockquote>
<p>Download the source to use it as library project</p>
</blockquote>
<h2 id="流程">流程</h2><p>整个流程很清晰：</p>
<ol>
<li>获取JIRA Ticket，简单说就是去<a href="https://issues.sonatype.org/browse/" target="_blank" rel="external">Issues Sonatype</a>注册并提交issue</li>
<li>GPG密钥，要上传到maven，需要GPG密钥</li>
<li>本地配置POM，即配置项目信息</li>
<li>Gradle提交到Sonatype，通过脚本提交到Sonatype</li>
<li>发布版本，分为SNAPSHOT和Release版本</li>
</ol>
<p>整个流程就是酱紫。OVER。</p>
<h2 id="获取JIRA_Ticket">获取JIRA Ticket</h2><h3 id="注册JIRA帐号">注册JIRA帐号</h3><p>提交项目到Sonatype，首先需要注册。打开<a href="https://issues.sonatype.org/" target="_blank" rel="external">(Issue Sonatype)</a>注册JIRA帐号。</p>
<h3 id="创建Issue">创建Issue</h3><p>在导航上Create按钮，创建一个新的Issue。其中特别注意：</p>
<ol>
<li>Issue Type默认是new Project，按照默认就好</li>
<li>Summer和Description填写你要创建项目的描述即可</li>
<li>Group id特别关键，最好创建顶级Group ID，比如我需要<code>com.hwangjr.xxx</code>，那么Group ID填写为<code>com.hwangjr</code>，这样其他的库也可发布</li>
<li>Project URL和SCM URL填GIT HUB项目地址即可</li>
<li>其他基本都懂</li>
</ol>
<p>填写完毕，等待！工作人员会让你提交你的项目到Sonatype。</p>
<h2 id="GPG密钥">GPG密钥</h2><p>密钥是为了上传文件的加密和签名。如果有安装git，那么应该是已经安装GPG了，以下默认命令为Linux下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">gpg --gen-key</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">gpg --list-key</span><br></pre></td></tr></table></figure></p>
<p>其中姓名、邮箱和备注需要认真填写下，最后输入的Passphase，是密码，上传maven需要使用。</p>
<blockquote>
<p>pub   2048R/B53A8137 2015-11-24<br>uid                  hwangjr (Upload Modules For Maven By Sonatype.) <a href="&#x6d;&#x61;&#105;&#108;&#x74;&#x6f;&#x3a;&#104;&#x75;&#x61;&#x6e;&#103;&#x6a;&#105;&#97;&#110;&#x72;&#x6f;&#110;&#103;&#50;&#48;&#49;&#x30;&#x40;&#x67;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">&#104;&#x75;&#x61;&#x6e;&#103;&#x6a;&#105;&#97;&#110;&#x72;&#x6f;&#110;&#103;&#50;&#48;&#49;&#x30;&#x40;&#x67;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;</a><br>sub   2048R/2F11E234 2015-11-24</p>
</blockquote>
<p>B53A8137是KEY ID。上传公钥到服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://pool.sks-keyservers.net --send-keys B53A8137</span><br></pre></td></tr></table></figure></p>
<h2 id="本地配置POM">本地配置POM</h2><p>Chris Banes大神已经写完Gradle插件<a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">chrisbanes/gradle-mvn-push</a>，可直接使用<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，上面有详细的配置和使用方式。简要步骤为：</p>
<ol>
<li>项目，保证是可以用Gradle编译。</li>
<li>更新<code>HOME gradle.properties</code>，修改<code>USER_HOME/.gradle/gradle.properties</code>文件。</li>
<li>在项目根目录下，创建文件<code>gradle.properties</code>。</li>
<li>在想要上传的子模块下，分别创建<code>gradle.properties</code>。</li>
<li>在子模块下，应用Gradle插件，即在<code>build.gradle</code>末尾加上<code>apply from: &#39;https://raw.github.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle&#39;</code> 或者下载gradle-mvn-push.gradle文件，放到根目录的<code>gradle</code>文件夹下，在<code>build.gradle</code>末尾加上<code>apply from: rootProject.file(&#39;gradle/gradle-mvn-push.gradle&#39;)</code>。</li>
<li>编译并上传<code>gradle clean build uploadArchives</code>。</li>
</ol>
<p>其他属性：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RELEASE_REPOSITORY_URL (defaults to Maven Central's staging server)</span><br><span class="line">SNAPSHOT_REPOSITORY_URL (defaults to Maven Central's snapshot server)</span><br></pre></td></tr></table></figure></p>
<p>USER_HOME/.gradle/gradle.properties文件新增，内容修改为自身用户名密码，下面的就是创建的GPG密钥：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NEXUS_USERNAME=chrisbanes</span><br><span class="line">NEXUS_PASSWORD=g00dtry</span><br><span class="line"></span><br><span class="line">signing.keyId=ABCDEF12</span><br><span class="line">signing.password=n1c3try</span><br><span class="line">signing.secretKeyRingFile=<span class="regexp">/home/u</span>ser<span class="regexp">/.gnupg/</span>secring.gpg</span><br></pre></td></tr></table></figure></p>
<p>项目根目录下的gradle.properties文件内容为，需要根据具体项目情况进行修改：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">VERSION_NAME=0.9.2-SNAPSHOT</span><br><span class="line">VERSION_CODE=92</span><br><span class="line">GROUP=com.github.chrisbanes.actionbarpulltorefresh</span><br><span class="line"></span><br><span class="line">POM_DESCRIPTION=A modern implementation of the pull-to-refresh for Android</span><br><span class="line">POM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_SCM_DEV_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_LICENCE_NAME=The Apache Software License, Version 2.0</span><br><span class="line">POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt</span><br><span class="line">POM_LICENCE_DIST=repo</span><br><span class="line">POM_DEVELOPER_ID=chrisbanes</span><br><span class="line">POM_DEVELOPER_NAME=Chris Banes</span><br></pre></td></tr></table></figure></p>
<p>子模块的gradle.properties文件内容为：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POM_NAME=ActionBar-PullToRefresh Library</span><br><span class="line">POM_ARTIFACT_ID=library</span><br><span class="line">POM_PACKAGING=aar</span><br></pre></td></tr></table></figure></p>
<p><strong>其中</strong>VERSION_NAME后面如果带<code>SNAPSHOT</code>会提交到<a href="https://oss.sonatype.org/content/repositories/snapshots" target="_blank" rel="external">Snapshots</a>，这个不需要同步即可下载jar和源码，如果不加则为RELEASE版本，会同步到MAVEN CENTER。</p>
<h2 id="Gradle脚本提交到Sonatype">Gradle脚本提交到Sonatype</h2><p>运行命令：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle clean build uploadArchives</span><br></pre></td></tr></table></figure></p>
<p>即会执行clean，并重新编译，上传到Sonatype。</p>
<h2 id="发布版本">发布版本</h2><p>版本分为<code>SNAPSHOT</code>版本和<code>RELEASE</code>版本。<br>如果<code>VERSION_NAME</code>有加入<code>SNAPSHOT</code>，即为<code>SNAPSHOT</code>版本，不会同步到MAVEN。<br>如果没有<code>SNAPSHOT</code>，则会同步到MAVEN。</p>
<p>首次提交之后，登陆<a href="https://oss.sonatype.org/index.html#welcome" target="_blank" rel="external">Sonatype Nexus Professional</a>，查看<code>Staging Repositories</code>，找到提交的包，选择并close并Release，再到<code>issue sonatype</code>上提交的JIRA TICKET后面评论告知版本已经staged并released，可以进行sync，工作人员会进行同步。<br>同步成功之后，即可在<a href="http://search.maven.org/" target="_blank" rel="external">maven center</a>搜索到项目，可通过gradle添加依赖。</p>
<h2 id="常规发布步骤">常规发布步骤</h2><ol>
<li>发布<code>SNAPSHOT</code>版本是否查看是否正常</li>
<li>发布<code>RELEASE</code>版本到线上，并进行同步</li>
<li>修改为下个<code>SNAPSHOT</code>版本</li>
</ol>
<h2 id="TIPS">TIPS</h2><h3 id="发布JAR">发布JAR</h3><p>如果想发布JAR，在<a href="#本地配置POM">本地配置POM</a>时，修改<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，在脚本中加入：<br>``` gradle<br>artifacts {<br>    archives packageReleaseJar<br>}</p>
<h3 id="发布时返回401">发布时返回401</h3><p>401为没有权限错误，检查：</p>
<ol>
<li>用户名密码，可在gradle-mvn-push中打印日志查看用户名密码是否正确</li>
<li>检查Sonatype是否有权限</li>
</ol>
<h2 id="REFS">REFS</h2><p><a href="http://central.sonatype.org/pages/ossrh-guide.html" target="_blank" rel="external">OSSRH Guide</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/gpg.html" target="_blank" rel="external">GPG入门教程</a><br><a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">gradle-mvn-push</a><br><a href="https://oss.sonatype.org/" target="_blank" rel="external">Sonatype Nexus Professional</a><br><a href="http://afoo.me/posts/2013-07-18-publishing-oss-release-to-maven-central-repo.html" target="_blank" rel="external">发布开源项目到Maven Central</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在使用自己构建库的同时，是否有强烈的分享欲，那么，就开源上传到Maven Center让别人一起开森吧。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[应用内存泄露排查]]></title>
    <link href="https://hwangjr.github.io/2015/11/13/%E5%BA%94%E7%94%A8%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%8E%92%E6%9F%A5/"/>
    <id>https://hwangjr.github.io/2015/11/13/应用内存泄露排查/</id>
    <published>2015-11-13T03:26:23.000Z</published>
    <updated>2015-11-24T07:30:44.759Z</updated>
    <content type="html"><![CDATA[<h2 id="内存泄露">内存泄露</h2><p>用到神器<a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a>：</p>
<blockquote>
<p>A memory leak detection library for Android and Java.<br>“A small leak will sink a great ship.”    - Benjamin Franklin<br>千里之堤，毁于蚁穴。 — 《韩非子.喻老》</p>
</blockquote>
<h3 id="LeakCanary完整集成">LeakCanary完整集成</h3><p><strong>配置build.gradle</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">	    <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.2.3'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">apply plugin: <span class="string">'android-library'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">	<span class="keyword">repositories</span>&#123;</span><br><span class="line">		jcenter()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">   debugCompile <span class="string">'com.squareup.leakcanary:leakcanary-android:1.3.1'</span></span><br><span class="line">   releaseCompile <span class="string">'com.squareup.leakcanary:leakcanary-android-no-op:1.3.1'</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>配置代码</strong><br>在你的APPLICATION中：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class ExampleApplication extends Application &#123;&#10;  @Override public void onCreate() &#123;&#10;&#9;super.onCreate();&#10;&#9;if (BuildConfig.DEBUG) &#123;&#10;&#9;    refWatcher = LeakCanary.install(this, LeakLogService.class,&#10;&#9;            AndroidExcludedRefs.createAndroidDefaults().build());&#10;&#9;&#125; else &#123;&#10;&#9;    refWatcher = RefWatcher.DISABLED;&#10;&#9;&#125;&#10;&#10;&#9;public static RefWatcher getRefWatcher(Context context) &#123;&#10;        ExampleApplication application = (ExampleApplication) context.getApplicationContext();&#10;        return application.refWatcher;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后在需要检测的地方进行监听即可：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract class BaseFragment extends Fragment &#123;&#10;&#10;  @Override public void onDestroy() &#123;&#10;    super.onDestroy();&#10;    RefWatcher refWatcher = ExampleApplication.getRefWatcher(getActivity());&#10;    refWatcher.watch(this);&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简易集成">简易集成</h3><p>参考<a href="https://github.com/GavinCT/SimpleLeakCanary" target="_blank" rel="external">GavinCT/SimpleLeakCanary</a>。<br>拷贝库文件到项目下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AndroidWatchExecutor<span class="class">.java</span></span><br><span class="line">GcTrigger<span class="class">.java</span></span><br><span class="line">KeyedWeakReference<span class="class">.java</span></span><br><span class="line">RefWatcher.java</span><br></pre></td></tr></table></figure></p>
<p>在需要监听的地方添加监听代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected void onDestroy() &#123;&#10;&#9;super.onDestroy();&#10;&#9;getApplicationContext().getRefWatcher().watch(this);&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="排查内存泄露">排查内存泄露</h2><p>利用Eclipse的Memory Analyzer（<a href="http://www.eclipse.org/mat/" target="_blank" rel="external">Eclipse Memory Analyzer Open Source Project</a>）可以方便的分析内存泄露原因。</p>
<p><strong>使用Studio帮助我们排查泄露</strong><br>通过Studio我们可以：</p>
<ol>
<li>查看内存堆栈情况</li>
<li>手动/强制垃圾回收，排除LeakCanary误报</li>
<li>导出Heap信息（Dump Java Heap）</li>
</ol>
<p>内存信息导出后，可用MAT打开.hprof文件进行分析，可能需要进行转换：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hprof-conv source.hprof dist.hprof</span><br></pre></td></tr></table></figure></p>
<p>打开QQL查询当前内存信息（快捷键CTRL + ENTER执行QQL语句）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from instanceof android.app.Activity</span><br></pre></td></tr></table></figure></p>
<p>查看内存信息，如果有多个相同对象即为可疑泄露对象：<br><code>右键 -&gt; Merge Shortest Paths to GC Roots -&gt; exclude all phantom/weak/soft etc. refrences</code><br>具体排查类，即可发现泄露对象。</p>
<h2 id="解决内存泄露">解决内存泄露</h2><p>针对可疑泄露对象，进行代码排查，即可解决。</p>
<h2 id="避免内存泄露">避免内存泄露</h2><p>良好编码习惯！</p>
<ol>
<li>匿名内部类</li>
<li>非静态内部类</li>
<li>单例对象持有Activity或Context对象<br>ETC…</li>
</ol>
<h2 id="REF">REF</h2><p><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html" target="_blank" rel="external">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a><br><a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a><br><a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/" target="_blank" rel="external">Google IO：Android内存管理主题演讲记录 - 技术小黑屋</a><br><a href="http://jiajixin.cn/2015/01/06/memory_leak/" target="_blank" rel="external">Android内存泄漏研究 | Jason’s Blog</a></p>
]]></content>
    <summary type="html">
    <![CDATA[调试内存泄露方法，监控应用是否正常使用内存并回收。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS如何移除依赖]]></title>
    <link href="https://hwangjr.github.io/2015/11/09/CentOS%E5%A6%82%E4%BD%95%E7%A7%BB%E9%99%A4%E4%BE%9D%E8%B5%96/"/>
    <id>https://hwangjr.github.io/2015/11/09/CentOS如何移除依赖/</id>
    <published>2015-11-09T02:44:12.000Z</published>
    <updated>2015-11-09T02:44:38.879Z</updated>
    <content type="html"><![CDATA[<h2 id="自带清除技能">自带清除技能</h2><p>从Fedora 18之后，yum有自带清除：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum autoremove</span><br><span class="line">yum autoremove &lt;package&gt;</span><br><span class="line"><span class="comment"># 一般不用</span></span><br><span class="line">yum remove --setopt=clean_requerements_on_remove=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="第三方技能">第三方技能</h2><p>安装<code>yum-utils</code>也是可以自动清理依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">package-cleanup --leaves</span><br><span class="line">package-cleanup --leaves --all</span><br><span class="line">package-cleanup -q --leaves | xargs <span class="operator">-l</span>1 yum -y remove</span><br></pre></td></tr></table></figure></p>
<h2 id="回滚安装技能">回滚安装技能</h2><p>自然，我们是在安装的时候安装了依赖，那如果我们回滚本次安装，也一样可以卸载这些依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> list &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> undo &lt;ID&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>相比而言，现在对包管理还是简单方便的，当然更高深的还需要自己摸索。</p>
]]></content>
    <summary type="html">
    <![CDATA[在使用CentOS时，会安装很多软件，自动解析依赖并安装，然而在卸载时候，仅仅只是卸载当前包，如何清除包及其依赖呢？]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Crontabs Guide]]></title>
    <link href="https://hwangjr.github.io/2015/10/27/Crontabs-Guide/"/>
    <id>https://hwangjr.github.io/2015/10/27/Crontabs-Guide/</id>
    <published>2015-10-27T04:05:24.000Z</published>
    <updated>2015-10-27T04:05:43.536Z</updated>
    <content type="html"><![CDATA[<h2 id="Introduction">Introduction</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure>
<p>—-&gt;</p>
<blockquote>
<p>Crontab  is the program used to install, remove or list the tables used to drive the cron(8) daemon.  Each user can have their own crontab, and though these are files in /var/spool/ , they are not intended to be edited directly. For SELinux in mls mode can be even more crontabs - for each range. For more see selinux(8).</p>
<p>The  cron  jobs  could  be allow or disallow for different users. For classical crontab there exists cron.allow and cron.deny files.  If cron.allow file exists, then you must be listed therein in order to be allowed to use this command.  If the cron.allow file does not exist but the cron.deny file does exist,  then  you must  not  be listed in the cron.deny file in order to use this command.  If neither of these files exists, only the super user will be allowed to use this com-mand. The second option is using PAM authentication, where you set up users, which could or couldn’t use crontab and also system cron jobs from /etc/cron.d/.</p>
<p>The temporary directory could be set in enviroment variables. If it’s not set by user than /tmp is used.</p>
</blockquote>
<h2 id="Installation">Installation</h2><p>Just the commands:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check installation</span></span><br><span class="line">rpm -ql crontabs</span><br><span class="line">rpm -qa crontabs</span><br><span class="line"><span class="comment"># install</span></span><br><span class="line">yum install crontabs</span><br><span class="line"><span class="comment"># start service on boot</span></span><br><span class="line">chkconfig crond on</span><br><span class="line"><span class="comment"># start service now</span></span><br><span class="line">service crond start</span><br><span class="line">service crond status</span><br><span class="line">service crond restart</span><br><span class="line">service crond reload</span><br><span class="line">service crond stop</span><br></pre></td></tr></table></figure></p>
<p>Also, you can check the service by:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntsysv</span><br></pre></td></tr></table></figure></p>
<h2 id="Usage">Usage</h2><h3 id="Basic_Usage">Basic Usage</h3><p>Also, <code>man</code> is our best friend :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>NAME<br>crontab - maintain crontab files for individual users</li>
<li>SYNOPSIS<br>crontab [-u user] file<br>crontab [-u user] [-l | -r | -e] [-i] [-s]</li>
<li>OPTIONS<pre><code>**-u**     Append <span class="keyword">the</span> <span class="property">name</span> <span class="keyword">of</span> <span class="keyword">the</span> user <span class="keyword">whose</span> crontab <span class="keyword">is</span> <span class="keyword">to</span> be tweaked.  If this option <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">given</span>, crontab examines <span class="string">"your"</span> crontab, i.e., <span class="keyword">the</span> crontab <span class="keyword">of</span> <span class="keyword">the</span>  person  executing  <span class="keyword">the</span>  command.   Note  <span class="keyword">that</span>  su(<span class="number">8</span>) can confuse crontab <span class="keyword">and</span> <span class="keyword">that</span> <span class="keyword">if</span> you are <span class="property">running</span> inside <span class="keyword">of</span> su(<span class="number">8</span>) you should always use <span class="keyword">the</span> -u option <span class="keyword">for</span> safety’s sake.  The <span class="keyword">first</span> form <span class="keyword">of</span> this command <span class="keyword">is</span> used <span class="keyword">to</span> install a new crontab <span class="keyword">from</span> <span class="keyword">some</span> named <span class="type">file</span> <span class="keyword">or</span> standard input  <span class="keyword">if</span>  <span class="keyword">the</span>  pseudo-filename  <span class="string">"-"</span>  <span class="keyword">is</span> <span class="keyword">given</span>.
**-l**     The current crontab will be displayed <span class="function_start"><span class="keyword">on</span></span> standard output.
**-r**     The current crontab will be removed.
**-e**     This  option  <span class="keyword">is</span> used <span class="keyword">to</span> edit <span class="keyword">the</span> current crontab using <span class="keyword">the</span> editor specified <span class="keyword">by</span> <span class="keyword">the</span> VISUAL <span class="keyword">or</span> EDITOR environment variables.  After you <span class="keyword">exit</span> <span class="keyword">from</span> <span class="keyword">the</span> editor, <span class="keyword">the</span> modified crontab will be installed automatically.
**-i**     This option modifies <span class="keyword">the</span> -r option <span class="keyword">to</span> prompt <span class="keyword">the</span> user <span class="keyword">for</span> a ’y/Y’ response <span class="keyword">before</span> actually removing <span class="keyword">the</span> crontab.
**-s**     It will append <span class="keyword">the</span> current SELinux security context <span class="type">string</span> <span class="keyword">as</span> an MLS_LEVEL setting <span class="keyword">to</span> <span class="keyword">the</span> crontab <span class="type">file</span> <span class="keyword">before</span> editing / replacement occurs - see <span class="keyword">the</span> doc-umentation <span class="keyword">of</span> MLS_LEVEL <span class="keyword">in</span> crontab(<span class="number">5</span>).
</code></pre></li>
<li>FILES<pre><code><span class="regexp">/etc/</span>cron.allow
<span class="regexp">/etc/</span>cron.deny
</code></pre></li>
</ul>
</blockquote>
<p>Shortly for this :<br>&gt;</p>
<ul>
<li>usage:<br>  crontab [-u user] file<br>  crontab [-u user] [ -e | -l | -r ]<pre><code>(<span class="keyword">default</span> operation <span class="keyword">is</span> <span class="built_in">replace</span>, per <span class="number">1003.2</span>)
</code></pre>  -e    (edit user’s crontab)<br>  -l    (list user’s crontab)<br>  -r    (delete user’s crontab)<br>  -i    (prompt before deleting user’s crontab)<br>  -s    (selinux context)</li>
</ul>
<p>The format of <code>-e</code> command is:<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  *    *    *    *    *   command</span><br><span class="line">minus <span class="built_in">hour</span> <span class="built_in">day</span> <span class="built_in">month</span> week command</span><br><span class="line"></span><br><span class="line">minus: <span class="number">1</span>~<span class="number">59</span> minus, * <span class="keyword">or</span> */<span class="number">1</span> <span class="keyword">for</span> per minus</span><br><span class="line"><span class="built_in">hour</span>: <span class="number">1</span>~<span class="number">23</span>, <span class="number">0</span> means <span class="number">0</span> o<span class="comment">'clock</span></span><br><span class="line"><span class="built_in">day</span>: <span class="number">1</span>~<span class="number">31</span></span><br><span class="line"><span class="built_in">month</span>: <span class="number">1</span>~<span class="number">12</span></span><br><span class="line">week: <span class="number">0</span>~<span class="number">6</span>, <span class="number">0</span> means sunday</span><br><span class="line">command: the command u want <span class="keyword">to</span> run</span><br></pre></td></tr></table></figure></p>
<h3 id="Examples">Examples</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># every night at <span class="number">21</span>:<span class="number">31</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每晚的<span class="number">21</span>:<span class="number">30</span></span></span><br><span class="line"><span class="number">30</span> <span class="number">21</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span> per month at <span class="number">4</span>:<span class="number">45</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每月<span class="number">1</span>、<span class="number">10</span>、<span class="number">22</span>日的<span class="number">4</span>:<span class="number">45</span></span></span><br><span class="line"><span class="number">45</span> <span class="number">4</span> <span class="number">1</span>,<span class="number">10</span>,<span class="number">22</span> * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday and sunday per week at <span class="number">1</span>:<span class="number">10</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每周六、周日的<span class="number">1</span>:<span class="number">10</span></span></span><br><span class="line"><span class="number">10</span> <span class="number">1</span> * * <span class="number">6</span>,<span class="number">0</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">18</span>:<span class="number">00</span> ~ <span class="number">23</span>:<span class="number">00</span> per <span class="number">30</span> minus everyday reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每天<span class="number">18</span>:<span class="number">00</span>至<span class="number">23</span>:<span class="number">00</span>之间每隔<span class="number">30</span>分钟</span></span><br><span class="line"><span class="number">0</span>,<span class="number">30</span> <span class="number">18</span>-<span class="number">23</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday per week at <span class="number">23</span>:<span class="number">00</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每星期六的<span class="number">23</span>:<span class="number">00</span></span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * <span class="number">6</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">23</span>:<span class="number">00</span> ~ <span class="number">7</span>:<span class="number">00</span> per hour</span></span><br><span class="line"><span class="preprocessor"># <span class="number">23</span>点到<span class="number">7</span>点之间，每隔一小时</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span>-<span class="number">7</span>/<span class="number">1</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per hour</span></span><br><span class="line"><span class="comment"># 每一小时</span></span><br><span class="line"><span class="keyword">*</span> <span class="keyword">*</span>/1 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">4</span> every month and monday to wednesday every week at <span class="number">11</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 每月的<span class="number">4</span>号与每周一到周三的<span class="number">11</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">11</span> <span class="number">4</span> * mon-wed /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span> january at <span class="number">4</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 一月一号的<span class="number">4</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span> <span class="number">1</span> jan * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per 30 minus</span></span><br><span class="line"><span class="comment"># 每半小时</span></span><br><span class="line"><span class="keyword">*</span>/30 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="Advanced_Usage">Advanced Usage</h3><p>For the files:</p>
<ul>
<li>/etc/cron.allow : list the user who can use crontab</li>
<li>/etc/cron.deny : list the user who cannot use crontab</li>
<li>/var/spool/cron : all users and their crontab will be store here</li>
<li>/var/log/cron : cron log per job</li>
<li>/etc/crontab : for system jobs, <code>crontab -e</code> is for current user</li>
<li>/etc/cron.d/* : seperated cron file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.d</span><br><span class="line"><span class="number">0</span>hourly  raid-check</span><br><span class="line"></span><br><span class="line">cat /etc/cron.d/<span class="number">0</span>hourly </span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"><span class="number">01</span> * * * * root run-parts /etc/cron.hourly</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.hourly/</span><br><span class="line"><span class="number">0</span>anacron</span><br><span class="line"></span><br><span class="line">cat /etc/cron.hourly/<span class="number">0</span>anacron </span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Skip excecution unless the date has changed from the previous run </span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -r /var/spool/anacron/cron.daily; <span class="keyword">then</span></span><br><span class="line">    day=`cat /var/spool/anacron/cron.daily`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `date +%Y%m%d` = <span class="string">"<span class="variable">$day</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip excecution unless AC powered</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -x /usr/bin/on_ac_power; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/on_ac_power &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> $? <span class="operator">-eq</span> <span class="number">1</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/usr/sbin/anacron <span class="operator">-s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/anacrontab </span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=<span class="number">45</span></span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=<span class="number">3</span>-<span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line"><span class="number">1</span>	<span class="number">5</span>	cron.daily		nice run-parts /etc/cron.daily</span><br><span class="line"><span class="number">7</span>	<span class="number">25</span>	cron.weekly		nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly <span class="number">45</span>	cron.monthly		nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">More Info</a>.</p>
<h2 id="Practice">Practice</h2><p>I want to backup my svn daily, so i must have a script to backup:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">cd</span> /home/svn/repos</span><br><span class="line">now=`/bin/date +%Y%m%d`</span><br><span class="line">/bin/tar czvf <span class="string">"kk_backup_<span class="variable">$now</span>.tar.gz"</span> kk/ &amp;&amp; rm -rf /home/svn/backup/* &amp;&amp; /bin/mv kk_backup_*.tar.gz /home/svn/backup/</span><br><span class="line"><span class="keyword">if</span> [ $? == <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">result=<span class="string">"backup svn OK!!"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">result=<span class="string">"backup svn False!!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$result</span></span><br></pre></td></tr></table></figure></p>
<p>then just give the script to <code>/etc/cron.daily</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp scripts/backup.sh /etc/cron.daily/svn_backup.sh</span><br><span class="line">chmod +x /etc/cron.daily/svn_backup.sh</span><br></pre></td></tr></table></figure></p>
<p>That’s all.</p>
<h1 id="REF">REF</h1><p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">鳥哥的 Linux 私房菜 — 第十五章、例行性工作排程(crontab)</a><br><a href="http://www.cnblogs.com/ccdc/archive/2012/06/01/2529471.html" target="_blank" rel="external">centos中crontab（计时器）用法详解 - 长城的草 - 博客园</a></p>
]]></content>
    <summary type="html">
    <![CDATA[The guide line about crontabs。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS6.5使用RSYNC发布程序]]></title>
    <link href="https://hwangjr.github.io/2015/10/24/CentOS6-5%E4%BD%BF%E7%94%A8RSYNC%E5%8F%91%E5%B8%83%E7%A8%8B%E5%BA%8F/"/>
    <id>https://hwangjr.github.io/2015/10/24/CentOS6-5使用RSYNC发布程序/</id>
    <published>2015-10-24T11:53:51.000Z</published>
    <updated>2015-10-24T11:54:25.895Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>Rsync（remote synchronize）是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件，也可以使用 Rsync 同步本地硬盘中的不同目录。</p>
<blockquote>
<p>rsync is an <a href="http://www.opensource.org/" target="_blank" rel="external">open source</a> utility that provides fast incremental file transfer. rsync is freely available under the <a href="https://rsync.samba.org/GPL.html" target="_blank" rel="external">GNU General Public License</a> and is currently being maintained by <a href="http://opencoder.net/" target="_blank" rel="external">Wayne Davison</a>.<br>If you are running (1) an xattr-enabled rsync older than 3.0.2, (2) a writable rsync daemon older than 3.0.0, or (3) a version of rsync older than 2.6.6, please see the <a href="https://rsync.samba.org/security.html" target="_blank" rel="external">rsync security advisory page</a>.</p>
</blockquote>
<p>本次将使用此工具与SVN配合，通过SVN进行版本控制，上传代码之后，自动同步发布到线上。</p>
<h2 id="安装">安装</h2><p>查询现有版本并安装。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">rpm -qa | grep rsync</span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">rpm <span class="operator">-e</span> rsync</span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget http://pkgs.repoforge.org/rsync/rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">rpm -ivh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 直接升级</span></span><br><span class="line">rpm -Uvh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>自然，你可以通过<code>yum</code>安装，不过版本较低：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">9</span>.el6_4.<span class="number">1</span> will be updated</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">12</span>.el6 will be an update</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br></pre></td></tr></table></figure></p>
<h2 id="配置">配置</h2><h3 id="初始配置">初始配置</h3><ul>
<li>选择rsync服务器启动方式：<ol>
<li>rsync服务器负载较高，则使用独立启动模式</li>
<li>rsync服务器负载较低，使用xinetd运行方式</li>
</ol>
</li>
<li>创建配置文件rsyncd.conf</li>
<li>对于非匿名方式访问的rsync服务器创建配置口令（建议配置需要口令访问）<br>CentOS 默认以xinetd模式运行rsync，rsync的xinetd配置文件是/etc/xinetd.d/rsync<br>如果配置rsync以xinetd模式运行，执行如下命令<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rsync on</span><br><span class="line">service xinetd restart</span><br><span class="line"><span class="preprocessor"># 如果执行 service xinetd restart 发现 xinetd: unrecognized service 则未安装xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 执行 yum install xinetd 安装 xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 安装之后启动 xinetd服务(service xinetd start)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>编辑rsync的xinetd配置文件/etc/xinetd.d/rsync文件，修改参数 server_args = —daemon —config=/etc/rsyncd/rsyncd.conf 可以配置rsync服务器启动时的参数</p>
<p>如果使用独立运行模式，则执行如下命令<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/rsync <span class="comment">--daemon</span></span><br><span class="line">#编辑 /etc/rc.<span class="keyword">local</span>文件 加入 /usr/bin/rsync <span class="comment">--daemon 保证每次开机启动都会自动启动rsync服务</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置设置">配置设置</h3><p>创建配置目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建rsync服务目录</span></span><br><span class="line">mkdir /etc/rsyncd</span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.conf</span><br><span class="line"><span class="comment"># 创建密码文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="comment">#权限修改</span></span><br><span class="line">chown root:root /etc/rsyncd/rsyncd.passwd</span><br><span class="line">chmod <span class="number">600</span> /etc/rsyncd/rsyncd.passwd</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root                         </span><br><span class="line">gid = root                                  </span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span>                      </span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid             </span><br><span class="line"></span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line">#<span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span>           </span><br><span class="line"></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd        </span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"></span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[hwangjrhome]</span><br><span class="line"><span class="keyword">path</span> = /home/hwangjr/</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = hwangjr</span><br><span class="line"><span class="keyword">comment</span> = HwangJR home</span><br><span class="line"><span class="keyword">exclude</span> = important/</span><br><span class="line"></span><br><span class="line">[chinatmp]</span><br><span class="line"><span class="keyword">path</span> = /tmp/china/</span><br><span class="line"><span class="keyword">list</span>=<span class="keyword">no</span></span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = china</span><br><span class="line"><span class="keyword">comment</span> = tmp china</span></span><br></pre></td></tr></table></figure></p>
<p>密码文件：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">hwangjr:</span>asdf             <span class="preprocessor">#格式   用户名:口令</span></span><br><span class="line"><span class="label">china:</span>jk               <span class="preprocessor">#该用户不要求是系统用户</span></span><br></pre></td></tr></table></figure></p>
<p>查看服务是否启动：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an <span class="string">| grep 873</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自动同步">自动同步</h3><p>编辑crontab<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure></p>
<p>加入同步命令：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 每天<span class="number">0</span>点<span class="number">10</span>分执行后面的命令</span></span><br><span class="line"><span class="number">10</span> <span class="number">0</span> * * * rsync -avzP  --<span class="keyword">delete</span>  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端配置">客户端配置</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 安装客户端</span></span><br><span class="line">yum -y install rsync</span><br><span class="line"><span class="preprocessor"># 同步命令</span></span><br><span class="line"><span class="preprocessor"># -a 参数，相当于-rlptgoD</span></span><br><span class="line"><span class="preprocessor">#   -r 是递归 -l 是链接文件，意思是拷贝链接文件；-p 表示保持文件原有权限</span></span><br><span class="line"><span class="preprocessor">#   -t 保持文件原有时间；-g 保持文#件原有用户组；-o 保持文件原有属主；-D 相当于块设备文件</span></span><br><span class="line"><span class="preprocessor"># -z 传输时压缩；</span></span><br><span class="line"><span class="preprocessor"># -P 传输进度；</span></span><br><span class="line"><span class="preprocessor"># -v 传输时的进度等信息，和-P有点关系，自己试试。可以看文档；</span></span><br><span class="line"><span class="preprocessor"># 同步</span></span><br><span class="line">rsync -avzP hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 客户端数据和服务器端数据保持一致</span></span><br><span class="line"><span class="preprocessor"># –delete 选项，表示客户端上的数据要与服务器端完全一致，如果 /tmp/hwangjr/目录中有服务器上不存在的文件，则删除。最终目的是让/tmp/hwangjr/目录上的数据完全与服务器上保持一致；用的时候要小心点，最好不要把已经有重要数所据的目录，当做本地更新目录，否则会把你的数据全部删除</span></span><br><span class="line">rsync -avzP  --delete hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 指定传输时候的密码文件，密码文件权限 600</span></span><br><span class="line"><span class="preprocessor"># –password-file=rsync.password ，这时当我们以hwangjr用户登录rsync服务器同步数据时，密码将读取 /tmp/rsync.password 这个文件。这个文件内容只是hwangjr用户的密码。我们要如下做；</span></span><br><span class="line"><span class="preprocessor"># touch /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># chmod 600 /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># echo "asdf"&gt; /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@172.16.1.135::hwangjrhome  /tmp/hwangjr/</span></span><br><span class="line"><span class="preprocessor"># 注： 这样就不需要密码了，服务器通过crond 计划任务自动同步</span></span><br><span class="line">rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure>
<h3 id="配置语法">配置语法</h3><blockquote>
<ul>
<li><strong>模块</strong>：<br>  以[模块名称]开始</li>
<li><strong>参数配置行</strong>：<br>  格式 name = value<br>  其中 value的值可以是string(可以不使用引号)或者boolean(0/1,true/false,yes/no)</li>
<li><strong>以#开始是注释行</strong></li>
<li><strong>以\是续行符</strong></li>
</ul>
</blockquote>
<ol>
<li><p>全局参数（[模块名称]之外的配置均为全局配置）<br><strong>address</strong><br>在独立运行时，用于指定的服务器运行的 IP 地址。由 xinetd 运行时将忽略此参数，使用命令行上的 –address 选项替代<br>默认值 本地所有IP<br><strong>port</strong><br>指定 rsync 守护进程监听的端口号。 由 xinetd 运行时将忽略此参数，使用命令行上的–port 选项替代。<br>默认值是 873<br><strong>motd file</strong><br>指定一个消息文件，当客户连接服务器时该文件的内容显示给客户。<br>默认值无<br><strong>pid file</strong><br>rsync 的守护进程将其 PID 写入指定的文件。<br>默认值 无<br><strong>log file</strong><br>指定 rsync 守护进程的日志文件，而不将日志发送给 syslog。<br>默认值 无<br><strong>syslog facility</strong><br>指定 rsync 发送日志消息给 syslog 时的消息级别<br>默认值 daemon<br><strong>socket options</strong><br>指定自定义 TCP 选项。<br>默认值无</p>
</li>
<li><p>模块参数<br>模块参数主要用于定义 rsync 服务器哪个目录要被同步。模块声明的格式必须为 [module] 形式，这个名字就是在 rsync 客户端看到的名字，类似于 Samba 服务器提供的共享名。而服务器真正同步的数据是通过 path 来指定的。可以根据自己的需要，来指定多个模块，模块中可以定义以下参数：</p>
</li>
</ol>
<ul>
<li>基本模块参数<br><strong>path</strong><br>指定当前模块在 rsync 服务器上的同步路径，该参数是必须指定的<br><strong>comment</strong><br>给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户<br>模块控制参数<br><strong>use chroot</strong><br>若为 true，则 rsync 在传输文件之前首先 chroot 到 path 参数所指定的目录下。这样做的原因是实现额外的安全防护，但是缺点是需要 root 权限，并且不能备份指向 path 外部的符号连接所指向的目录文件。<br>默认值true<br><strong>uid</strong><br>指定该模块以指定的 UID 传输文件。<br>默认值 nobody<br><strong>gid</strong><br>指定该模块以指定的 GID 传输文件。<br>默认值 nobody<br><strong>max connections</strong><br>定该模块的最大并发连接数量以保护服务器，超过限制的连接请求将被告知随后再试。<br>默认值 0 不限制<br><strong>read only</strong><br>指定是否允许客户上传文件。若为 true 则不允许上传；若为 false 并且服务器目录也具有读写权限则允许上传。<br>默认值 true<br><strong>write only</strong><br>指定是否允许客户下载文件。若为 true 则不允许下载；若为 false 并且服务器目录也具有读权限则允许下载。<br>默认值 false<br>模块认证参数<br><strong>hosts allow</strong><br>用一个主机列表指定哪些主机客户允许连接该模块。不匹配主机列表的主机将被拒绝<br>默认值 <em><br><strong>hosts deny</strong><br>用一个主机列表指定哪些主机客户不允许连接该模块。<br>默认值 空<br><strong>auth users</strong><br>指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块。这里的用户和系统用户没有任何关系。用户名和口令以明文方式存放在 secrets file 参数指定的文件中<br>默认匿名<br><strong>secrets file</strong><br>指定一个 rsync 认证口令文件。只有在 auth users 被定义时，该文件才起作用。<br>默认值 空<br><em>*strict modes</em></em><br>指定是否监测口令文件的权限。若为 true 则口令文件只能被 rsync 服务器运行身份的用户访问，其他任何用户不可以访问该文件。<br>默认值 true</li>
</ul>
<p>其中客户主机列表定义可以是以下形式：</p>
<blockquote>
<p>单个IP地址 例如：192.168.0.1<br>整个网段 例如：192.168.0.0/24，192.168.0.0/255.255.255.0<br>可解析的单个主机名 例如：centos，centos.bsmart.cn<br>域内的所有主机 例如：.bsmart.cn<br>“”则表示所有。<br>多个列表项要用空格间隔。</p>
</blockquote>
<p>而认证口令则：</p>
<blockquote>
<p>rsync 认证口令文件的权限一定是 600，否则客户端将不能连接服务器。<br>rsync 认证口令文件中每一行指定一个 用户名:口令 对，格式为：username:passwd<br>一般来说口令最好不要超过8个字符。若您只配置匿名访问的 rsync 服务器，则无需设置上述参数。</p>
</blockquote>
<h2 id="SVN同步实例">SVN同步实例</h2><p>基本思路就是，当发生commit时，触发服务端svn数据目录update，也触发rsync去同步网站目录。</p>
<h3 id="服务器配置文件">服务器配置文件</h3><p>编辑配置文件：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/rsyncd/rsyncd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<p>配置文件为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid</span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd</span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[kksvn]</span><br><span class="line"><span class="keyword">path</span> = /home/svn/rsyncd/kk</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = kksvn</span><br><span class="line"><span class="keyword">comment</span> = KK SVN</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>use chroot=no 时，同步后DES的文件主或组如果有，则显示名，即使ID不一样；<br>use chroot=yes时，如果两台机器同名的ID不同，则服务端只会显示SRC的ID，造成权限问题。</p>
</blockquote>
<p>编辑rsync的用户认证配置文件<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /etc/rsyncd/rsyncd.passwd</span></span><br><span class="line">kksvn:kksvn</span><br><span class="line"><span class="preprocessor">#chmod 600 /etc/rsyncd/rsyncd.passwd</span></span><br></pre></td></tr></table></figure></p>
<p>启动服务：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/rsync --daemon --config=/</span>etc<span class="regexp">/rsyncd/</span>rsyncd.conf</span><br><span class="line">echo <span class="string">"/usr/bin/rsync --daemon"</span> &gt;&gt;<span class="regexp">/etc/</span>rc.local</span><br></pre></td></tr></table></figure></p>
<p>注：修改配置文件和用户密码不需要重启服务</p>
<h3 id="客户端测试">客户端测试</h3><p>客户端测试：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line">kksvn</span><br><span class="line"><span class="preprocessor"># chmod <span class="number">600</span> /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line"><span class="preprocessor"># rsync -avzp --progress --delete --exclude=.svn --password-file=/home/svn/rsyncd/conf/rsyncd.passwd kksvn@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>::kksvn /tmp/kk</span></span><br></pre></td></tr></table></figure></p>
<h3 id="SVN配置">SVN配置</h3><p>配置钩子：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br><span class="line">chmod +x <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br></pre></td></tr></table></figure></p>
<p>post-commit内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=zh_CN.UTF-<span class="number">8</span></span><br><span class="line">/usr/bin/svn update /home/svn/rsyncd/kke</span><br><span class="line"><span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    /bin/bash /home/svn/rsyncd/scripts/kke_rsync.sh &gt; /dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>kke_rsync.sh内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"></span><br><span class="line">IP=<span class="string">"127.0.0.1"</span></span><br><span class="line">Auth_module=<span class="string">"kksvn"</span></span><br><span class="line">Localdir=<span class="string">"/tmp/kk"</span></span><br><span class="line">Auth_user=<span class="string">"kksvn"</span></span><br><span class="line">Passwd_file=<span class="string">"/home/svn/rsyncd/conf/rsyncd.passwd"</span></span><br><span class="line">Exc=<span class="string">" --exclude=.svn"</span></span><br><span class="line">/usr/bin/rsync -vrtopgl --progress --delete <span class="variable">$&#123;Exc&#125;</span> --password-file=<span class="variable">$&#123;Passwd_file&#125;</span> <span class="variable">$Auth_user</span>@<span class="variable">$&#123;IP&#125;</span>::<span class="variable">$&#123;Auth_module&#125;</span> <span class="variable">$&#123;Localdir&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="拓展">拓展</h2><h3 id="通过exclude排除多个文件/目录">通过exclude排除多个文件/目录</h3><p>使用rsync -av –exclude=.svn /home/hwangjr/t1 /home/hwangjr/t2 只能排除.svn文件/目录。但如果要排除多个文件/目录，就需要新建个exclude.list，然后rsync -av –exclude-from=”exclude.list”指定不需要同步的文件/目录。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将/home/hwangjr/t1目录拷贝到/home/hwangjr/t2目录下，/home/hwangjr/exclude.list中指定文件不拷贝</span></span><br><span class="line">rsync -av --exclude-from=<span class="regexp">/home/hwangjr</span><span class="regexp">/exclude.list /home</span><span class="regexp">/hwangjr/t</span>1 /home/hwangjr/t2</span><br></pre></td></tr></table></figure></p>
<p>exclude.list里面填写要排除的文件/目录，一行一个，直接写文件名即可。如果要排除a,b.1,b.2,tmp/g，那么exclude.list里就应该写：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">a</span></span><br><span class="line"><span class="regexp">b.*</span></span><br><span class="line">tmp/g</span><br></pre></td></tr></table></figure></p>
<p>不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>也不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>SO：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">–<span class="keyword">exclude</span>=PATTERN <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">exclude</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">exclude</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br><span class="line">–<span class="keyword">include</span>=PATTERN don’t <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">include</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">include</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br></pre></td></tr></table></figure></p>
<h2 id="REF">REF</h2><p><a href="https://download.samba.org/pub/rsync/src/" target="_blank" rel="external">Index of /pub/rsync/src</a><br><a href="https://rsync.samba.org/" target="_blank" rel="external">rsync</a><br><a href="http://pkgs.repoforge.org/rsync/" target="_blank" rel="external">Index of /rsync</a><br><a href="http://segmentfault.com/a/1190000002502991" target="_blank" rel="external">CentOS 6.5下rsync服务器安装配置 - SegmentFault</a><br><a href="http://my.oschina.net/duguaoxue/blog/496228" target="_blank" rel="external">CentOS 6.3下rsync服务器的安装与配置 - longjian的个人页面 - 开源中国社区</a><br><a href="http://wjw7702.blog.51cto.com/5210820/1148808" target="_blank" rel="external">Rsync常见错误及命令详细参数 - 彼岸 - 51CTO技术博客</a><br><a href="http://sndapk.blog.51cto.com/5385144/1360384" target="_blank" rel="external">svn+rsync实时发布程序 - notepad - 51CTO技术博客</a><br><a href="http://www.ttlsa.com/svn/linux-svn-rsync-inotify/" target="_blank" rel="external">linux下svn+rsync+inotify实现代码自动同步 - 运维生存时间</a></p>
]]></content>
    <summary type="html">
    <![CDATA[配置SVN版本控制之后，需要实时发布代码到线上，人懒，故有了此工具。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[阿里CentOS 6 iptables配置]]></title>
    <link href="https://hwangjr.github.io/2015/10/23/%E9%98%BF%E9%87%8CCentOS-6-iptables%E9%85%8D%E7%BD%AE/"/>
    <id>https://hwangjr.github.io/2015/10/23/阿里CentOS-6-iptables配置/</id>
    <published>2015-10-23T10:31:08.000Z</published>
    <updated>2015-10-23T10:31:31.333Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>就是，配置防火墙，防止被鲁。</p>
<p>iptables的命令格式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] <span class="built_in">command</span> [chain] [rules] [-j target]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>[-t table] ：用来指明使用的表， 有三种选项: filter, nat 和 mangle，如果未指定，则使用filter作为缺省表。 事实上，对于单个服务器的防火墙配置，一般来讲，我们只需要对filter表进行配件就OK了。filter表包括 INPUT, OUTPUT,和FORWARD三个chain.</p>
</li>
<li><p>command 表明iptables命名要做什么，比如</p>
</li>
<li><p>-A （–append): 该命令会把一条规则附件到chain的末尾。</p>
</li>
<li><p>-D（–delete)用来删除某个规则。</p>
</li>
<li><p>-F （–flush) 如果指定了chain, 删除该chain中的所有规则，如果未指定chain, 则删除所有chain中的所有规则。</p>
</li>
<li><p>target: 是由规则指定的操作。 包括下面几种：</p>
</li>
<li><p>ACCEPT: 接收信息包(允许它前往目的地），并且将停止遍历chain.</p>
</li>
<li><p>DROP：  拒绝，</p>
</li>
</ul>
<p>此外还有REJECT, RETURN, LOG, REDIRECT, MARK, MIRROR, MAQUERADE等。</p>
<p>具体的iptables的语法和概念就不再多说了，请参照<a href="http://linux.die.net/man/8/iptables" target="_blank" rel="external">iptables man page</a>官方文档 .</p>
<p>简单来说，iptables防火墙是由一系列的规则(rule)组成，  一个数据请求进来， 会依次和这些规则进行比较，如果正好符合规则的定义，那这个数据请求要么会被接收ACCEPT，要么被拒绝DRIP。如果不符合任何规则的定义，最后缺省的规则会被应用。</p>
<h2 id="配置">配置</h2><p>SSH的端口22自然是需要开放的，否则我们就无法登录服务器了。CentOS的VPS经常作为用LAMP搭建的Web服务器，FTP服务器， Mail服务器等。</p>
<ul>
<li><p>对于Web服务来说，需要开放80端口，如果是HTTPS/SSL协议的话，还需用开放443端口。</p>
</li>
<li><p>对于Mail服务来说，由于涉及SMTP, POP3, IMAP协议，需要开放的端口：SMTP : 25   Secure SMTP:465  POP3: 110   Secure POP3: 995   IMAP: 143   IMAP over SSL: 993。</p>
</li>
<li><p>对于FTP服务来说，需要开放 20, 21两个端口。</p>
</li>
</ul>
<h3 id="屏蔽常见攻击">屏蔽常见攻击</h3><p>缺省情况下，CentOS的iptables的设置是允许任何数据通过的。我们首先要清空iptables中的所有的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure></p>
<p>然后我们加上阻止简单扫描和攻击的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP             <span class="comment">#NONE 包(所有标识bit都没有设置)主要是扫描类的数据包</span></span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP     <span class="comment">#防止sync-flood 攻击</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP              <span class="comment">#ALL包（所有的标注bit都被设置了）也是网络扫描的数据包</span></span><br></pre></td></tr></table></figure></p>
<p>关于sync-flood, 请参照<a href="http://en.wikipedia.org/wiki/SYN_flood" target="_blank" rel="external">wikipedia</a>的解释。</p>
<h3 id="相应服务开放端口">相应服务开放端口</h3><p>首先我们应该接受本机localhost的任何请求，否则，数据库连接等将无法工作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>对于不同的服务需要开放不同的端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT      <span class="comment"># SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT      <span class="comment"># HTTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">443</span> -j ACCEPT     <span class="comment">#HTTPS</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">25</span> -j ACCEPT   <span class="comment">#SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">465</span>  -j ACCEPT <span class="comment">#Secure SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">110</span> -j ACCEPT   <span class="comment">#POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">995</span> -j ACCEPT   <span class="comment">#Secure POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">143</span> -j ACCEPT   <span class="comment">#IMAP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">993</span> -j ACCEPT   <span class="comment">#Secure IMAP</span></span><br></pre></td></tr></table></figure></p>
<h3 id="通用规则">通用规则</h3><p>首先要允许所有从服务器端发起的连接，由此返回的响应数据应该是允许的！比如VPS发起的yum update , 必须要允许外部的update数据进来：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -m <span class="keyword">state</span>  --state ESTABLISHED, RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>最后，设置缺省的策略：屏蔽任何进入的数据请求，允许所有从Server发出的请求<br><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -<span class="keyword">P</span> OUTPUT <span class="keyword">ACC</span>EPT</span><br><span class="line">iptables -<span class="keyword">P</span> INPUT DROP</span><br></pre></td></tr></table></figure></p>
<h3 id="保存设置">保存设置</h3><p>首先通过下面的命令查看一下我们的设置是否正确！<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptable -<span class="keyword">L</span> -<span class="keyword">n</span></span><br></pre></td></tr></table></figure></p>
<p>确认没有问题后，执行下面的命令<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables <span class="keyword">save</span></span><br></pre></td></tr></table></figure></p>
<p>执行上述命令后，相应的规则会写入 /etc/sysconfig/iptables这个文件，你可以检查一下看看。</p>
<p>最后执行<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">service</span> iptables restart</span><br></pre></td></tr></table></figure></p>
<p>重新启动iptables防火墙，以使上述设置生效。</p>
<h3 id="自动化">自动化</h3><p>为了更方便的修改和维护自己的iptables的设置，我一般是把所有的iptables的设置先写到一个单独文件中，测试没有问题后。然后再保存到iptable的配置文件中。</p>
<p>放大招，sh配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># A simple iptables firewall configuration</span></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin; <span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#flush/erase original rules</span></span><br><span class="line">iptables -F <span class="comment">#清除所有已制定的rule</span></span><br><span class="line">iptables -X <span class="comment">#清除用户自定义的chain/table</span></span><br><span class="line">iptables -Z <span class="comment">#将所有的chain的计数和流量统计归零</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept localhost connetting, no matter what it is</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept any response package which is initiated from inside</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#block most common network attacks(recon packets and syn-flood attack)</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#open ports for different services</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT <span class="comment">#SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT <span class="comment">#HTTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 443 -j ACCEPT #HTTPS</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 25 -j ACCEPT #SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 465 -j ACCEPT #Secure SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 110 -j ACCEPT #POP3</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 995 -j ACCEPT #Secure POP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ICMP configuration</span></span><br><span class="line"><span class="comment">#To prevent ICMP DDOS,we do not allow ICMP type 8(echo-request) or limit this request with 1/second</span></span><br><span class="line"><span class="comment">#some ICMP requests are allowed.</span></span><br><span class="line">icmp_<span class="built_in">type</span>=<span class="string">"0 3 4 11 12 14 16 18"</span></span><br><span class="line"><span class="keyword">for</span> ticmp <span class="keyword">in</span> <span class="variable">$icmp_type</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    iptables -A INPUT -p icmp --icmp-type <span class="variable">$ticmp</span> -j ACCEPT</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 1/second -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#default policies</span></span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#save to /etc/sysconfig/iptables</span></span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<h2 id="常用命令">常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables</span><br><span class="line"><span class="comment"># 检测状态</span></span><br><span class="line">service iptables status</span><br><span class="line">service iptables start</span><br><span class="line"><span class="comment"># 查看当前配置</span></span><br><span class="line">iptables -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受一切请求</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空默认所有规则</span></span><br><span class="line">iptables -F</span><br><span class="line"><span class="comment"># 清空自定义所有规则</span></span><br><span class="line">iptables -X</span><br><span class="line"><span class="comment"># 清除计数器</span></span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line">service iptables save</span><br><span class="line">chkconfig iptables on</span><br></pre></td></tr></table></figure>
<h2 id="REF">REF</h2><p><a href="http://www.androiddev.net/centos-6-iptables-firewall/" target="_blank" rel="external">为CentOS 6设置IPTables防火墙 | 码农日记</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在CentOS 6.5服务器上配置iptables。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Gradle查询/排除依赖]]></title>
    <link href="https://hwangjr.github.io/2015/10/23/Gradle%E6%9F%A5%E8%AF%A2-%E6%8E%92%E9%99%A4%E4%BE%9D%E8%B5%96/"/>
    <id>https://hwangjr.github.io/2015/10/23/Gradle查询-排除依赖/</id>
    <published>2015-10-23T10:29:58.000Z</published>
    <updated>2015-10-23T10:30:16.389Z</updated>
    <content type="html"><![CDATA[<p>使用Gradle编译项目时，可使用此排查依赖包冲突。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看项目库依赖</span></span><br><span class="line">gradle -q dependencies plugin_framework:dependencies —configuration compile</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[在使用Gradle编译项目时，时常遇到引用包冲突，可用此方法来进行排除。]]>
    
    </summary>
    
      <category term="Android" scheme="https://hwangjr.github.io/tags/Android/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Android" scheme="https://hwangjr.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS6.5 配置Subversion]]></title>
    <link href="https://hwangjr.github.io/2015/10/23/CentOS6-5-%E9%85%8D%E7%BD%AESubversion/"/>
    <id>https://hwangjr.github.io/2015/10/23/CentOS6-5-配置Subversion/</id>
    <published>2015-10-23T10:28:24.000Z</published>
    <updated>2015-10-23T10:28:49.357Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>需要部署Subversion进行版本控制，团队习惯用Subversion，自然Git也有部署，后续慢慢切入。<br>不基于Apache，也就是http无法访问，只通过svn访问。<br>不源码编译，版本兼容会有问题。</p>
<blockquote>
<p>Subversion目录说明：<br><em>dav目录：是提供apache与mod_dav_svn使用的目录，让他们存储内部数据
</em>db目录：就是所有版本控制的数据存放文件<br><em>hooks目录：放置hook脚本文件的目录
</em>locks目录：用来放置subversion锁定数据的目录，追踪存取文件库的客户端<br><em>format文件：是一个文本文件，里面只放了一个整数。表示当前文件库配置的版本号
</em>conf目录：是这个仓库的配置文件（仓库的用户访问账号、权限等）</p>
</blockquote>
<h2 id="安装">安装</h2><p>查询是否已经有安装，并查询安装信息：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询是否安装及版本</span></span><br><span class="line">rpm -qa subversion</span><br><span class="line"><span class="comment"># 移除</span></span><br><span class="line">yum remove subversion</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install subversion</span><br><span class="line"><span class="comment"># 查询安装目录</span></span><br><span class="line">rpm -ql subversion</span><br></pre></td></tr></table></figure></p>
<h2 id="基本配置">基本配置</h2><p>本次配置将针对多个版本库，其访问统一为：<code>svn://ip/project1</code>，可在下面分别创建多个库。</p>
<h3 id="创建svn库并初始化">创建svn库并初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建版本库路径</span></span><br><span class="line">mkdir -p /home/svn/repos/project1</span><br><span class="line"><span class="comment"># 新建一个版本仓库</span></span><br><span class="line">svnadmin create /home/svn/repos/project1</span><br><span class="line"><span class="comment"># 初始化版本库中目录</span></span><br><span class="line">mkdir project project/server project/server/branches project/server/tags project/server/trunk project/android project/android/branches project/android/tags project/android/trunk project/ios project/ios/branches project/ios/tags project/ios/trunk</span><br><span class="line">svn import project/ file:///home/svn/repos/project1 -m <span class="string">'init svn folder'</span></span><br><span class="line"><span class="comment"># 可删除临时创建文件，或者保留以后创建其他版本库继续使用</span></span><br><span class="line">rm -rf project</span><br><span class="line"><span class="comment"># 保留以后继续使用</span></span><br><span class="line">mv project /home/svn/projectTemp</span><br></pre></td></tr></table></figure>
<p>其中project目录为：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">project</span>/</span><br><span class="line">├── <span class="keyword">android</span><br><span class="line"></span>│   ├── <span class="keyword">branches</span><br><span class="line"></span>│   ├── tags</span><br><span class="line">│   └── trunk</span><br><span class="line">├── ios</span><br><span class="line">│   ├── <span class="keyword">branches</span><br><span class="line"></span>│   ├── tags</span><br><span class="line">│   └── trunk</span><br><span class="line">└── server</span><br><span class="line">    ├── <span class="keyword">branches</span><br><span class="line"></span>    ├── tags</span><br><span class="line">    └── trunk</span><br></pre></td></tr></table></figure></p>
<p><code>/home/svn/repos</code>目录为：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/home/svn/repos/</span><br><span class="line">└── project1</span><br><span class="line">    ├── <span class="keyword">conf</span></span><br><span class="line">    ├── <span class="keyword">db</span></span><br><span class="line">    ├── <span class="keyword">format</span></span><br><span class="line">    ├── hooks</span><br><span class="line">    ├── locks</span><br><span class="line">    └── README.txt</span><br></pre></td></tr></table></figure></p>
<h3 id="配置svn">配置svn</h3><p>版本库用户统一管理，故这里会直接在<code>/home/svn</code>目录创建<code>conf</code>文件并保存其配置。<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="keyword">mkdir</span> /home/svn/conf</span><br></pre></td></tr></table></figure></p>
<h4 id="配置用户">配置用户</h4><p>移动用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /home/svn/repos/project1/conf/passwd /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/passwd</span><br></pre></td></tr></table></figure></p>
<p>修改里面用户，格式<code>username = passwd</code>的条目即可。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[users]</span></span><br><span class="line"><span class="setting">hwangjr = <span class="value">hwangjr</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="修改访问策略">修改访问策略</h4><p>移动用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /home/svn/repos/project1/conf/authz /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/authz</span><br></pre></td></tr></table></figure></p>
<p>修改里面配置，<code>groups</code>为定义用户群组，其他为配置访问权限，<strong>需要注意是<code>* =</code>表示除了上面配置的用户组之外，任何人都被禁止访问本目录，此必须加上</strong>。<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[groups]</span></span><br><span class="line">dev = hwangjr</span><br><span class="line"></span><br><span class="line"><span class="string">[project1:/]</span></span><br><span class="line">@dev = rw</span><br><span class="line">* =</span><br></pre></td></tr></table></figure></p>
<h4 id="修改svnserve，让配置生效">修改svnserve，让配置生效</h4><p>拷贝用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /home/svn/repos/project1/conf/svnserve.conf /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/svnserve.conf</span><br></pre></td></tr></table></figure></p>
<p>修改里面配置。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[general]</span><br><span class="line">anon-access = none</span><br><span class="line">auth-access = <span class="keyword">write</span></span><br><span class="line">password-db = <span class="regexp">/home/</span>svn<span class="regexp">/conf/</span>passwd</span><br><span class="line">authz-db = <span class="regexp">/home/</span>svn<span class="regexp">/conf/</span>authz</span><br></pre></td></tr></table></figure></p>
<h4 id="启动/停止svn">启动/停止svn</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">svnserve <span class="operator">-d</span> -r /home/svn/repos</span><br><span class="line"><span class="comment"># 指定port</span></span><br><span class="line">svnserve <span class="operator">-d</span> -r /home/svn/repos --listen-port <span class="number">3391</span></span><br><span class="line"><span class="comment"># 停止svn</span></span><br><span class="line">killall svnserve</span><br><span class="line"><span class="comment"># ps</span></span><br><span class="line">ps -ef | grep svnserve</span><br><span class="line"><span class="built_in">kill</span> -<span class="number">9</span> pid</span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -tlnp | grep svn</span><br></pre></td></tr></table></figure>
<h3 id="测试访问">测试访问</h3><p>本地测试即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn co svn://<span class="number">127.0</span>.<span class="number">0.1</span>/project1 --username hwangjr --password hwangjr</span><br></pre></td></tr></table></figure></p>
<h3 id="新增一个版本库">新增一个版本库</h3><p>本次配置可管理多个版本库，且用户共用，新增一个版本库很简单：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/svn/repos/project2</span><br><span class="line">svnadmin create /home/svn/repos/project2</span><br><span class="line">rm -rf /home/svn/repos/project2/conf/passwd /home/svn/repos/project2/conf/authz</span><br><span class="line">cp /home/svn/conf/svnserve.conf /home/svn/repos/project2/conf/</span><br></pre></td></tr></table></figure></p>
<p>此版本库已经新增完毕，如果需要初始化目录，则可采用上面方式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn import /home/svn/projectTemp/  file:///home/svn/repos/project2 -m <span class="string">'init svn folder'</span></span><br></pre></td></tr></table></figure></p>
<p>可编辑<code>/home/svn/conf/passwd</code>来新增/删除用户，可编辑<code>/home/svn/conf/authz</code>来控制权限。举个authz栗子：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[project1:/]</span><br><span class="line"><span class="comment">@dev = rw</span></span><br><span class="line"><span class="keyword">*</span> =</span><br><span class="line"></span><br><span class="line">[project2:/]</span><br><span class="line"><span class="comment">@dev = rw</span></span><br><span class="line"><span class="keyword">*</span> =</span><br></pre></td></tr></table></figure></p>
<h3 id="自启动">自启动</h3><p>通过服务来启动即可，编辑<code>vim /etc/init.d/svnserve</code>，修改OPTIONS为<code>-r /home/svn/repos</code>，片段为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### <span class="operator"><span class="keyword">END</span> INIT INFO</span><br><span class="line"></span><br><span class="line">OPTIONS=<span class="string">"-r /home/svn/repos"</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">Source</span> <span class="keyword">function</span> <span class="keyword">library</span>.</span><br><span class="line">. /etc/rc.<span class="keyword">d</span>/init.<span class="keyword">d</span>/functions</span></span><br></pre></td></tr></table></figure></p>
<p>设置服务自启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig svnserve on</span><br></pre></td></tr></table></figure></p>
<h3 id="防火墙">防火墙</h3><p>如果对防火墙有疑问，可以参考另一篇iptables，开放所需端口即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -tlnp | grep svn</span><br><span class="line"><span class="comment"># 开放端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">3690</span> -j ACCEPT <span class="comment"># SVN</span></span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<p>或者编辑配置文件：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -m tcp --dport <span class="number">3690</span> -j <span class="constant">ACCEPT</span></span><br><span class="line"></span>service iptables restart</span><br></pre></td></tr></table></figure></p>
<h2 id="常用配置">常用配置</h2><h3 id="强制提交写LOG">强制提交写LOG</h3><p>配置pre-comit文件，要求用户提交前必须写LOG。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/repos/project1/hooks</span><br><span class="line"><span class="keyword">vim</span> <span class="keyword">pre</span>-commit</span><br><span class="line">chmod +<span class="keyword">x</span> <span class="keyword">pre</span>-commit</span><br></pre></td></tr></table></figure></p>
<p>pre-commit文件内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">TXN=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">SVNLOOK=/usr/bin/svnlook</span><br><span class="line">LOGMSG=`<span class="variable">$SVNLOOK</span> <span class="built_in">log</span> -t <span class="string">"<span class="variable">$TXN</span>"</span> <span class="string">"<span class="variable">$REPOS</span>"</span> | grep <span class="string">"[a-zA-Z0-9]"</span> | wc -c`</span><br><span class="line"><span class="comment"># 5(要求的LOG长度，依实际需要修改)</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$LOGMSG</span>"</span> <span class="operator">-lt</span> <span class="number">5</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"\nEmpty log message not allowed. Commit aborted!"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span></span><br><span class="line"><span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<h3 id="可修改LOG">可修改LOG</h3><p>配置pre-revprop-change文件，此文件在show log中修改log时会运行，得到修改的权限，否则会报错：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DAV request failed; it’s possible that the repository’s pre-revprop-<span class="operator"><span class="keyword">change</span> hook either <span class="keyword">failed</span> <span class="keyword">or</span> <span class="keyword">is</span> non-existent. <span class="keyword">At</span> <span class="keyword">least</span> one property <span class="keyword">change</span> <span class="keyword">failed</span>;</span> repository is unchanged</span><br></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/repos/project1/hooks/</span><br><span class="line"><span class="keyword">vim</span> <span class="keyword">pre</span>-revprop-<span class="keyword">change</span></span><br><span class="line">chmod +<span class="keyword">x</span> <span class="keyword">pre</span>-revprop-<span class="keyword">change</span></span><br></pre></td></tr></table></figure>
<p>文件内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">USER=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">PROPNAME=<span class="string">"<span class="variable">$4</span>"</span></span><br><span class="line"><span class="keyword">if</span> [<span class="string">"<span class="variable">$PROPNAME</span>"</span> = <span class="string">"svn:log"</span>];<span class="keyword">then</span> <span class="built_in">exit</span> <span class="number">0</span>;<span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="HTTP服务器（未进行验证_）">HTTP服务器（未进行验证 ）</h2><h3 id="转换密码">转换密码</h3><p>HTTP不支持明文，Perl脚本来进行转化密码，脚本目录下会多一个<code>webpasswd</code>文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/svn/conf/</span><br><span class="line">vim ptopw.pl</span><br><span class="line">chmod +x ptopw.pl</span><br><span class="line">./ptopw.pl</span><br></pre></td></tr></table></figure></p>
<p>脚本内容：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> warnings;</span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"></span><br><span class="line"><span class="comment">#open the svn passwd file</span></span><br><span class="line"><span class="keyword">open</span> (FILE, <span class="string">"../conf/passwd"</span>) <span class="keyword">or</span> <span class="keyword">die</span> (<span class="string">"Cannot open the passwd file!!!\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the apache passwd file</span></span><br><span class="line"><span class="keyword">open</span> (OUT_FILE, <span class="string">"&gt;webpasswd"</span>) <span class="keyword">or</span> <span class="keyword">die</span> (<span class="string">"Cannot open the webpasswd file!!!\n"</span>);</span><br><span class="line"><span class="keyword">close</span> (OUT_FILE);</span><br><span class="line"></span><br><span class="line"><span class="comment">#begin</span></span><br><span class="line"><span class="keyword">foreach</span> (&lt;FILE&gt;) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_</span> =~ <span class="regexp">m/^[^#].*=/</span>) &#123;</span><br><span class="line"><span class="variable">$_</span> =~ <span class="regexp">s/=//</span>;</span><br><span class="line"><span class="string">`htpasswd -b webpasswd $_`</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改httpd配置">修改httpd配置</h3><p>编辑<code>/etc/httpd/conf/httpd.conf</code>，在末尾添加svn：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /repos&gt;</span><br><span class="line">DAV svn</span><br><span class="line">SVNPath /home/svn/repos/</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName <span class="string">"svn for repos"</span></span><br><span class="line">AuthUserFile /home/svn/conf/webpasswd</span><br><span class="line">AuthzSVNAccessFile /home/svn/conf/authz</span><br><span class="line">Satisfy all</span><br><span class="line">Require valid-user</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改权限">修改权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R apache.apache /home/svn/repos</span><br></pre></td></tr></table></figure>
<h3 id="重启服务">重启服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/httpd restart</span><br></pre></td></tr></table></figure>
<h3 id="测试">测试</h3><p>浏览器打开<code>http://ip/repos/server</code>测试。</p>
<h2 id="邮件提醒（未验证）">邮件提醒（未验证）</h2><ul>
<li><p>安装Perl模块Module::Build</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/D/DA/DAGOLDEN/Module-Build-0.36_11.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Module-Build-0.36_11.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Module-Build-0.36_11</span></span><br><span class="line"><span class="preprocessor"># perl Build.PL</span></span><br><span class="line"><span class="preprocessor"># ./Build</span></span><br><span class="line"><span class="preprocessor"># ./Build test</span></span><br><span class="line"><span class="preprocessor"># ./Build install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块Authen::SASL</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/G/GB/GBARR/Authen-SASL-2.15.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Authen-SASL-2.15.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Authen-SASL-2.15</span></span><br><span class="line"><span class="preprocessor"># perl Makefile.PL</span></span><br><span class="line"><span class="preprocessor"># make test</span></span><br><span class="line"><span class="preprocessor"># make install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块Net::SMTP_auth</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/A/AP/APLEINER/Net-SMTP_auth-0.08.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Net-SMTP_auth-0.08.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Net-SMTP_auth-0.08</span></span><br><span class="line"><span class="preprocessor"># perl Makefile.PL</span></span><br><span class="line"><span class="preprocessor"># make test</span></span><br><span class="line"><span class="preprocessor"># make install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块SVN::Notify</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/D/DW/DWHEELER/SVN-Notify-2.80.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf SVN-Notify-2.80.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd SVN-Notify-2.80</span></span><br><span class="line"><span class="preprocessor"># perl Build.PL</span></span><br><span class="line"><span class="preprocessor"># ./Build</span></span><br><span class="line"><span class="preprocessor"># ./Build test</span></span><br><span class="line"><span class="preprocessor"># ./Build install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动邮件服务器</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service sendmail restart</span></span><br><span class="line"><span class="keyword">Shutting</span> down sendmail:                                   <span class="sqbracket"> [FAILED]</span></span><br><span class="line"><span class="keyword">Starting</span> sendmail:                                        <span class="sqbracket"> [  OK  ]</span></span><br><span class="line"><span class="keyword">Starting</span> sm-client:                                       <span class="sqbracket"> [  OK  ]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置自动发邮件脚本<br>修改post-commit脚本，以支持邮件通知功能。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd /home/svn/repos/project1/hooks/</span></span><br><span class="line"><span class="preprocessor"># vim post-commit</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line">/usr/bin/svnnotify –repos-path “<span class="variable">$1</span>″ –revision “<span class="variable">$2</span>″ –to huangjianrong2010@gmail.com –from project1@svn.com –handler “HTML::ColorDiff”  –with-diff –smtp localhost –smtp-user root –smtp-pass passwd -c “UTF-<span class="number">8</span>″ -g zh_CN -o raw –svnlook /usr/bin/svnlook –subject-prefix ‘[SVN Update]‘</span><br></pre></td></tr></table></figure></p>
<p>to参数代表接收邮件的地址，可以有多个。from参数是虚拟的，代表你的发送地址，一般情况下，这个参数 不重要，但如果接收者的邮件服务器有反垃圾邮件的功能，需要判定源地址的话，这个参数是否合法就显得很重要了</p>
<p>再给该脚本添加可执行权限<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># chmod +x post-commit</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>再次提交时，就会给指定邮件地址发信了。ALL DONE！</li>
</ul>
<h2 id="备份管理">备份管理</h2><p>采用简单方式，定时备份仓库目录。</p>
<ul>
<li><p>新建备份目录</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /home/svn/backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写备份脚本</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/scripts</span><br><span class="line"><span class="keyword">vim</span> backup.<span class="keyword">sh</span></span><br><span class="line">chmod +<span class="keyword">x</span> backup.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>backup.sh内容：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cd /home/svn/repos</span><br><span class="line">now=`/bin/date +%Y%m%d`</span><br><span class="line">/bin/tar czvf <span class="string">"project_backup_$now.tar.gz"</span> project1/ &amp;&amp; rm -rf /home/svn/backup/* &amp;&amp; /bin/mv project_backup_*.tar.gz /home/svn/backup/</span><br><span class="line"><span class="keyword">if</span> [ $? == <span class="number">0</span> ]</span><br><span class="line">then</span><br><span class="line"><span class="literal">result</span>=”<span class="type">OK</span>!!”</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="literal">result</span>=”<span class="type">False</span>!!”</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment">#send mail to administrator</span></span><br><span class="line">/bin/mail mail@gmail.com -s “project_backup_$now” &lt;&lt;<span class="type">MESSAGE</span></span><br><span class="line"><span class="type">Result</span>: `/bin/echo $<span class="literal">result</span>`</span><br><span class="line"><span class="type">MESSAGE</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>设置每日执行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输入：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 每晚<span class="number">23</span>点备份</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * * /home/svn/scripts/backup.sh</span><br></pre></td></tr></table></figure></p>
<h2 id="svnstat分析svn数据（未验证）">svnstat分析svn数据（未验证）</h2><ul>
<li><p>安装JAVA</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x jre-xxx-rpm<span class="class">.bin</span></span><br><span class="line">./jre-xxx-rpm.bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载svnstat</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/iweb.dl.sourceforge.net/project</span><span class="regexp">/svnstat/svnstat</span><span class="regexp">/Release-1.1-beta/</span><span class="constant">SvnStat</span>-<span class="number">1.1</span>-beta.zip</span><br><span class="line">unzip <span class="constant">SvnStat</span>-<span class="number">1.1</span>-beta.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn co <span class="string">svn:</span><span class="comment">//ip/project1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成数据</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pwd</span></span><br><span class="line"># /root</span><br><span class="line">svn <span class="keyword">log</span> project1 -v -xml -non-interactive &gt; project1.<span class="literal">log</span></span><br><span class="line"><span class="keyword">cd</span> SvnStat-1.1-beta</span><br><span class="line">java -classpath SvnStat-all.jar <span class="keyword">de</span>.agentlab.svnstat.SvnStat -jar SvnStat-all.jar -r /root/project.<span class="keyword">log</span> -<span class="keyword">d</span> /<span class="keyword">var</span>/www/html/</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<br>打开浏览器即可查看</p>
</li>
</ul>
<h2 id="statsvn分析svn数据（未验证）">statsvn分析svn数据（未验证）</h2><ul>
<li><p>下载statsvn</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//downloads.sourceforge.net/project/statsvn/statsvn/0.7.0/statsvn-0.7.0.zip?use_mirror=jaist</span></span><br><span class="line">unzip statsvn-<span class="number">0.7</span><span class="number">.0</span>.zip</span><br><span class="line">cd statsvn-<span class="number">0.7</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成statsvn数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/var/</span>www<span class="regexp">/html/</span>statsvn</span><br><span class="line">java -jar statsvn.jar -verbose -output-dir <span class="regexp">/var/</span>www<span class="regexp">/html/</span>statsvn<span class="regexp">/ /</span>root<span class="regexp">/project.log /</span>root<span class="regexp">/project</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<br>打开浏览器查看</p>
</li>
</ul>
<h2 id="配置codestriker（未验证）">配置codestriker（未验证）</h2><ul>
<li><p>依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -MCPAN <span class="operator">-e</span> <span class="string">'install "Template"'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http:<span class="comment">//downloads.sourceforge.net/project/codestriker/codestriker/1.9.10/codestriker-1.9.10.tar.gz?use_mirror=jaist&amp;ts=1279246587</span></span></span><br><span class="line"><span class="preprocessor"># mkdir /var/www/codestriker</span></span><br><span class="line"><span class="preprocessor"># cd /var/www/codestriker</span></span><br><span class="line"><span class="preprocessor"># tar xvf /path/codestriker-<span class="number">1.9</span><span class="number">.10</span>.tar.gz</span></span><br><span class="line"><span class="preprocessor"># chown -R apache.apache codestriker-<span class="number">1.9</span><span class="number">.10</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置数据库</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># service mysqld restart</span></span><br><span class="line"><span class="preprocessor"># mysql -uroot mysql</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>执行:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> codestrikerdb <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8;</span></span><br><span class="line"><span class="operator"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span>,<span class="keyword">UPDATE</span>,<span class="keyword">DELETE</span>,<span class="keyword">INDEX</span>,<span class="keyword">ALTER</span>,<span class="keyword">CREATE</span>,<span class="keyword">DROP</span>,<span class="keyword">REFERENCES</span> <span class="keyword">ON</span> codestrikerdb.* <span class="keyword">TO</span> codestriker@localhost <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> ‘cspasswd’;</span></span><br><span class="line"><span class="operator"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span></span><br><span class="line">quit</span><br></pre></td></tr></table></figure></p>
<ul>
<li>配置codestriker<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd codestriker-<span class="number">1.9</span><span class="number">.10</span>/</span></span><br><span class="line"><span class="preprocessor"># vim codestriker.conf</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意以下几点(详细可查看codestriker的安装文档)<br>a.数据库的用户名密码要配对<br>b.svn的数据仓库要配对，如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@valid</span>_repositories =</span><br><span class="line">(</span><br><span class="line"><span class="symbol">'svn</span>:file:<span class="comment">///home/svn/repos/project1',</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>执行安装脚本</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> bin/</span><br><span class="line">./install.<span class="keyword">pl</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置http支持</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">vim</span> /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在最后面加上如下内容:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Alias <span class="regexp">/codestriker/</span>  <span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/cgi-bin/</span></span><br><span class="line">Alias <span class="regexp">/codestrikerhtml/</span>  <span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/html/</span></span><br><span class="line"></span><br><span class="line">&lt;Directory “<span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/cgi-bin/</span>”&gt;</span><br><span class="line">SetHandler perl-script</span><br><span class="line">PerlHandler <span class="string">ModPerl:</span>:Registry</span><br><span class="line">Options +ExecCGI</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory “<span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/html/</span>”&gt;</span><br><span class="line">AllowOverride None</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>查看<br>重启httpd服务：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">service</span> httpd restart</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>浏览器输入<code>http://ip/codestriker/codestriker.pl</code>。</p>
<h2 id="REFS">REFS</h2><p><a href="http://www.ha97.com/4467.html" target="_blank" rel="external">CentOS Linux搭建SVN Server配置详解</a><br><a href="http://www.hi-docs.com/article/detail-MTA4.html" target="_blank" rel="external">Centos 6.5+ 搭建SVN服务器（实用简写版）-LINUX技术文章,经验分享,HI-DOCS</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在CentOS 6.5服务器上部署配置Subversion。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Supervisor Basic Usage]]></title>
    <link href="https://hwangjr.github.io/2015/10/09/Supervisor-Basic-Usage/"/>
    <id>https://hwangjr.github.io/2015/10/09/Supervisor-Basic-Usage/</id>
    <published>2015-10-09T06:38:05.000Z</published>
    <updated>2015-10-09T06:38:44.370Z</updated>
    <content type="html"><![CDATA[<p><a href="http://supervisord.org/" target="_blank" rel="external">Supervisor</a> is a process control system, it is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.</p>
<p>It shares some of the same goals of programs like <a href="http://supervisord.org/glossary.html#term-launchd" target="_blank" rel="external">launchd</a>, <a href="http://supervisord.org/glossary.html#term-daemontools" target="_blank" rel="external">daemontools</a>, and <a href="http://supervisord.org/glossary.html#term-runit" target="_blank" rel="external">runit</a>. Unlike some of these programs, it is not meant to be run as a substitute for init as “process id 1”. Instead it is meant to be used to control processes related to a project or a customer, and is meant to start like any other program at boot time.</p>
<h2 id="Install">Install</h2><p>Sample for centos:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Maybe u need to install python-setuptools or pip</span></span><br><span class="line"><span class="comment">## yum install python-setuptools &amp;&amp; easy_install pip</span></span><br><span class="line">easy_install supervisor</span><br><span class="line"><span class="comment">## or </span></span><br><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure></p>
<h2 id="Commands">Commands</h2><p>This is some common commands:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for all service</span></span><br><span class="line">supervisorctl start all</span><br><span class="line">supervisorctl stop all</span><br><span class="line">supervisorctl restart all</span><br><span class="line"></span><br><span class="line"><span class="comment"># for service 'ss'</span></span><br><span class="line">supervisorctl stop ss</span><br><span class="line">supervisorctl start ss</span><br><span class="line">supervisorctl restart ss</span><br></pre></td></tr></table></figure></p>
<h2 id="Usage">Usage</h2><p><strong>STEP 1: Init the config file </strong></p>
<p>First of all, we need a config file, supervisor provider us a sample:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## This will create a supervisord.conf file under /etc folder</span></span><br><span class="line"><span class="built_in">echo</span>_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure></p>
<p><strong>STEP 2: Setup config </strong></p>
<p>Second, we need to config the file, add the code below to the end of conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if this config is not correct, it may occur supervisor start fail</span></span><br><span class="line">[program:ss]</span><br><span class="line"><span class="built_in">command</span> = ssserver -c /etc/ss.json</span><br><span class="line">user = root</span><br><span class="line">autostart = <span class="literal">true</span></span><br><span class="line">autorestart = <span class="literal">true</span></span><br><span class="line">stderr_logfile = /var/<span class="built_in">log</span>/supervisor/ss.stderr.log</span><br><span class="line">stdout_logfile = /var/<span class="built_in">log</span>/supervisor/ss.stdout.log</span><br></pre></td></tr></table></figure></p>
<p>More info see : <a href="http://supervisord.org/configuration.html#programx-section" target="_blank" rel="external">Configuration File — Supervisor 3.1.3 documentation</a></p>
<p><strong>STEP 3: Run Supervisor</strong></p>
<p>Finally, run the supervisor:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run supervisor with conf file</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># run without conf file, will search for the default conf file by:</span></span><br><span class="line"><span class="comment"># $CWD/supervisord.conf</span></span><br><span class="line"><span class="comment"># $CWD/etc/supervisord.conf</span></span><br><span class="line"><span class="comment"># /etc/supervisord.conf</span></span><br><span class="line">supervisord</span><br></pre></td></tr></table></figure></p>
<p>If we modify the conf file, we also can update the conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure></p>
<h2 id="Run_on_startup">Run on startup</h2><p>If you are using a distribution-packaged version of Supervisor, it should already be integrated into the service management infrastructure of your distribution.</p>
<p>There are user-contributed scripts for various operating systems at: <a href="https://github.com/Supervisor/initscripts" target="_blank" rel="external">Supervisor/initscripts</a></p>
<p>OR :<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># add this before exit</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure></p>
<h2 id="Manage_on_web">Manage on web</h2><p>U can manage the service remote, just modify the conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line">port=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9001</span>        ; (ip_address:port specifier, *:port <span class="keyword">for</span> all iface)</span><br><span class="line">username=user              ; (default is no username (open server))</span><br><span class="line">password=<span class="number">123</span>               ; (default is no password (open server))</span><br></pre></td></tr></table></figure></p>
<p>and reload conf:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl reload</span><br></pre></td></tr></table></figure></p>
<h2 id="END">END</h2><p>Just so easy, Supervisor is very fantastic, enjoy it.</p>
]]></content>
    <summary type="html">
    <![CDATA[Introduction about supervisor.]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[将SOCKET代理转化为HTTP代理]]></title>
    <link href="https://hwangjr.github.io/2015/08/21/%E5%B0%86SOCKET%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8C%96%E4%B8%BAHTTP%E4%BB%A3%E7%90%86/"/>
    <id>https://hwangjr.github.io/2015/08/21/将SOCKET代理转化为HTTP代理/</id>
    <published>2015-08-21T07:39:01.000Z</published>
    <updated>2015-08-21T07:39:25.302Z</updated>
    <content type="html"><![CDATA[<h2 id="背景">背景</h2><p>众所周知，中国伟大的墙阻碍了很多前进的脚步，特别是ANDROID SDK的更新（node啥的都不说了）。特别是最近管控比较严，就只能使用朋友的SOCKET5的服务器代理，而ANDROID SDK是无法使用SOCKET5代理，只支持HTTP代理，类似<a href="http://www.androiddevtools.cn/" target="_blank" rel="external">AndroidDevTools</a>的站点也不是很好使了，只能寻找SOCKET5转换成HTTP的方式。</p>
<h2 id="SOCKET转HTTP">SOCKET转HTTP</h2><h3 id="DeleGate介绍">DeleGate介绍</h3><p>这里要使用到<a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>软件，支持各个平台。<br><a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>是一个多平台的简单代理服务器软件，通过本地建立各种代理服务器，包括HTTP，FTP，SOCKET等。</p>
<blockquote>
<p>This is a private and voluntary site that is independent of AIST, for providing support information and redistribution of DeleGate, a general purpose proxy server software developed in AIST and, more specifically, for providing voluntary-based support for users in forums, supplementary contents for guide, some experimental services and demonstrations, as well as contents mirroring some of those in the official site of DeleGate of AIST. </p>
</blockquote>
<h3 id="安装软件">安装软件</h3><p>新版没有找到源码，但是<a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>提供了编译之后的可执行程序。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://delegate.hpcc.jp/pub/DeleGate/bin/linux/<span class="number">9.9</span>.<span class="number">13</span>/linux2.<span class="number">6</span>-dg9_9_13.tar.gz</span><br><span class="line">tar xzf linux2.<span class="number">6</span>-dg9_9_13.tar.gz</span><br><span class="line"><span class="built_in">cd</span> dg9_9_13</span><br><span class="line">tree .</span><br></pre></td></tr></table></figure></p>
<p>在bin目录下就是可执行程序和配置文件，整个文件目录很简洁，在subin里面也提供了setup-subin.sh脚本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">│   ├── dg9_9_13</span><br><span class="line">│   ├── dg9_9_13.conf</span><br><span class="line">subin</span><br><span class="line">│   ├── dgbind</span><br><span class="line">│   ├── dgchroot</span><br><span class="line">│   ├── dgcpnod</span><br><span class="line">│   ├── dgdate</span><br><span class="line">│   ├── dgforkpty</span><br><span class="line">│   ├── dgpam</span><br><span class="line">│   └── setup-subin.sh</span><br></pre></td></tr></table></figure></p>
<p>setup-subin.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">SUBINS=<span class="string">"dgpam dgbind dgchroot dgcpnod"</span></span><br><span class="line">sudo sh -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">  su root -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">  su root -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">ls <span class="operator">-l</span> <span class="variable">$SUBINS</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用">使用</h3><p>使用方式也很简单，通过编辑bin目录下的conf文件来完成，这里以SOCKET转HTTP为例，具体需求自己查看配置文件。<br>编辑dg9_9_13.conf，新增：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mail-address of the administrator of this DeleGat</span></span><br><span class="line">ADMIN=email@email.com</span><br><span class="line"><span class="comment"># the protocol DeleGate speaks with its clients</span></span><br><span class="line">SERVER=http</span><br><span class="line"><span class="comment"># the entrance port on which DeleGate waits clients</span></span><br><span class="line">-P8080</span><br><span class="line"><span class="comment"># forwarding to a SOCKS server</span></span><br><span class="line">SOCKS=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>配置完成后，直接执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./dg9_9_13</span><br><span class="line"><span class="comment"># 如果没有权限，给权限即可</span></span><br><span class="line">sudo chmod +x dg9_9_13</span><br></pre></td></tr></table></figure></p>
<p>查看是否在运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep dg9</span><br><span class="line">hwangjr   <span class="number">4595</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">53340</span>  <span class="number">3436</span> ?        Ss   <span class="number">11</span>:<span class="number">10</span>   <span class="number">0</span>:<span class="number">00</span> ./dg9_9_13 -&#123;<span class="number">000</span>&#125;[RPM=<span class="number">0.00</span>(<span class="number">0.0</span> <span class="number">0.0</span> <span class="number">0.0</span>),IDLE=<span class="number">15</span>s]-P8080 -- --------------------</span><br><span class="line">hwangjr   <span class="number">4601</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">15952</span>   <span class="number">940</span> pts/<span class="number">14</span>   S+   <span class="number">11</span>:<span class="number">10</span>   <span class="number">0</span>:<span class="number">00</span> grep --color=auto dg9</span><br></pre></td></tr></table></figure></p>
<p>停止运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./dg9_9_13 -P8080 -F<span class="built_in">kill</span></span><br><span class="line"><span class="comment"># 暴力</span></span><br><span class="line"><span class="built_in">kill</span> -<span class="number">9</span> <span class="number">4595</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置ANDROID_SDK">配置ANDROID SDK</h3><p>回到我们的场景，配置ANDROID SDK，基本按照我们的思路，直接配置本地的路由和端口即可。<br>打开ANDROID SDK，Tools -&gt; Options，配置HTTP PROXY SERVER为：127.0.0.1，端口为8080，然后即可畅游谷歌网络。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">12</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52791</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">15</span> INFO     connecting dl-ssl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52796</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">17</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52799</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">03</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52809</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">57</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52821</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">02</span> INFO     connecting ssl.google-analytics.com:<span class="number">443</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52962</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ShadowSocks">ShadowSocks</h3><p>顺带简单介绍下<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks/shadowsocks</a>，其功能在官网已经介绍：</p>
<blockquote>
<p>A fast tunnel proxy that helps you bypass firewalls.<br>Features:<br>TCP &amp; UDP support<br>User management API<br>TCP Fast Open<br>Workers and graceful restart<br>Destination IP blacklist</p>
</blockquote>
<p>安装（ubuntu）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-pip</span><br><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure></p>
<p>使用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">usage: sslocal [OPTION]...</span><br><span class="line">A fast tunnel proxy that helps you bypass firewalls.</span><br><span class="line"></span><br><span class="line">You can supply configurations via either config file or <span class="built_in">command</span> line arguments.</span><br><span class="line"></span><br><span class="line">Proxy options:</span><br><span class="line">  -c CONFIG              path to config file</span><br><span class="line">  <span class="operator">-s</span> SERVER_ADDR         server address</span><br><span class="line">  -p SERVER_PORT         server port, default: <span class="number">8388</span></span><br><span class="line">  -b LOCAL_ADDR          <span class="built_in">local</span> binding address, default: <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">  <span class="operator">-l</span> LOCAL_PORT          <span class="built_in">local</span> port, default: <span class="number">1080</span></span><br><span class="line">  -k PASSWORD            password</span><br><span class="line">  -m METHOD              encryption method, default: aes-<span class="number">256</span>-cfb</span><br><span class="line">  -t TIMEOUT             timeout <span class="keyword">in</span> seconds, default: <span class="number">300</span></span><br><span class="line">  --fast-open            use TCP_FASTOPEN, requires Linux <span class="number">3.7</span>+</span><br><span class="line"></span><br><span class="line">General options:</span><br><span class="line">  -h, --help             show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  <span class="operator">-d</span> start/stop/restart  daemon mode</span><br><span class="line">  --pid-file PID_FILE    pid file <span class="keyword">for</span> daemon mode</span><br><span class="line">  --log-file LOG_FILE    <span class="built_in">log</span> file <span class="keyword">for</span> daemon mode</span><br><span class="line">  --user USER            username to run as</span><br><span class="line">  -v, -vv                verbose mode</span><br><span class="line">  -q, -qq                quiet mode, only show warnings/errors</span><br><span class="line">  --version              show version information</span><br><span class="line"></span><br><span class="line">Online <span class="built_in">help</span>: &lt;https://github.com/shadowsocks/shadowsocks&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">sudo sslocal <span class="operator">-s</span> SERVER_ADDR -p SERVER_PORT -b LOCAL_ADDR <span class="operator">-l</span> LOCAL_PORT -k PASSWORD -m METHOD</span><br><span class="line"></span><br><span class="line"><span class="comment"># LOG</span></span><br><span class="line">sudo less /var/<span class="built_in">log</span>/shadowsocks.log</span><br></pre></td></tr></table></figure>
<p>更多详细可以参考文档<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks/shadowsocks</a>。</p>
<h2 id="总结">总结</h2><p>伟大的墙。</p>
<h2 id="REF">REF</h2><p><a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a><br><a href="http://www.delegate.org/documents/" target="_blank" rel="external">Documents on DeleGate</a><br><a href="ftp://ftp.delegate.org/pub/DeleGate/" target="_blank" rel="external">FTP on DeleGate</a><br><a href="http://www.delegate.org/delegate/build.shtml" target="_blank" rel="external">Building DeleGate</a></p>
]]></content>
    <summary type="html">
    <![CDATA[由于ANDROID SDK只能接受HTTP代理，而我使用的只支持SOCKET5，故只能转化为HTTP代理。]]>
    
    </summary>
    
      <category term="Linux" scheme="https://hwangjr.github.io/tags/Linux/"/>
    
      <category term="tech" scheme="https://hwangjr.github.io/tags/tech/"/>
    
      <category term="Linux" scheme="https://hwangjr.github.io/categories/Linux/"/>
    
  </entry>
  
</feed>