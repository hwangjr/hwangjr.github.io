
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>HwangJR&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="HwangJR">
    

    
    <meta name="description" content="Some stuff about tech etc..">
<meta property="og:type" content="website">
<meta property="og:title" content="HwangJR's Blog">
<meta property="og:url" content="https://hwangjr.github.io/index.html">
<meta property="og:site_name" content="HwangJR's Blog">
<meta property="og:description" content="Some stuff about tech etc..">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HwangJR's Blog">
<meta name="twitter:description" content="Some stuff about tech etc..">
<meta name="twitter:creator" content="@HuangJR">
<link rel="publisher" href="+JianrongHuang">

    
    <link rel="alternative" href="/atom.xml" title="HwangJR&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HwangJR&#39;s Blog" title="HwangJR&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a></h1>
				<h2 class="blog-motto">Life is wonderful!</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="ts-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/23/自动清理tmp文件/" title="自动清理tmp文件" itemprop="url">自动清理tmp文件</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-23T11:03:26.000Z" itemprop="datePublished"> 发表于 2015-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>在<code>supervisor</code>默认配置中，其启动的<code>sock</code>等都会放到<code>tmp</code>目录，而<code>tmp</code>目录会自动清理导致无法使用<code>supervisorctl</code>命令，此时：</p>
<ol>
<li>修改<code>supervisor.conf</code>文件，修改到<code>/var/run/</code>及<code>/var/log/</code>目录，具体配置就不进行贴了，简单直接搜索<code>tmp</code>进行修改即可。</li>
<li>重启<code>supervisor</code>服务，记得<code>kill</code>原来服务。</li>
</ol>
<p>但是，为什么系统会自动清理<code>tmp</code>目录呢？</p>
<h1 id="RHEL\CentOS\Fedora系统">RHEL\CentOS\Fedora系统</h1><p>在<code>CentOS 6</code>中，使用<code>tmpwatch</code>命令进行删除。</p>
<blockquote>
<p>tmpwatch - removes files which haven’t been accessed for a period of time</p>
<p>tmpwatch [-u|-m|-c] [-MUadfqstvx] [—verbose] [—force] [—all] [—nodirs] [—nosymlinks] [—test] [—fuser] [—quiet] [—atime|—mtime|—ctime] [—dirmtime] [—exclude path] [—exclude-user user] time dirs</p>
</blockquote>
<p>在<code>/etc/cron.daily/</code>目录下会生成<code>tmpwatch</code>文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh&#10;flags=-umc&#10;/usr/sbin/tmpwatch &#34;$flags&#34; -x /tmp/.X11-unix -x /tmp/.XIM-unix \&#10;        -x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix \&#10;        -X &#39;/tmp/hsperfdata_*&#39; 10d /tmp&#10;/usr/sbin/tmpwatch &#34;$flags&#34; 30d /var/tmp&#10;for d in /var/&#123;cache/man,catman&#125;/&#123;cat?,X11R6/cat?,local/cat?&#125;; do&#10;    if [ -d &#34;$d&#34; ]; then&#10;        /usr/sbin/tmpwatch &#34;$flags&#34; -f 30d &#34;$d&#34;&#10;    fi&#10;done</span><br></pre></td></tr></table></figure></p>
<p>将自动删除240小时未访问文件，<code>tmpwatch</code>工具可以从指定目录递归搜索并删除一段时间未访问文件。<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">u, --atime 基于访问时间来删除文件，默认的。</span><br><span class="line"></span>-<span class="ruby">m, --mtime 基于修改时间来删除文件。</span><br><span class="line"></span>-<span class="ruby">c, --ctime 基于创建时间来删除文件，对于目录，基于mtime。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">M</span>, --dirmtime 删除目录基于目录的修改时间而不是访问时间。</span><br><span class="line"></span>-<span class="ruby">a, --all 删除所有的文件类型，不只是普通文件，符号链接和目录。</span><br><span class="line"></span>-<span class="ruby">d, --nodirs 不尝试删除目录，即使是空目录。</span><br><span class="line"></span>-<span class="ruby">d, --nosymlinks 不尝试删除符号链接。</span><br><span class="line"></span>-<span class="ruby">f, --force 强制删除。</span><br><span class="line"></span>-<span class="ruby">q, --quiet 只报告错误信息。</span><br><span class="line"></span>-<span class="ruby">s, --fuser 如果文件已经是打开状态在删除前，尝试使用“定影”命令。默认不启用。</span><br><span class="line"></span>-<span class="ruby">t, --test 仅作测试，并不真的删除文件或目录。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">U</span>, --exclude-user=user 不删除属于谁的文件。</span><br><span class="line"></span>-<span class="ruby">v, --verbose 打印详细信息。</span><br><span class="line"></span>-<span class="ruby">x, --exclude=path 排除路径，如果路径是一个目录，它包含的所有文件被排除了。如果路径不存在，它必须是一个绝对路径不包含符号链接。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">X</span>, --exclude-pattern=pattern 排除某规则下的路径。</span></span><br></pre></td></tr></table></figure></p>
<h2 id="CentOS_7">CentOS 7</h2><p>在<code>CentOS 7</code>中会注意到一点，在系统中默认会清理<code>tmp</code>目录，而且没有安装<code>tmpwatch</code>，那么<code>CentOS 7</code>中是通过什么来实现的呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># systemctl status systemd-tmpfiles-clean.service</span></span><br><span class="line">systemd-tmpfiles-clean.service - Cleanup of Temporary Directories</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/systemd-tmpfiles-clean.service; <span class="keyword">static</span>)</span><br><span class="line">   Active: inactive (dead) since Thu <span class="number">2015</span>-<span class="number">12</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> HKT; <span class="number">5</span>h <span class="number">12</span>min ago</span><br><span class="line">     Docs: man:tmpfiles.d(<span class="number">5</span>)</span><br><span class="line">           man:systemd-tmpfiles(<span class="number">8</span>)</span><br><span class="line">  Process: <span class="number">6523</span> ExecStart=/usr/bin/systemd-tmpfiles --clean (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">6523</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"></span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Starting Cleanup of Temporary Directories...</span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Started Cleanup of Temporary Directories.</span><br></pre></td></tr></table></figure></p>
<p>没错，就是通过这个服务来实现的，此服务为<code>/usr/lib/systemd/system/systemd-tmpfiles-clean.service</code>。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.service </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="setting">DefaultDependencies=<span class="value"><span class="keyword">no</span></span></span></span><br><span class="line"><span class="setting">Wants=<span class="value">local-fs.target</span></span></span><br><span class="line"><span class="setting">After=<span class="value">systemd-readahead-collect.service systemd-readahead-replay.service local-fs.target</span></span></span><br><span class="line"><span class="setting">Before=<span class="value">sysinit.target shutdown.target</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/local/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/etc/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/run/tmpfiles.d</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Type=<span class="value">oneshot</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/bin/systemd-tmpfiles --clean</span></span></span><br><span class="line"><span class="setting">IOSchedulingClass=<span class="value">idle</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.timer </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Daily Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Timer]</span></span><br><span class="line"><span class="setting">OnBootSec=<span class="value"><span class="number">15</span>min</span></span></span><br><span class="line"><span class="setting">OnUnitActiveSec=<span class="value"><span class="number">1</span>d</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到在启动15分钟之后会清理，每隔1天清理一次。更多详细信息<a href="http://www.freedesktop.org/software/systemd/man/systemd-tmpfiles.html" target="_blank" rel="external">systemd-tmpfiles</a>。</p>
<h1 id="Debian\Ubuntu系统">Debian\Ubuntu系统</h1><p>在<code>Ubuntu</code>系统中每次开机会进行清除，具体配置为<code>rcS</code>文件的<code>TMPTIME</code>值。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/<span class="keyword">default</span>/rcS</span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># /etc/default/rcS</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Default settings for the scripts in /etc/rcS.d/</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For information about these variables see the rcS(5) manual page.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># This file belongs to the "initscripts" package.</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># delete files in /tmp during boot older than x days.</span></span><br><span class="line"><span class="preprocessor"># '0' means always, -1 or 'infinite' disables the feature</span></span><br><span class="line"><span class="preprocessor">#TMPTIME=0</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># spawn sulogin during boot, continue normal boot if not used in 30 seconds</span></span><br><span class="line"><span class="preprocessor">#SULOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># do not allow users to log in until the boot has completed</span></span><br><span class="line"><span class="preprocessor">#DELAYLOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># assume that the BIOS clock is set to UTC time (recommended)</span></span><br><span class="line">UTC=yes</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># be more verbose during the boot process</span></span><br><span class="line"><span class="preprocessor">#VERBOSE=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># automatically repair filesystems with inconsistencies during boot</span></span><br><span class="line"><span class="preprocessor">#FSCKFIX=no</span></span><br></pre></td></tr></table></figure></p>
<p>也就是在x天启动之后会自动清理<code>tmp</code>目录，0代表一直清理，-1代表取消此特性。</p>
<h1 id="注意点">注意点</h1><h2 id="supervisor">supervisor</h2><p>修改默认配置的<code>/tmp/</code>目录为<code>/var/run/</code>和<code>/var/log</code>目录。</p>
<h2 id="mysql">mysql</h2><p>默认将<code>pid</code>和<code>socket</code>创建在<code>tmp</code>目录，将两个此文件排除在外，否则<code>mysql</code>重启或使用<code>socket</code>登陆时提示找不到文件，可通过<code>-U mysql</code>。</p>
<h1 id="REF">REF</h1><p><a href="http://www.oss4aix.org/download/SRPMS/tmpwatch/" target="_blank" rel="external">Index of /download/SRPMS/tmpwatch</a><br><a href="https://git.centos.org/summary/?r=rpms/tmpwatch" target="_blank" rel="external">rpms/tmpwatch - git.centos.org</a><br><a href="http://www.ttlsa.com/linux/the-tmp-directory-is-automatically-cleared-and-the-tmpwatch-command/" target="_blank" rel="external">tmp目录自动清除和tmpwatch命令 - 运维生存时间</a><br><a href="http://www.opsers.org/base/clean-up-on-the-linux-system-tmp-folder-you-may-want-to-know.html" target="_blank" rel="external">关于Linux系统清理/tmp/文件夹，你可能想知道的 | 羽飞博客</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/23/自动清理tmp文件/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/23/Android中的CheckStyle/" title="Android中的CheckStyle" itemprop="url">Android中的CheckStyle</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-23T11:02:08.000Z" itemprop="datePublished"> 发表于 2015-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>简单一句话：CheckStyle解放了团队编码规范的审核。</p>
<p>CheckStyle主要实现了事实检测代码是否符合已经定义的规范，比如静态变量需要大写，函数名不超过20字符等。当发现这些检测不符合规范，则发出警告或错误。</p>
<p>简单来说，checkstyle检测了（更多信息：<a href="http://checkstyle.sourceforge.net/checks.html" target="_blank" rel="external">checkstyle</a>）：</p>
<blockquote>
<p>Annotations<br>Block Checks<br>Class Design<br>Coding<br>Headers<br>Imports<br>Javadoc Comments<br>Metrics<br>Miscellaneous<br>Modifiers<br>Naming Conventions<br>Regexp<br>Size Violations<br>Whitespace</p>
</blockquote>
<h1 id="Android中的配置">Android中的配置</h1><p>由于checkstyle功能丰富，如果自行配置，相对较为复杂，所以在其官网谷歌、sun都有提供范例。接下来简要介绍如何在gradle中配置checkstyle。</p>
<h2 id="配置plugin">配置plugin</h2><p>在<code>build.gradle</code>中，新增插件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'checkstyle'</span></span><br></pre></td></tr></table></figure></p>
<p>默认checkstyle的版本为<code>5.9</code>，如果觉得版本较老，可以配置版本（目前最新版本为<code>6.13</code>，但是不兼容，最高可用版本为<code>6.1.1</code>）：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkstyle &#123;</span><br><span class="line">	toolVersion <span class="string">'6.1.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测任务">检测任务</h2><p>在添加完插件之后，需要添加检测的任务：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task checkstyle(<span class="string">type:</span> Checkstyle) &#123;</span><br><span class="line">    configFile rootProject.file(<span class="string">'checkstyle.xml'</span>)</span><br><span class="line">    <span class="comment">// source fileTree('src')</span></span><br><span class="line">    source <span class="string">'src/main/java'</span></span><br><span class="line">    ignoreFailures <span class="literal">false</span></span><br><span class="line">    showViolations <span class="literal">true</span></span><br><span class="line">    include <span class="string">'**/*.java'</span></span><br><span class="line">    exclude <span class="string">'**/gen/**'</span></span><br><span class="line"></span><br><span class="line">    classpath = files()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测配置">检测配置</h2><p>可以看到上一个步骤有<code>checkstyle.xml</code>文件，这个文件就是检测配置文件，里面包含了检测的规则，可以参考<a href="https://github.com/AndroidKnife/check" target="_blank" rel="external">AndroidKnife/check</a>这里的配置。</p>
<h2 id="检测插件">检测插件</h2><p>如果是使用studio的话，有一系列插件可以方便检测，输入<code>QAPlug</code>并进行搜索即可安装，其中包括<code>check style</code>、<code>FindBugs</code>、<code>PMD</code>、<code>Hammurapi</code>。</p>
<h1 id="Ref">Ref</h1><p><a href="https://github.com/checkstyle/checkstyle" target="_blank" rel="external">checkstyle/checkstyle</a><br><a href="https://google.github.io/styleguide/javaguide.html" target="_blank" rel="external">Google Java Style</a><br><a href="http://www.oracle.com/technetwork/java/codeconvtoc-136057.html" target="_blank" rel="external">Code Conventions for the Java Programming Language</a><br><a href="https://rockeyhoo.gitbooks.io/dianping_codestyle/content/source/BeautyStyle.xml" target="_blank" rel="external">BeautyStyle</a></p>
<p>顺便带上目前使用的<code>check style</code>，可在<a href="https://github.com/AndroidKnife/Utils" target="_blank" rel="external">AndroidKnife/Utils</a>找到：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0"?&gt;</span><span class="doctype">&lt;!DOCTYPE module PUBLIC</span><br><span class="line">    "-//Puppy Crawl//DTD Check Configuration 1.2//EN"</span><br><span class="line">    "http://www.puppycrawl.com/dtds/configuration_1_2.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"Checker"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--module name="NewlineAtEndOfFile"/--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileLength"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileTabCharacter"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Trailing spaces --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"\s+$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Line has trailing spaces."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Space after 'for' and 'if' --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*(for|if)\("</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed before opening parenthesis."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- For each spacing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*for \(.*?([^ ]:|:[^ ])"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed around ':' character."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TreeWalker"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name="cacheFile" value="$&#123;checkstyle.cache.file&#125;"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Javadoc comments.                     --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_javadoc.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocMethod"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocType"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocVariable"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocStyle"/--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Naming Conventions.                  --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_naming.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ConstantName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalFinalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MemberName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[a-z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"PackageName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"StaticVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypeName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[A-Z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for imports                              --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_import.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidStarImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UnusedImports"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"processJavadoc"</span> <span class="attribute">value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Size Violations.                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_sizes.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LineLength"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"max"</span> <span class="attribute">value</span>=<span class="value">"150"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"ignorePattern"</span></span><br><span class="line">                <span class="attribute">value</span>=<span class="value">"^package.*|^import.*|a href|href|http://|https://|ftp://"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodLength"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterNumber"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for whitespace                               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_whitespace.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"GenericWhitespace"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyForIteratorPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodParamPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceBefore"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"OperatorWrap"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypecastParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAround"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Modifier Checks                                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_modifiers.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="ModifierOrder"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantModifier"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for blocks. You know, those &#123;&#125;'s         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_blocks.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidNestedBlocks"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyBlock"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LeftCurly"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NeedBraces"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RightCurly"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for common coding problems               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_coding.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="AvoidInlineConditionals"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"CovariantEquals"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyStatement"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsAvoidNull"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsHashCode"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="HiddenField"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalInstantiation"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InnerAssignment"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="MagicNumber"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MissingSwitchDefault"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantThrows"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanExpression"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanReturn"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for class design                         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_design.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="DesignForExtension"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalClass"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"HideUtilityClassConstructor"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InterfaceIsType"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="VisibilityModifier"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Miscellaneous other checks.                   --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_misc.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ArrayTypeStyle"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalParameters"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TodoComment"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UpperEll"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/23/Android中的CheckStyle/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/03/ProGuard-精粹/" title="ProGuard 精粹" itemprop="url">ProGuard 精粹</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-03T07:01:25.000Z" itemprop="datePublished"> 发表于 2015-12-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>总结ProGuard混淆日常的使用方式，常见的混淆片段等。</p>
<p>更多内容<a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a></p>
<blockquote>
<p>ProGuard is a free Java class file shrinker, optimizer, obfuscator, and preverifier. It detects and removes unused classes, fields, methods, and attributes. It optimizes bytecode and removes unused instructions. It renames the remaining classes, fields, and methods using short meaningless names. Finally, it preverifies the processed code for Java 6 or higher, or for Java Micro Edition.<br><strong>Some uses of ProGuard are:</strong><br>Creating more compact code, for smaller code archives, faster transfer across networks, faster loading, and smaller memory footprints.<br>Making programs and libraries harder to reverse-engineer.<br>Listing dead code, so it can be removed from the source code.<br>Retargeting and preverifying existing class files for Java 6 or higher, to take full advantage of their faster class loading.</p>
</blockquote>
<h1 id="原则">原则</h1><p>现在面向对象都讲究原则，做事也讲究原则。</p>
<ul>
<li>反射用到的类不混淆</li>
<li>JNI方法不混淆</li>
<li>Manifest中类不混淆</li>
<li>四大组件和Application子类、Framework层下所有类默认不混淆</li>
<li>Parcelable子类和Creator静态成员变量不混淆（BadParcelableException，怕了吧）</li>
<li>GSon、FastJson等库时，Json对象不混淆（注解可解决此问题）</li>
<li>第三方开源库或引用其他第三方SDK，加入对应混淆规则（或者库在打包aar时有指定<code>consumerProguardFiles</code>）</li>
<li>WebView的JS调用接口不混淆</li>
</ul>
<h1 id="使用">使用</h1><h2 id="AndroidStudio">AndroidStudio</h2><p>新建项目后，默认会在模块目录下新建<code>build.gradle</code>和<code>proguard-rules.pro</code>文件，修改<code>build.gradle</code>文件中的<code>proguardFiles</code>配置：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    debug &#123;</span><br><span class="line">        versionNameSuffix <span class="string">"-debug"</span></span><br><span class="line">        minifyEnabled <span class="literal">false</span></span><br><span class="line">        zipAlignEnabled <span class="literal">false</span></span><br><span class="line">        shrinkResources <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span></span><br><span class="line">        zipAlignEnabled <span class="literal">true</span></span><br><span class="line">        shrinkResources <span class="literal">true</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        signingConfig signingConfigs.xxx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你是引用库，那么不要忘了给库配上混淆，详细参考<a href="http://blog.hwangjr.com/2015/11/25/%E6%90%9E%E5%AE%9AAndroid-Proguard/" target="_blank" rel="external">搞定Android Proguard</a>或者<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumerProguardFiles</span><br></pre></td></tr></table></figure></p>
<h2 id="其他方式">其他方式</h2><p>在SDK目录下，有<code>tools/proguard/</code>，这里即<code>proguard</code>的大本营，包括上面的<code>getDefaultProguardFile</code>方法也是到此目录获取<code>proguard-android.txt</code>文件。</p>
<p>在<code>proguard</code>目录下有<code>bin</code>目录，可以直接启动界面配置，当然也可以保存配置等。</p>
<p>其他类似<code>ANT</code>或者<code>IDE</code>类似<code>Eclipse</code>等，基本大同小异，自行摸索。</p>
<h1 id="配置">配置</h1><h2 id="基本配置">基本配置</h2><p>常用语法：</p>
<ul>
<li><code>-libraryjars class_path</code>：应用的依赖包，如<code>android-support-v4</code></li>
<li>-keep [,modifier,…] class_specification`：不混淆某些类</li>
<li><code>-keepclassmembers [,modifier,...] class_specification</code>：不混淆类的成员</li>
<li><code>-keepclasseswithmembers [,modifier,...] class_specification</code>：不混淆类及其成员</li>
<li><code>-keepnames class_specification</code>：不混淆类及其成员名</li>
<li><code>-keepclassmembernames class_specification</code>：不混淆类的成员名</li>
<li><code>-keepclasseswithmembernames class_specification</code>：不混淆类及其成员名</li>
<li><code>-assumenosideeffects class_specification</code>：假设调用不产生任何影响，在代码优化时会将该调用<code>remove</code>掉。如<code>system.out.println</code>和<code>Log.v</code>等等</li>
<li><code>-dontwarn [class_filter]</code>：不提示warnning</li>
</ul>
<p>更多关于ProGuard混淆规则和语法，参考<a href="http://proguard.sourceforge.net/index.html#manual/usage.html" target="_blank" rel="external">ProGuard</a>。</p>
<h2 id="常见使用">常见使用</h2><p><strong>不混淆类构造方法，需指定函数参数类型：</strong><br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(<span class="keyword">int</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个包所有/某个类、接口：</strong><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.hwangjr.utils.<span class="keyword">*</span><span class="keyword">*</span> &#123; <span class="keyword">*</span>; &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个方法：</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    public <span class="built_in">String</span> getTelephone(java.lang.<span class="built_in">String</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆Parcelable子类：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用assumenosideeffects移除代码：</strong><br>正常可通过BuildConfig.DEBUG变量控制日志输出，DEBUG模式可查看到日志。但ProGuard也可压缩和优化不必要的代码，包括debug日志，在发布时，会自动从源码中删除。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-assumenosideeffects <span class="keyword">class</span> android.util.Log &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">v</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">i</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">d</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">w</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">e</span><span class="params">(...)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 反射：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepattributes <span class="constant">Signature</span></span><br><span class="line"></span>-<span class="ruby">keepattributes <span class="constant">EnclosingMethod</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>Serializable类：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.io.ObjectStreamField[] serialPersistentFields;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream)</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">writeReplace</span><span class="params">()</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">readResolve</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>JS接口：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">fqcn</span>.<span class="title">of</span>.<span class="title">javascript</span>.<span class="title">interface</span>.<span class="title">for</span>.<span class="title">webview</span> &#123;</span></span><br><span class="line"></span>    public *;</span><br><span class="line">&#125;</span><br><span class="line">-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">package</span>.<span class="title">name</span>.** &#123; *;</span> &#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="混淆后">混淆后</h1><h2 id="混淆后文件">混淆后文件</h2><p>Android Studio发布版本之后，会自动生成混淆之后文件（build/outputs/mapping/channel/release/）：<br><code>mapping.txt</code>：混淆前后代码对照，在混淆之后如果出现问题，需要查找此文件进行定位。<br><code>dump.txt</code>：APK内所有class文件结构<br><code>seeds.txt</code>：没有被混淆的类和成员<br><code>usage.txt</code>：源代码中被删除的代码</p>
<p><strong>所以，养成保存<code>mapping.txt</code>文件的习惯。</strong></p>
<h2 id="混淆后验证">混淆后验证</h2><p>反编译应用，大部分都变成<code>abc...</code>。</p>
<h2 id="混淆后调试">混淆后调试</h2><p>问题分为代码问题和混淆问题。</p>
<p><strong>代码问题</strong><br>通过查看<code>mapping.txt</code>文件，反推定位对应代码问题来进行解决。混淆后<code>$</code>为匿名内部类。</p>
<p><strong>混淆问题</strong><br>最常见<code>ClassNotFoundException</code>、<code>BadParcelableException</code>及JSON解析错误。<br><code>ClassNotFoundException</code>通过mapping逆推找到类，在混淆中加入不混淆此类即可：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="type">class</span> package.<span class="property">name</span>.<span class="type">class</span> &#123; *; &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Parcelable</code>混淆错误加入：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>V4</code>包、<code>V7</code>包等包混淆问题（<code>sdk/tools/proguard/proguard-android.txt</code>中已经明确）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>更多问题可以参考：<a href="http://proguard.sourceforge.net/index.html#manual/troubleshooting.html" target="_blank" rel="external">ProGuard TroubleShooting</a></p>
<h1 id="ProGuard-Android">ProGuard-Android</h1><p>参考示例<code>sdk/tools/proguard/proguard-android.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimization is turned off by default. Dex does not like code run</span></span><br><span class="line"><span class="comment"># through the ProGuard optimize and preverify steps (and performs some</span></span><br><span class="line"><span class="comment"># of these optimizations on its own).</span></span><br><span class="line">-dontoptimize</span><br><span class="line">-dontpreverify</span><br><span class="line"><span class="comment"># Note that if you want to enable optimization, you cannot just</span></span><br><span class="line"><span class="comment"># include optimization flags in your own project configuration file;</span></span><br><span class="line"><span class="comment"># instead you will need to point to the</span></span><br><span class="line"><span class="comment"># "proguard-android-optimize.txt" file instead of this one from your</span></span><br><span class="line"><span class="comment"># project.properties file.</span></span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考示例<code>sdk/tools/proguard/proguard-android-optimize.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimizations: If you don't want to optimize, use the</span></span><br><span class="line"><span class="comment"># proguard-android.txt configuration file instead of this one, which</span></span><br><span class="line"><span class="comment"># turns off the optimization flags.  Adding optimization introduces</span></span><br><span class="line"><span class="comment"># certain risks, since for example not all optimizations performed by</span></span><br><span class="line"><span class="comment"># ProGuard works on all versions of Dalvik.  The following flags turn</span></span><br><span class="line"><span class="comment"># off various optimizations known to have issues, but the list may not</span></span><br><span class="line"><span class="comment"># be complete or up to date. (The "arithmetic" optimization can be</span></span><br><span class="line"><span class="comment"># used if you are only targeting Android 2.0 or later.)  Make sure you</span></span><br><span class="line"><span class="comment"># test thoroughly if you go this route.</span></span><br><span class="line">-optimizations !code/simplification/arithmetic,!code/simplification/cast,!field/<span class="keyword">*</span>,!class/merging/<span class="keyword">*</span></span><br><span class="line">-optimizationpasses 5</span><br><span class="line">-allowaccessmodification</span><br><span class="line">-dontpreverify</span><br><span class="line"></span><br><span class="line"><span class="comment"># The remainder of this file is identical to the non-optimized version</span></span><br><span class="line"><span class="comment"># of the Proguard configuration file (except that the other file has</span></span><br><span class="line"><span class="comment"># flags to turn off optimization).</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考<code>sdk/tools/proguard/proguard-project.txt</code>：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># To enable ProGuard in your project, edit project.properties</span></span><br><span class="line"><span class="preprocessor"># to define the proguard.config property as described in that file.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Add project specific ProGuard rules here.</span></span><br><span class="line"><span class="preprocessor"># By default, the flags in this file are appended to flags specified</span></span><br><span class="line"><span class="preprocessor"># in $&#123;sdk.dir&#125;/tools/proguard/proguard-android.txt</span></span><br><span class="line"><span class="preprocessor"># You can edit the include path and order by changing the ProGuard</span></span><br><span class="line"><span class="preprocessor"># include property in project.properties.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For more details, see</span></span><br><span class="line"><span class="preprocessor">#   http://developer.android.com/guide/developing/tools/proguard.html</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Add any project specific keep options here:</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># If your project uses WebView with JS, uncomment the following</span></span><br><span class="line"><span class="preprocessor"># and specify the fully qualified class name to the JavaScript interface</span></span><br><span class="line"><span class="preprocessor"># class:</span></span><br><span class="line"><span class="preprocessor">#-keepclassmembers class fqcn.of.javascript.interface.for.webview &#123;</span></span><br><span class="line"><span class="preprocessor">#   public *;</span></span><br><span class="line"><span class="preprocessor">#&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Ref">Ref</h2><p><a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a><br><a href="http://developer.android.com/intl/zh-cn/tools/help/proguard.html" target="_blank" rel="external">ProGuard | Android Developers</a><br><a href="http://www.trinea.cn/android/proguard-use/" target="_blank" rel="external">ProGuard的作用</a><br><a href="https://github.com/D-clock/Doc/blob/master/Gradle/4_AndroidStudio%E4%B8%8BProGuard%E6%B7%B7%E6%B7%86%E6%89%93%E5%8C%85.md" target="_blank" rel="external">AndroidStudio下ProGuard混淆打包.md</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/03/ProGuard-精粹/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/25/搞定Android-Proguard/" title="搞定Android Proguard" itemprop="url">搞定Android Proguard</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-25T10:23:19.000Z" itemprop="datePublished"> 发表于 2015-11-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>各种引用库，各种混淆，心好累。<br>所以，有了<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>。</p>
<h2 id="混淆设置">混淆设置</h2><p>Android中采用Proguard进行代码混淆。每次混淆，都会开始找寻混淆配置，在此开源库中，你可以找到你想要的，如果没找到，没关系，可以PULL REQUEST。</p>
<h3 id="build-gradle">build.gradle</h3><p>正常在<code>build.gradle</code>中加入混淆配置文件即可：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            zipAlignEnabled <span class="keyword">true</span></span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// specific proguard files</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span>, <span class="string">'proguard-gson.pro'</span></span><br><span class="line">            proguardFile <span class="string">'proguard-square-okio.pro'</span></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// As of Gradle Android plugin 1.1.0, the test APK has a separate config</span></span><br><span class="line">            testProguardFile <span class="string">'proguard-rules-test.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="proguard-rules-pro">proguard-rules.pro</h3><p>将混淆设置加入<code>proguard-rules.pro</code>文件也是一种方式：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="keyword">include</span> xxx</span></span><br></pre></td></tr></table></figure></p>
<h3 id="consumerProguardFiles">consumerProguardFiles</h3><p>开源库中可以依赖此标志来指定库的混淆方式，此会将<code>*.pro</code>文件打包进入<code>aar</code>中，库混淆时候会自动使用此混淆配置文件。</p>
<p>需要注意的是，以<code>consumerProguardFiles</code>方式加入的混淆具有以下特性：</p>
<ul>
<li><code>*.pro</code>文件会包含在<code>aar</code>文件中</li>
<li>这些<code>pro</code>配置会在混淆的时候被使用</li>
<li>此配置针对此<code>aar</code>进行混淆配置</li>
<li>此配置只对库文件有效，对应用程序无效</li>
</ul>
<p>所以以<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>开源库，只要一行代码即可搞定外部混淆：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.hwangjr.proguard:proguardconfig:1.0.1@aar'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>使用此库大善，欢迎pull request。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/25/搞定Android-Proguard/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/24/发布开源项目到Maven（Gradle-Sonatype）/" title="发布开源项目到Maven（Gradle + Sonatype）" itemprop="url">发布开源项目到Maven（Gradle + Sonatype）</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-24T10:43:22.000Z" itemprop="datePublished"> 发表于 2015-11-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>最近整理Android开发工具，想跟其他人分享，就有了将其发布到maven想法，所以考虑将库发布到maven，目前Android官方使用jCenter，比这个简单，后续补充（jCenter会自动同步Maven Center中的库）。<br>顺带避免：</p>
<blockquote>
<p>Download the source to use it as library project</p>
</blockquote>
<h2 id="流程">流程</h2><p>整个流程很清晰：</p>
<ol>
<li>获取JIRA Ticket，简单说就是去<a href="https://issues.sonatype.org/browse/" target="_blank" rel="external">Issues Sonatype</a>注册并提交issue</li>
<li>GPG密钥，要上传到maven，需要GPG密钥</li>
<li>本地配置POM，即配置项目信息</li>
<li>Gradle提交到Sonatype，通过脚本提交到Sonatype</li>
<li>发布版本，分为SNAPSHOT和Release版本</li>
</ol>
<p>整个流程就是酱紫。OVER。</p>
<h2 id="获取JIRA_Ticket">获取JIRA Ticket</h2><h3 id="注册JIRA帐号">注册JIRA帐号</h3><p>提交项目到Sonatype，首先需要注册。打开<a href="https://issues.sonatype.org/" target="_blank" rel="external">(Issue Sonatype)</a>注册JIRA帐号。</p>
<h3 id="创建Issue">创建Issue</h3><p>在导航上Create按钮，创建一个新的Issue。其中特别注意：</p>
<ol>
<li>Issue Type默认是new Project，按照默认就好</li>
<li>Summer和Description填写你要创建项目的描述即可</li>
<li>Group id特别关键，最好创建顶级Group ID，比如我需要<code>com.hwangjr.xxx</code>，那么Group ID填写为<code>com.hwangjr</code>，这样其他的库也可发布</li>
<li>Project URL和SCM URL填GIT HUB项目地址即可</li>
<li>其他基本都懂</li>
</ol>
<p>填写完毕，等待！工作人员会让你提交你的项目到Sonatype。</p>
<h2 id="GPG密钥">GPG密钥</h2><p>密钥是为了上传文件的加密和签名。如果有安装git，那么应该是已经安装GPG了，以下默认命令为Linux下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">gpg --gen-key</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">gpg --list-key</span><br></pre></td></tr></table></figure></p>
<p>其中姓名、邮箱和备注需要认真填写下，最后输入的Passphase，是密码，上传maven需要使用。</p>
<blockquote>
<p>pub   2048R/B53A8137 2015-11-24<br>uid                  hwangjr (Upload Modules For Maven By Sonatype.) <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#104;&#117;&#x61;&#x6e;&#x67;&#106;&#105;&#x61;&#110;&#114;&#x6f;&#x6e;&#x67;&#50;&#48;&#x31;&#48;&#x40;&#x67;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#104;&#117;&#x61;&#x6e;&#x67;&#106;&#105;&#x61;&#110;&#114;&#x6f;&#x6e;&#x67;&#50;&#48;&#x31;&#48;&#x40;&#x67;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;</a><br>sub   2048R/2F11E234 2015-11-24</p>
</blockquote>
<p>B53A8137是KEY ID。上传公钥到服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://pool.sks-keyservers.net --send-keys B53A8137</span><br></pre></td></tr></table></figure></p>
<h2 id="本地配置POM">本地配置POM</h2><p>Chris Banes大神已经写完Gradle插件<a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">chrisbanes/gradle-mvn-push</a>，可直接使用<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，上面有详细的配置和使用方式。简要步骤为：</p>
<ol>
<li>项目，保证是可以用Gradle编译。</li>
<li>更新<code>HOME gradle.properties</code>，修改<code>USER_HOME/.gradle/gradle.properties</code>文件。</li>
<li>在项目根目录下，创建文件<code>gradle.properties</code>。</li>
<li>在想要上传的子模块下，分别创建<code>gradle.properties</code>。</li>
<li>在子模块下，应用Gradle插件，即在<code>build.gradle</code>末尾加上<code>apply from: &#39;https://raw.github.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle&#39;</code> 或者下载gradle-mvn-push.gradle文件，放到根目录的<code>gradle</code>文件夹下，在<code>build.gradle</code>末尾加上<code>apply from: rootProject.file(&#39;gradle/gradle-mvn-push.gradle&#39;)</code>。</li>
<li>编译并上传<code>gradle clean build uploadArchives</code>。</li>
</ol>
<p>其他属性：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RELEASE_REPOSITORY_URL (defaults to Maven Central's staging server)</span><br><span class="line">SNAPSHOT_REPOSITORY_URL (defaults to Maven Central's snapshot server)</span><br></pre></td></tr></table></figure></p>
<p>USER_HOME/.gradle/gradle.properties文件新增，内容修改为自身用户名密码，下面的就是创建的GPG密钥：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NEXUS_USERNAME=chrisbanes</span><br><span class="line">NEXUS_PASSWORD=g00dtry</span><br><span class="line"></span><br><span class="line">signing.keyId=ABCDEF12</span><br><span class="line">signing.password=n1c3try</span><br><span class="line">signing.secretKeyRingFile=<span class="regexp">/home/u</span>ser<span class="regexp">/.gnupg/</span>secring.gpg</span><br></pre></td></tr></table></figure></p>
<p>项目根目录下的gradle.properties文件内容为，需要根据具体项目情况进行修改：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">VERSION_NAME=0.9.2-SNAPSHOT</span><br><span class="line">VERSION_CODE=92</span><br><span class="line">GROUP=com.github.chrisbanes.actionbarpulltorefresh</span><br><span class="line"></span><br><span class="line">POM_DESCRIPTION=A modern implementation of the pull-to-refresh for Android</span><br><span class="line">POM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_SCM_DEV_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_LICENCE_NAME=The Apache Software License, Version 2.0</span><br><span class="line">POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt</span><br><span class="line">POM_LICENCE_DIST=repo</span><br><span class="line">POM_DEVELOPER_ID=chrisbanes</span><br><span class="line">POM_DEVELOPER_NAME=Chris Banes</span><br></pre></td></tr></table></figure></p>
<p>子模块的gradle.properties文件内容为：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POM_NAME=ActionBar-PullToRefresh Library</span><br><span class="line">POM_ARTIFACT_ID=library</span><br><span class="line">POM_PACKAGING=aar</span><br></pre></td></tr></table></figure></p>
<p><strong>其中</strong>VERSION_NAME后面如果带<code>SNAPSHOT</code>会提交到<a href="https://oss.sonatype.org/content/repositories/snapshots" target="_blank" rel="external">Snapshots</a>，这个不需要同步即可下载jar和源码，如果不加则为RELEASE版本，会同步到MAVEN CENTER。</p>
<h2 id="Gradle脚本提交到Sonatype">Gradle脚本提交到Sonatype</h2><p>运行命令：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle clean build uploadArchives</span><br></pre></td></tr></table></figure></p>
<p>即会执行clean，并重新编译，上传到Sonatype。</p>
<h2 id="发布版本">发布版本</h2><p>版本分为<code>SNAPSHOT</code>版本和<code>RELEASE</code>版本。<br>如果<code>VERSION_NAME</code>有加入<code>SNAPSHOT</code>，即为<code>SNAPSHOT</code>版本，不会同步到MAVEN。<br>如果没有<code>SNAPSHOT</code>，则会同步到MAVEN。</p>
<p>首次提交之后，登陆<a href="https://oss.sonatype.org/index.html#welcome" target="_blank" rel="external">Sonatype Nexus Professional</a>，查看<code>Staging Repositories</code>，找到提交的包，选择并close并Release，再到<code>issue sonatype</code>上提交的JIRA TICKET后面评论告知版本已经staged并released，可以进行sync，工作人员会进行同步。<br>同步成功之后，即可在<a href="http://search.maven.org/" target="_blank" rel="external">maven center</a>搜索到项目，可通过gradle添加依赖。</p>
<h2 id="常规发布步骤">常规发布步骤</h2><ol>
<li>发布<code>SNAPSHOT</code>版本是否查看是否正常</li>
<li>发布<code>RELEASE</code>版本到线上，并进行同步</li>
<li>修改为下个<code>SNAPSHOT</code>版本</li>
</ol>
<h2 id="TIPS">TIPS</h2><h3 id="发布JAR">发布JAR</h3><p>如果想发布JAR，在<a href="#本地配置POM">本地配置POM</a>时，修改<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，在脚本中加入：<br>``` gradle<br>artifacts {<br>    archives packageReleaseJar<br>}</p>
<h3 id="发布时返回401">发布时返回401</h3><p>401为没有权限错误，检查：</p>
<ol>
<li>用户名密码，可在gradle-mvn-push中打印日志查看用户名密码是否正确</li>
<li>检查Sonatype是否有权限</li>
</ol>
<h2 id="REFS">REFS</h2><p><a href="http://central.sonatype.org/pages/ossrh-guide.html" target="_blank" rel="external">OSSRH Guide</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/gpg.html" target="_blank" rel="external">GPG入门教程</a><br><a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">gradle-mvn-push</a><br><a href="https://oss.sonatype.org/" target="_blank" rel="external">Sonatype Nexus Professional</a><br><a href="http://afoo.me/posts/2013-07-18-publishing-oss-release-to-maven-central-repo.html" target="_blank" rel="external">发布开源项目到Maven Central</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/24/发布开源项目到Maven（Gradle-Sonatype）/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/13/应用内存泄露排查/" title="应用内存泄露排查" itemprop="url">应用内存泄露排查</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-13T03:26:23.000Z" itemprop="datePublished"> 发表于 2015-11-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="内存泄露">内存泄露</h2><p>用到神器<a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a>：</p>
<blockquote>
<p>A memory leak detection library for Android and Java.<br>“A small leak will sink a great ship.”    - Benjamin Franklin<br>千里之堤，毁于蚁穴。 — 《韩非子.喻老》</p>
</blockquote>
<h3 id="LeakCanary完整集成">LeakCanary完整集成</h3><p><strong>配置build.gradle</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">	    <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.2.3'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">apply plugin: <span class="string">'android-library'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">	<span class="keyword">repositories</span>&#123;</span><br><span class="line">		jcenter()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">   debugCompile <span class="string">'com.squareup.leakcanary:leakcanary-android:1.3.1'</span></span><br><span class="line">   releaseCompile <span class="string">'com.squareup.leakcanary:leakcanary-android-no-op:1.3.1'</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>配置代码</strong><br>在你的APPLICATION中：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class ExampleApplication extends Application &#123;&#10;  @Override public void onCreate() &#123;&#10;&#9;super.onCreate();&#10;&#9;if (BuildConfig.DEBUG) &#123;&#10;&#9;    refWatcher = LeakCanary.install(this, LeakLogService.class,&#10;&#9;            AndroidExcludedRefs.createAndroidDefaults().build());&#10;&#9;&#125; else &#123;&#10;&#9;    refWatcher = RefWatcher.DISABLED;&#10;&#9;&#125;&#10;&#10;&#9;public static RefWatcher getRefWatcher(Context context) &#123;&#10;        ExampleApplication application = (ExampleApplication) context.getApplicationContext();&#10;        return application.refWatcher;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后在需要检测的地方进行监听即可：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract class BaseFragment extends Fragment &#123;&#10;&#10;  @Override public void onDestroy() &#123;&#10;    super.onDestroy();&#10;    RefWatcher refWatcher = ExampleApplication.getRefWatcher(getActivity());&#10;    refWatcher.watch(this);&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简易集成">简易集成</h3><p>参考<a href="https://github.com/GavinCT/SimpleLeakCanary" target="_blank" rel="external">GavinCT/SimpleLeakCanary</a>。<br>拷贝库文件到项目下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AndroidWatchExecutor<span class="class">.java</span></span><br><span class="line">GcTrigger<span class="class">.java</span></span><br><span class="line">KeyedWeakReference<span class="class">.java</span></span><br><span class="line">RefWatcher.java</span><br></pre></td></tr></table></figure></p>
<p>在需要监听的地方添加监听代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected void onDestroy() &#123;&#10;&#9;super.onDestroy();&#10;&#9;getApplicationContext().getRefWatcher().watch(this);&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="排查内存泄露">排查内存泄露</h2><p>利用Eclipse的Memory Analyzer（<a href="http://www.eclipse.org/mat/" target="_blank" rel="external">Eclipse Memory Analyzer Open Source Project</a>）可以方便的分析内存泄露原因。</p>
<p><strong>使用Studio帮助我们排查泄露</strong><br>通过Studio我们可以：</p>
<ol>
<li>查看内存堆栈情况</li>
<li>手动/强制垃圾回收，排除LeakCanary误报</li>
<li>导出Heap信息（Dump Java Heap）</li>
</ol>
<p>内存信息导出后，可用MAT打开.hprof文件进行分析，可能需要进行转换：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hprof-conv source.hprof dist.hprof</span><br></pre></td></tr></table></figure></p>
<p>打开QQL查询当前内存信息（快捷键CTRL + ENTER执行QQL语句）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from instanceof android.app.Activity</span><br></pre></td></tr></table></figure></p>
<p>查看内存信息，如果有多个相同对象即为可疑泄露对象：<br><code>右键 -&gt; Merge Shortest Paths to GC Roots -&gt; exclude all phantom/weak/soft etc. refrences</code><br>具体排查类，即可发现泄露对象。</p>
<h2 id="解决内存泄露">解决内存泄露</h2><p>针对可疑泄露对象，进行代码排查，即可解决。</p>
<h2 id="避免内存泄露">避免内存泄露</h2><p>良好编码习惯！</p>
<ol>
<li>匿名内部类</li>
<li>非静态内部类</li>
<li>单例对象持有Activity或Context对象<br>ETC…</li>
</ol>
<h2 id="REF">REF</h2><p><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html" target="_blank" rel="external">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a><br><a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a><br><a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/" target="_blank" rel="external">Google IO：Android内存管理主题演讲记录 - 技术小黑屋</a><br><a href="http://jiajixin.cn/2015/01/06/memory_leak/" target="_blank" rel="external">Android内存泄漏研究 | Jason’s Blog</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/13/应用内存泄露排查/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/09/CentOS如何移除依赖/" title="CentOS如何移除依赖" itemprop="url">CentOS如何移除依赖</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-09T02:44:12.000Z" itemprop="datePublished"> 发表于 2015-11-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="自带清除技能">自带清除技能</h2><p>从Fedora 18之后，yum有自带清除：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum autoremove</span><br><span class="line">yum autoremove &lt;package&gt;</span><br><span class="line"><span class="comment"># 一般不用</span></span><br><span class="line">yum remove --setopt=clean_requerements_on_remove=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="第三方技能">第三方技能</h2><p>安装<code>yum-utils</code>也是可以自动清理依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">package-cleanup --leaves</span><br><span class="line">package-cleanup --leaves --all</span><br><span class="line">package-cleanup -q --leaves | xargs <span class="operator">-l</span>1 yum -y remove</span><br></pre></td></tr></table></figure></p>
<h2 id="回滚安装技能">回滚安装技能</h2><p>自然，我们是在安装的时候安装了依赖，那如果我们回滚本次安装，也一样可以卸载这些依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> list &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> undo &lt;ID&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>相比而言，现在对包管理还是简单方便的，当然更高深的还需要自己摸索。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/09/CentOS如何移除依赖/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/27/Crontabs-Guide/" title="Crontabs Guide" itemprop="url">Crontabs Guide</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-27T04:05:24.000Z" itemprop="datePublished"> 发表于 2015-10-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Introduction">Introduction</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure>
<p>—-&gt;</p>
<blockquote>
<p>Crontab  is the program used to install, remove or list the tables used to drive the cron(8) daemon.  Each user can have their own crontab, and though these are files in /var/spool/ , they are not intended to be edited directly. For SELinux in mls mode can be even more crontabs - for each range. For more see selinux(8).</p>
<p>The  cron  jobs  could  be allow or disallow for different users. For classical crontab there exists cron.allow and cron.deny files.  If cron.allow file exists, then you must be listed therein in order to be allowed to use this command.  If the cron.allow file does not exist but the cron.deny file does exist,  then  you must  not  be listed in the cron.deny file in order to use this command.  If neither of these files exists, only the super user will be allowed to use this com-mand. The second option is using PAM authentication, where you set up users, which could or couldn’t use crontab and also system cron jobs from /etc/cron.d/.</p>
<p>The temporary directory could be set in enviroment variables. If it’s not set by user than /tmp is used.</p>
</blockquote>
<h2 id="Installation">Installation</h2><p>Just the commands:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check installation</span></span><br><span class="line">rpm -ql crontabs</span><br><span class="line">rpm -qa crontabs</span><br><span class="line"><span class="comment"># install</span></span><br><span class="line">yum install crontabs</span><br><span class="line"><span class="comment"># start service on boot</span></span><br><span class="line">chkconfig crond on</span><br><span class="line"><span class="comment"># start service now</span></span><br><span class="line">service crond start</span><br><span class="line">service crond status</span><br><span class="line">service crond restart</span><br><span class="line">service crond reload</span><br><span class="line">service crond stop</span><br></pre></td></tr></table></figure></p>
<p>Also, you can check the service by:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntsysv</span><br></pre></td></tr></table></figure></p>
<h2 id="Usage">Usage</h2><h3 id="Basic_Usage">Basic Usage</h3><p>Also, <code>man</code> is our best friend :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>NAME<br>crontab - maintain crontab files for individual users</li>
<li>SYNOPSIS<br>crontab [-u user] file<br>crontab [-u user] [-l | -r | -e] [-i] [-s]</li>
<li>OPTIONS<pre><code>**-u**     Append <span class="keyword">the</span> <span class="property">name</span> <span class="keyword">of</span> <span class="keyword">the</span> user <span class="keyword">whose</span> crontab <span class="keyword">is</span> <span class="keyword">to</span> be tweaked.  If this option <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">given</span>, crontab examines <span class="string">"your"</span> crontab, i.e., <span class="keyword">the</span> crontab <span class="keyword">of</span> <span class="keyword">the</span>  person  executing  <span class="keyword">the</span>  command.   Note  <span class="keyword">that</span>  su(<span class="number">8</span>) can confuse crontab <span class="keyword">and</span> <span class="keyword">that</span> <span class="keyword">if</span> you are <span class="property">running</span> inside <span class="keyword">of</span> su(<span class="number">8</span>) you should always use <span class="keyword">the</span> -u option <span class="keyword">for</span> safety’s sake.  The <span class="keyword">first</span> form <span class="keyword">of</span> this command <span class="keyword">is</span> used <span class="keyword">to</span> install a new crontab <span class="keyword">from</span> <span class="keyword">some</span> named <span class="type">file</span> <span class="keyword">or</span> standard input  <span class="keyword">if</span>  <span class="keyword">the</span>  pseudo-filename  <span class="string">"-"</span>  <span class="keyword">is</span> <span class="keyword">given</span>.
**-l**     The current crontab will be displayed <span class="function_start"><span class="keyword">on</span></span> standard output.
**-r**     The current crontab will be removed.
**-e**     This  option  <span class="keyword">is</span> used <span class="keyword">to</span> edit <span class="keyword">the</span> current crontab using <span class="keyword">the</span> editor specified <span class="keyword">by</span> <span class="keyword">the</span> VISUAL <span class="keyword">or</span> EDITOR environment variables.  After you <span class="keyword">exit</span> <span class="keyword">from</span> <span class="keyword">the</span> editor, <span class="keyword">the</span> modified crontab will be installed automatically.
**-i**     This option modifies <span class="keyword">the</span> -r option <span class="keyword">to</span> prompt <span class="keyword">the</span> user <span class="keyword">for</span> a ’y/Y’ response <span class="keyword">before</span> actually removing <span class="keyword">the</span> crontab.
**-s**     It will append <span class="keyword">the</span> current SELinux security context <span class="type">string</span> <span class="keyword">as</span> an MLS_LEVEL setting <span class="keyword">to</span> <span class="keyword">the</span> crontab <span class="type">file</span> <span class="keyword">before</span> editing / replacement occurs - see <span class="keyword">the</span> doc-umentation <span class="keyword">of</span> MLS_LEVEL <span class="keyword">in</span> crontab(<span class="number">5</span>).
</code></pre></li>
<li>FILES<pre><code><span class="regexp">/etc/</span>cron.allow
<span class="regexp">/etc/</span>cron.deny
</code></pre></li>
</ul>
</blockquote>
<p>Shortly for this :<br>&gt;</p>
<ul>
<li>usage:<br>  crontab [-u user] file<br>  crontab [-u user] [ -e | -l | -r ]<pre><code>(<span class="keyword">default</span> operation <span class="keyword">is</span> <span class="built_in">replace</span>, per <span class="number">1003.2</span>)
</code></pre>  -e    (edit user’s crontab)<br>  -l    (list user’s crontab)<br>  -r    (delete user’s crontab)<br>  -i    (prompt before deleting user’s crontab)<br>  -s    (selinux context)</li>
</ul>
<p>The format of <code>-e</code> command is:<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  *    *    *    *    *   command</span><br><span class="line">minus <span class="built_in">hour</span> <span class="built_in">day</span> <span class="built_in">month</span> week command</span><br><span class="line"></span><br><span class="line">minus: <span class="number">1</span>~<span class="number">59</span> minus, * <span class="keyword">or</span> */<span class="number">1</span> <span class="keyword">for</span> per minus</span><br><span class="line"><span class="built_in">hour</span>: <span class="number">1</span>~<span class="number">23</span>, <span class="number">0</span> means <span class="number">0</span> o<span class="comment">'clock</span></span><br><span class="line"><span class="built_in">day</span>: <span class="number">1</span>~<span class="number">31</span></span><br><span class="line"><span class="built_in">month</span>: <span class="number">1</span>~<span class="number">12</span></span><br><span class="line">week: <span class="number">0</span>~<span class="number">6</span>, <span class="number">0</span> means sunday</span><br><span class="line">command: the command u want <span class="keyword">to</span> run</span><br></pre></td></tr></table></figure></p>
<h3 id="Examples">Examples</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># every night at <span class="number">21</span>:<span class="number">31</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每晚的<span class="number">21</span>:<span class="number">30</span></span></span><br><span class="line"><span class="number">30</span> <span class="number">21</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span> per month at <span class="number">4</span>:<span class="number">45</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每月<span class="number">1</span>、<span class="number">10</span>、<span class="number">22</span>日的<span class="number">4</span>:<span class="number">45</span></span></span><br><span class="line"><span class="number">45</span> <span class="number">4</span> <span class="number">1</span>,<span class="number">10</span>,<span class="number">22</span> * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday and sunday per week at <span class="number">1</span>:<span class="number">10</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每周六、周日的<span class="number">1</span>:<span class="number">10</span></span></span><br><span class="line"><span class="number">10</span> <span class="number">1</span> * * <span class="number">6</span>,<span class="number">0</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">18</span>:<span class="number">00</span> ~ <span class="number">23</span>:<span class="number">00</span> per <span class="number">30</span> minus everyday reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每天<span class="number">18</span>:<span class="number">00</span>至<span class="number">23</span>:<span class="number">00</span>之间每隔<span class="number">30</span>分钟</span></span><br><span class="line"><span class="number">0</span>,<span class="number">30</span> <span class="number">18</span>-<span class="number">23</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday per week at <span class="number">23</span>:<span class="number">00</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每星期六的<span class="number">23</span>:<span class="number">00</span></span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * <span class="number">6</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">23</span>:<span class="number">00</span> ~ <span class="number">7</span>:<span class="number">00</span> per hour</span></span><br><span class="line"><span class="preprocessor"># <span class="number">23</span>点到<span class="number">7</span>点之间，每隔一小时</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span>-<span class="number">7</span>/<span class="number">1</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per hour</span></span><br><span class="line"><span class="comment"># 每一小时</span></span><br><span class="line"><span class="keyword">*</span> <span class="keyword">*</span>/1 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">4</span> every month and monday to wednesday every week at <span class="number">11</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 每月的<span class="number">4</span>号与每周一到周三的<span class="number">11</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">11</span> <span class="number">4</span> * mon-wed /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span> january at <span class="number">4</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 一月一号的<span class="number">4</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span> <span class="number">1</span> jan * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per 30 minus</span></span><br><span class="line"><span class="comment"># 每半小时</span></span><br><span class="line"><span class="keyword">*</span>/30 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="Advanced_Usage">Advanced Usage</h3><p>For the files:</p>
<ul>
<li>/etc/cron.allow : list the user who can use crontab</li>
<li>/etc/cron.deny : list the user who cannot use crontab</li>
<li>/var/spool/cron : all users and their crontab will be store here</li>
<li>/var/log/cron : cron log per job</li>
<li>/etc/crontab : for system jobs, <code>crontab -e</code> is for current user</li>
<li>/etc/cron.d/* : seperated cron file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.d</span><br><span class="line"><span class="number">0</span>hourly  raid-check</span><br><span class="line"></span><br><span class="line">cat /etc/cron.d/<span class="number">0</span>hourly </span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"><span class="number">01</span> * * * * root run-parts /etc/cron.hourly</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.hourly/</span><br><span class="line"><span class="number">0</span>anacron</span><br><span class="line"></span><br><span class="line">cat /etc/cron.hourly/<span class="number">0</span>anacron </span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Skip excecution unless the date has changed from the previous run </span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -r /var/spool/anacron/cron.daily; <span class="keyword">then</span></span><br><span class="line">    day=`cat /var/spool/anacron/cron.daily`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `date +%Y%m%d` = <span class="string">"<span class="variable">$day</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip excecution unless AC powered</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -x /usr/bin/on_ac_power; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/on_ac_power &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> $? <span class="operator">-eq</span> <span class="number">1</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/usr/sbin/anacron <span class="operator">-s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/anacrontab </span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=<span class="number">45</span></span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=<span class="number">3</span>-<span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line"><span class="number">1</span>	<span class="number">5</span>	cron.daily		nice run-parts /etc/cron.daily</span><br><span class="line"><span class="number">7</span>	<span class="number">25</span>	cron.weekly		nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly <span class="number">45</span>	cron.monthly		nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">More Info</a>.</p>
<h2 id="Practice">Practice</h2><p>I want to backup my svn daily, so i must have a script to backup:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">cd</span> /home/svn/repos</span><br><span class="line">now=`/bin/date +%Y%m%d`</span><br><span class="line">/bin/tar czvf <span class="string">"kk_backup_<span class="variable">$now</span>.tar.gz"</span> kk/ &amp;&amp; rm -rf /home/svn/backup/* &amp;&amp; /bin/mv kk_backup_*.tar.gz /home/svn/backup/</span><br><span class="line"><span class="keyword">if</span> [ $? == <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">result=<span class="string">"backup svn OK!!"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">result=<span class="string">"backup svn False!!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$result</span></span><br></pre></td></tr></table></figure></p>
<p>then just give the script to <code>/etc/cron.daily</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp scripts/backup.sh /etc/cron.daily/svn_backup.sh</span><br><span class="line">chmod +x /etc/cron.daily/svn_backup.sh</span><br></pre></td></tr></table></figure></p>
<p>That’s all.</p>
<h1 id="REF">REF</h1><p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">鳥哥的 Linux 私房菜 — 第十五章、例行性工作排程(crontab)</a><br><a href="http://www.cnblogs.com/ccdc/archive/2012/06/01/2529471.html" target="_blank" rel="external">centos中crontab（计时器）用法详解 - 长城的草 - 博客园</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/27/Crontabs-Guide/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/24/CentOS6-5使用RSYNC发布程序/" title="CentOS6.5使用RSYNC发布程序" itemprop="url">CentOS6.5使用RSYNC发布程序</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-24T11:53:51.000Z" itemprop="datePublished"> 发表于 2015-10-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>Rsync（remote synchronize）是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件，也可以使用 Rsync 同步本地硬盘中的不同目录。</p>
<blockquote>
<p>rsync is an <a href="http://www.opensource.org/" target="_blank" rel="external">open source</a> utility that provides fast incremental file transfer. rsync is freely available under the <a href="https://rsync.samba.org/GPL.html" target="_blank" rel="external">GNU General Public License</a> and is currently being maintained by <a href="http://opencoder.net/" target="_blank" rel="external">Wayne Davison</a>.<br>If you are running (1) an xattr-enabled rsync older than 3.0.2, (2) a writable rsync daemon older than 3.0.0, or (3) a version of rsync older than 2.6.6, please see the <a href="https://rsync.samba.org/security.html" target="_blank" rel="external">rsync security advisory page</a>.</p>
</blockquote>
<p>本次将使用此工具与SVN配合，通过SVN进行版本控制，上传代码之后，自动同步发布到线上。</p>
<h2 id="安装">安装</h2><p>查询现有版本并安装。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">rpm -qa | grep rsync</span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">rpm <span class="operator">-e</span> rsync</span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget http://pkgs.repoforge.org/rsync/rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">rpm -ivh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 直接升级</span></span><br><span class="line">rpm -Uvh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>自然，你可以通过<code>yum</code>安装，不过版本较低：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">9</span>.el6_4.<span class="number">1</span> will be updated</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">12</span>.el6 will be an update</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br></pre></td></tr></table></figure></p>
<h2 id="配置">配置</h2><h3 id="初始配置">初始配置</h3><ul>
<li>选择rsync服务器启动方式：<ol>
<li>rsync服务器负载较高，则使用独立启动模式</li>
<li>rsync服务器负载较低，使用xinetd运行方式</li>
</ol>
</li>
<li>创建配置文件rsyncd.conf</li>
<li>对于非匿名方式访问的rsync服务器创建配置口令（建议配置需要口令访问）<br>CentOS 默认以xinetd模式运行rsync，rsync的xinetd配置文件是/etc/xinetd.d/rsync<br>如果配置rsync以xinetd模式运行，执行如下命令<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rsync on</span><br><span class="line">service xinetd restart</span><br><span class="line"><span class="preprocessor"># 如果执行 service xinetd restart 发现 xinetd: unrecognized service 则未安装xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 执行 yum install xinetd 安装 xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 安装之后启动 xinetd服务(service xinetd start)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>编辑rsync的xinetd配置文件/etc/xinetd.d/rsync文件，修改参数 server_args = —daemon —config=/etc/rsyncd/rsyncd.conf 可以配置rsync服务器启动时的参数</p>
<p>如果使用独立运行模式，则执行如下命令<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/rsync <span class="comment">--daemon</span></span><br><span class="line">#编辑 /etc/rc.<span class="keyword">local</span>文件 加入 /usr/bin/rsync <span class="comment">--daemon 保证每次开机启动都会自动启动rsync服务</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置设置">配置设置</h3><p>创建配置目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建rsync服务目录</span></span><br><span class="line">mkdir /etc/rsyncd</span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.conf</span><br><span class="line"><span class="comment"># 创建密码文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="comment">#权限修改</span></span><br><span class="line">chown root:root /etc/rsyncd/rsyncd.passwd</span><br><span class="line">chmod <span class="number">600</span> /etc/rsyncd/rsyncd.passwd</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root                         </span><br><span class="line">gid = root                                  </span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span>                      </span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid             </span><br><span class="line"></span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line">#<span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span>           </span><br><span class="line"></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd        </span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"></span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[hwangjrhome]</span><br><span class="line"><span class="keyword">path</span> = /home/hwangjr/</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = hwangjr</span><br><span class="line"><span class="keyword">comment</span> = HwangJR home</span><br><span class="line"><span class="keyword">exclude</span> = important/</span><br><span class="line"></span><br><span class="line">[chinatmp]</span><br><span class="line"><span class="keyword">path</span> = /tmp/china/</span><br><span class="line"><span class="keyword">list</span>=<span class="keyword">no</span></span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = china</span><br><span class="line"><span class="keyword">comment</span> = tmp china</span></span><br></pre></td></tr></table></figure></p>
<p>密码文件：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">hwangjr:</span>asdf             <span class="preprocessor">#格式   用户名:口令</span></span><br><span class="line"><span class="label">china:</span>jk               <span class="preprocessor">#该用户不要求是系统用户</span></span><br></pre></td></tr></table></figure></p>
<p>查看服务是否启动：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an <span class="string">| grep 873</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自动同步">自动同步</h3><p>编辑crontab<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure></p>
<p>加入同步命令：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 每天<span class="number">0</span>点<span class="number">10</span>分执行后面的命令</span></span><br><span class="line"><span class="number">10</span> <span class="number">0</span> * * * rsync -avzP  --<span class="keyword">delete</span>  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端配置">客户端配置</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 安装客户端</span></span><br><span class="line">yum -y install rsync</span><br><span class="line"><span class="preprocessor"># 同步命令</span></span><br><span class="line"><span class="preprocessor"># -a 参数，相当于-rlptgoD</span></span><br><span class="line"><span class="preprocessor">#   -r 是递归 -l 是链接文件，意思是拷贝链接文件；-p 表示保持文件原有权限</span></span><br><span class="line"><span class="preprocessor">#   -t 保持文件原有时间；-g 保持文#件原有用户组；-o 保持文件原有属主；-D 相当于块设备文件</span></span><br><span class="line"><span class="preprocessor"># -z 传输时压缩；</span></span><br><span class="line"><span class="preprocessor"># -P 传输进度；</span></span><br><span class="line"><span class="preprocessor"># -v 传输时的进度等信息，和-P有点关系，自己试试。可以看文档；</span></span><br><span class="line"><span class="preprocessor"># 同步</span></span><br><span class="line">rsync -avzP hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 客户端数据和服务器端数据保持一致</span></span><br><span class="line"><span class="preprocessor"># –delete 选项，表示客户端上的数据要与服务器端完全一致，如果 /tmp/hwangjr/目录中有服务器上不存在的文件，则删除。最终目的是让/tmp/hwangjr/目录上的数据完全与服务器上保持一致；用的时候要小心点，最好不要把已经有重要数所据的目录，当做本地更新目录，否则会把你的数据全部删除</span></span><br><span class="line">rsync -avzP  --delete hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 指定传输时候的密码文件，密码文件权限 600</span></span><br><span class="line"><span class="preprocessor"># –password-file=rsync.password ，这时当我们以hwangjr用户登录rsync服务器同步数据时，密码将读取 /tmp/rsync.password 这个文件。这个文件内容只是hwangjr用户的密码。我们要如下做；</span></span><br><span class="line"><span class="preprocessor"># touch /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># chmod 600 /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># echo "asdf"&gt; /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@172.16.1.135::hwangjrhome  /tmp/hwangjr/</span></span><br><span class="line"><span class="preprocessor"># 注： 这样就不需要密码了，服务器通过crond 计划任务自动同步</span></span><br><span class="line">rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure>
<h3 id="配置语法">配置语法</h3><blockquote>
<ul>
<li><strong>模块</strong>：<br>  以[模块名称]开始</li>
<li><strong>参数配置行</strong>：<br>  格式 name = value<br>  其中 value的值可以是string(可以不使用引号)或者boolean(0/1,true/false,yes/no)</li>
<li><strong>以#开始是注释行</strong></li>
<li><strong>以\是续行符</strong></li>
</ul>
</blockquote>
<ol>
<li><p>全局参数（[模块名称]之外的配置均为全局配置）<br><strong>address</strong><br>在独立运行时，用于指定的服务器运行的 IP 地址。由 xinetd 运行时将忽略此参数，使用命令行上的 –address 选项替代<br>默认值 本地所有IP<br><strong>port</strong><br>指定 rsync 守护进程监听的端口号。 由 xinetd 运行时将忽略此参数，使用命令行上的–port 选项替代。<br>默认值是 873<br><strong>motd file</strong><br>指定一个消息文件，当客户连接服务器时该文件的内容显示给客户。<br>默认值无<br><strong>pid file</strong><br>rsync 的守护进程将其 PID 写入指定的文件。<br>默认值 无<br><strong>log file</strong><br>指定 rsync 守护进程的日志文件，而不将日志发送给 syslog。<br>默认值 无<br><strong>syslog facility</strong><br>指定 rsync 发送日志消息给 syslog 时的消息级别<br>默认值 daemon<br><strong>socket options</strong><br>指定自定义 TCP 选项。<br>默认值无</p>
</li>
<li><p>模块参数<br>模块参数主要用于定义 rsync 服务器哪个目录要被同步。模块声明的格式必须为 [module] 形式，这个名字就是在 rsync 客户端看到的名字，类似于 Samba 服务器提供的共享名。而服务器真正同步的数据是通过 path 来指定的。可以根据自己的需要，来指定多个模块，模块中可以定义以下参数：</p>
</li>
</ol>
<ul>
<li>基本模块参数<br><strong>path</strong><br>指定当前模块在 rsync 服务器上的同步路径，该参数是必须指定的<br><strong>comment</strong><br>给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户<br>模块控制参数<br><strong>use chroot</strong><br>若为 true，则 rsync 在传输文件之前首先 chroot 到 path 参数所指定的目录下。这样做的原因是实现额外的安全防护，但是缺点是需要 root 权限，并且不能备份指向 path 外部的符号连接所指向的目录文件。<br>默认值true<br><strong>uid</strong><br>指定该模块以指定的 UID 传输文件。<br>默认值 nobody<br><strong>gid</strong><br>指定该模块以指定的 GID 传输文件。<br>默认值 nobody<br><strong>max connections</strong><br>定该模块的最大并发连接数量以保护服务器，超过限制的连接请求将被告知随后再试。<br>默认值 0 不限制<br><strong>read only</strong><br>指定是否允许客户上传文件。若为 true 则不允许上传；若为 false 并且服务器目录也具有读写权限则允许上传。<br>默认值 true<br><strong>write only</strong><br>指定是否允许客户下载文件。若为 true 则不允许下载；若为 false 并且服务器目录也具有读权限则允许下载。<br>默认值 false<br>模块认证参数<br><strong>hosts allow</strong><br>用一个主机列表指定哪些主机客户允许连接该模块。不匹配主机列表的主机将被拒绝<br>默认值 <em><br><strong>hosts deny</strong><br>用一个主机列表指定哪些主机客户不允许连接该模块。<br>默认值 空<br><strong>auth users</strong><br>指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块。这里的用户和系统用户没有任何关系。用户名和口令以明文方式存放在 secrets file 参数指定的文件中<br>默认匿名<br><strong>secrets file</strong><br>指定一个 rsync 认证口令文件。只有在 auth users 被定义时，该文件才起作用。<br>默认值 空<br><em>*strict modes</em></em><br>指定是否监测口令文件的权限。若为 true 则口令文件只能被 rsync 服务器运行身份的用户访问，其他任何用户不可以访问该文件。<br>默认值 true</li>
</ul>
<p>其中客户主机列表定义可以是以下形式：</p>
<blockquote>
<p>单个IP地址 例如：192.168.0.1<br>整个网段 例如：192.168.0.0/24，192.168.0.0/255.255.255.0<br>可解析的单个主机名 例如：centos，centos.bsmart.cn<br>域内的所有主机 例如：.bsmart.cn<br>“”则表示所有。<br>多个列表项要用空格间隔。</p>
</blockquote>
<p>而认证口令则：</p>
<blockquote>
<p>rsync 认证口令文件的权限一定是 600，否则客户端将不能连接服务器。<br>rsync 认证口令文件中每一行指定一个 用户名:口令 对，格式为：username:passwd<br>一般来说口令最好不要超过8个字符。若您只配置匿名访问的 rsync 服务器，则无需设置上述参数。</p>
</blockquote>
<h2 id="SVN同步实例">SVN同步实例</h2><p>基本思路就是，当发生commit时，触发服务端svn数据目录update，也触发rsync去同步网站目录。</p>
<h3 id="服务器配置文件">服务器配置文件</h3><p>编辑配置文件：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/rsyncd/rsyncd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<p>配置文件为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid</span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd</span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[kksvn]</span><br><span class="line"><span class="keyword">path</span> = /home/svn/rsyncd/kk</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = kksvn</span><br><span class="line"><span class="keyword">comment</span> = KK SVN</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>use chroot=no 时，同步后DES的文件主或组如果有，则显示名，即使ID不一样；<br>use chroot=yes时，如果两台机器同名的ID不同，则服务端只会显示SRC的ID，造成权限问题。</p>
</blockquote>
<p>编辑rsync的用户认证配置文件<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /etc/rsyncd/rsyncd.passwd</span></span><br><span class="line">kksvn:kksvn</span><br><span class="line"><span class="preprocessor">#chmod 600 /etc/rsyncd/rsyncd.passwd</span></span><br></pre></td></tr></table></figure></p>
<p>启动服务：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/rsync --daemon --config=/</span>etc<span class="regexp">/rsyncd/</span>rsyncd.conf</span><br><span class="line">echo <span class="string">"/usr/bin/rsync --daemon"</span> &gt;&gt;<span class="regexp">/etc/</span>rc.local</span><br></pre></td></tr></table></figure></p>
<p>注：修改配置文件和用户密码不需要重启服务</p>
<h3 id="客户端测试">客户端测试</h3><p>客户端测试：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line">kksvn</span><br><span class="line"><span class="preprocessor"># chmod <span class="number">600</span> /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line"><span class="preprocessor"># rsync -avzp --progress --delete --exclude=.svn --password-file=/home/svn/rsyncd/conf/rsyncd.passwd kksvn@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>::kksvn /tmp/kk</span></span><br></pre></td></tr></table></figure></p>
<h3 id="SVN配置">SVN配置</h3><p>配置钩子：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br><span class="line">chmod +x <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br></pre></td></tr></table></figure></p>
<p>post-commit内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=zh_CN.UTF-<span class="number">8</span></span><br><span class="line">/usr/bin/svn update /home/svn/rsyncd/kke</span><br><span class="line"><span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    /bin/bash /home/svn/rsyncd/scripts/kke_rsync.sh &gt; /dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>kke_rsync.sh内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"></span><br><span class="line">IP=<span class="string">"127.0.0.1"</span></span><br><span class="line">Auth_module=<span class="string">"kksvn"</span></span><br><span class="line">Localdir=<span class="string">"/tmp/kk"</span></span><br><span class="line">Auth_user=<span class="string">"kksvn"</span></span><br><span class="line">Passwd_file=<span class="string">"/home/svn/rsyncd/conf/rsyncd.passwd"</span></span><br><span class="line">Exc=<span class="string">" --exclude=.svn"</span></span><br><span class="line">/usr/bin/rsync -vrtopgl --progress --delete <span class="variable">$&#123;Exc&#125;</span> --password-file=<span class="variable">$&#123;Passwd_file&#125;</span> <span class="variable">$Auth_user</span>@<span class="variable">$&#123;IP&#125;</span>::<span class="variable">$&#123;Auth_module&#125;</span> <span class="variable">$&#123;Localdir&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="拓展">拓展</h2><h3 id="通过exclude排除多个文件/目录">通过exclude排除多个文件/目录</h3><p>使用rsync -av –exclude=.svn /home/hwangjr/t1 /home/hwangjr/t2 只能排除.svn文件/目录。但如果要排除多个文件/目录，就需要新建个exclude.list，然后rsync -av –exclude-from=”exclude.list”指定不需要同步的文件/目录。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将/home/hwangjr/t1目录拷贝到/home/hwangjr/t2目录下，/home/hwangjr/exclude.list中指定文件不拷贝</span></span><br><span class="line">rsync -av --exclude-from=<span class="regexp">/home/hwangjr</span><span class="regexp">/exclude.list /home</span><span class="regexp">/hwangjr/t</span>1 /home/hwangjr/t2</span><br></pre></td></tr></table></figure></p>
<p>exclude.list里面填写要排除的文件/目录，一行一个，直接写文件名即可。如果要排除a,b.1,b.2,tmp/g，那么exclude.list里就应该写：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">a</span></span><br><span class="line"><span class="regexp">b.*</span></span><br><span class="line">tmp/g</span><br></pre></td></tr></table></figure></p>
<p>不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>也不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>SO：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">–<span class="keyword">exclude</span>=PATTERN <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">exclude</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">exclude</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br><span class="line">–<span class="keyword">include</span>=PATTERN don’t <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">include</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">include</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br></pre></td></tr></table></figure></p>
<h2 id="REF">REF</h2><p><a href="https://download.samba.org/pub/rsync/src/" target="_blank" rel="external">Index of /pub/rsync/src</a><br><a href="https://rsync.samba.org/" target="_blank" rel="external">rsync</a><br><a href="http://pkgs.repoforge.org/rsync/" target="_blank" rel="external">Index of /rsync</a><br><a href="http://segmentfault.com/a/1190000002502991" target="_blank" rel="external">CentOS 6.5下rsync服务器安装配置 - SegmentFault</a><br><a href="http://my.oschina.net/duguaoxue/blog/496228" target="_blank" rel="external">CentOS 6.3下rsync服务器的安装与配置 - longjian的个人页面 - 开源中国社区</a><br><a href="http://wjw7702.blog.51cto.com/5210820/1148808" target="_blank" rel="external">Rsync常见错误及命令详细参数 - 彼岸 - 51CTO技术博客</a><br><a href="http://sndapk.blog.51cto.com/5385144/1360384" target="_blank" rel="external">svn+rsync实时发布程序 - notepad - 51CTO技术博客</a><br><a href="http://www.ttlsa.com/svn/linux-svn-rsync-inotify/" target="_blank" rel="external">linux下svn+rsync+inotify实现代码自动同步 - 运维生存时间</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/24/CentOS6-5使用RSYNC发布程序/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/23/阿里CentOS-6-iptables配置/" title="阿里CentOS 6 iptables配置" itemprop="url">阿里CentOS 6 iptables配置</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-23T10:31:08.000Z" itemprop="datePublished"> 发表于 2015-10-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>就是，配置防火墙，防止被鲁。</p>
<p>iptables的命令格式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] <span class="built_in">command</span> [chain] [rules] [-j target]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>[-t table] ：用来指明使用的表， 有三种选项: filter, nat 和 mangle，如果未指定，则使用filter作为缺省表。 事实上，对于单个服务器的防火墙配置，一般来讲，我们只需要对filter表进行配件就OK了。filter表包括 INPUT, OUTPUT,和FORWARD三个chain.</p>
</li>
<li><p>command 表明iptables命名要做什么，比如</p>
</li>
<li><p>-A （–append): 该命令会把一条规则附件到chain的末尾。</p>
</li>
<li><p>-D（–delete)用来删除某个规则。</p>
</li>
<li><p>-F （–flush) 如果指定了chain, 删除该chain中的所有规则，如果未指定chain, 则删除所有chain中的所有规则。</p>
</li>
<li><p>target: 是由规则指定的操作。 包括下面几种：</p>
</li>
<li><p>ACCEPT: 接收信息包(允许它前往目的地），并且将停止遍历chain.</p>
</li>
<li><p>DROP：  拒绝，</p>
</li>
</ul>
<p>此外还有REJECT, RETURN, LOG, REDIRECT, MARK, MIRROR, MAQUERADE等。</p>
<p>具体的iptables的语法和概念就不再多说了，请参照<a href="http://linux.die.net/man/8/iptables" target="_blank" rel="external">iptables man page</a>官方文档 .</p>
<p>简单来说，iptables防火墙是由一系列的规则(rule)组成，  一个数据请求进来， 会依次和这些规则进行比较，如果正好符合规则的定义，那这个数据请求要么会被接收ACCEPT，要么被拒绝DRIP。如果不符合任何规则的定义，最后缺省的规则会被应用。</p>
<h2 id="配置">配置</h2><p>SSH的端口22自然是需要开放的，否则我们就无法登录服务器了。CentOS的VPS经常作为用LAMP搭建的Web服务器，FTP服务器， Mail服务器等。</p>
<ul>
<li><p>对于Web服务来说，需要开放80端口，如果是HTTPS/SSL协议的话，还需用开放443端口。</p>
</li>
<li><p>对于Mail服务来说，由于涉及SMTP, POP3, IMAP协议，需要开放的端口：SMTP : 25   Secure SMTP:465  POP3: 110   Secure POP3: 995   IMAP: 143   IMAP over SSL: 993。</p>
</li>
<li><p>对于FTP服务来说，需要开放 20, 21两个端口。</p>
</li>
</ul>
<h3 id="屏蔽常见攻击">屏蔽常见攻击</h3><p>缺省情况下，CentOS的iptables的设置是允许任何数据通过的。我们首先要清空iptables中的所有的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure></p>
<p>然后我们加上阻止简单扫描和攻击的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP             <span class="comment">#NONE 包(所有标识bit都没有设置)主要是扫描类的数据包</span></span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP     <span class="comment">#防止sync-flood 攻击</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP              <span class="comment">#ALL包（所有的标注bit都被设置了）也是网络扫描的数据包</span></span><br></pre></td></tr></table></figure></p>
<p>关于sync-flood, 请参照<a href="http://en.wikipedia.org/wiki/SYN_flood" target="_blank" rel="external">wikipedia</a>的解释。</p>
<h3 id="相应服务开放端口">相应服务开放端口</h3><p>首先我们应该接受本机localhost的任何请求，否则，数据库连接等将无法工作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>对于不同的服务需要开放不同的端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT      <span class="comment"># SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT      <span class="comment"># HTTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">443</span> -j ACCEPT     <span class="comment">#HTTPS</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">25</span> -j ACCEPT   <span class="comment">#SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">465</span>  -j ACCEPT <span class="comment">#Secure SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">110</span> -j ACCEPT   <span class="comment">#POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">995</span> -j ACCEPT   <span class="comment">#Secure POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">143</span> -j ACCEPT   <span class="comment">#IMAP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">993</span> -j ACCEPT   <span class="comment">#Secure IMAP</span></span><br></pre></td></tr></table></figure></p>
<h3 id="通用规则">通用规则</h3><p>首先要允许所有从服务器端发起的连接，由此返回的响应数据应该是允许的！比如VPS发起的yum update , 必须要允许外部的update数据进来：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -m <span class="keyword">state</span>  --state ESTABLISHED, RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>最后，设置缺省的策略：屏蔽任何进入的数据请求，允许所有从Server发出的请求<br><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -<span class="keyword">P</span> OUTPUT <span class="keyword">ACC</span>EPT</span><br><span class="line">iptables -<span class="keyword">P</span> INPUT DROP</span><br></pre></td></tr></table></figure></p>
<h3 id="保存设置">保存设置</h3><p>首先通过下面的命令查看一下我们的设置是否正确！<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptable -<span class="keyword">L</span> -<span class="keyword">n</span></span><br></pre></td></tr></table></figure></p>
<p>确认没有问题后，执行下面的命令<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables <span class="keyword">save</span></span><br></pre></td></tr></table></figure></p>
<p>执行上述命令后，相应的规则会写入 /etc/sysconfig/iptables这个文件，你可以检查一下看看。</p>
<p>最后执行<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">service</span> iptables restart</span><br></pre></td></tr></table></figure></p>
<p>重新启动iptables防火墙，以使上述设置生效。</p>
<h3 id="自动化">自动化</h3><p>为了更方便的修改和维护自己的iptables的设置，我一般是把所有的iptables的设置先写到一个单独文件中，测试没有问题后。然后再保存到iptable的配置文件中。</p>
<p>放大招，sh配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># A simple iptables firewall configuration</span></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin; <span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#flush/erase original rules</span></span><br><span class="line">iptables -F <span class="comment">#清除所有已制定的rule</span></span><br><span class="line">iptables -X <span class="comment">#清除用户自定义的chain/table</span></span><br><span class="line">iptables -Z <span class="comment">#将所有的chain的计数和流量统计归零</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept localhost connetting, no matter what it is</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept any response package which is initiated from inside</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#block most common network attacks(recon packets and syn-flood attack)</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#open ports for different services</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT <span class="comment">#SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT <span class="comment">#HTTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 443 -j ACCEPT #HTTPS</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 25 -j ACCEPT #SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 465 -j ACCEPT #Secure SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 110 -j ACCEPT #POP3</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 995 -j ACCEPT #Secure POP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ICMP configuration</span></span><br><span class="line"><span class="comment">#To prevent ICMP DDOS,we do not allow ICMP type 8(echo-request) or limit this request with 1/second</span></span><br><span class="line"><span class="comment">#some ICMP requests are allowed.</span></span><br><span class="line">icmp_<span class="built_in">type</span>=<span class="string">"0 3 4 11 12 14 16 18"</span></span><br><span class="line"><span class="keyword">for</span> ticmp <span class="keyword">in</span> <span class="variable">$icmp_type</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    iptables -A INPUT -p icmp --icmp-type <span class="variable">$ticmp</span> -j ACCEPT</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 1/second -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#default policies</span></span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#save to /etc/sysconfig/iptables</span></span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<h2 id="常用命令">常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables</span><br><span class="line"><span class="comment"># 检测状态</span></span><br><span class="line">service iptables status</span><br><span class="line">service iptables start</span><br><span class="line"><span class="comment"># 查看当前配置</span></span><br><span class="line">iptables -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受一切请求</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空默认所有规则</span></span><br><span class="line">iptables -F</span><br><span class="line"><span class="comment"># 清空自定义所有规则</span></span><br><span class="line">iptables -X</span><br><span class="line"><span class="comment"># 清除计数器</span></span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line">service iptables save</span><br><span class="line">chkconfig iptables on</span><br></pre></td></tr></table></figure>
<h2 id="REF">REF</h2><p><a href="http://www.androiddev.net/centos-6-iptables-firewall/" target="_blank" rel="external">为CentOS 6设置IPTables防火墙 | 码农日记</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/23/阿里CentOS-6-iptables配置/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/Books/" title="Books">Books<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CI/" title="CI">CI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/tech/" title="tech">tech<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/创业/" title="创业">创业<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/tech/" title="tech">tech<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/创业/" title="创业">创业<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ci/" title="ci">ci<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Books/" title="Books">Books<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://blog.hwangjr.com" target="_blank" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, Welcome to my blog. <br/>
			I&#39;m HwangJR, Tech change the world.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1234193120" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/hwangjr" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/4827228" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/HuangJR" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/https://facebook.com/jr.hwang.2010" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		
		
		<a href="https://www.zhihu.com/people/hwangjr" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		<a href="https://plus.google.com/+JianrongHuang?rel=author" target="_blank" class="icon-google_plus" title="Google+"></a>
		
		
		<a href="mailto:huangjianrong2010@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="HwangJR">HwangJR</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'HwangJR';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-63911310-1', 'hwangjr.github.io');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<script>
var option = {
  engineKey: '6e8f6d9aa88722365432'
};
(function(w,d,t,u,n,s,e){
  s = d.createElement(t);
  s.src = u;
  s.async = 1;
  w[n] = function(r){
    w[n].opts = r;
  };
  e = d.getElementsByTagName(t)[0];
  e.parentNode.insertBefore(s, e);
})(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
_ts(option);
</script>

<!-- Tiny_search End -->

  </body>
 </html>
