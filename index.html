
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>HwangJR&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="HwangJR">
    

    
    <meta name="description" content="Some stuff about tech etc..">
<meta property="og:type" content="website">
<meta property="og:title" content="HwangJR's Blog">
<meta property="og:url" content="https://hwangjr.github.io/index.html">
<meta property="og:site_name" content="HwangJR's Blog">
<meta property="og:description" content="Some stuff about tech etc..">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HwangJR's Blog">
<meta name="twitter:description" content="Some stuff about tech etc..">
<meta name="twitter:creator" content="@HuangJR">
<link rel="publisher" href="+JianrongHuang">

    
    <link rel="alternative" href="/atom.xml" title="HwangJR&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HwangJR&#39;s Blog" title="HwangJR&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a></h1>
				<h2 class="blog-motto">Life is wonderful!</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="ts-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/02/Android-HotFix方案/" title="Android HotFix方案" itemprop="url">Android HotFix方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-03-02T12:14:44.000Z" itemprop="datePublished"> 发表于 2016-03-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>随着开发需求的不断迫切，目前开源已经涌现了很多Hot Fix项目，但是从方案上来说，主要是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的<a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>；以方法hook，从Field切入的<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">AndFix</a>；<a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">Dex分包</a>的<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>。而相同原理的不同实现有很多，这里就不再累赘。这三个实现原理截然不同，各有各自优缺点，让我们走近这几个方案。</p>
<h1 id="方案揭秘">方案揭秘</h1><h2 id="Dexposed">Dexposed</h2><p><a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的AOP框架，方法级别粒度，而且不仅可以Hot Fix，还可进行AOP编程、插桩、Hook等功能。</p>
<p>Xposed是需要ROOT权限，因为其要修改其他应用及系统行为，而对于单个应用而言，不需要ROOT。Xposed基本原理是：通过修改Dalvik运行时的Zygote进程，使用Xposed Bridge来hook方法并注入自身代码，实现非侵入式的Runtime修改。包括小米（<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_dalvik.cpp" target="_blank" rel="external">onVmCreated方法</a>），也利用此特性，做了自定义主题、沉浸式状态栏等功能。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called very early during VM startup. */</span></span><br><span class="line"><span class="literal">void</span> onVmCreated(JNIEnv* env) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="subst">!</span>initMemberOffsets(env))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    jclass classMiuiResources = env<span class="subst">-&gt;</span>FindClass(CLASS_MIUI_RESOURCES);</span><br><span class="line">    <span class="keyword">if</span> (classMiuiResources != <span class="built_in">NULL</span>) &#123;</span><br><span class="line">        ClassObject* clazz = (ClassObject*)dvmDecodeIndirectRef(dvmThreadSelf(), classMiuiResources);</span><br><span class="line">        <span class="keyword">if</span> (dvmIsFinalClass(clazz)) &#123;</span><br><span class="line">            ALOGD(<span class="string">"Removing final flag for class '%s'"</span>, CLASS_MIUI_RESOURCES);</span><br><span class="line">            clazz<span class="subst">-&gt;</span>accessFlags <span class="subst">&amp;</span>= ~ACC_FINAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    env<span class="subst">-&gt;</span>ExceptionClear();</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>应用启动时，会fork zygote进程，装载class和invoke各种初始化方法，Xposed就是在这个过程替换了app_process，hook各个入口方法，加载XposedBridge.jar提供动态hook基础，具体查看<a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="external">XposedBridge</a>。</p>
<p>具体的Native实现则是在<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_common.cpp" target="_blank" rel="external">libxposed_common.cpp</a>里面，根据系统版本进行分发到libxposed_dalvik或libxposed_art，记录下原来方法信息，将方法指针指向hookedMethodCallback，从而达到劫持目的。</p>
<p>此方式只能对JAVA方法做拦截，不支持C方法。如果线上RELEASE版本进行混淆，patch也是一个痛苦事情，反射和内部类、包名和内部类冲突等处理很繁琐。</p>
<p>针对Xposed<strong>不支持ART</strong>这个事情，现在应该已经解决了，具体移步<a href="https://github.com/rovo89/android_art" target="_blank" rel="external">rovo89/android_art</a>。</p>
<h2 id="AndFix">AndFix</h2><p>简单来说，主要通过补丁工具，利用注解等，描述其与要打补丁的类和方法的对应关系，之后在应用中，加载并替换方法的信息和指针，从而达到热修复目的。里面的实现可能还涉及到其他的部分，比如Security检查、PATCH覆盖等。</p>
<p>化繁为简，直接上核心代码，先以ART（不同版本差异不大，以6.0为例）为例：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> replace_6_0(JNIEnv* env, jobject src, jobject dest) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* smeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(src);</span><br><span class="line"></span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* dmeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(dest);</span><br><span class="line"></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_; <span class="comment">//for plugin classloader</span></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_;</span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_ = smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改原方法属性为补丁方法</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>declaring_class_ = dmeth<span class="subst">-&gt;</span>declaring_class_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_types_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_types_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>access_flags_ = dmeth<span class="subst">-&gt;</span>access_flags_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_code_item_offset_ = dmeth<span class="subst">-&gt;</span>dex_code_item_offset_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>method_index_ = dmeth<span class="subst">-&gt;</span>method_index_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_method_index_ = dmeth<span class="subst">-&gt;</span>dex_method_index_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改实现指针</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_;</span><br><span class="line"></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_;</span><br><span class="line"></span><br><span class="line">	LOGD(<span class="string">"replace_6_0: %d , %d"</span>,</span><br><span class="line">			smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_,</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将方法修改为PUBLIC</span></span><br><span class="line"><span class="literal">void</span> setFieldFlag_6_0(JNIEnv* env, jobject field) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtField</span>* artField =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtField</span>*) env<span class="subst">-&gt;</span>FromReflectedField(field);</span><br><span class="line">	artField<span class="subst">-&gt;</span>access_flags_ = artField<span class="subst">-&gt;</span>access_flags_ <span class="subst">&amp;</span> (~<span class="number">0x0002</span>) | <span class="number">0x0001</span>;</span><br><span class="line">	LOGD(<span class="string">"setFieldFlag_6_0: %d "</span>, artField<span class="subst">-&gt;</span>access_flags_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Dalvik上的实现略有不同，先指向到<code>dalvik_dispatcher</code>，之后在里面进行补丁方法的调用和返回，也就是通过JNI Bridge来指向补丁方法。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="type">void</span> __attribute__ ((visibility (<span class="string">"hidden"</span>))) dalvik_replaceMethod(</span><br><span class="line">		<span class="type">JNIEnv</span>* env, jobject src, jobject dest) &#123;</span><br><span class="line">	jobject clazz = env-&gt;<span class="type">CallObjectMethod</span>(dest, jClassMethod);</span><br><span class="line">	<span class="type">ClassObject</span>* clz = (<span class="type">ClassObject</span>*) dvmDecodeIndirectRef_fnPtr(</span><br><span class="line">			dvmThreadSelf_fnPtr(), clazz);</span><br><span class="line">	clz-&gt;status = <span class="type">CLASS_INITIALIZED</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(src);</span><br><span class="line">	<span class="type">Method</span>* target = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(dest);</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvikMethod: %s"</span>, meth-&gt;name);</span><br><span class="line"></span><br><span class="line">	meth-&gt;jniArgInfo = <span class="number">0x80000000</span>;</span><br><span class="line">	meth-&gt;accessFlags |= <span class="type">ACC_NATIVE</span>;</span><br><span class="line"></span><br><span class="line">    // 将目标方法赋值到附带值上</span><br><span class="line">	<span class="type">int</span> argsSize = dvmComputeMethodArgsSize_fnPtr(meth);</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth))</span><br><span class="line">		argsSize++;</span><br><span class="line">	meth-&gt;registersSize = meth-&gt;insSize = argsSize;</span><br><span class="line">	meth-&gt;insns = (<span class="type">void</span>*) target;</span><br><span class="line"></span><br><span class="line">    // 指向本地的dispatcher方法</span><br><span class="line">	meth-&gt;nativeFunc = dalvik_dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> dalvik_dispatcher(<span class="keyword">const</span> u4* args, jvalue* pResult,</span><br><span class="line">		<span class="keyword">const</span> <span class="type">Method</span>* <span class="keyword">method</span>, <span class="type">void</span>* self) &#123;</span><br><span class="line">	<span class="type">ClassObject</span>* returnType;</span><br><span class="line">	jvalue <span class="literal">result</span>;</span><br><span class="line">	<span class="type">ArrayObject</span>* argArray;</span><br><span class="line"></span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher source method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) <span class="keyword">method</span>-&gt;insns;</span><br><span class="line">	meth-&gt;accessFlags = meth-&gt;accessFlags | <span class="type">ACC_PUBLIC</span>;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher target method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line"></span><br><span class="line">	returnType = dvmGetBoxedReturnType_fnPtr(<span class="keyword">method</span>);</span><br><span class="line">	<span class="keyword">if</span> (returnType == <span class="type">NULL</span>) &#123;</span><br><span class="line">		assert(dvmCheckException_fnPtr(self));</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher start call-&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    // 是否静态方法</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth)) &#123;</span><br><span class="line">		<span class="type">Object</span>* thisObj = (<span class="type">Object</span>*) args[<span class="number">0</span>];</span><br><span class="line">		<span class="type">ClassObject</span>* tmp = thisObj-&gt;clazz;</span><br><span class="line">		thisObj-&gt;clazz = meth-&gt;clazz;</span><br><span class="line">		argArray = boxMethodArgs(meth, args + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line"></span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, thisObj,</span><br><span class="line">				argArray);</span><br><span class="line"></span><br><span class="line">		thisObj-&gt;clazz = tmp;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		argArray = boxMethodArgs(meth, args);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, <span class="type">NULL</span>,</span><br><span class="line">				argArray);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dvmCheckException_fnPtr(self)) &#123;</span><br><span class="line">		<span class="type">Object</span>* excep = dvmGetException_fnPtr(self);</span><br><span class="line">		jni_env-&gt;<span class="type">Throw</span>((jthrowable) excep);</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (returnType-&gt;primitiveType == <span class="type">PRIM_VOID</span>) &#123;</span><br><span class="line">		<span class="type">LOGD</span>(<span class="string">"+++ ignoring return to void"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">result</span>.l == <span class="type">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (dvmIsPrimitiveClass(returnType)) &#123;</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">NPEClazz</span>, <span class="string">"null result when primitive expected"</span>);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">		pResult-&gt;l = <span class="type">NULL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!dvmUnboxPrimitive_fnPtr(<span class="literal">result</span>.l, returnType, pResult)) &#123;</span><br><span class="line">			<span class="type">char</span> msg[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			snprintf(msg, sizeof(msg) - <span class="number">1</span>, <span class="string">"%s!=%s\0"</span>,</span><br><span class="line">					((<span class="type">Object</span>*) <span class="literal">result</span>.l)-&gt;clazz-&gt;descriptor,</span><br><span class="line">					returnType-&gt;descriptor);</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">CastEClazz</span>, msg);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bail: dvmReleaseTrackedAlloc_fnPtr((<span class="type">Object</span>*) argArray, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Multiple_Dex">Multiple Dex</h2><p>Multiple Dex的方案原来是为了突破65535的限制，其就是将多个Dex放到应用的ClassLoader之中，从而使所有的Dex的类都能被找到。实际上，在<code>findClass</code>过程中，如果重复的类，参照下面的类加载的实现，是会使用第一个找到的类。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">Class</span> <span class="title">findClass</span>(<span class="title">String</span> <span class="title">name</span>, <span class="title">List</span>&lt;<span class="title">Throwable</span>&gt; <span class="title">suppressed</span>) &#123;  </span></span><br><span class="line">    <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">        DexFile dex = element.dexFile;</span><br><span class="line">        <span class="keyword">if</span> (dex != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">Class</span> <span class="title">clazz</span> = <span class="title">dex</span>.<span class="title">loadClassBinaryName</span>(<span class="title">name</span>, <span class="title">definingContext</span>, <span class="title">suppressed</span>);</span></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="literal">null</span>) &#123;  </span><br><span class="line">        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而方法过多的原因其实也很明显：因为在Dalvik指令集里，调用方法的<code>invoke-kind</code>指令中，method reference index只给了16bits，最多能调用65535个方法，所以在生成Dex文件的过程中，当方法数超过65535就会报错。</p>
<blockquote>
<p>This number is significant in that it represents the total number of references that can be invoked by the code within a single Dalvik Executable (dex) bytecode file.</p>
</blockquote>
<p>该方法就是从这入手，将问题修复后，放到一个单独的Dex中，通过反射插入到<code>dexElements</code>数组的最前面，完成虚拟机打补丁的操作。</p>
<p>在此方案中，有一个问题就是，在运行加载类的时候会报<code>preverified</code>错误，在<code>DexPrepare.cpp</code>中，将Dex转化为ODex过程中，会在<code>DexVerify.cpp</code>中进行校验，验证如果直接引用到的类和clazz是否在同一个Dex，如果是则会打上<code>CLASS_ISPREVERIFIED</code>标志。通过在所有类（Application除外，此时还没加载自定义代码）的构造函数中插入一个对在单独Dex类的引用，来解决此问题。在空间中，是使用<code>javaassist</code>进行编译时字节码插入。</p>
<blockquote>
<p>当一个apk在安装的时候，apk中的classes.dex会被虚拟机(dexopt)优化成odex文件，然后才会拿去执行。<br>虚拟机在启动的时候，会有许多的启动参数，其中一项就是verify选项，当verify选项被打开的时候，就会执行dvmVerifyClass进行类的校验，如果dvmVerifyClass校验类成功，那么这个类会被打上CLASS_ISPREVERIFIED的标志。<br>怎么样算是校验类成功？如果static方法、private方法、构造函数等，其中的直接引用（第一层关系）到的类都在同一个Dex文件中，那么该类就会被打上CLASS_ISPREVERIFIED标志。<br>我们要做的就是，阻止该类打上CLASS_ISPREVERIFIED的标志。否则加载其他Dex的时候会报错。<br>注意下，是阻止引用者的类，也就是说，假设你的app里面有个类叫做LoadBugClass，再其内部引用了BugClass。发布过程中发现BugClass有编写错误，那么想要发布一个新的BugClass类，那么你就要阻止LoadBugClass这个类打上CLASS_ISPREVERIFIED的标志。<br>你在生成apk之前，就需要阻止相关类打上CLASS_ISPREVERIFIED的标志了。对于如何阻止，可让LoadBugClass在构造方法中，去引用别的dex文件，比如：hack.dex中的某个类即可。<br>空间使用的是在字节码插入代码,而不是源代码插入，使用的是javaassist库来进行字节码插入的。</p>
</blockquote>
<p>需要做的两件事：1、动态改变BaseDexClassLoader对象间接引用的dexElements；2、在app打包的时候，阻止相关类去打上CLASS_ISPREVERIFIED标志。</p>
<p>另外混淆问题，需要保存每个版本的<code>mapping</code>混淆文件，后续编译用相同的<code>mapping</code>文件，保证混淆过后类名始终一致。</p>
<p>此方式无法在已经加载好的类中实现动态替换，所以需要在类加载之前替换。也就是补丁下载下来之后，需要等待用户重启应用才可完成补丁效果。</p>
<p>目前开源实现有：<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>，<a href="https://github.com/dodola/HotFix" target="_blank" rel="external">HotFix</a>，<a href="https://github.com/bunnyblue/DroidFix" target="_blank" rel="external">DroidFix</a>，其各个版本也有做相应的兼容。</p>
<h1 id="方案对比">方案对比</h1><ol>
<li>Dexposed方法生成补丁难度较大，需要反射写混淆后的代码，粒度太细，如果替换方法很多的话，工作量巨大。</li>
<li>AndFix支持2.3 - 6.0系统，但JNI不像JAVA那样标准，所以偶尔会有未知的机型异常。从实现来说，类似Dexposed，通过JNI来替代方法，更加简洁的完成补丁修复，应用PATCH不需要重启。但由于实现上直接跳过了类初始化，设置为初始化完毕，所以静态函数、静态成员、构造函数都会出现问题，复杂的类<code>Class.forName</code>很可能直接崩溃。</li>
<li>Multiple Dex方案支持2.3 - 6.0系统，对启动速度会有略微影响，而且只能下次启动生效。</li>
</ol>
<p>相比而言，Multiple Dex方案较为可靠，但是如果Dex文件较为庞大，启动速度会变慢；而AndFix则适用于应用不重启即可修复，且方法够简单；Dexposed方案较为复杂，暂不考虑。</p>
<h1 id="REF">REF</h1><p><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=63&amp;highlight=ClassLoader" target="_blank" rel="external">当dex分包遇上NoClassDefFoundError&amp;ClassNotFoundException</a><br><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">让App像Web一样发布新版本</a><br><a href="http://blog.zhaiyifan.cn/2015/11/20/HotPatchCompare/" target="_blank" rel="external">各大热补丁方案分析和比较</a><br><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a&amp;scene=1&amp;srcid=1106Imu9ZgwybID13e7y2nEi#wechat_redirect" target="_blank" rel="external">安卓App热补丁动态修复技术介绍</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/49883661" target="_blank" rel="external">Android 热补丁动态修复框架小结</a><br><a href="https://github.com/dodola/HotFix" target="_blank" rel="external">dodola/HotFix: 安卓App热补丁动态修复框架</a><br><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external">美团Android DEX自动拆包及动态加载简介</a><br><a href="https://m.oschina.net/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="http://www.gitzx.com/android-inject-hook/" target="_blank" rel="external">Android下的挂钩(hook)和代码注入(inject)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/02/Android-HotFix方案/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/27/调试Android应用/" title="调试Android应用" itemprop="url">调试Android应用</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-27T02:05:43.000Z" itemprop="datePublished"> 发表于 2016-01-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>需要针对已经发布的Release包进行调试，而要调试应用程序，需要满足：</p>
<ol>
<li>应用Manifest文件中Application标签包含属性<code>android:debuggable=&quot;true&quot;</code></li>
<li><code>/default.prop</code>中<code>ro.debuggable</code>值为1</li>
</ol>
<p>针对上面限制，可选方案有：</p>
<ol>
<li>反编译应用修改Manifest，插入<code>android:debuggable=&quot;true&quot;</code></li>
<li>修改<code>boot.img</code>，将<code>ro.debuggable</code>修改为1</li>
<li>利用<a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed</a>进行hook并debug应用</li>
</ol>
<h1 id="实践">实践</h1><h2 id="使用Debuggable属性">使用<code>Debuggable</code>属性</h2><p>从官方文档可以看出（<a href="http://developer.android.com/intl/zh-cn/guide/topics/manifest/application-element.html#debug" target="_blank" rel="external">application</a>）：</p>
<blockquote>
<p>android:debuggable<br>Whether or not the application can be debugged, even when running on a device in user mode — “true” if it can be, and “false” if not. The default value is “false”.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">application</span></span><br><span class="line">	<span class="attribute">android:icon</span>=<span class="value">"@drawable/ic_launcher"</span></span><br><span class="line">	<span class="attribute">android:label</span>=<span class="value">"@string/app_name"</span></span><br><span class="line">	<span class="attribute">android:theme</span>=<span class="value">"@style/AppTheme"</span> </span><br><span class="line">	<span class="attribute">android:debuggable</span>=<span class="value">"true"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>正常情况下，IDE会根据自身的打包来配置debug属性，因此在Manifest中最好<strong>不</strong>设置<code>debuggable</code>属性，而由打包方式来决定。查看具体的APK的信息：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 查看应用信息，可查看android:debuggable，<span class="number">0x0</span>为false，<span class="number">0xffffffff</span>为true</span></span><br><span class="line">aapt <span class="built_in">list</span> -v -a apk.apk</span><br></pre></td></tr></table></figure></p>
<p>在应用中也可判断是否<code>debug</code>状态：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 自身应用</span><br><span class="line">public static boolean isDebuggable(Context context) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		ApplicationInfo info = context.getApplicationInfo();</span><br><span class="line">		return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 其他应用</span><br><span class="line">public static boolean isDebuggable(Context context,String packageName) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		PackageInfo pkgInfo = context.getPackageManager().getPackageInfo(packageName, 1);</span><br><span class="line">		if (pkgInfo != null ) &#123;</span><br><span class="line">			ApplicationInfo info = pkgInfo.applicationInfo;</span><br><span class="line">			return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>有的时候，我们还需要一些其他的方式或手段：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反编译apk，可修改smali及资源等</span></span><br><span class="line">apktool d apk.apk</span><br><span class="line"><span class="comment"># 修改Manifest，新增debuggable</span></span><br><span class="line">vim apk/AndroidManifest.xml</span><br><span class="line"><span class="comment"># 重新打包，apk文件在dist目录中，也可指定apk文件</span></span><br><span class="line">apktool b apk</span><br><span class="line"><span class="comment"># 更多信息</span></span><br><span class="line">apktool -h</span><br><span class="line"><span class="comment"># debug签名，也可自行指定签名，密码android</span></span><br><span class="line">jarsigner -verbose -keystore ~/.android/debug.keystore -signedjar new.apk apk.apk androiddebugkey</span><br><span class="line"><span class="comment"># 查看签名</span></span><br><span class="line">keytool -list -alias androiddebugkey -keystore &lt;path_to_debug_keystore&gt;.keystore -storepass android -keypass android</span><br><span class="line"><span class="comment"># 有时需要系统签名，系统签名官方git有提供([security at master · android](https://github.com/android/platform_build/tree/master/target/product/security))</span></span><br><span class="line">java -jar signapk.jar platform.x509.pem platform.pk8 apk/dist/apk.apk new_sys.apk</span><br></pre></td></tr></table></figure></p>
<h2 id="使用build-prop属性">使用<code>build.prop</code>属性</h2><p>有一种是重新打包<code>boot.img</code>，简单思路就是解包<code>boot.img</code>，修改<code>ramdisk</code>中的<code>default.prop</code>，再打包并刷机。因为<code>boot.img</code>会在开机自动覆盖，所以只能通过刷<code>boot</code>来搞定。具体可以搜索相关解包教程。</p>
<p>另外一种要涉及重新编译<code>boot.img</code>，不同的版本源码编译不一样。更多可以参考：<a href="https://source.android.com/" target="_blank" rel="external">Android Open Source Project</a>。<br>ADB权限管理：</p>
<ol>
<li>4.2.2版本，针对连接设备需要使用者进行确认，且分设备与MAC进行管理</li>
<li>4.2等设备有针对ADB管理的开发者模式，通过该模式对ADB的DEBUG进行权限管理</li>
<li>开源版本，针对<code>eng/userdebug/user</code>进行管理与开放adb权限</li>
</ol>
<p>从系统编译和编译环境控制来说，通过property进行管理，主要为<code>ro.debuggable</code>和<code>system/core/rootdir/init.usb.rc</code>中<code>sys.usb.config</code>里包含对adb选项。</p>
<p>简单编译可通过查找：</p>
<ol>
<li><code>ro.debuggable</code>相关的环境变量，比如<code>enable_target_debugging</code></li>
<li>查找init.rc中权限改变</li>
<li>添加开发者模式进行管理</li>
</ol>
<p>在系统编译时，有几个编译选项：</p>
<ol>
<li>eng：编译时默认选项</li>
<li>user：产品生成发布版</li>
<li>userdebug：与user版本相同，添加adb服务</li>
</ol>
<p>在4.4源码上进行相关参数的搜索（<code>ro.secure</code>，<code>ro.debuggable</code>，<code>ro.kernel.android.checkjni</code>）：<br><strong><code>ro.secure</code></strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/services/</span>java<span class="regexp">/com/</span>android<span class="regexp">/server/</span>wm/WindowManagerService.<span class="string">java:</span>    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_SECURE = <span class="string">"ro.secure"</span>;</span><br><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>net<span class="regexp">/http/</span>AndroidHttpClient.<span class="string">java:</span>                <span class="comment">// Never print auth token -- we used to check ro.secure=0 to</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> * binary tree.  For instance, <span class="string">"ro.secure"</span>=<span class="string">"1"</span> could be stored <span class="keyword">as</span> <span class="string">follows:</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> *                     v        v            v     +--------&gt;| ro.secure |</span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">1</span></span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">0</span></span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=0&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=1&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/system/</span>core<span class="regexp">/adb/</span>adb.<span class="string">c:</span>   <span class="comment">/* run adbd in secure mode if ro.secure is set and</span><br><span class="line">./system/core/adb/adb.c:        property_get("ro.secure", value, "1");</span><br><span class="line">./system/core/adb/adb.c:            // don't run as root if ro.secure is set...</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>build/xxx：环境设置</li>
<li>system/xxx/adb.c：如果=1,adb root将无法成功. 还有其它的附加条件除外.</li>
<li>WindowManagerService：用于管理viewserver(Hierarchy Viewer)</li>
<li>AndroidHttpClient：在=1时,不会在log中dump auth token</li>
<li>bionic/xxx/system_properties.c：介绍properties存储结构时用的例子</li>
</ul>
<p><strong><code>ro.debuggable</code></strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">./bootable/recovery/adb_install.cpp:    int len = property_get("ro.debuggable", value, NULL);</span><br><span class="line">./bootable/recovery/etc/init.rc:on property:ro.debuggable=1</span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=0<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0</span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1</span><br><span class="line">./build/tools/post_process_props.py:  # If ro.debuggable is 1, then enable adb on USB by default</span><br><span class="line">./build/tools/post_process_props.py:  if prop.get("ro.debuggable") == "1":</span><br><span class="line">./dalvik/docs/debugger.html:for all applications when the system property <span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./dalvik/docs/debugger.html:is set to <span class="tag">&lt;/<span class="title">code</span>&gt;</span>1<span class="tag">&lt;/<span class="title">code</span>&gt;</span> (use <span class="tag">&lt;<span class="title">code</span>&gt;</span>adb shell getprop ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./device/samsung/manta/init.manta.rc:on property:ro.debuggable=1</span><br><span class="line">./external/libnfc-nxp/Linux_x86/phDal4Nfc.c:    property_get("ro.debuggable", value, "");</span><br><span class="line">./external/openssh/servconf.c:  /* Allow root login if ro.debuggable is set */</span><br><span class="line">./external/openssh/servconf.c:  property_get("ro.debuggable", value, "");</span><br><span class="line">./frameworks/av/services/audioflinger/AudioFlinger.cpp:    (void) property_get("ro.debuggable", value, "0");</span><br><span class="line">./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java:        return "1".equals(SystemProperties.get("ro.debuggable")) &amp;&amp;</span><br><span class="line">./frameworks/base/core/java/android/os/Build.java:            SystemProperties.getInt("ro.debuggable", 0) == 1;</span><br><span class="line">./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java:        if ("1".equals(SystemProperties.get("ro.debuggable"))) </span><span class="expression">&#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/core</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/os</span><span class="end-block">/ZygoteConnection.java</span>:     * <span class="variable"><span class="keyword">If</span></span> <span class="string">"ro.debuggable"</span> <span class="variable">is</span> <span class="string">"1"</span>, <span class="variable">all</span> <span class="variable">apps</span> <span class="variable">are</span> <span class="variable">debuggable.</span> <span class="variable">Otherwise</span>,</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/policy</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/policy</span><span class="end-block">/impl</span><span class="end-block">/PhoneWindowManager.java</span>:        <span class="variable">mEnableShiftMenuBugReports</span> = <span class="string">"1"</span><span class="variable">.equals</span>(<span class="variable">SystemProperties.get</span>(<span class="string">"ro.debuggable"</span>));</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/BootReceiver.java</span>:        <span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1 ? 98304 : 65536;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/am</span><span class="end-block">/ActivityManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/wm</span><span class="end-block">/WindowManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/native</span><span class="end-block">/opengl</span><span class="end-block">/libs</span><span class="end-block">/EGL</span><span class="end-block">/egl.cpp</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/AudioRouter.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothPhoneService.java</span>:            &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallCommandService.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallController.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallHandlerServiceProxy.java</span>:            <span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallLogger.java</span>:        (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallModeler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallNotifier.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallStateMonitor.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCache.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCacheUpdateReceiver.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CdmaDisplayInfo.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">boolean</span> <span class="variable">DBG</span> = (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:                    &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)) &#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/NotificationMgr.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/OutgoingCallBroadcaster.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   (<span class="variable">PhoneApp.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   1 <span class="variable">-</span> <span class="variable">normal</span> <span class="variable">debug</span> <span class="variable">logging</span> <span class="variable"><span class="keyword">if</span></span> <span class="variable">ro.debuggable</span> <span class="variable">is</span> <span class="variable">set</span> (<span class="variable">which</span> <span class="variable">is</span> <span class="variable">true</span> <span class="variable">in</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/RespondViaSmsManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/Ringer.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/SipCallOptionHandler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/WiredHeadsetManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/sdk</span><span class="end-block">/eclipse</span><span class="end-block">/plugins</span><span class="end-block">/com.android.ide.eclipse.adt</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/ide</span><span class="end-block">/eclipse</span><span class="end-block">/adt</span><span class="end-block">/internal</span><span class="end-block">/launch</span><span class="end-block">/AndroidLaunchController.java</span>:                        /<span class="end-block">/ because am -D does not check for ro.debuggable and the</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:            <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/services.c</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/debuggerd</span><span class="end-block">/tombstone.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/include</span><span class="end-block">/cutils</span><span class="end-block">/trace.h</span>: * <span class="variable">level</span> <span class="variable">tracing</span> <span class="variable">is</span> <span class="variable">not</span> <span class="variable">allowed</span> <span class="variable">unless</span> <span class="variable">the</span> <span class="variable">ro.debuggable</span> <span class="variable">system</span> <span class="variable">property</span> <span class="variable">is</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/init</span><span class="end-block">/property</span>_<span class="variable">service.c</span>:    <span class="variable">ret</span> = <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">debuggable</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:/<span class="end-block">/ application-level tracing is allowed when the ro.debuggable system property</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/rootdir</span><span class="end-block">/init.rc</span>:<span class="variable">on</span> <span class="variable">property</span>:<span class="variable">ro.debuggable</span>=1</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./bootable/recovery/adb_install.cpp：debuggable 开启时,才可以成功重启adb</li>
<li>./build/xxxx：debuggable 数据设置</li>
<li>./dalvik/xxx：在dalvik中,如果debuggable为0, 仅AndroidManifest.xml中含有debuggable 才会支持jdwp调试</li>
<li>./external/libnfc-nxp/Linux_x86/phDal4Nfc.c：NFC调试支持开关</li>
<li>./external/openssh/servconf.c：openssh 允许root访问开关</li>
<li>./frameworks/av/services/audioflinger/AudioFlinger.cpp：Audio Debug 开关</li>
<li>./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java：SSL check 开关</li>
<li>./frameworks/base/core/java/android/os/Build.java：IS_DEBUGGABLE环境变量控制</li>
<li>./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java：App debuggable 开关, 如果=1, 所有应用都将进行debug支持</li>
<li>./frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java：mEnableShiftMenuBugReports 支持</li>
<li>./frameworks/base/services/java/com/android/server/BootReceiver.java：logged event size 控制, =1 存储量大</li>
<li>./frameworks/base/services/java/com/android/server/am/ActivityManagerService.java：系统DEBUG状态，包括do bug report, OpenGLTrace, App Profile, App Heap Dump</li>
<li>./frameworks/base/services/java/com/android/server/wm/WindowManagerService.java：系统DEBUG状态，与ro.secure 一起管理viewserver</li>
<li>./frameworks/native/opengl/libs/EGL/egl.cpp：EGL debug</li>
<li>LOGD 开关：<br>./packages/services/Telephony/src/com/android/phone/AudioRouter.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothManager.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothPhoneService.java<br>./packages/services/Telephony/src/com/android/phone/CallCommandService.java<br>./packages/services/Telephony/src/com/android/phone/CallController.java<br>./packages/services/Telephony/src/com/android/phone/CallHandlerServiceProxy.java<br>./packages/services/Telephony/src/com/android/phone/CallLogger.java<br>./packages/services/Telephony/src/com/android/phone/CallModeler.java<br>./packages/services/Telephony/src/com/android/phone/CallNotifier.java<br>./packages/services/Telephony/src/com/android/phone/CallStateMonitor.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCache.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCacheUpdateReceiver.java<br>./packages/services/Telephony/src/com/android/phone/CdmaDisplayInfo.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/NotificationMgr.java<br>./packages/services/Telephony/src/com/android/phone/OutgoingCallBroadcaster.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/RespondViaSmsManager.java<br>./packages/services/Telephony/src/com/android/phone/Ringer.java<br>./packages/services/Telephony/src/com/android/phone/SipCallOptionHandler.java<br>./packages/services/Telephony/src/com/android/phone/WiredHeadsetManager.java</li>
<li>./sdk/eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/launch/AndroidLaunchController.java：ADT app debug launcher 支持</li>
<li>./system/core/adb/adb.c：adb root permission</li>
<li>./system/core/adb/services.c：adb root permission</li>
<li>./system/core/debuggerd/tombstone.c：dump_crash want log if =1</li>
<li>./system/core/init/property_service.c：Allow local property overwrite ro.debuggerd value</li>
<li>./system/core/libcutils/trace.c：app trace on/off</li>
<li>./system/core/rootdir/init.rc：adbd服务开启控制</li>
</ul>
<p><strong><code>ro.kernel.android.checkjni</code></strong><br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./frameworks/<span class="keyword">base/core/jni/AndroidRuntime.cpp: </span>       property_get(<span class="string">"ro.kernel.android.checkjni"</span>, propBuf, <span class="string">""</span>)<span class="comment">;</span></span><br><span class="line">./dalvik/docs/embedded-vm-control.html:first is &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;. </span> This is set <span class="keyword">by </span>the</span><br><span class="line">./dalvik/docs/embedded-vm-control.html:of this overrides the value from &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;.</span><br><span class="line"></span>./<span class="keyword">build/core/main.mk: </span> <span class="keyword">ADDITIONAL_BUILD_PROPERTIES </span>+= ro.kernel.<span class="keyword">android.checkjni=1</span><br><span class="line"></span>./<span class="keyword">build/core/build-system.html: </span>       &lt;li&gt;&lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni=1&lt;/code&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./frameworks/base/core/jni/AndroidRuntime.cpp：checkJNI value load</li>
<li>dalvik/xxx：Java VM CheckJNI on/off</li>
<li>build/xxx：checkJNI 状态设置</li>
</ul>
<p>基本来说，<code>ro.secure</code>主要是系统安全相关属性开关，包括：</p>
<ul>
<li>adb的root权限</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统各个模块的敏感信息输出</li>
</ul>
<p><code>ro.debuggable</code>主要是系统debug信息开关，包括：</p>
<ul>
<li>adb管理，是否可root，是否开机运行</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统debug信息开关，包括应用内部log、audio debug, ssl check, nfc, opengl elg等信息打印、系统各应用级别状态，包括profile, jdwp-debug, heap dump, opengl trace等</li>
</ul>
<p><code>ro.kernel.android.checkjni</code>主要是Java VM checkJNI的开关</p>
<h2 id="Xposed进行HOOK"><code>Xposed</code>进行HOOK</h2><p>从上面的两个方案来看，debug都太过麻烦，还有一个简单的方式，那就是利用开源的Xposed框架进行hook。使用这一利器之前需要先root系统。用一句话来解释Xposed：</p>
<blockquote>
<p>利用JNI作为一个中转，将所有对于被hook的方法统一进入Xposed管理器，管理器再进行hook的前后调用。Xposed 调用非JVM JNI标准接口，需要准确调用dalvik/art中的方法调用，完成对原函数的调用。</p>
</blockquote>
<p>当我们设置<code>android:debuggable=&quot;true&quot;</code>时候，应用即可进行调试，而且可以进行JDWP连接进行调试。开启新应用时，Dalvik VM会forked/started新的线程，并开启debug，这时JDWP线程知道是否开启。我们跟踪<code>android.os.Process.start()</code>方法会发现，这是一个<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ProcessStartResult start(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span><br><span class="line">                              <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span><br><span class="line">                              <span class="built_in">int</span> uid, <span class="built_in">int</span> gid, <span class="built_in">int</span>[] gids,</span><br><span class="line">                              <span class="built_in">int</span> debugFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">                              <span class="built_in">int</span> targetSdkVersion,</span><br><span class="line">                              <span class="keyword">String</span> seInfo,</span><br><span class="line">                              <span class="keyword">String</span>[] zygoteArgs) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids, debugFlags, mountExternal, targetSdkVersion, seInfo, zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.e(LOG_TAG,</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟踪会发现，在<code>startViaZygote</code>方法中对<code>DEBUG_ENABLE_DEBUGGER</code>进行判断：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="number">0</span>) &#123;</span><br><span class="line">	argsForZygote.add(<span class="string">"--enable-debugger"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来就简单了，利用反射获得这个<code>start</code>的方法，并进行hook即可，代码为（完整项目查看<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里演示了两个hook的方式，更多可以参阅文档</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneDebug</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> debugApps = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_ENABLE_DEBUGGER = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- handle package: "</span> + loadPackageParam.packageName + <span class="string">" process: "</span> + loadPackageParam.processName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (loadPackageParam.appInfo == <span class="keyword">null</span> ||</span><br><span class="line">                (loadPackageParam.appInfo.flags &amp; (ApplicationInfo.FLAG_SYSTEM | ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method start = Process.class.getMethod(</span><br><span class="line">                    <span class="string">"start"</span>, String.class, String.class, Integer.TYPE, Integer.TYPE, <span class="keyword">int</span>[].class,</span><br><span class="line">                    Integer.TYPE, Integer.TYPE, Integer.TYPE, String.class, String[].class);</span><br><span class="line">            XposedBridge.log(<span class="string">"-- start hook, appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            XposedBridge.hookMethod(start, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (debugApps) &#123;</span><br><span class="line">                        <span class="keyword">int</span> id = <span class="number">5</span>;</span><br><span class="line">                        <span class="keyword">int</span> flags = (Integer) methodHookParam.args[id];</span><br><span class="line">                        <span class="keyword">if</span> ((flags &amp; DEBUG_ENABLE_DEBUGGER) == <span class="number">0</span>) &#123;</span><br><span class="line">                            flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                        &#125;</span><br><span class="line">                        methodHookParam.args[id] = flags;</span><br><span class="line">                        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">                            XposedBridge.log(<span class="string">"set debuggable flags to: "</span> + flags);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">        XposedBridge.hookAllMethods(Process.class, "start", new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                if (debugApps) &#123;</span><br><span class="line">                    int id = 5;</span><br><span class="line">                    int flags = (Integer) param.args[id];</span><br><span class="line">                    if ((flags &amp; DEBUG_ENABLE_DEBUGGER) == 0) &#123;</span><br><span class="line">                        flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                    &#125;</span><br><span class="line">                    param.args[id] = flags;</span><br><span class="line">                    if (BuildConfig.DEBUG) &#123;</span><br><span class="line">                        XposedBridge.log("set debuggable flags to: " + flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);*/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简要介绍Xposed插件开发流程">简要介绍Xposed插件开发流程</h3><p>在Android Studio上大概过程为（完整代码：<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：</p>
<ol>
<li>创建工程，可以无Activity</li>
<li>下载<a href="http://forum.xda-developers.com/xposed/xposed-api-changelog-developer-news-t2714067" target="_blank" rel="external">Xposed API</a> XposedBridgeApi-xx.jar，并将其放入<code>libs</code>目录</li>
<li>修改Manifest，新增三个<code>meta-data</code>标签（详细看下面代码）</li>
<li>实现<code>IXposedHookLoadPackage</code>接口及具体hook逻辑</li>
<li>在<code>assets/xposed_init</code>配置声明需要加载到<code>XposedInstaller</code>的入口</li>
<li>ALL DONE。<br>更多可以查看<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial" target="_blank" rel="external">Development tutorial</a>。</li>
</ol>
<p>运行Xposed插件，需要：</p>
<ol>
<li>安装<a href="http://repo.xposed.info/module/de.robv.android.xposed.installer" target="_blank" rel="external">Xposed Installer</a></li>
<li>手机root</li>
</ol>
<p>AndroidManifest.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">package</span>=<span class="value">"com.hwangjr.xposed.mods.phonedebug"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span></span><br><span class="line">        <span class="attribute">android:allowBackup</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:supportsRtl</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedmodule"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposeddescription"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"Phone Debugger! (ro.debuggable or android:debuggable)"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedminversion"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"54"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>assets/xposed_init</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="class">.hwangjr</span><span class="class">.xposed</span><span class="class">.mods</span><span class="class">.phonedebug</span><span class="class">.PhoneDebug</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed Module Repository</a><br><a href="https://labs.mwrinfosecurity.com/blog/2013/11/29/debug-all-the-android-things/" target="_blank" rel="external">Debug All the Android Things - mwrlabs</a><br><a href="http://blog.csdn.net/hunanwy/article/details/9200673" target="_blank" rel="external">Android USER 版本与ENG 版本的差异—MTK官方解释 - hunanwy的专栏 - 博客频道 - CSDN.NET</a><br><a href="http://www.codefrom.com/c/49" target="_blank" rel="external">Xposed插件开发基础篇｜码源</a><br><a href="http://forum.xda-developers.com/" target="_blank" rel="external">Android Forum for Mobile Phones, Tablets, Watches &amp; Android App Development - XDA Forums</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/27/调试Android应用/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git设置白名单/" title="Git设置白名单" itemprop="url">Git设置白名单</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:20:39.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p><code>.gitignore</code>可以设置过滤文件，此文件还可以用来设置白名单。</p>
<h1 id="白名单">白名单</h1><p>简单粗暴上菜（要解决此目录下的子目录也要过滤问题）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore everything</span></span><br><span class="line"><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># white list anything that's a directort</span></span><br><span class="line">!<span class="keyword">*</span>/</span><br><span class="line"><span class="comment"># add all the file types you don't want miss</span></span><br><span class="line">!<span class="keyword">*</span>.txt</span><br><span class="line">!<span class="keyword">*</span>.etc</span><br></pre></td></tr></table></figure></p>
<p>ALL DONE!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git设置白名单/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git无法提交目录/" title="Git无法提交目录" itemprop="url">Git无法提交目录</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:18:16.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>初始化时，可能需要提交空目录，但是Git是针对文件变动进行跟踪，不对目录进行跟踪。所以一个目录如果没有文件，即使<code>git add</code>此目录，也无法进行提交。</p>
<h1 id="Solution">Solution</h1><p>简单做法是，在空目录下新建一个文件。此文件可能是：</p>
<ol>
<li><code>.gitignore</code>文件</li>
<li><code>.gitkeep</code>或<code>.keep</code>文件</li>
<li>其他空文件</li>
</ol>
<p><code>.gitignore</code>文件内容可以是：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 忽略所有文件</span></span><br><span class="line">*</span><br><span class="line"><span class="preprocessor"># 除了gitignore文件</span></span><br><span class="line">!.gitignore</span><br></pre></td></tr></table></figure></p>
<p>之后进行<code>git add</code>即可。</p>
<h1 id="脚本">脚本</h1><p>懒人脚本，其实就是一行命令，查找当前目录，如果为空则添加空文件（忽略.git目录）：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . <span class="string">\(</span> -type d -empty <span class="string">\)</span> -<span class="keyword">and</span> <span class="string">\(</span> -<span class="keyword">not</span> -regex .<span class="pi">/\.git.* \) -exec touch &#123;&#125;/</span>.gitkeep <span class="string">\;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://blog.csdn.net/zhaodezhong/article/details/7774869" target="_blank" rel="external">git 保存空目录</a><br><a href="http://www.oschina.net/question/114628_125642" target="_blank" rel="external">eclipse 工程下新建文件夹无法上传至Git仓库</a><br><a href="https://segmentfault.com/q/1010000000663317" target="_blank" rel="external">gitignore 添加空目录</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git无法提交目录/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git多个远程仓库进行管理/" title="Git多个远程仓库进行管理" itemprop="url">Git多个远程仓库进行管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:17:39.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>现在免费代码托管平台很多，有时需要多个远程库同时进行PUSH，这时如何处理。</p>
<p>举个糖炒栗子，本地创建git仓库后，在GitHub上创建一个仓库，并在GitCoffee上也有远程仓库，此时如何同步，狡兔三窟。可作为代码备份和远程协作。</p>
<h1 id="新增远程仓库">新增远程仓库</h1><h2 id="一次PUSH多个仓库更新">一次PUSH多个仓库更新</h2><p>直接在<code>origin</code>或现有远程仓库上添加远程仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 远程仓库</span><br></pre></td></tr></table></figure></p>
<p>如果提示<code>fatal: remote origin already exists</code>，先删除再添加：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="comment"># 不推荐此方法</span></span><br><span class="line">git remote rm origin</span><br></pre></td></tr></table></figure></p>
<p>也可以直接修改config方法，修改<code>.git/config</code>文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">url = 远程仓库</span><br></pre></td></tr></table></figure></p>
<h2 id="分开PUSH管理多个仓库">分开PUSH管理多个仓库</h2><p>上面那个方法比较方便，可以PUSH到多个URL上。但是有时我们的RSA KEY不一样，会导致无法PUSH，这时可以新增一个远程仓库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增</span></span><br><span class="line">git remote add newpush 远程仓库</span><br><span class="line"><span class="comment"># push到新增远程仓库的master分支</span></span><br><span class="line">git push newpush master</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br></pre></td></tr></table></figure></p>
<p>直接编辑<code>.git/config</code>也是一个方式。</p>
<h2 id="脚本">脚本</h2><p>也就诞生了懒人脚本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to origin master'</span></span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to newpush master'</span></span><br><span class="line">git push newpush master</span><br></pre></td></tr></table></figure></p>
<h1 id="REF">REF</h1><p><a href="http://www.xiaoleilu.com/push-multi-repo/" target="_blank" rel="external">Git push到多个远程库</a><br><a href="http://higrid.net/hi/docs/git-pull-push-from-multiple-remote-locations" target="_blank" rel="external">git与多个远程仓库同步</a><br><a href="http://www.v2ex.com/t/37919#reply8" target="_blank" rel="external">有没有可能同时把代码提交到两个git代码托管的服务器上？ - V2EX</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git多个远程仓库进行管理/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/使用Gitolite搭建Git服务器/" title="使用Gitolite搭建Git服务器" itemprop="url">使用Gitolite搭建Git服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:16:25.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>搭建Git服务器作为代码管理工具。</p>
<h1 id="搭建">搭建</h1><h2 id="软件安装">软件安装</h2><p>基于：</p>
<ul>
<li>CentOS 7</li>
<li>Git 1.8.3<br>直接用yum安装，如果需要最新版本，请编译安装。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git -y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="添加用户">添加用户</h2><p>添加一个新用户来跑git服务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adduser git</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">useradd <span class="operator">-s</span> /sbin/nologin -g git git</span><br><span class="line"><span class="comment"># /etc/passwd can checkout the users and group</span></span><br><span class="line">w git</span><br><span class="line">groups git</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化仓库">初始化仓库</h2><p>选择目录并初始化仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> path/git</span><br><span class="line">git init --bare project.git</span><br><span class="line">chown -R git project.git</span><br></pre></td></tr></table></figure></p>
<h2 id="禁用远程登陆">禁用远程登陆</h2><p>禁止用户通过git账户登陆。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/passwd</span><br><span class="line"><span class="comment"># modify the bash</span></span><br><span class="line">git:xxxxxxxxx:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure></p>
<h2 id="配置客户端key">配置客户端key</h2><p>客户端生成rsa key：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">cat .ssh/id_rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>将生成的<code>id_rsa.pub</code>复制到服务器上，修改<code>.ssh/authorized_keys</code>文件。</p>
<h2 id="DONE">DONE</h2><p>现在即可在本地进行<code>check out</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@ip:/path/git/project.git</span><br></pre></td></tr></table></figure></p>
<h1 id="使用Gitolite">使用Gitolite</h1><h2 id="背景-1">背景</h2><p>这是Git服务器管理软件，还有很多选择，自己决定。这里使用<a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>。</p>
<blockquote>
<p><a href="https://about.gitlab.com/" target="_blank" rel="external">GitLab</a> : GitLab includes git repository management, code reviews, issue tracking, wikis and much more. GitLab comes with GitLab CI, an easy to use continuous integration and deployment tool.<br><a href="https://www.scm-manager.org/" target="_blank" rel="external">SCM-Manager</a> : The easiest way to share and manage your Git, Mercurial and Subversion repositories over http.<br><a href="https://www.gerritcodereview.com/" target="_blank" rel="external">Gerrit Code Review</a> + <a href="http://gitblit.com/" target="_blank" rel="external">Gitblit</a> : Gerrit provides web based code review and repository management for the Git version control system. Gitblit is an open-source, pure Java stack for managing, viewing, and serving Git repositories. It’s designed primarily as a tool for small workgroups who want to host centralized repositories.<br><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a> + <a href="http://git-scm.com/book/ch4-6.html" target="_blank" rel="external">Git - Smart HTTP</a> : Gitolite allows you to setup git hosting on a central server, with fine-grained access control and many more powerful features.<br><a href="https://gogs.io/" target="_blank" rel="external">Gogs</a> : Gogs (Go Git Service) is a painless self-hosted Git service.<br><a href="http://www.getgitorious.com/" target="_blank" rel="external">Gitorious</a> : Run Gitorious yourself — get started with free, open source Git hosting and collaboration today.<br><a href="https://tuleap.net/" target="_blank" rel="external">Tuleap</a> OR <a href="https://github.com/Enalean/tuleap" target="_blank" rel="external">Tuleap Github</a> : Traditional development, Requirement Management, Agile Development, IT Service management… Tuleap makes software projects more productive, collaborative and industrialized.<br><a href="http://phabricator.org/" target="_blank" rel="external">Phabricator</a> OR <a href="https://github.com/phacility/phabricator" target="_blank" rel="external">phacility/phabricator</a> : Phabricator is a collection of open source web applications that help software companies build better software.<br><a href="https://github.com/gitbucket/gitbucket" target="_blank" rel="external">gitbucket/gitbucket</a> : GitBucket is a GitHub clone powered by Scala which has easy installation and high extensibility.<br><a href="http://gitlist.org/" target="_blank" rel="external">GitList</a> OR <a href="https://github.com/klaussilveira/gitlist" target="_blank" rel="external">klaussilveira/gitlist</a> : GitList allows you to browse repositories using your favorite browser, viewing files under different revisions, commit history and diffs. GitList is free and open source software, written in PHP, on top of Silex and the Twig template engine.<br><a href="http://git.zx2c4.com/cgit/about/" target="_blank" rel="external">cgit</a> : A hyperfast web frontend for git repositories written in C.<br><a href="https://github.com/mensi/cydra/" target="_blank" rel="external">mensi/cydra</a> : <strong>SEEMS DEAD</strong>. Cydra is a platform for project hosting written in Python. It has an extensible architecture to facilitate integration of 3rd party software such as version control systems and project management tools.<br><a href="https://github.com/tv42/gitosis" target="_blank" rel="external">tv42/gitosis</a> : <strong>SEEMS DEAD</strong>. Manage git repositories, provide access to them over SSH, with tight access control and not needing shell accounts.<br><a href="https://github.com/jakubgarfield/Bonobo-Git-Server" target="_blank" rel="external">jakubgarfield/Bonobo-Git-Server</a> : Bonobo Git Server for Windows is a web application you can install on your IIS and easily manage and connect to your git repositories.</p>
</blockquote>
<h2 id="安装前">安装前</h2><ol>
<li>安装git</li>
<li>创建git用户组和git用户</li>
<li>创建管理员密钥</li>
<li>将公钥上传到git服务器中</li>
</ol>
<p>其中，创建管理员密钥：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"git-admin"</span></span><br></pre></td></tr></table></figure></p>
<p>并将git-admin.pub上传到服务器（可使用<code>scp</code>，如有问题，可能是firewall问题）。</p>
<h2 id="安装">安装</h2><ol>
<li>创建git用户下bin目录</li>
<li>clone gitolite并安装</li>
<li>使用公钥初始化gitolite</li>
</ol>
<p><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>安装很简单，可以查看官方文档：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su git</span><br><span class="line">mkdir -p ~/bin</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/sitaramc/gitolite</span><br><span class="line">gitolite/install --help</span><br><span class="line">gitolite/install -ln ~/bin</span><br><span class="line"><span class="comment"># make sure you have the path in $HOME/bin</span></span><br><span class="line"><span class="built_in">source</span> .bash_profile</span><br></pre></td></tr></table></figure></p>
<p>初始化gitolite：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitolite setup -pk git-admin.pub</span><br></pre></td></tr></table></figure></p>
<h2 id="添加gitolite用户和仓库">添加gitolite用户和仓库</h2><p>不需要手动在<code>git</code>服务器中添加新用户或新仓库。因为gitolite的用户，仓库和权限规则是使用一个名为<code>gitolite-admin</code>的特殊仓库进行维护，需通过修改该仓库并合并<code>push</code>到服务器中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@host:gitolite-admin</span><br></pre></td></tr></table></figure></p>
<p>Clone后，看到两个目录<code>conf</code>和<code>keydir</code>，<code>conf/gitolite.conf</code>用于修改仓库及用户权限，<code>keydir</code>用于存放用户公钥。<br>新增<code>hwangjr</code>用户：</p>
<ol>
<li>将其公钥（hwangjr.pub）添加到<code>keydir</code>目录</li>
<li>修改<code>conf/gitolite.conf</code>文件，新增仓库和用户权限：<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repo <span class="keyword">project</span></span><br><span class="line">	RW+ = hwangjr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用其他权限：RW, R等</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>修改完上传服务器即可：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_ins">add</span> conf</span><br><span class="line">git <span class="built_ins">add</span> keydir</span><br><span class="line">git commit -m '<span class="built_ins">add</span> repo project, <span class="built_ins">add</span> <span class="built_ins">user</span> hwangjr'</span><br><span class="line">git push</span><br></pre></td></tr></table></figure></p>
<p><code>PUSH</code>成功之后，服务器会自动创建新的仓库并将用户密钥加入<code>.ssh/authorized_keys</code>文件中。</p>
<h2 id="更多配置">更多配置</h2><p><code>gitolite</code>权限管理很完备，在此给出一些配置方案：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repo project</span><br><span class="line">    RW+                     =   hwangjr</span><br><span class="line">    -   master              =   hwangjr</span><br><span class="line">    -   refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    RW                      =   hwangjr</span><br><span class="line">    RW  refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    R                       =   hwangjr</span><br></pre></td></tr></table></figure></p>
<p>上面配置即：</p>
<ul>
<li>RW+ ： 能够对仓库进行所有的操作。</li>
<li><ul>
<li>master : 能够创建和推送任何名字不为master的分支，并能够添加任何不以v+数字开头的tag。</li>
</ul>
</li>
<li><ul>
<li>refs/tags/v[0-9] : 能够添加任何以v+数字开头的tag。</li>
</ul>
</li>
<li>R : 能够进行clone和fetch操作。</li>
</ul>
<p>还可以添加组进行管理（<strong>@all</strong>为特殊组，表示所有用户）：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@staff</span>      =   hwangjr hwangjr1 hwangjr2</span><br><span class="line"><span class="variable">@interns</span>    =   hwangjr</span><br><span class="line"><span class="variable">@all-devs</span>   =   <span class="variable">@staff</span> <span class="variable">@interns</span></span><br><span class="line"></span><br><span class="line">repo secret</span><br><span class="line">    RW      =   <span class="variable">@staff</span></span><br><span class="line"></span><br><span class="line">repo project</span><br><span class="line">    RW+     =   <span class="variable">@staff</span></span><br><span class="line">    RW      =   <span class="variable">@interns</span></span><br></pre></td></tr></table></figure></p>
<p>更多查看：<a href="http://gitolite.com/gitolite/gitolite.html" target="_blank" rel="external">gitolite all-in-one page</a>。</p>
<h1 id="QUESTION">QUESTION</h1><h2 id="安装过程遇到cant_locate_Data/Dumper-pm">安装过程遇到cant locate Data/Dumper.pm</h2><p>在安装过程中，可能会遇到错误：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gitolite/install -h</span><br><span class="line">Can't locate Data/Dumper.pm <span class="keyword">in</span> @INC (@INC <span class="keyword">contains</span>: /home/git/gitolite/src/lib /usr/<span class="keyword">local</span>/lib64/perl5 /usr/<span class="keyword">local</span>/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) <span class="keyword">at</span> /home/git/gitolite/src/lib/Gitolite/Common.pm line <span class="number">61.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at /home/git/gitolite/src/lib/Gitolite/Common.pm line 61.</span></span><br><span class="line">Compilation failed <span class="keyword">in</span> require <span class="keyword">at</span> gitolite/install line <span class="number">15.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at gitolite/install line 15.</span></span><br></pre></td></tr></table></figure></p>
<p>这是因为缺少包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install perl-Data-Dumper</span><br></pre></td></tr></table></figure></p>
<h2 id="Clone_gitolite-admin时提示需要输入密码">Clone gitolite-admin时提示需要输入密码</h2><p>在clone gitolite-admin时，会提示输入密码：</p>
<ol>
<li>在服务端生成rsa key</li>
<li>在服务端进行clone</li>
</ol>
<p>此时会出现此错误，使用其他机器即可（需要复制rsa key到其他机器）。</p>
<h1 id="Ref">Ref</h1><p><a href="http://wenzhiquan.github.io/blog/2014/10/14/fedora_20_install_gitolite/" target="_blank" rel="external">Fedora 20 安装gitolite</a><br><a href="https://github.com/sitaramc/gitolite" target="_blank" rel="external">sitaramc/gitolite</a><br><a href="http://gitolite.com/gitolite/install.html" target="_blank" rel="external">install and setup</a><br><a href="http://www.loushi135.com/articles/2015/09/21/1442848708235.html" target="_blank" rel="external">centos git服务器安装与gitolite用户权限管理 - 思迁</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/使用Gitolite搭建Git服务器/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/23/自动清理tmp文件/" title="自动清理tmp文件" itemprop="url">自动清理tmp文件</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-23T11:03:26.000Z" itemprop="datePublished"> 发表于 2015-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>在<code>supervisor</code>默认配置中，其启动的<code>sock</code>等都会放到<code>tmp</code>目录，而<code>tmp</code>目录会自动清理导致无法使用<code>supervisorctl</code>命令，此时：</p>
<ol>
<li>修改<code>supervisor.conf</code>文件，修改到<code>/var/run/</code>及<code>/var/log/</code>目录，具体配置就不进行贴了，简单直接搜索<code>tmp</code>进行修改即可。</li>
<li>重启<code>supervisor</code>服务，记得<code>kill</code>原来服务。</li>
</ol>
<p>但是，为什么系统会自动清理<code>tmp</code>目录呢？</p>
<h1 id="RHEL\CentOS\Fedora系统">RHEL\CentOS\Fedora系统</h1><p>在<code>CentOS 6</code>中，使用<code>tmpwatch</code>命令进行删除。</p>
<blockquote>
<p>tmpwatch - removes files which haven’t been accessed for a period of time</p>
<p>tmpwatch [-u|-m|-c] [-MUadfqstvx] [—verbose] [—force] [—all] [—nodirs] [—nosymlinks] [—test] [—fuser] [—quiet] [—atime|—mtime|—ctime] [—dirmtime] [—exclude path] [—exclude-user user] time dirs</p>
</blockquote>
<p>在<code>/etc/cron.daily/</code>目录下会生成<code>tmpwatch</code>文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh&#10;flags=-umc&#10;/usr/sbin/tmpwatch &#34;$flags&#34; -x /tmp/.X11-unix -x /tmp/.XIM-unix \&#10;        -x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix \&#10;        -X &#39;/tmp/hsperfdata_*&#39; 10d /tmp&#10;/usr/sbin/tmpwatch &#34;$flags&#34; 30d /var/tmp&#10;for d in /var/&#123;cache/man,catman&#125;/&#123;cat?,X11R6/cat?,local/cat?&#125;; do&#10;    if [ -d &#34;$d&#34; ]; then&#10;        /usr/sbin/tmpwatch &#34;$flags&#34; -f 30d &#34;$d&#34;&#10;    fi&#10;done</span><br></pre></td></tr></table></figure></p>
<p>将自动删除240小时未访问文件，<code>tmpwatch</code>工具可以从指定目录递归搜索并删除一段时间未访问文件。<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">u, --atime 基于访问时间来删除文件，默认的。</span><br><span class="line"></span>-<span class="ruby">m, --mtime 基于修改时间来删除文件。</span><br><span class="line"></span>-<span class="ruby">c, --ctime 基于创建时间来删除文件，对于目录，基于mtime。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">M</span>, --dirmtime 删除目录基于目录的修改时间而不是访问时间。</span><br><span class="line"></span>-<span class="ruby">a, --all 删除所有的文件类型，不只是普通文件，符号链接和目录。</span><br><span class="line"></span>-<span class="ruby">d, --nodirs 不尝试删除目录，即使是空目录。</span><br><span class="line"></span>-<span class="ruby">d, --nosymlinks 不尝试删除符号链接。</span><br><span class="line"></span>-<span class="ruby">f, --force 强制删除。</span><br><span class="line"></span>-<span class="ruby">q, --quiet 只报告错误信息。</span><br><span class="line"></span>-<span class="ruby">s, --fuser 如果文件已经是打开状态在删除前，尝试使用“定影”命令。默认不启用。</span><br><span class="line"></span>-<span class="ruby">t, --test 仅作测试，并不真的删除文件或目录。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">U</span>, --exclude-user=user 不删除属于谁的文件。</span><br><span class="line"></span>-<span class="ruby">v, --verbose 打印详细信息。</span><br><span class="line"></span>-<span class="ruby">x, --exclude=path 排除路径，如果路径是一个目录，它包含的所有文件被排除了。如果路径不存在，它必须是一个绝对路径不包含符号链接。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">X</span>, --exclude-pattern=pattern 排除某规则下的路径。</span></span><br></pre></td></tr></table></figure></p>
<h2 id="CentOS_7">CentOS 7</h2><p>在<code>CentOS 7</code>中会注意到一点，在系统中默认会清理<code>tmp</code>目录，而且没有安装<code>tmpwatch</code>，那么<code>CentOS 7</code>中是通过什么来实现的呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># systemctl status systemd-tmpfiles-clean.service</span></span><br><span class="line">systemd-tmpfiles-clean.service - Cleanup of Temporary Directories</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/systemd-tmpfiles-clean.service; <span class="keyword">static</span>)</span><br><span class="line">   Active: inactive (dead) since Thu <span class="number">2015</span>-<span class="number">12</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> HKT; <span class="number">5</span>h <span class="number">12</span>min ago</span><br><span class="line">     Docs: man:tmpfiles.d(<span class="number">5</span>)</span><br><span class="line">           man:systemd-tmpfiles(<span class="number">8</span>)</span><br><span class="line">  Process: <span class="number">6523</span> ExecStart=/usr/bin/systemd-tmpfiles --clean (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">6523</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"></span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Starting Cleanup of Temporary Directories...</span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Started Cleanup of Temporary Directories.</span><br></pre></td></tr></table></figure></p>
<p>没错，就是通过这个服务来实现的，此服务为<code>/usr/lib/systemd/system/systemd-tmpfiles-clean.service</code>。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.service </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="setting">DefaultDependencies=<span class="value"><span class="keyword">no</span></span></span></span><br><span class="line"><span class="setting">Wants=<span class="value">local-fs.target</span></span></span><br><span class="line"><span class="setting">After=<span class="value">systemd-readahead-collect.service systemd-readahead-replay.service local-fs.target</span></span></span><br><span class="line"><span class="setting">Before=<span class="value">sysinit.target shutdown.target</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/local/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/etc/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/run/tmpfiles.d</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Type=<span class="value">oneshot</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/bin/systemd-tmpfiles --clean</span></span></span><br><span class="line"><span class="setting">IOSchedulingClass=<span class="value">idle</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.timer </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Daily Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Timer]</span></span><br><span class="line"><span class="setting">OnBootSec=<span class="value"><span class="number">15</span>min</span></span></span><br><span class="line"><span class="setting">OnUnitActiveSec=<span class="value"><span class="number">1</span>d</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到在启动15分钟之后会清理，每隔1天清理一次。更多详细信息<a href="http://www.freedesktop.org/software/systemd/man/systemd-tmpfiles.html" target="_blank" rel="external">systemd-tmpfiles</a>。</p>
<h1 id="Debian\Ubuntu系统">Debian\Ubuntu系统</h1><p>在<code>Ubuntu</code>系统中每次开机会进行清除，具体配置为<code>rcS</code>文件的<code>TMPTIME</code>值。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/<span class="keyword">default</span>/rcS</span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># /etc/default/rcS</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Default settings for the scripts in /etc/rcS.d/</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For information about these variables see the rcS(5) manual page.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># This file belongs to the "initscripts" package.</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># delete files in /tmp during boot older than x days.</span></span><br><span class="line"><span class="preprocessor"># '0' means always, -1 or 'infinite' disables the feature</span></span><br><span class="line"><span class="preprocessor">#TMPTIME=0</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># spawn sulogin during boot, continue normal boot if not used in 30 seconds</span></span><br><span class="line"><span class="preprocessor">#SULOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># do not allow users to log in until the boot has completed</span></span><br><span class="line"><span class="preprocessor">#DELAYLOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># assume that the BIOS clock is set to UTC time (recommended)</span></span><br><span class="line">UTC=yes</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># be more verbose during the boot process</span></span><br><span class="line"><span class="preprocessor">#VERBOSE=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># automatically repair filesystems with inconsistencies during boot</span></span><br><span class="line"><span class="preprocessor">#FSCKFIX=no</span></span><br></pre></td></tr></table></figure></p>
<p>也就是在x天启动之后会自动清理<code>tmp</code>目录，0代表一直清理，-1代表取消此特性。</p>
<h1 id="注意点">注意点</h1><h2 id="supervisor">supervisor</h2><p>修改默认配置的<code>/tmp/</code>目录为<code>/var/run/</code>和<code>/var/log</code>目录。</p>
<h2 id="mysql">mysql</h2><p>默认将<code>pid</code>和<code>socket</code>创建在<code>tmp</code>目录，将两个此文件排除在外，否则<code>mysql</code>重启或使用<code>socket</code>登陆时提示找不到文件，可通过<code>-U mysql</code>。</p>
<h1 id="REF">REF</h1><p><a href="http://www.oss4aix.org/download/SRPMS/tmpwatch/" target="_blank" rel="external">Index of /download/SRPMS/tmpwatch</a><br><a href="https://git.centos.org/summary/?r=rpms/tmpwatch" target="_blank" rel="external">rpms/tmpwatch - git.centos.org</a><br><a href="http://www.ttlsa.com/linux/the-tmp-directory-is-automatically-cleared-and-the-tmpwatch-command/" target="_blank" rel="external">tmp目录自动清除和tmpwatch命令 - 运维生存时间</a><br><a href="http://www.opsers.org/base/clean-up-on-the-linux-system-tmp-folder-you-may-want-to-know.html" target="_blank" rel="external">关于Linux系统清理/tmp/文件夹，你可能想知道的 | 羽飞博客</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/23/自动清理tmp文件/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/23/Android中的CheckStyle/" title="Android中的CheckStyle" itemprop="url">Android中的CheckStyle</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-23T11:02:08.000Z" itemprop="datePublished"> 发表于 2015-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>简单一句话：CheckStyle解放了团队编码规范的审核。</p>
<p>CheckStyle主要实现了事实检测代码是否符合已经定义的规范，比如静态变量需要大写，函数名不超过20字符等。当发现这些检测不符合规范，则发出警告或错误。</p>
<p>简单来说，checkstyle检测了（更多信息：<a href="http://checkstyle.sourceforge.net/checks.html" target="_blank" rel="external">checkstyle</a>）：</p>
<blockquote>
<p>Annotations<br>Block Checks<br>Class Design<br>Coding<br>Headers<br>Imports<br>Javadoc Comments<br>Metrics<br>Miscellaneous<br>Modifiers<br>Naming Conventions<br>Regexp<br>Size Violations<br>Whitespace</p>
</blockquote>
<h1 id="Android中的配置">Android中的配置</h1><p>由于checkstyle功能丰富，如果自行配置，相对较为复杂，所以在其官网谷歌、sun都有提供范例。接下来简要介绍如何在gradle中配置checkstyle。</p>
<h2 id="配置plugin">配置plugin</h2><p>在<code>build.gradle</code>中，新增插件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'checkstyle'</span></span><br></pre></td></tr></table></figure></p>
<p>默认checkstyle的版本为<code>5.9</code>，如果觉得版本较老，可以配置版本（目前最新版本为<code>6.13</code>，但是不兼容，最高可用版本为<code>6.1.1</code>）：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkstyle &#123;</span><br><span class="line">	toolVersion <span class="string">'6.1.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测任务">检测任务</h2><p>在添加完插件之后，需要添加检测的任务：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task checkstyle(<span class="string">type:</span> Checkstyle) &#123;</span><br><span class="line">    configFile rootProject.file(<span class="string">'checkstyle.xml'</span>)</span><br><span class="line">    <span class="comment">// source fileTree('src')</span></span><br><span class="line">    source <span class="string">'src/main/java'</span></span><br><span class="line">    ignoreFailures <span class="literal">false</span></span><br><span class="line">    showViolations <span class="literal">true</span></span><br><span class="line">    include <span class="string">'**/*.java'</span></span><br><span class="line">    exclude <span class="string">'**/gen/**'</span></span><br><span class="line"></span><br><span class="line">    classpath = files()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="检测配置">检测配置</h2><p>可以看到上一个步骤有<code>checkstyle.xml</code>文件，这个文件就是检测配置文件，里面包含了检测的规则，可以参考<a href="https://github.com/AndroidKnife/check" target="_blank" rel="external">AndroidKnife/check</a>这里的配置。</p>
<h2 id="检测插件">检测插件</h2><p>如果是使用studio的话，有一系列插件可以方便检测，输入<code>QAPlug</code>并进行搜索即可安装，其中包括<code>check style</code>、<code>FindBugs</code>、<code>PMD</code>、<code>Hammurapi</code>。</p>
<h1 id="Ref">Ref</h1><p><a href="https://github.com/checkstyle/checkstyle" target="_blank" rel="external">checkstyle/checkstyle</a><br><a href="https://google.github.io/styleguide/javaguide.html" target="_blank" rel="external">Google Java Style</a><br><a href="http://www.oracle.com/technetwork/java/codeconvtoc-136057.html" target="_blank" rel="external">Code Conventions for the Java Programming Language</a><br><a href="https://rockeyhoo.gitbooks.io/dianping_codestyle/content/source/BeautyStyle.xml" target="_blank" rel="external">BeautyStyle</a></p>
<p>顺便带上目前使用的<code>check style</code>，可在<a href="https://github.com/AndroidKnife/Utils" target="_blank" rel="external">AndroidKnife/Utils</a>找到：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0"?&gt;</span><span class="doctype">&lt;!DOCTYPE module PUBLIC</span><br><span class="line">    "-//Puppy Crawl//DTD Check Configuration 1.2//EN"</span><br><span class="line">    "http://www.puppycrawl.com/dtds/configuration_1_2.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"Checker"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--module name="NewlineAtEndOfFile"/--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileLength"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"FileTabCharacter"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Trailing spaces --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"\s+$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Line has trailing spaces."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Space after 'for' and 'if' --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*(for|if)\("</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed before opening parenthesis."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- For each spacing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RegexpSingleline"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^\s*for \(.*?([^ ]:|:[^ ])"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"Space needed around ':' character."</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TreeWalker"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name="cacheFile" value="$&#123;checkstyle.cache.file&#125;"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Javadoc comments.                     --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_javadoc.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocMethod"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocType"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocVariable"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="JavadocStyle"/--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Naming Conventions.                  --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_naming.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ConstantName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalFinalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LocalVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MemberName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[a-z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"PackageName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"StaticVariableName"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypeName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"format"</span> <span class="attribute">value</span>=<span class="value">"^[A-Z][a-zA-Z0-9_]*$"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for imports                              --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_import.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidStarImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantImport"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UnusedImports"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"processJavadoc"</span> <span class="attribute">value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for Size Violations.                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_sizes.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LineLength"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"max"</span> <span class="attribute">value</span>=<span class="value">"150"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"ignorePattern"</span></span><br><span class="line">                <span class="attribute">value</span>=<span class="value">"^package.*|^import.*|a href|href|http://|https://|ftp://"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodLength"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParameterNumber"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for whitespace                               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_whitespace.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"GenericWhitespace"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyForIteratorPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MethodParamPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NoWhitespaceBefore"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"OperatorWrap"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TypecastParenPad"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAfter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"WhitespaceAround"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Modifier Checks                                    --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_modifiers.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="ModifierOrder"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantModifier"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for blocks. You know, those &#123;&#125;'s         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_blocks.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"AvoidNestedBlocks"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyBlock"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"LeftCurly"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"NeedBraces"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RightCurly"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for common coding problems               --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_coding.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="AvoidInlineConditionals"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"CovariantEquals"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EmptyStatement"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsAvoidNull"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"EqualsHashCode"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="HiddenField"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"IllegalInstantiation"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InnerAssignment"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="MagicNumber"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"MissingSwitchDefault"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"RedundantThrows"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanExpression"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"SimplifyBooleanReturn"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Checks for class design                         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_design.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="DesignForExtension"/--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalClass"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"HideUtilityClassConstructor"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"InterfaceIsType"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;module name="VisibilityModifier"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Miscellaneous other checks.                   --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- See http://checkstyle.sf.net/config_misc.html --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"ArrayTypeStyle"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--module name="FinalParameters"/--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"TodoComment"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">module</span> <span class="attribute">name</span>=<span class="value">"UpperEll"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">module</span>&gt;</span></span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/23/Android中的CheckStyle/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/03/ProGuard-精粹/" title="ProGuard 精粹" itemprop="url">ProGuard 精粹</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-03T07:01:25.000Z" itemprop="datePublished"> 发表于 2015-12-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>总结ProGuard混淆日常的使用方式，常见的混淆片段等。</p>
<p>更多内容<a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a></p>
<blockquote>
<p>ProGuard is a free Java class file shrinker, optimizer, obfuscator, and preverifier. It detects and removes unused classes, fields, methods, and attributes. It optimizes bytecode and removes unused instructions. It renames the remaining classes, fields, and methods using short meaningless names. Finally, it preverifies the processed code for Java 6 or higher, or for Java Micro Edition.<br><strong>Some uses of ProGuard are:</strong><br>Creating more compact code, for smaller code archives, faster transfer across networks, faster loading, and smaller memory footprints.<br>Making programs and libraries harder to reverse-engineer.<br>Listing dead code, so it can be removed from the source code.<br>Retargeting and preverifying existing class files for Java 6 or higher, to take full advantage of their faster class loading.</p>
</blockquote>
<h1 id="原则">原则</h1><p>现在面向对象都讲究原则，做事也讲究原则。</p>
<ul>
<li>反射用到的类不混淆</li>
<li>JNI方法不混淆</li>
<li>Manifest中类不混淆</li>
<li>四大组件和Application子类、Framework层下所有类默认不混淆</li>
<li>Parcelable子类和Creator静态成员变量不混淆（BadParcelableException，怕了吧）</li>
<li>GSon、FastJson等库时，Json对象不混淆（注解可解决此问题）</li>
<li>第三方开源库或引用其他第三方SDK，加入对应混淆规则（或者库在打包aar时有指定<code>consumerProguardFiles</code>）</li>
<li>WebView的JS调用接口不混淆</li>
</ul>
<h1 id="使用">使用</h1><h2 id="AndroidStudio">AndroidStudio</h2><p>新建项目后，默认会在模块目录下新建<code>build.gradle</code>和<code>proguard-rules.pro</code>文件，修改<code>build.gradle</code>文件中的<code>proguardFiles</code>配置：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    debug &#123;</span><br><span class="line">        versionNameSuffix <span class="string">"-debug"</span></span><br><span class="line">        minifyEnabled <span class="literal">false</span></span><br><span class="line">        zipAlignEnabled <span class="literal">false</span></span><br><span class="line">        shrinkResources <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span></span><br><span class="line">        zipAlignEnabled <span class="literal">true</span></span><br><span class="line">        shrinkResources <span class="literal">true</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        signingConfig signingConfigs.xxx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你是引用库，那么不要忘了给库配上混淆，详细参考<a href="http://blog.hwangjr.com/2015/11/25/%E6%90%9E%E5%AE%9AAndroid-Proguard/" target="_blank" rel="external">搞定Android Proguard</a>或者<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumerProguardFiles</span><br></pre></td></tr></table></figure></p>
<h2 id="其他方式">其他方式</h2><p>在SDK目录下，有<code>tools/proguard/</code>，这里即<code>proguard</code>的大本营，包括上面的<code>getDefaultProguardFile</code>方法也是到此目录获取<code>proguard-android.txt</code>文件。</p>
<p>在<code>proguard</code>目录下有<code>bin</code>目录，可以直接启动界面配置，当然也可以保存配置等。</p>
<p>其他类似<code>ANT</code>或者<code>IDE</code>类似<code>Eclipse</code>等，基本大同小异，自行摸索。</p>
<h1 id="配置">配置</h1><h2 id="基本配置">基本配置</h2><p>常用语法：</p>
<ul>
<li><code>-libraryjars class_path</code>：应用的依赖包，如<code>android-support-v4</code></li>
<li>-keep [,modifier,…] class_specification`：不混淆某些类</li>
<li><code>-keepclassmembers [,modifier,...] class_specification</code>：不混淆类的成员</li>
<li><code>-keepclasseswithmembers [,modifier,...] class_specification</code>：不混淆类及其成员</li>
<li><code>-keepnames class_specification</code>：不混淆类及其成员名</li>
<li><code>-keepclassmembernames class_specification</code>：不混淆类的成员名</li>
<li><code>-keepclasseswithmembernames class_specification</code>：不混淆类及其成员名</li>
<li><code>-assumenosideeffects class_specification</code>：假设调用不产生任何影响，在代码优化时会将该调用<code>remove</code>掉。如<code>system.out.println</code>和<code>Log.v</code>等等</li>
<li><code>-dontwarn [class_filter]</code>：不提示warnning</li>
</ul>
<p>更多关于ProGuard混淆规则和语法，参考<a href="http://proguard.sourceforge.net/index.html#manual/usage.html" target="_blank" rel="external">ProGuard</a>。</p>
<h2 id="常见使用">常见使用</h2><p><strong>不混淆类构造方法，需指定函数参数类型：</strong><br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(<span class="keyword">int</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个包所有/某个类、接口：</strong><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.hwangjr.utils.<span class="keyword">*</span><span class="keyword">*</span> &#123; <span class="keyword">*</span>; &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆某个方法：</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">hwangjr</span>.<span class="title">utils</span>.<span class="title">Telephony</span> </span>&#123;</span><br><span class="line">    public <span class="built_in">String</span> getTelephone(java.lang.<span class="built_in">String</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>不混淆Parcelable子类：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用assumenosideeffects移除代码：</strong><br>正常可通过BuildConfig.DEBUG变量控制日志输出，DEBUG模式可查看到日志。但ProGuard也可压缩和优化不必要的代码，包括debug日志，在发布时，会自动从源码中删除。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-assumenosideeffects <span class="keyword">class</span> android.util.Log &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">v</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">i</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">d</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">w</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> *** <span class="title">e</span><span class="params">(...)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 反射：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepattributes <span class="constant">Signature</span></span><br><span class="line"></span>-<span class="ruby">keepattributes <span class="constant">EnclosingMethod</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>Serializable类：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.io.ObjectStreamField[] serialPersistentFields;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream)</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">writeReplace</span><span class="params">()</span></span>;</span><br><span class="line">    java.lang.<span class="function">Object <span class="title">readResolve</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>JS接口：</strong><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keepclassmembers <span class="class"><span class="keyword">class</span> <span class="title">fqcn</span>.<span class="title">of</span>.<span class="title">javascript</span>.<span class="title">interface</span>.<span class="title">for</span>.<span class="title">webview</span> &#123;</span></span><br><span class="line"></span>    public *;</span><br><span class="line">&#125;</span><br><span class="line">-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">package</span>.<span class="title">name</span>.** &#123; *;</span> &#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="混淆后">混淆后</h1><h2 id="混淆后文件">混淆后文件</h2><p>Android Studio发布版本之后，会自动生成混淆之后文件（build/outputs/mapping/channel/release/）：<br><code>mapping.txt</code>：混淆前后代码对照，在混淆之后如果出现问题，需要查找此文件进行定位。<br><code>dump.txt</code>：APK内所有class文件结构<br><code>seeds.txt</code>：没有被混淆的类和成员<br><code>usage.txt</code>：源代码中被删除的代码</p>
<p><strong>所以，养成保存<code>mapping.txt</code>文件的习惯。</strong></p>
<h2 id="混淆后验证">混淆后验证</h2><p>反编译应用，大部分都变成<code>abc...</code>。</p>
<h2 id="混淆后调试">混淆后调试</h2><p>问题分为代码问题和混淆问题。</p>
<p><strong>代码问题</strong><br>通过查看<code>mapping.txt</code>文件，反推定位对应代码问题来进行解决。混淆后<code>$</code>为匿名内部类。</p>
<p><strong>混淆问题</strong><br>最常见<code>ClassNotFoundException</code>、<code>BadParcelableException</code>及JSON解析错误。<br><code>ClassNotFoundException</code>通过mapping逆推找到类，在混淆中加入不混淆此类即可：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="type">class</span> package.<span class="property">name</span>.<span class="type">class</span> &#123; *; &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Parcelable</code>混淆错误加入：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> android.os.Parcelable<span class="variable">$Creator</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>V4</code>包、<code>V7</code>包等包混淆问题（<code>sdk/tools/proguard/proguard-android.txt</code>中已经明确）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>更多问题可以参考：<a href="http://proguard.sourceforge.net/index.html#manual/troubleshooting.html" target="_blank" rel="external">ProGuard TroubleShooting</a></p>
<h1 id="ProGuard-Android">ProGuard-Android</h1><p>参考示例<code>sdk/tools/proguard/proguard-android.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimization is turned off by default. Dex does not like code run</span></span><br><span class="line"><span class="comment"># through the ProGuard optimize and preverify steps (and performs some</span></span><br><span class="line"><span class="comment"># of these optimizations on its own).</span></span><br><span class="line">-dontoptimize</span><br><span class="line">-dontpreverify</span><br><span class="line"><span class="comment"># Note that if you want to enable optimization, you cannot just</span></span><br><span class="line"><span class="comment"># include optimization flags in your own project configuration file;</span></span><br><span class="line"><span class="comment"># instead you will need to point to the</span></span><br><span class="line"><span class="comment"># "proguard-android-optimize.txt" file instead of this one from your</span></span><br><span class="line"><span class="comment"># project.properties file.</span></span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考示例<code>sdk/tools/proguard/proguard-android-optimize.txt</code>：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for ProGuard.</span></span><br><span class="line"><span class="comment"># http://proguard.sourceforge.net/index.html#manual/usage.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimizations: If you don't want to optimize, use the</span></span><br><span class="line"><span class="comment"># proguard-android.txt configuration file instead of this one, which</span></span><br><span class="line"><span class="comment"># turns off the optimization flags.  Adding optimization introduces</span></span><br><span class="line"><span class="comment"># certain risks, since for example not all optimizations performed by</span></span><br><span class="line"><span class="comment"># ProGuard works on all versions of Dalvik.  The following flags turn</span></span><br><span class="line"><span class="comment"># off various optimizations known to have issues, but the list may not</span></span><br><span class="line"><span class="comment"># be complete or up to date. (The "arithmetic" optimization can be</span></span><br><span class="line"><span class="comment"># used if you are only targeting Android 2.0 or later.)  Make sure you</span></span><br><span class="line"><span class="comment"># test thoroughly if you go this route.</span></span><br><span class="line">-optimizations !code/simplification/arithmetic,!code/simplification/cast,!field/<span class="keyword">*</span>,!class/merging/<span class="keyword">*</span></span><br><span class="line">-optimizationpasses 5</span><br><span class="line">-allowaccessmodification</span><br><span class="line">-dontpreverify</span><br><span class="line"></span><br><span class="line"><span class="comment"># The remainder of this file is identical to the non-optimized version</span></span><br><span class="line"><span class="comment"># of the Proguard configuration file (except that the other file has</span></span><br><span class="line"><span class="comment"># flags to turn off optimization).</span></span><br><span class="line"></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line">-keepattributes <span class="keyword">*</span>Annotation<span class="keyword">*</span></span><br><span class="line">-keep public class com.google.vending.licensing.ILicensingService</span><br><span class="line">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="line"></span><br><span class="line"><span class="comment"># For native methods, see http://proguard.sourceforge.net/manual/examples.html#native</span></span><br><span class="line">-keepclasseswithmembernames class <span class="keyword">*</span> &#123;</span><br><span class="line">    native <span class="variable">&lt;methods&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep setters in Views so that animations can still work.</span></span><br><span class="line"><span class="comment"># see http://proguard.sourceforge.net/manual/examples.html#beans</span></span><br><span class="line">-keepclassmembers public class <span class="keyword">*</span> extends android.view.View &#123;</span><br><span class="line">   void set<span class="keyword">*</span>(<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>);</span><br><span class="line">   <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> get<span class="keyword">*</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We want to keep methods in Activity that could be used in the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> extends android.app.Activity &#123;</span><br><span class="line">   public void <span class="keyword">*</span>(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># For enumeration classes, see http://proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers enum <span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span>[] values();</span><br><span class="line">    public static <span class="keyword">*</span><span class="keyword">*</span> valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span> implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class <span class="keyword">*</span><span class="keyword">*</span>.R$<span class="keyword">*</span> &#123;</span><br><span class="line">    public static <span class="variable">&lt;fields&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The support library contains references to newer platform versions.</span></span><br><span class="line"><span class="comment"># Don't warn about those in case this app is linking against an older</span></span><br><span class="line"><span class="comment"># platform version.  We know about them, and they are safe.</span></span><br><span class="line">-dontwarn android.support.<span class="keyword">*</span><span class="keyword">*</span></span><br></pre></td></tr></table></figure></p>
<p>参考<code>sdk/tools/proguard/proguard-project.txt</code>：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># To enable ProGuard in your project, edit project.properties</span></span><br><span class="line"><span class="preprocessor"># to define the proguard.config property as described in that file.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Add project specific ProGuard rules here.</span></span><br><span class="line"><span class="preprocessor"># By default, the flags in this file are appended to flags specified</span></span><br><span class="line"><span class="preprocessor"># in $&#123;sdk.dir&#125;/tools/proguard/proguard-android.txt</span></span><br><span class="line"><span class="preprocessor"># You can edit the include path and order by changing the ProGuard</span></span><br><span class="line"><span class="preprocessor"># include property in project.properties.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For more details, see</span></span><br><span class="line"><span class="preprocessor">#   http://developer.android.com/guide/developing/tools/proguard.html</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Add any project specific keep options here:</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># If your project uses WebView with JS, uncomment the following</span></span><br><span class="line"><span class="preprocessor"># and specify the fully qualified class name to the JavaScript interface</span></span><br><span class="line"><span class="preprocessor"># class:</span></span><br><span class="line"><span class="preprocessor">#-keepclassmembers class fqcn.of.javascript.interface.for.webview &#123;</span></span><br><span class="line"><span class="preprocessor">#   public *;</span></span><br><span class="line"><span class="preprocessor">#&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Ref">Ref</h2><p><a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a><br><a href="http://developer.android.com/intl/zh-cn/tools/help/proguard.html" target="_blank" rel="external">ProGuard | Android Developers</a><br><a href="http://www.trinea.cn/android/proguard-use/" target="_blank" rel="external">ProGuard的作用</a><br><a href="https://github.com/D-clock/Doc/blob/master/Gradle/4_AndroidStudio%E4%B8%8BProGuard%E6%B7%B7%E6%B7%86%E6%89%93%E5%8C%85.md" target="_blank" rel="external">AndroidStudio下ProGuard混淆打包.md</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/03/ProGuard-精粹/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/25/搞定Android-Proguard/" title="搞定Android Proguard" itemprop="url">搞定Android Proguard</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-25T10:23:19.000Z" itemprop="datePublished"> 发表于 2015-11-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>各种引用库，各种混淆，心好累。<br>所以，有了<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>。</p>
<h2 id="混淆设置">混淆设置</h2><p>Android中采用Proguard进行代码混淆。每次混淆，都会开始找寻混淆配置，在此开源库中，你可以找到你想要的，如果没找到，没关系，可以PULL REQUEST。</p>
<h3 id="build-gradle">build.gradle</h3><p>正常在<code>build.gradle</code>中加入混淆配置文件即可：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            zipAlignEnabled <span class="keyword">true</span></span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// specific proguard files</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span>, <span class="string">'proguard-gson.pro'</span></span><br><span class="line">            proguardFile <span class="string">'proguard-square-okio.pro'</span></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// As of Gradle Android plugin 1.1.0, the test APK has a separate config</span></span><br><span class="line">            testProguardFile <span class="string">'proguard-rules-test.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="proguard-rules-pro">proguard-rules.pro</h3><p>将混淆设置加入<code>proguard-rules.pro</code>文件也是一种方式：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="keyword">include</span> xxx</span></span><br></pre></td></tr></table></figure></p>
<h3 id="consumerProguardFiles">consumerProguardFiles</h3><p>开源库中可以依赖此标志来指定库的混淆方式，此会将<code>*.pro</code>文件打包进入<code>aar</code>中，库混淆时候会自动使用此混淆配置文件。</p>
<p>需要注意的是，以<code>consumerProguardFiles</code>方式加入的混淆具有以下特性：</p>
<ul>
<li><code>*.pro</code>文件会包含在<code>aar</code>文件中</li>
<li>这些<code>pro</code>配置会在混淆的时候被使用</li>
<li>此配置针对此<code>aar</code>进行混淆配置</li>
<li>此配置只对库文件有效，对应用程序无效</li>
</ul>
<p>所以以<a href="https://github.com/AndroidKnife/proguard-config" target="_blank" rel="external">AndroidKnife/proguard-config</a>开源库，只要一行代码即可搞定外部混淆：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.hwangjr.proguard:proguardconfig:1.0.1@aar'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>使用此库大善，欢迎pull request。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/25/搞定Android-Proguard/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/Books/" title="Books">Books<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CI/" title="CI">CI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Git/" title="Git">Git<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/tech/" title="tech">tech<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/创业/" title="创业">创业<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/tech/" title="tech">tech<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Git/" title="Git">Git<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/创业/" title="创业">创业<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ci/" title="ci">ci<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Books/" title="Books">Books<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://blog.hwangjr.com" target="_blank" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, Welcome to my blog. <br/>
			I&#39;m HwangJR, Tech change the world.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1234193120" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/hwangjr" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/4827228" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/HuangJR" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/https://facebook.com/jr.hwang.2010" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		
		
		<a href="https://www.zhihu.com/people/hwangjr" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		<a href="https://plus.google.com/+JianrongHuang?rel=author" target="_blank" class="icon-google_plus" title="Google+"></a>
		
		
		<a href="mailto:huangjianrong2010@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="HwangJR">HwangJR</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'HwangJR';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-63911310-1', 'hwangjr.github.io');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<script>
var option = {
  engineKey: '6e8f6d9aa88722365432'
};
(function(w,d,t,u,n,s,e){
  s = d.createElement(t);
  s.src = u;
  s.async = 1;
  w[n] = function(r){
    w[n].opts = r;
  };
  e = d.getElementsByTagName(t)[0];
  e.parentNode.insertBefore(s, e);
})(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
_ts(option);
</script>

<!-- Tiny_search End -->

  </body>
 </html>
