
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>HwangJR&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="HwangJR">
    

    
    <meta name="description" content="Some stuff about tech etc..">
<meta property="og:type" content="website">
<meta property="og:title" content="HwangJR's Blog">
<meta property="og:url" content="https://hwangjr.github.io/index.html">
<meta property="og:site_name" content="HwangJR's Blog">
<meta property="og:description" content="Some stuff about tech etc..">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HwangJR's Blog">
<meta name="twitter:description" content="Some stuff about tech etc..">
<meta name="twitter:creator" content="@HuangJR">
<link rel="publisher" href="+JianrongHuang">

    
    <link rel="alternative" href="/atom.xml" title="HwangJR&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HwangJR&#39;s Blog" title="HwangJR&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a></h1>
				<h2 class="blog-motto">Life is wonderful!</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="ts-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/24/发布开源项目到Maven（Gradle-Sonatype）/" title="发布开源项目到Maven（Gradle + Sonatype）" itemprop="url">发布开源项目到Maven（Gradle + Sonatype）</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-24T10:43:22.000Z" itemprop="datePublished"> 发表于 2015-11-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>最近整理Android开发工具，想跟其他人分享，就有了将其发布到maven想法，所以考虑将库发布到maven，目前Android官方使用jCenter，比这个简单，后续补充（jCenter会自动同步Maven Center中的库）。<br>顺带避免：</p>
<blockquote>
<p>Download the source to use it as library project</p>
</blockquote>
<h2 id="流程">流程</h2><p>整个流程很清晰：</p>
<ol>
<li>获取JIRA Ticket，简单说就是去<a href="https://issues.sonatype.org/browse/" target="_blank" rel="external">Issues Sonatype</a>注册并提交issue</li>
<li>GPG密钥，要上传到maven，需要GPG密钥</li>
<li>本地配置POM，即配置项目信息</li>
<li>Gradle提交到Sonatype，通过脚本提交到Sonatype</li>
<li>发布版本，分为SNAPSHOT和Release版本</li>
</ol>
<p>整个流程就是酱紫。OVER。</p>
<h2 id="获取JIRA_Ticket">获取JIRA Ticket</h2><h3 id="注册JIRA帐号">注册JIRA帐号</h3><p>提交项目到Sonatype，首先需要注册。打开<a href="https://issues.sonatype.org/" target="_blank" rel="external">(Issue Sonatype)</a>注册JIRA帐号。</p>
<h3 id="创建Issue">创建Issue</h3><p>在导航上Create按钮，创建一个新的Issue。其中特别注意：</p>
<ol>
<li>Issue Type默认是new Project，按照默认就好</li>
<li>Summer和Description填写你要创建项目的描述即可</li>
<li>Group id特别关键，最好创建顶级Group ID，比如我需要<code>com.hwangjr.xxx</code>，那么Group ID填写为<code>com.hwangjr</code>，这样其他的库也可发布</li>
<li>Project URL和SCM URL填GIT HUB项目地址即可</li>
<li>其他基本都懂</li>
</ol>
<p>填写完毕，等待！工作人员会让你提交你的项目到Sonatype。</p>
<h2 id="GPG密钥">GPG密钥</h2><p>密钥是为了上传文件的加密和签名。如果有安装git，那么应该是已经安装GPG了，以下默认命令为Linux下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">gpg --gen-key</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">gpg --list-key</span><br></pre></td></tr></table></figure></p>
<p>其中姓名、邮箱和备注需要认真填写下，最后输入的Passphase，是密码，上传maven需要使用。</p>
<blockquote>
<p>pub   2048R/B53A8137 2015-11-24<br>uid                  hwangjr (Upload Modules For Maven By Sonatype.) <a href="&#x6d;&#x61;&#x69;&#108;&#x74;&#111;&#x3a;&#x68;&#x75;&#97;&#x6e;&#x67;&#x6a;&#105;&#97;&#x6e;&#114;&#x6f;&#x6e;&#x67;&#50;&#x30;&#49;&#48;&#64;&#x67;&#x6d;&#97;&#105;&#108;&#46;&#x63;&#x6f;&#109;">&#x68;&#x75;&#97;&#x6e;&#x67;&#x6a;&#105;&#97;&#x6e;&#114;&#x6f;&#x6e;&#x67;&#50;&#x30;&#49;&#48;&#64;&#x67;&#x6d;&#97;&#105;&#108;&#46;&#x63;&#x6f;&#109;</a><br>sub   2048R/2F11E234 2015-11-24</p>
</blockquote>
<p>B53A8137是KEY ID。上传公钥到服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://pool.sks-keyservers.net --send-keys B53A8137</span><br></pre></td></tr></table></figure></p>
<h2 id="本地配置POM">本地配置POM</h2><p>Chris Banes大神已经写完Gradle插件<a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">chrisbanes/gradle-mvn-push</a>，可直接使用<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，上面有详细的配置和使用方式。简要步骤为：</p>
<ol>
<li>项目，保证是可以用Gradle编译。</li>
<li>更新<code>HOME gradle.properties</code>，修改<code>USER_HOME/.gradle/gradle.properties</code>文件。</li>
<li>在项目根目录下，创建文件<code>gradle.properties</code>。</li>
<li>在想要上传的子模块下，分别创建<code>gradle.properties</code>。</li>
<li>在子模块下，应用Gradle插件，即在<code>build.gradle</code>末尾加上<code>apply from: &#39;https://raw.github.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle&#39;</code> 或者下载gradle-mvn-push.gradle文件，放到根目录的<code>gradle</code>文件夹下，在<code>build.gradle</code>末尾加上<code>apply from: rootProject.file(&#39;gradle/gradle-mvn-push.gradle&#39;)</code>。</li>
<li>编译并上传<code>gradle clean build uploadArchives</code>。</li>
</ol>
<p>其他属性：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RELEASE_REPOSITORY_URL (defaults to Maven Central's staging server)</span><br><span class="line">SNAPSHOT_REPOSITORY_URL (defaults to Maven Central's snapshot server)</span><br></pre></td></tr></table></figure></p>
<p>USER_HOME/.gradle/gradle.properties文件新增，内容修改为自身用户名密码，下面的就是创建的GPG密钥：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NEXUS_USERNAME=chrisbanes</span><br><span class="line">NEXUS_PASSWORD=g00dtry</span><br><span class="line"></span><br><span class="line">signing.keyId=ABCDEF12</span><br><span class="line">signing.password=n1c3try</span><br><span class="line">signing.secretKeyRingFile=<span class="regexp">/home/u</span>ser<span class="regexp">/.gnupg/</span>secring.gpg</span><br></pre></td></tr></table></figure></p>
<p>项目根目录下的gradle.properties文件内容为，需要根据具体项目情况进行修改：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">VERSION_NAME=0.9.2-SNAPSHOT</span><br><span class="line">VERSION_CODE=92</span><br><span class="line">GROUP=com.github.chrisbanes.actionbarpulltorefresh</span><br><span class="line"></span><br><span class="line">POM_DESCRIPTION=A modern implementation of the pull-to-refresh for Android</span><br><span class="line">POM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_URL=https://github.com/chrisbanes/ActionBar-PullToRefresh</span><br><span class="line">POM_SCM_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_SCM_DEV_CONNECTION=scm:git@github.com:chrisbanes/ActionBar-PullToRefresh.git</span><br><span class="line">POM_LICENCE_NAME=The Apache Software License, Version 2.0</span><br><span class="line">POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt</span><br><span class="line">POM_LICENCE_DIST=repo</span><br><span class="line">POM_DEVELOPER_ID=chrisbanes</span><br><span class="line">POM_DEVELOPER_NAME=Chris Banes</span><br></pre></td></tr></table></figure></p>
<p>子模块的gradle.properties文件内容为：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POM_NAME=ActionBar-PullToRefresh Library</span><br><span class="line">POM_ARTIFACT_ID=library</span><br><span class="line">POM_PACKAGING=aar</span><br></pre></td></tr></table></figure></p>
<p><strong>其中</strong>VERSION_NAME后面如果带<code>SNAPSHOT</code>会提交到<a href="https://oss.sonatype.org/content/repositories/snapshots" target="_blank" rel="external">Snapshots</a>，这个不需要同步即可下载jar和源码，如果不加则为RELEASE版本，会同步到MAVEN CENTER。</p>
<h2 id="Gradle脚本提交到Sonatype">Gradle脚本提交到Sonatype</h2><p>运行命令：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle clean build uploadArchives</span><br></pre></td></tr></table></figure></p>
<p>即会执行clean，并重新编译，上传到Sonatype。</p>
<h2 id="发布版本">发布版本</h2><p>版本分为<code>SNAPSHOT</code>版本和<code>RELEASE</code>版本。<br>如果<code>VERSION_NAME</code>有加入<code>SNAPSHOT</code>，即为<code>SNAPSHOT</code>版本，不会同步到MAVEN。<br>如果没有<code>SNAPSHOT</code>，则会同步到MAVEN。</p>
<p>首次提交之后，登陆<a href="https://oss.sonatype.org/index.html#welcome" target="_blank" rel="external">Sonatype Nexus Professional</a>，查看<code>Staging Repositories</code>，找到提交的包，选择并close并Release，再到<code>issue sonatype</code>上提交的JIRA TICKET后面评论告知版本已经staged并released，可以进行sync，工作人员会进行同步。<br>同步成功之后，即可在<a href="http://search.maven.org/" target="_blank" rel="external">maven center</a>搜索到项目，可通过gradle添加依赖。</p>
<h2 id="常规发布步骤">常规发布步骤</h2><ol>
<li>发布<code>SNAPSHOT</code>版本是否查看是否正常</li>
<li>发布<code>RELEASE</code>版本到线上，并进行同步</li>
<li>修改为下个<code>SNAPSHOT</code>版本</li>
</ol>
<h2 id="TIPS">TIPS</h2><h3 id="发布JAR">发布JAR</h3><p>如果想发布JAR，在<a href="#本地配置POM">本地配置POM</a>时，修改<a href="https://raw.githubusercontent.com/chrisbanes/gradle-mvn-push/master/gradle-mvn-push.gradle" target="_blank" rel="external">gradle-mvn-push.gradle</a>，在脚本中加入：<br>``` gradle<br>artifacts {<br>    archives packageReleaseJar<br>}</p>
<h3 id="发布时返回401">发布时返回401</h3><p>401为没有权限错误，检查：</p>
<ol>
<li>用户名密码，可在gradle-mvn-push中打印日志查看用户名密码是否正确</li>
<li>检查Sonatype是否有权限</li>
</ol>
<h2 id="REFS">REFS</h2><p><a href="http://central.sonatype.org/pages/ossrh-guide.html" target="_blank" rel="external">OSSRH Guide</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/gpg.html" target="_blank" rel="external">GPG入门教程</a><br><a href="https://github.com/chrisbanes/gradle-mvn-push" target="_blank" rel="external">gradle-mvn-push</a><br><a href="https://oss.sonatype.org/" target="_blank" rel="external">Sonatype Nexus Professional</a><br><a href="http://afoo.me/posts/2013-07-18-publishing-oss-release-to-maven-central-repo.html" target="_blank" rel="external">发布开源项目到Maven Central</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/24/发布开源项目到Maven（Gradle-Sonatype）/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/13/应用内存泄露排查/" title="应用内存泄露排查" itemprop="url">应用内存泄露排查</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-13T03:26:23.000Z" itemprop="datePublished"> 发表于 2015-11-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="内存泄露">内存泄露</h2><p>用到神器<a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a>：</p>
<blockquote>
<p>A memory leak detection library for Android and Java.<br>“A small leak will sink a great ship.”    - Benjamin Franklin<br>千里之堤，毁于蚁穴。 — 《韩非子.喻老》</p>
</blockquote>
<h3 id="LeakCanary完整集成">LeakCanary完整集成</h3><p><strong>配置build.gradle</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">	    <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.2.3'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">apply plugin: <span class="string">'android-library'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">	<span class="keyword">repositories</span>&#123;</span><br><span class="line">		jcenter()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">   debugCompile <span class="string">'com.squareup.leakcanary:leakcanary-android:1.3.1'</span></span><br><span class="line">   releaseCompile <span class="string">'com.squareup.leakcanary:leakcanary-android-no-op:1.3.1'</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>配置代码</strong><br>在你的APPLICATION中：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class ExampleApplication extends Application &#123;&#10;  @Override public void onCreate() &#123;&#10;&#9;super.onCreate();&#10;&#9;if (BuildConfig.DEBUG) &#123;&#10;&#9;    refWatcher = LeakCanary.install(this, LeakLogService.class,&#10;&#9;            AndroidExcludedRefs.createAndroidDefaults().build());&#10;&#9;&#125; else &#123;&#10;&#9;    refWatcher = RefWatcher.DISABLED;&#10;&#9;&#125;&#10;&#10;&#9;public static RefWatcher getRefWatcher(Context context) &#123;&#10;        ExampleApplication application = (ExampleApplication) context.getApplicationContext();&#10;        return application.refWatcher;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后在需要检测的地方进行监听即可：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract class BaseFragment extends Fragment &#123;&#10;&#10;  @Override public void onDestroy() &#123;&#10;    super.onDestroy();&#10;    RefWatcher refWatcher = ExampleApplication.getRefWatcher(getActivity());&#10;    refWatcher.watch(this);&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简易集成">简易集成</h3><p>参考<a href="https://github.com/GavinCT/SimpleLeakCanary" target="_blank" rel="external">GavinCT/SimpleLeakCanary</a>。<br>拷贝库文件到项目下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AndroidWatchExecutor<span class="class">.java</span></span><br><span class="line">GcTrigger<span class="class">.java</span></span><br><span class="line">KeyedWeakReference<span class="class">.java</span></span><br><span class="line">RefWatcher.java</span><br></pre></td></tr></table></figure></p>
<p>在需要监听的地方添加监听代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected void onDestroy() &#123;&#10;&#9;super.onDestroy();&#10;&#9;getApplicationContext().getRefWatcher().watch(this);&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="排查内存泄露">排查内存泄露</h2><p>利用Eclipse的Memory Analyzer（<a href="http://www.eclipse.org/mat/" target="_blank" rel="external">Eclipse Memory Analyzer Open Source Project</a>）可以方便的分析内存泄露原因。</p>
<p><strong>使用Studio帮助我们排查泄露</strong><br>通过Studio我们可以：</p>
<ol>
<li>查看内存堆栈情况</li>
<li>手动/强制垃圾回收，排除LeakCanary误报</li>
<li>导出Heap信息（Dump Java Heap）</li>
</ol>
<p>内存信息导出后，可用MAT打开.hprof文件进行分析，可能需要进行转换：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hprof-conv source.hprof dist.hprof</span><br></pre></td></tr></table></figure></p>
<p>打开QQL查询当前内存信息（快捷键CTRL + ENTER执行QQL语句）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from instanceof android.app.Activity</span><br></pre></td></tr></table></figure></p>
<p>查看内存信息，如果有多个相同对象即为可疑泄露对象：<br><code>右键 -&gt; Merge Shortest Paths to GC Roots -&gt; exclude all phantom/weak/soft etc. refrences</code><br>具体排查类，即可发现泄露对象。</p>
<h2 id="解决内存泄露">解决内存泄露</h2><p>针对可疑泄露对象，进行代码排查，即可解决。</p>
<h2 id="避免内存泄露">避免内存泄露</h2><p>良好编码习惯！</p>
<ol>
<li>匿名内部类</li>
<li>非静态内部类</li>
<li>单例对象持有Activity或Context对象<br>ETC…</li>
</ol>
<h2 id="REF">REF</h2><p><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html" target="_blank" rel="external">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a><br><a href="https://github.com/square/leakcanary" target="_blank" rel="external">square/leakcanary</a><br><a href="http://droidyue.com/blog/2014/11/02/note-for-google-io-memory-management-for-android-chinese-edition/" target="_blank" rel="external">Google IO：Android内存管理主题演讲记录 - 技术小黑屋</a><br><a href="http://jiajixin.cn/2015/01/06/memory_leak/" target="_blank" rel="external">Android内存泄漏研究 | Jason’s Blog</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/13/应用内存泄露排查/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/09/CentOS如何移除依赖/" title="CentOS如何移除依赖" itemprop="url">CentOS如何移除依赖</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-11-09T02:44:12.000Z" itemprop="datePublished"> 发表于 2015-11-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="自带清除技能">自带清除技能</h2><p>从Fedora 18之后，yum有自带清除：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum autoremove</span><br><span class="line">yum autoremove &lt;package&gt;</span><br><span class="line"><span class="comment"># 一般不用</span></span><br><span class="line">yum remove --setopt=clean_requerements_on_remove=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="第三方技能">第三方技能</h2><p>安装<code>yum-utils</code>也是可以自动清理依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">package-cleanup --leaves</span><br><span class="line">package-cleanup --leaves --all</span><br><span class="line">package-cleanup -q --leaves | xargs <span class="operator">-l</span>1 yum -y remove</span><br></pre></td></tr></table></figure></p>
<h2 id="回滚安装技能">回滚安装技能</h2><p>自然，我们是在安装的时候安装了依赖，那如果我们回滚本次安装，也一样可以卸载这些依赖：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> list &lt;package&gt;</span><br><span class="line">yum <span class="built_in">history</span> undo &lt;ID&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><p>相比而言，现在对包管理还是简单方便的，当然更高深的还需要自己摸索。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/09/CentOS如何移除依赖/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/27/Crontabs-Guide/" title="Crontabs Guide" itemprop="url">Crontabs Guide</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-27T04:05:24.000Z" itemprop="datePublished"> 发表于 2015-10-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Introduction">Introduction</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure>
<p>—-&gt;</p>
<blockquote>
<p>Crontab  is the program used to install, remove or list the tables used to drive the cron(8) daemon.  Each user can have their own crontab, and though these are files in /var/spool/ , they are not intended to be edited directly. For SELinux in mls mode can be even more crontabs - for each range. For more see selinux(8).</p>
<p>The  cron  jobs  could  be allow or disallow for different users. For classical crontab there exists cron.allow and cron.deny files.  If cron.allow file exists, then you must be listed therein in order to be allowed to use this command.  If the cron.allow file does not exist but the cron.deny file does exist,  then  you must  not  be listed in the cron.deny file in order to use this command.  If neither of these files exists, only the super user will be allowed to use this com-mand. The second option is using PAM authentication, where you set up users, which could or couldn’t use crontab and also system cron jobs from /etc/cron.d/.</p>
<p>The temporary directory could be set in enviroment variables. If it’s not set by user than /tmp is used.</p>
</blockquote>
<h2 id="Installation">Installation</h2><p>Just the commands:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check installation</span></span><br><span class="line">rpm -ql crontabs</span><br><span class="line">rpm -qa crontabs</span><br><span class="line"><span class="comment"># install</span></span><br><span class="line">yum install crontabs</span><br><span class="line"><span class="comment"># start service on boot</span></span><br><span class="line">chkconfig crond on</span><br><span class="line"><span class="comment"># start service now</span></span><br><span class="line">service crond start</span><br><span class="line">service crond status</span><br><span class="line">service crond restart</span><br><span class="line">service crond reload</span><br><span class="line">service crond stop</span><br></pre></td></tr></table></figure></p>
<p>Also, you can check the service by:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntsysv</span><br></pre></td></tr></table></figure></p>
<h2 id="Usage">Usage</h2><h3 id="Basic_Usage">Basic Usage</h3><p>Also, <code>man</code> is our best friend :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>NAME<br>crontab - maintain crontab files for individual users</li>
<li>SYNOPSIS<br>crontab [-u user] file<br>crontab [-u user] [-l | -r | -e] [-i] [-s]</li>
<li>OPTIONS<pre><code>**-u**     Append <span class="keyword">the</span> <span class="property">name</span> <span class="keyword">of</span> <span class="keyword">the</span> user <span class="keyword">whose</span> crontab <span class="keyword">is</span> <span class="keyword">to</span> be tweaked.  If this option <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">given</span>, crontab examines <span class="string">"your"</span> crontab, i.e., <span class="keyword">the</span> crontab <span class="keyword">of</span> <span class="keyword">the</span>  person  executing  <span class="keyword">the</span>  command.   Note  <span class="keyword">that</span>  su(<span class="number">8</span>) can confuse crontab <span class="keyword">and</span> <span class="keyword">that</span> <span class="keyword">if</span> you are <span class="property">running</span> inside <span class="keyword">of</span> su(<span class="number">8</span>) you should always use <span class="keyword">the</span> -u option <span class="keyword">for</span> safety’s sake.  The <span class="keyword">first</span> form <span class="keyword">of</span> this command <span class="keyword">is</span> used <span class="keyword">to</span> install a new crontab <span class="keyword">from</span> <span class="keyword">some</span> named <span class="type">file</span> <span class="keyword">or</span> standard input  <span class="keyword">if</span>  <span class="keyword">the</span>  pseudo-filename  <span class="string">"-"</span>  <span class="keyword">is</span> <span class="keyword">given</span>.
**-l**     The current crontab will be displayed <span class="function_start"><span class="keyword">on</span></span> standard output.
**-r**     The current crontab will be removed.
**-e**     This  option  <span class="keyword">is</span> used <span class="keyword">to</span> edit <span class="keyword">the</span> current crontab using <span class="keyword">the</span> editor specified <span class="keyword">by</span> <span class="keyword">the</span> VISUAL <span class="keyword">or</span> EDITOR environment variables.  After you <span class="keyword">exit</span> <span class="keyword">from</span> <span class="keyword">the</span> editor, <span class="keyword">the</span> modified crontab will be installed automatically.
**-i**     This option modifies <span class="keyword">the</span> -r option <span class="keyword">to</span> prompt <span class="keyword">the</span> user <span class="keyword">for</span> a ’y/Y’ response <span class="keyword">before</span> actually removing <span class="keyword">the</span> crontab.
**-s**     It will append <span class="keyword">the</span> current SELinux security context <span class="type">string</span> <span class="keyword">as</span> an MLS_LEVEL setting <span class="keyword">to</span> <span class="keyword">the</span> crontab <span class="type">file</span> <span class="keyword">before</span> editing / replacement occurs - see <span class="keyword">the</span> doc-umentation <span class="keyword">of</span> MLS_LEVEL <span class="keyword">in</span> crontab(<span class="number">5</span>).
</code></pre></li>
<li>FILES<pre><code><span class="regexp">/etc/</span>cron.allow
<span class="regexp">/etc/</span>cron.deny
</code></pre></li>
</ul>
</blockquote>
<p>Shortly for this :<br>&gt;</p>
<ul>
<li>usage:<br>  crontab [-u user] file<br>  crontab [-u user] [ -e | -l | -r ]<pre><code>(<span class="keyword">default</span> operation <span class="keyword">is</span> <span class="built_in">replace</span>, per <span class="number">1003.2</span>)
</code></pre>  -e    (edit user’s crontab)<br>  -l    (list user’s crontab)<br>  -r    (delete user’s crontab)<br>  -i    (prompt before deleting user’s crontab)<br>  -s    (selinux context)</li>
</ul>
<p>The format of <code>-e</code> command is:<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  *    *    *    *    *   command</span><br><span class="line">minus <span class="built_in">hour</span> <span class="built_in">day</span> <span class="built_in">month</span> week command</span><br><span class="line"></span><br><span class="line">minus: <span class="number">1</span>~<span class="number">59</span> minus, * <span class="keyword">or</span> */<span class="number">1</span> <span class="keyword">for</span> per minus</span><br><span class="line"><span class="built_in">hour</span>: <span class="number">1</span>~<span class="number">23</span>, <span class="number">0</span> means <span class="number">0</span> o<span class="comment">'clock</span></span><br><span class="line"><span class="built_in">day</span>: <span class="number">1</span>~<span class="number">31</span></span><br><span class="line"><span class="built_in">month</span>: <span class="number">1</span>~<span class="number">12</span></span><br><span class="line">week: <span class="number">0</span>~<span class="number">6</span>, <span class="number">0</span> means sunday</span><br><span class="line">command: the command u want <span class="keyword">to</span> run</span><br></pre></td></tr></table></figure></p>
<h3 id="Examples">Examples</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># every night at <span class="number">21</span>:<span class="number">31</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每晚的<span class="number">21</span>:<span class="number">30</span></span></span><br><span class="line"><span class="number">30</span> <span class="number">21</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span>, <span class="number">10</span>, <span class="number">22</span> per month at <span class="number">4</span>:<span class="number">45</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每月<span class="number">1</span>、<span class="number">10</span>、<span class="number">22</span>日的<span class="number">4</span>:<span class="number">45</span></span></span><br><span class="line"><span class="number">45</span> <span class="number">4</span> <span class="number">1</span>,<span class="number">10</span>,<span class="number">22</span> * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday and sunday per week at <span class="number">1</span>:<span class="number">10</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每周六、周日的<span class="number">1</span>:<span class="number">10</span></span></span><br><span class="line"><span class="number">10</span> <span class="number">1</span> * * <span class="number">6</span>,<span class="number">0</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">18</span>:<span class="number">00</span> ~ <span class="number">23</span>:<span class="number">00</span> per <span class="number">30</span> minus everyday reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每天<span class="number">18</span>:<span class="number">00</span>至<span class="number">23</span>:<span class="number">00</span>之间每隔<span class="number">30</span>分钟</span></span><br><span class="line"><span class="number">0</span>,<span class="number">30</span> <span class="number">18</span>-<span class="number">23</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># saturday per week at <span class="number">23</span>:<span class="number">00</span> reload nginx</span></span><br><span class="line"><span class="preprocessor"># 每星期六的<span class="number">23</span>:<span class="number">00</span></span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * <span class="number">6</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">23</span>:<span class="number">00</span> ~ <span class="number">7</span>:<span class="number">00</span> per hour</span></span><br><span class="line"><span class="preprocessor"># <span class="number">23</span>点到<span class="number">7</span>点之间，每隔一小时</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span>-<span class="number">7</span>/<span class="number">1</span> * * * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per hour</span></span><br><span class="line"><span class="comment"># 每一小时</span></span><br><span class="line"><span class="keyword">*</span> <span class="keyword">*</span>/1 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">4</span> every month and monday to wednesday every week at <span class="number">11</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 每月的<span class="number">4</span>号与每周一到周三的<span class="number">11</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">11</span> <span class="number">4</span> * mon-wed /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># <span class="number">1</span> january at <span class="number">4</span>:<span class="number">00</span></span></span><br><span class="line"><span class="preprocessor"># 一月一号的<span class="number">4</span>点</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span> <span class="number">1</span> jan * /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># per 30 minus</span></span><br><span class="line"><span class="comment"># 每半小时</span></span><br><span class="line"><span class="keyword">*</span>/30 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> /usr/bin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="Advanced_Usage">Advanced Usage</h3><p>For the files:</p>
<ul>
<li>/etc/cron.allow : list the user who can use crontab</li>
<li>/etc/cron.deny : list the user who cannot use crontab</li>
<li>/var/spool/cron : all users and their crontab will be store here</li>
<li>/var/log/cron : cron log per job</li>
<li>/etc/crontab : for system jobs, <code>crontab -e</code> is for current user</li>
<li>/etc/cron.d/* : seperated cron file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.d</span><br><span class="line"><span class="number">0</span>hourly  raid-check</span><br><span class="line"></span><br><span class="line">cat /etc/cron.d/<span class="number">0</span>hourly </span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"><span class="number">01</span> * * * * root run-parts /etc/cron.hourly</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/cron.hourly/</span><br><span class="line"><span class="number">0</span>anacron</span><br><span class="line"></span><br><span class="line">cat /etc/cron.hourly/<span class="number">0</span>anacron </span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Skip excecution unless the date has changed from the previous run </span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -r /var/spool/anacron/cron.daily; <span class="keyword">then</span></span><br><span class="line">    day=`cat /var/spool/anacron/cron.daily`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `date +%Y%m%d` = <span class="string">"<span class="variable">$day</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip excecution unless AC powered</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -x /usr/bin/on_ac_power; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/on_ac_power &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> $? <span class="operator">-eq</span> <span class="number">1</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/usr/sbin/anacron <span class="operator">-s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/anacrontab </span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=<span class="number">45</span></span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=<span class="number">3</span>-<span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line"><span class="number">1</span>	<span class="number">5</span>	cron.daily		nice run-parts /etc/cron.daily</span><br><span class="line"><span class="number">7</span>	<span class="number">25</span>	cron.weekly		nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly <span class="number">45</span>	cron.monthly		nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">More Info</a>.</p>
<h2 id="Practice">Practice</h2><p>I want to backup my svn daily, so i must have a script to backup:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">cd</span> /home/svn/repos</span><br><span class="line">now=`/bin/date +%Y%m%d`</span><br><span class="line">/bin/tar czvf <span class="string">"kk_backup_<span class="variable">$now</span>.tar.gz"</span> kk/ &amp;&amp; rm -rf /home/svn/backup/* &amp;&amp; /bin/mv kk_backup_*.tar.gz /home/svn/backup/</span><br><span class="line"><span class="keyword">if</span> [ $? == <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">result=<span class="string">"backup svn OK!!"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">result=<span class="string">"backup svn False!!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$result</span></span><br></pre></td></tr></table></figure></p>
<p>then just give the script to <code>/etc/cron.daily</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp scripts/backup.sh /etc/cron.daily/svn_backup.sh</span><br><span class="line">chmod +x /etc/cron.daily/svn_backup.sh</span><br></pre></td></tr></table></figure></p>
<p>That’s all.</p>
<h1 id="REF">REF</h1><p><a href="http://linux.vbird.org/linux_basic/0430cron.php" target="_blank" rel="external">鳥哥的 Linux 私房菜 — 第十五章、例行性工作排程(crontab)</a><br><a href="http://www.cnblogs.com/ccdc/archive/2012/06/01/2529471.html" target="_blank" rel="external">centos中crontab（计时器）用法详解 - 长城的草 - 博客园</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/27/Crontabs-Guide/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/24/CentOS6-5使用RSYNC发布程序/" title="CentOS6.5使用RSYNC发布程序" itemprop="url">CentOS6.5使用RSYNC发布程序</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-24T11:53:51.000Z" itemprop="datePublished"> 发表于 2015-10-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>Rsync（remote synchronize）是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件，也可以使用 Rsync 同步本地硬盘中的不同目录。</p>
<blockquote>
<p>rsync is an <a href="http://www.opensource.org/" target="_blank" rel="external">open source</a> utility that provides fast incremental file transfer. rsync is freely available under the <a href="https://rsync.samba.org/GPL.html" target="_blank" rel="external">GNU General Public License</a> and is currently being maintained by <a href="http://opencoder.net/" target="_blank" rel="external">Wayne Davison</a>.<br>If you are running (1) an xattr-enabled rsync older than 3.0.2, (2) a writable rsync daemon older than 3.0.0, or (3) a version of rsync older than 2.6.6, please see the <a href="https://rsync.samba.org/security.html" target="_blank" rel="external">rsync security advisory page</a>.</p>
</blockquote>
<p>本次将使用此工具与SVN配合，通过SVN进行版本控制，上传代码之后，自动同步发布到线上。</p>
<h2 id="安装">安装</h2><p>查询现有版本并安装。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">rpm -qa | grep rsync</span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">rpm <span class="operator">-e</span> rsync</span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget http://pkgs.repoforge.org/rsync/rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">rpm -ivh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br><span class="line"><span class="comment"># 直接升级</span></span><br><span class="line">rpm -Uvh rsync-<span class="number">3.1</span>.<span class="number">1</span>-<span class="number">1</span>.el6.rfx.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>自然，你可以通过<code>yum</code>安装，不过版本较低：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">9</span>.el6_4.<span class="number">1</span> will be updated</span><br><span class="line">---&gt; Package rsync.x86_64 <span class="number">0</span>:<span class="number">3.0</span>.<span class="number">6</span>-<span class="number">12</span>.el6 will be an update</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br></pre></td></tr></table></figure></p>
<h2 id="配置">配置</h2><h3 id="初始配置">初始配置</h3><ul>
<li>选择rsync服务器启动方式：<ol>
<li>rsync服务器负载较高，则使用独立启动模式</li>
<li>rsync服务器负载较低，使用xinetd运行方式</li>
</ol>
</li>
<li>创建配置文件rsyncd.conf</li>
<li>对于非匿名方式访问的rsync服务器创建配置口令（建议配置需要口令访问）<br>CentOS 默认以xinetd模式运行rsync，rsync的xinetd配置文件是/etc/xinetd.d/rsync<br>如果配置rsync以xinetd模式运行，执行如下命令<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rsync on</span><br><span class="line">service xinetd restart</span><br><span class="line"><span class="preprocessor"># 如果执行 service xinetd restart 发现 xinetd: unrecognized service 则未安装xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 执行 yum install xinetd 安装 xinetd服务</span></span><br><span class="line"><span class="preprocessor"># 安装之后启动 xinetd服务(service xinetd start)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>编辑rsync的xinetd配置文件/etc/xinetd.d/rsync文件，修改参数 server_args = —daemon —config=/etc/rsyncd/rsyncd.conf 可以配置rsync服务器启动时的参数</p>
<p>如果使用独立运行模式，则执行如下命令<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/rsync <span class="comment">--daemon</span></span><br><span class="line">#编辑 /etc/rc.<span class="keyword">local</span>文件 加入 /usr/bin/rsync <span class="comment">--daemon 保证每次开机启动都会自动启动rsync服务</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置设置">配置设置</h3><p>创建配置目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建rsync服务目录</span></span><br><span class="line">mkdir /etc/rsyncd</span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.conf</span><br><span class="line"><span class="comment"># 创建密码文件</span></span><br><span class="line">touch /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="comment">#权限修改</span></span><br><span class="line">chown root:root /etc/rsyncd/rsyncd.passwd</span><br><span class="line">chmod <span class="number">600</span> /etc/rsyncd/rsyncd.passwd</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root                         </span><br><span class="line">gid = root                                  </span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span>                      </span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid             </span><br><span class="line"></span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line">#<span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span>           </span><br><span class="line"></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd        </span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"></span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[hwangjrhome]</span><br><span class="line"><span class="keyword">path</span> = /home/hwangjr/</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = hwangjr</span><br><span class="line"><span class="keyword">comment</span> = HwangJR home</span><br><span class="line"><span class="keyword">exclude</span> = important/</span><br><span class="line"></span><br><span class="line">[chinatmp]</span><br><span class="line"><span class="keyword">path</span> = /tmp/china/</span><br><span class="line"><span class="keyword">list</span>=<span class="keyword">no</span></span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = china</span><br><span class="line"><span class="keyword">comment</span> = tmp china</span></span><br></pre></td></tr></table></figure></p>
<p>密码文件：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">hwangjr:</span>asdf             <span class="preprocessor">#格式   用户名:口令</span></span><br><span class="line"><span class="label">china:</span>jk               <span class="preprocessor">#该用户不要求是系统用户</span></span><br></pre></td></tr></table></figure></p>
<p>查看服务是否启动：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an <span class="string">| grep 873</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自动同步">自动同步</h3><p>编辑crontab<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure></p>
<p>加入同步命令：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 每天<span class="number">0</span>点<span class="number">10</span>分执行后面的命令</span></span><br><span class="line"><span class="number">10</span> <span class="number">0</span> * * * rsync -avzP  --<span class="keyword">delete</span>  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端配置">客户端配置</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 安装客户端</span></span><br><span class="line">yum -y install rsync</span><br><span class="line"><span class="preprocessor"># 同步命令</span></span><br><span class="line"><span class="preprocessor"># -a 参数，相当于-rlptgoD</span></span><br><span class="line"><span class="preprocessor">#   -r 是递归 -l 是链接文件，意思是拷贝链接文件；-p 表示保持文件原有权限</span></span><br><span class="line"><span class="preprocessor">#   -t 保持文件原有时间；-g 保持文#件原有用户组；-o 保持文件原有属主；-D 相当于块设备文件</span></span><br><span class="line"><span class="preprocessor"># -z 传输时压缩；</span></span><br><span class="line"><span class="preprocessor"># -P 传输进度；</span></span><br><span class="line"><span class="preprocessor"># -v 传输时的进度等信息，和-P有点关系，自己试试。可以看文档；</span></span><br><span class="line"><span class="preprocessor"># 同步</span></span><br><span class="line">rsync -avzP hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 客户端数据和服务器端数据保持一致</span></span><br><span class="line"><span class="preprocessor"># –delete 选项，表示客户端上的数据要与服务器端完全一致，如果 /tmp/hwangjr/目录中有服务器上不存在的文件，则删除。最终目的是让/tmp/hwangjr/目录上的数据完全与服务器上保持一致；用的时候要小心点，最好不要把已经有重要数所据的目录，当做本地更新目录，否则会把你的数据全部删除</span></span><br><span class="line">rsync -avzP  --delete hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 指定传输时候的密码文件，密码文件权限 600</span></span><br><span class="line"><span class="preprocessor"># –password-file=rsync.password ，这时当我们以hwangjr用户登录rsync服务器同步数据时，密码将读取 /tmp/rsync.password 这个文件。这个文件内容只是hwangjr用户的密码。我们要如下做；</span></span><br><span class="line"><span class="preprocessor"># touch /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># chmod 600 /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># echo "asdf"&gt; /tmp/rsync.password</span></span><br><span class="line"><span class="preprocessor"># rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@172.16.1.135::hwangjrhome  /tmp/hwangjr/</span></span><br><span class="line"><span class="preprocessor"># 注： 这样就不需要密码了，服务器通过crond 计划任务自动同步</span></span><br><span class="line">rsync -avzP  --delete  --password-file=/tmp/rsync.password hwangjr@<span class="number">172.16</span><span class="number">.1</span><span class="number">.135</span>::hwangjrhome  /tmp/hwangjr/</span><br></pre></td></tr></table></figure>
<h3 id="配置语法">配置语法</h3><blockquote>
<ul>
<li><strong>模块</strong>：<br>  以[模块名称]开始</li>
<li><strong>参数配置行</strong>：<br>  格式 name = value<br>  其中 value的值可以是string(可以不使用引号)或者boolean(0/1,true/false,yes/no)</li>
<li><strong>以#开始是注释行</strong></li>
<li><strong>以\是续行符</strong></li>
</ul>
</blockquote>
<ol>
<li><p>全局参数（[模块名称]之外的配置均为全局配置）<br><strong>address</strong><br>在独立运行时，用于指定的服务器运行的 IP 地址。由 xinetd 运行时将忽略此参数，使用命令行上的 –address 选项替代<br>默认值 本地所有IP<br><strong>port</strong><br>指定 rsync 守护进程监听的端口号。 由 xinetd 运行时将忽略此参数，使用命令行上的–port 选项替代。<br>默认值是 873<br><strong>motd file</strong><br>指定一个消息文件，当客户连接服务器时该文件的内容显示给客户。<br>默认值无<br><strong>pid file</strong><br>rsync 的守护进程将其 PID 写入指定的文件。<br>默认值 无<br><strong>log file</strong><br>指定 rsync 守护进程的日志文件，而不将日志发送给 syslog。<br>默认值 无<br><strong>syslog facility</strong><br>指定 rsync 发送日志消息给 syslog 时的消息级别<br>默认值 daemon<br><strong>socket options</strong><br>指定自定义 TCP 选项。<br>默认值无</p>
</li>
<li><p>模块参数<br>模块参数主要用于定义 rsync 服务器哪个目录要被同步。模块声明的格式必须为 [module] 形式，这个名字就是在 rsync 客户端看到的名字，类似于 Samba 服务器提供的共享名。而服务器真正同步的数据是通过 path 来指定的。可以根据自己的需要，来指定多个模块，模块中可以定义以下参数：</p>
</li>
</ol>
<ul>
<li>基本模块参数<br><strong>path</strong><br>指定当前模块在 rsync 服务器上的同步路径，该参数是必须指定的<br><strong>comment</strong><br>给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户<br>模块控制参数<br><strong>use chroot</strong><br>若为 true，则 rsync 在传输文件之前首先 chroot 到 path 参数所指定的目录下。这样做的原因是实现额外的安全防护，但是缺点是需要 root 权限，并且不能备份指向 path 外部的符号连接所指向的目录文件。<br>默认值true<br><strong>uid</strong><br>指定该模块以指定的 UID 传输文件。<br>默认值 nobody<br><strong>gid</strong><br>指定该模块以指定的 GID 传输文件。<br>默认值 nobody<br><strong>max connections</strong><br>定该模块的最大并发连接数量以保护服务器，超过限制的连接请求将被告知随后再试。<br>默认值 0 不限制<br><strong>read only</strong><br>指定是否允许客户上传文件。若为 true 则不允许上传；若为 false 并且服务器目录也具有读写权限则允许上传。<br>默认值 true<br><strong>write only</strong><br>指定是否允许客户下载文件。若为 true 则不允许下载；若为 false 并且服务器目录也具有读权限则允许下载。<br>默认值 false<br>模块认证参数<br><strong>hosts allow</strong><br>用一个主机列表指定哪些主机客户允许连接该模块。不匹配主机列表的主机将被拒绝<br>默认值 <em><br><strong>hosts deny</strong><br>用一个主机列表指定哪些主机客户不允许连接该模块。<br>默认值 空<br><strong>auth users</strong><br>指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块。这里的用户和系统用户没有任何关系。用户名和口令以明文方式存放在 secrets file 参数指定的文件中<br>默认匿名<br><strong>secrets file</strong><br>指定一个 rsync 认证口令文件。只有在 auth users 被定义时，该文件才起作用。<br>默认值 空<br><em>*strict modes</em></em><br>指定是否监测口令文件的权限。若为 true 则口令文件只能被 rsync 服务器运行身份的用户访问，其他任何用户不可以访问该文件。<br>默认值 true</li>
</ul>
<p>其中客户主机列表定义可以是以下形式：</p>
<blockquote>
<p>单个IP地址 例如：192.168.0.1<br>整个网段 例如：192.168.0.0/24，192.168.0.0/255.255.255.0<br>可解析的单个主机名 例如：centos，centos.bsmart.cn<br>域内的所有主机 例如：.bsmart.cn<br>“”则表示所有。<br>多个列表项要用空格间隔。</p>
</blockquote>
<p>而认证口令则：</p>
<blockquote>
<p>rsync 认证口令文件的权限一定是 600，否则客户端将不能连接服务器。<br>rsync 认证口令文件中每一行指定一个 用户名:口令 对，格式为：username:passwd<br>一般来说口令最好不要超过8个字符。若您只配置匿名访问的 rsync 服务器，则无需设置上述参数。</p>
</blockquote>
<h2 id="SVN同步实例">SVN同步实例</h2><p>基本思路就是，当发生commit时，触发服务端svn数据目录update，也触发rsync去同步网站目录。</p>
<h3 id="服务器配置文件">服务器配置文件</h3><p>编辑配置文件：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/rsyncd/rsyncd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<p>配置文件为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># GLOBAL OPTIONS</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = yes</span><br><span class="line"></span><br><span class="line">#<span class="keyword">limit</span> <span class="keyword">access</span> <span class="keyword">to</span> <span class="keyword">private</span> LANs</span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span>=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">hosts</span> deny=*</span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid</span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsyncd/rsyncd.passwd</span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span></span><br><span class="line">#motd <span class="keyword">file</span> = /etc/rsyncd/rsyncd.motd</span><br><span class="line"></span><br><span class="line">#This will give you a separate <span class="keyword">log</span> <span class="keyword">file</span></span><br><span class="line">#<span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsync.<span class="keyword">log</span></span><br><span class="line"></span><br><span class="line">#This will <span class="keyword">log</span> every <span class="keyword">file</span> transferred - up <span class="keyword">to</span> <span class="number">85</span>,<span class="number">000</span>+ per <span class="keyword">user</span>, per <span class="keyword">sync</span></span><br><span class="line">transfer <span class="keyword">logging</span> = yes</span><br><span class="line"><span class="keyword">log</span> <span class="keyword">format</span> = %<span class="keyword">t</span> %a %<span class="keyword">m</span> %<span class="keyword">f</span> %b</span><br><span class="line">syslog facility = local3</span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">MODULE</span> OPTIONS</span><br><span class="line">[kksvn]</span><br><span class="line"><span class="keyword">path</span> = /home/svn/rsyncd/kk</span><br><span class="line"><span class="keyword">list</span>=yes</span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line">auth <span class="keyword">users</span> = kksvn</span><br><span class="line"><span class="keyword">comment</span> = KK SVN</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>use chroot=no 时，同步后DES的文件主或组如果有，则显示名，即使ID不一样；<br>use chroot=yes时，如果两台机器同名的ID不同，则服务端只会显示SRC的ID，造成权限问题。</p>
</blockquote>
<p>编辑rsync的用户认证配置文件<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /etc/rsyncd/rsyncd.passwd</span></span><br><span class="line">kksvn:kksvn</span><br><span class="line"><span class="preprocessor">#chmod 600 /etc/rsyncd/rsyncd.passwd</span></span><br></pre></td></tr></table></figure></p>
<p>启动服务：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/rsync --daemon --config=/</span>etc<span class="regexp">/rsyncd/</span>rsyncd.conf</span><br><span class="line">echo <span class="string">"/usr/bin/rsync --daemon"</span> &gt;&gt;<span class="regexp">/etc/</span>rc.local</span><br></pre></td></tr></table></figure></p>
<p>注：修改配置文件和用户密码不需要重启服务</p>
<h3 id="客户端测试">客户端测试</h3><p>客户端测试：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># vim /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line">kksvn</span><br><span class="line"><span class="preprocessor"># chmod <span class="number">600</span> /home/svn/rsyncd/conf/rsyncd.passwd</span></span><br><span class="line"><span class="preprocessor"># rsync -avzp --progress --delete --exclude=.svn --password-file=/home/svn/rsyncd/conf/rsyncd.passwd kksvn@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>::kksvn /tmp/kk</span></span><br></pre></td></tr></table></figure></p>
<h3 id="SVN配置">SVN配置</h3><p>配置钩子：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br><span class="line">chmod +x <span class="regexp">/home/</span>svn<span class="regexp">/repos/</span>kk<span class="regexp">/hooks/</span>post-commit</span><br></pre></td></tr></table></figure></p>
<p>post-commit内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=zh_CN.UTF-<span class="number">8</span></span><br><span class="line">/usr/bin/svn update /home/svn/rsyncd/kke</span><br><span class="line"><span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    /bin/bash /home/svn/rsyncd/scripts/kke_rsync.sh &gt; /dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>kke_rsync.sh内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"></span><br><span class="line">IP=<span class="string">"127.0.0.1"</span></span><br><span class="line">Auth_module=<span class="string">"kksvn"</span></span><br><span class="line">Localdir=<span class="string">"/tmp/kk"</span></span><br><span class="line">Auth_user=<span class="string">"kksvn"</span></span><br><span class="line">Passwd_file=<span class="string">"/home/svn/rsyncd/conf/rsyncd.passwd"</span></span><br><span class="line">Exc=<span class="string">" --exclude=.svn"</span></span><br><span class="line">/usr/bin/rsync -vrtopgl --progress --delete <span class="variable">$&#123;Exc&#125;</span> --password-file=<span class="variable">$&#123;Passwd_file&#125;</span> <span class="variable">$Auth_user</span>@<span class="variable">$&#123;IP&#125;</span>::<span class="variable">$&#123;Auth_module&#125;</span> <span class="variable">$&#123;Localdir&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="拓展">拓展</h2><h3 id="通过exclude排除多个文件/目录">通过exclude排除多个文件/目录</h3><p>使用rsync -av –exclude=.svn /home/hwangjr/t1 /home/hwangjr/t2 只能排除.svn文件/目录。但如果要排除多个文件/目录，就需要新建个exclude.list，然后rsync -av –exclude-from=”exclude.list”指定不需要同步的文件/目录。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将/home/hwangjr/t1目录拷贝到/home/hwangjr/t2目录下，/home/hwangjr/exclude.list中指定文件不拷贝</span></span><br><span class="line">rsync -av --exclude-from=<span class="regexp">/home/hwangjr</span><span class="regexp">/exclude.list /home</span><span class="regexp">/hwangjr/t</span>1 /home/hwangjr/t2</span><br></pre></td></tr></table></figure></p>
<p>exclude.list里面填写要排除的文件/目录，一行一个，直接写文件名即可。如果要排除a,b.1,b.2,tmp/g，那么exclude.list里就应该写：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">a</span></span><br><span class="line"><span class="regexp">b.*</span></span><br><span class="line">tmp/g</span><br></pre></td></tr></table></figure></p>
<p>不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line"><span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>也不应该写成：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>a</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>b.*</span><br><span class="line">.<span class="regexp">/home/</span>hwangjr<span class="regexp">/t1/</span>tmp<span class="regexp">/g</span></span><br></pre></td></tr></table></figure></p>
<p>SO：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">–<span class="keyword">exclude</span>=PATTERN <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">exclude</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">exclude</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br><span class="line">–<span class="keyword">include</span>=PATTERN don’t <span class="keyword">exclude</span> files matching PATTERN</span><br><span class="line">–<span class="keyword">include</span>-<span class="keyword">from</span>=<span class="keyword">FILE</span> <span class="keyword">read</span> <span class="keyword">include</span> patterns <span class="keyword">from</span> <span class="keyword">FILE</span></span><br></pre></td></tr></table></figure></p>
<h2 id="REF">REF</h2><p><a href="https://download.samba.org/pub/rsync/src/" target="_blank" rel="external">Index of /pub/rsync/src</a><br><a href="https://rsync.samba.org/" target="_blank" rel="external">rsync</a><br><a href="http://pkgs.repoforge.org/rsync/" target="_blank" rel="external">Index of /rsync</a><br><a href="http://segmentfault.com/a/1190000002502991" target="_blank" rel="external">CentOS 6.5下rsync服务器安装配置 - SegmentFault</a><br><a href="http://my.oschina.net/duguaoxue/blog/496228" target="_blank" rel="external">CentOS 6.3下rsync服务器的安装与配置 - longjian的个人页面 - 开源中国社区</a><br><a href="http://wjw7702.blog.51cto.com/5210820/1148808" target="_blank" rel="external">Rsync常见错误及命令详细参数 - 彼岸 - 51CTO技术博客</a><br><a href="http://sndapk.blog.51cto.com/5385144/1360384" target="_blank" rel="external">svn+rsync实时发布程序 - notepad - 51CTO技术博客</a><br><a href="http://www.ttlsa.com/svn/linux-svn-rsync-inotify/" target="_blank" rel="external">linux下svn+rsync+inotify实现代码自动同步 - 运维生存时间</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/24/CentOS6-5使用RSYNC发布程序/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/23/阿里CentOS-6-iptables配置/" title="阿里CentOS 6 iptables配置" itemprop="url">阿里CentOS 6 iptables配置</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-23T10:31:08.000Z" itemprop="datePublished"> 发表于 2015-10-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>就是，配置防火墙，防止被鲁。</p>
<p>iptables的命令格式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] <span class="built_in">command</span> [chain] [rules] [-j target]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>[-t table] ：用来指明使用的表， 有三种选项: filter, nat 和 mangle，如果未指定，则使用filter作为缺省表。 事实上，对于单个服务器的防火墙配置，一般来讲，我们只需要对filter表进行配件就OK了。filter表包括 INPUT, OUTPUT,和FORWARD三个chain.</p>
</li>
<li><p>command 表明iptables命名要做什么，比如</p>
</li>
<li><p>-A （–append): 该命令会把一条规则附件到chain的末尾。</p>
</li>
<li><p>-D（–delete)用来删除某个规则。</p>
</li>
<li><p>-F （–flush) 如果指定了chain, 删除该chain中的所有规则，如果未指定chain, 则删除所有chain中的所有规则。</p>
</li>
<li><p>target: 是由规则指定的操作。 包括下面几种：</p>
</li>
<li><p>ACCEPT: 接收信息包(允许它前往目的地），并且将停止遍历chain.</p>
</li>
<li><p>DROP：  拒绝，</p>
</li>
</ul>
<p>此外还有REJECT, RETURN, LOG, REDIRECT, MARK, MIRROR, MAQUERADE等。</p>
<p>具体的iptables的语法和概念就不再多说了，请参照<a href="http://linux.die.net/man/8/iptables" target="_blank" rel="external">iptables man page</a>官方文档 .</p>
<p>简单来说，iptables防火墙是由一系列的规则(rule)组成，  一个数据请求进来， 会依次和这些规则进行比较，如果正好符合规则的定义，那这个数据请求要么会被接收ACCEPT，要么被拒绝DRIP。如果不符合任何规则的定义，最后缺省的规则会被应用。</p>
<h2 id="配置">配置</h2><p>SSH的端口22自然是需要开放的，否则我们就无法登录服务器了。CentOS的VPS经常作为用LAMP搭建的Web服务器，FTP服务器， Mail服务器等。</p>
<ul>
<li><p>对于Web服务来说，需要开放80端口，如果是HTTPS/SSL协议的话，还需用开放443端口。</p>
</li>
<li><p>对于Mail服务来说，由于涉及SMTP, POP3, IMAP协议，需要开放的端口：SMTP : 25   Secure SMTP:465  POP3: 110   Secure POP3: 995   IMAP: 143   IMAP over SSL: 993。</p>
</li>
<li><p>对于FTP服务来说，需要开放 20, 21两个端口。</p>
</li>
</ul>
<h3 id="屏蔽常见攻击">屏蔽常见攻击</h3><p>缺省情况下，CentOS的iptables的设置是允许任何数据通过的。我们首先要清空iptables中的所有的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure></p>
<p>然后我们加上阻止简单扫描和攻击的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP             <span class="comment">#NONE 包(所有标识bit都没有设置)主要是扫描类的数据包</span></span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP     <span class="comment">#防止sync-flood 攻击</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP              <span class="comment">#ALL包（所有的标注bit都被设置了）也是网络扫描的数据包</span></span><br></pre></td></tr></table></figure></p>
<p>关于sync-flood, 请参照<a href="http://en.wikipedia.org/wiki/SYN_flood" target="_blank" rel="external">wikipedia</a>的解释。</p>
<h3 id="相应服务开放端口">相应服务开放端口</h3><p>首先我们应该接受本机localhost的任何请求，否则，数据库连接等将无法工作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>对于不同的服务需要开放不同的端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT      <span class="comment"># SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT      <span class="comment"># HTTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">443</span> -j ACCEPT     <span class="comment">#HTTPS</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">25</span> -j ACCEPT   <span class="comment">#SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">465</span>  -j ACCEPT <span class="comment">#Secure SMTP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">110</span> -j ACCEPT   <span class="comment">#POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">995</span> -j ACCEPT   <span class="comment">#Secure POP3</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">143</span> -j ACCEPT   <span class="comment">#IMAP</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">993</span> -j ACCEPT   <span class="comment">#Secure IMAP</span></span><br></pre></td></tr></table></figure></p>
<h3 id="通用规则">通用规则</h3><p>首先要允许所有从服务器端发起的连接，由此返回的响应数据应该是允许的！比如VPS发起的yum update , 必须要允许外部的update数据进来：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -m <span class="keyword">state</span>  --state ESTABLISHED, RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>最后，设置缺省的策略：屏蔽任何进入的数据请求，允许所有从Server发出的请求<br><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -<span class="keyword">P</span> OUTPUT <span class="keyword">ACC</span>EPT</span><br><span class="line">iptables -<span class="keyword">P</span> INPUT DROP</span><br></pre></td></tr></table></figure></p>
<h3 id="保存设置">保存设置</h3><p>首先通过下面的命令查看一下我们的设置是否正确！<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptable -<span class="keyword">L</span> -<span class="keyword">n</span></span><br></pre></td></tr></table></figure></p>
<p>确认没有问题后，执行下面的命令<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables <span class="keyword">save</span></span><br></pre></td></tr></table></figure></p>
<p>执行上述命令后，相应的规则会写入 /etc/sysconfig/iptables这个文件，你可以检查一下看看。</p>
<p>最后执行<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">service</span> iptables restart</span><br></pre></td></tr></table></figure></p>
<p>重新启动iptables防火墙，以使上述设置生效。</p>
<h3 id="自动化">自动化</h3><p>为了更方便的修改和维护自己的iptables的设置，我一般是把所有的iptables的设置先写到一个单独文件中，测试没有问题后。然后再保存到iptable的配置文件中。</p>
<p>放大招，sh配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># A simple iptables firewall configuration</span></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin; <span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#flush/erase original rules</span></span><br><span class="line">iptables -F <span class="comment">#清除所有已制定的rule</span></span><br><span class="line">iptables -X <span class="comment">#清除用户自定义的chain/table</span></span><br><span class="line">iptables -Z <span class="comment">#将所有的chain的计数和流量统计归零</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept localhost connetting, no matter what it is</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#Accept any response package which is initiated from inside</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#block most common network attacks(recon packets and syn-flood attack)</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#open ports for different services</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT <span class="comment">#SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT <span class="comment">#HTTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 443 -j ACCEPT #HTTPS</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 25 -j ACCEPT #SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 465 -j ACCEPT #Secure SMTP</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 110 -j ACCEPT #POP3</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p tcp --dport 995 -j ACCEPT #Secure POP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ICMP configuration</span></span><br><span class="line"><span class="comment">#To prevent ICMP DDOS,we do not allow ICMP type 8(echo-request) or limit this request with 1/second</span></span><br><span class="line"><span class="comment">#some ICMP requests are allowed.</span></span><br><span class="line">icmp_<span class="built_in">type</span>=<span class="string">"0 3 4 11 12 14 16 18"</span></span><br><span class="line"><span class="keyword">for</span> ticmp <span class="keyword">in</span> <span class="variable">$icmp_type</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    iptables -A INPUT -p icmp --icmp-type <span class="variable">$ticmp</span> -j ACCEPT</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#iptables -A INPUT -p icmp --icmp-type 8 -m limit --limit 1/second -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#default policies</span></span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#save to /etc/sysconfig/iptables</span></span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<h2 id="常用命令">常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables</span><br><span class="line"><span class="comment"># 检测状态</span></span><br><span class="line">service iptables status</span><br><span class="line">service iptables start</span><br><span class="line"><span class="comment"># 查看当前配置</span></span><br><span class="line">iptables -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受一切请求</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空默认所有规则</span></span><br><span class="line">iptables -F</span><br><span class="line"><span class="comment"># 清空自定义所有规则</span></span><br><span class="line">iptables -X</span><br><span class="line"><span class="comment"># 清除计数器</span></span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line">service iptables save</span><br><span class="line">chkconfig iptables on</span><br></pre></td></tr></table></figure>
<h2 id="REF">REF</h2><p><a href="http://www.androiddev.net/centos-6-iptables-firewall/" target="_blank" rel="external">为CentOS 6设置IPTables防火墙 | 码农日记</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/23/阿里CentOS-6-iptables配置/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/23/Gradle查询-排除依赖/" title="Gradle查询/排除依赖" itemprop="url">Gradle查询/排除依赖</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-23T10:29:58.000Z" itemprop="datePublished"> 发表于 2015-10-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>使用Gradle编译项目时，可使用此排查依赖包冲突。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看项目库依赖</span></span><br><span class="line">gradle -q dependencies plugin_framework:dependencies —configuration compile</span><br></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/23/Gradle查询-排除依赖/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/23/CentOS6-5-配置Subversion/" title="CentOS6.5 配置Subversion" itemprop="url">CentOS6.5 配置Subversion</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-23T10:28:24.000Z" itemprop="datePublished"> 发表于 2015-10-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>需要部署Subversion进行版本控制，团队习惯用Subversion，自然Git也有部署，后续慢慢切入。<br>不基于Apache，也就是http无法访问，只通过svn访问。<br>不源码编译，版本兼容会有问题。</p>
<blockquote>
<p>Subversion目录说明：<br><em>dav目录：是提供apache与mod_dav_svn使用的目录，让他们存储内部数据
</em>db目录：就是所有版本控制的数据存放文件<br><em>hooks目录：放置hook脚本文件的目录
</em>locks目录：用来放置subversion锁定数据的目录，追踪存取文件库的客户端<br><em>format文件：是一个文本文件，里面只放了一个整数。表示当前文件库配置的版本号
</em>conf目录：是这个仓库的配置文件（仓库的用户访问账号、权限等）</p>
</blockquote>
<h2 id="安装">安装</h2><p>查询是否已经有安装，并查询安装信息：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询是否安装及版本</span></span><br><span class="line">rpm -qa subversion</span><br><span class="line"><span class="comment"># 移除</span></span><br><span class="line">yum remove subversion</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install subversion</span><br><span class="line"><span class="comment"># 查询安装目录</span></span><br><span class="line">rpm -ql subversion</span><br></pre></td></tr></table></figure></p>
<h2 id="基本配置">基本配置</h2><p>本次配置将针对多个版本库，其访问统一为：<code>svn://ip/project1</code>，可在下面分别创建多个库。</p>
<h3 id="创建svn库并初始化">创建svn库并初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建版本库路径</span></span><br><span class="line">mkdir -p /home/svn/repos/project1</span><br><span class="line"><span class="comment"># 新建一个版本仓库</span></span><br><span class="line">svnadmin create /home/svn/repos/project1</span><br><span class="line"><span class="comment"># 初始化版本库中目录</span></span><br><span class="line">mkdir project project/server project/server/branches project/server/tags project/server/trunk project/android project/android/branches project/android/tags project/android/trunk project/ios project/ios/branches project/ios/tags project/ios/trunk</span><br><span class="line">svn import project/ file:///home/svn/repos/project1 -m <span class="string">'init svn folder'</span></span><br><span class="line"><span class="comment"># 可删除临时创建文件，或者保留以后创建其他版本库继续使用</span></span><br><span class="line">rm -rf project</span><br><span class="line"><span class="comment"># 保留以后继续使用</span></span><br><span class="line">mv project /home/svn/projectTemp</span><br></pre></td></tr></table></figure>
<p>其中project目录为：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">project</span>/</span><br><span class="line">├── <span class="keyword">android</span><br><span class="line"></span>│   ├── <span class="keyword">branches</span><br><span class="line"></span>│   ├── tags</span><br><span class="line">│   └── trunk</span><br><span class="line">├── ios</span><br><span class="line">│   ├── <span class="keyword">branches</span><br><span class="line"></span>│   ├── tags</span><br><span class="line">│   └── trunk</span><br><span class="line">└── server</span><br><span class="line">    ├── <span class="keyword">branches</span><br><span class="line"></span>    ├── tags</span><br><span class="line">    └── trunk</span><br></pre></td></tr></table></figure></p>
<p><code>/home/svn/repos</code>目录为：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/home/svn/repos/</span><br><span class="line">└── project1</span><br><span class="line">    ├── <span class="keyword">conf</span></span><br><span class="line">    ├── <span class="keyword">db</span></span><br><span class="line">    ├── <span class="keyword">format</span></span><br><span class="line">    ├── hooks</span><br><span class="line">    ├── locks</span><br><span class="line">    └── README.txt</span><br></pre></td></tr></table></figure></p>
<h3 id="配置svn">配置svn</h3><p>版本库用户统一管理，故这里会直接在<code>/home/svn</code>目录创建<code>conf</code>文件并保存其配置。<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="keyword">mkdir</span> /home/svn/conf</span><br></pre></td></tr></table></figure></p>
<h4 id="配置用户">配置用户</h4><p>移动用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /home/svn/repos/project1/conf/passwd /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/passwd</span><br></pre></td></tr></table></figure></p>
<p>修改里面用户，格式<code>username = passwd</code>的条目即可。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[users]</span></span><br><span class="line"><span class="setting">hwangjr = <span class="value">hwangjr</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="修改访问策略">修改访问策略</h4><p>移动用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /home/svn/repos/project1/conf/authz /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/authz</span><br></pre></td></tr></table></figure></p>
<p>修改里面配置，<code>groups</code>为定义用户群组，其他为配置访问权限，<strong>需要注意是<code>* =</code>表示除了上面配置的用户组之外，任何人都被禁止访问本目录，此必须加上</strong>。<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[groups]</span></span><br><span class="line">dev = hwangjr</span><br><span class="line"></span><br><span class="line"><span class="string">[project1:/]</span></span><br><span class="line">@dev = rw</span><br><span class="line">* =</span><br></pre></td></tr></table></figure></p>
<h4 id="修改svnserve，让配置生效">修改svnserve，让配置生效</h4><p>拷贝用户配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /home/svn/repos/project1/conf/svnserve.conf /home/svn/conf/</span><br></pre></td></tr></table></figure></p>
<p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/svn/conf/svnserve.conf</span><br></pre></td></tr></table></figure></p>
<p>修改里面配置。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[general]</span><br><span class="line">anon-access = none</span><br><span class="line">auth-access = <span class="keyword">write</span></span><br><span class="line">password-db = <span class="regexp">/home/</span>svn<span class="regexp">/conf/</span>passwd</span><br><span class="line">authz-db = <span class="regexp">/home/</span>svn<span class="regexp">/conf/</span>authz</span><br></pre></td></tr></table></figure></p>
<h4 id="启动/停止svn">启动/停止svn</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">svnserve <span class="operator">-d</span> -r /home/svn/repos</span><br><span class="line"><span class="comment"># 指定port</span></span><br><span class="line">svnserve <span class="operator">-d</span> -r /home/svn/repos --listen-port <span class="number">3391</span></span><br><span class="line"><span class="comment"># 停止svn</span></span><br><span class="line">killall svnserve</span><br><span class="line"><span class="comment"># ps</span></span><br><span class="line">ps -ef | grep svnserve</span><br><span class="line"><span class="built_in">kill</span> -<span class="number">9</span> pid</span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -tlnp | grep svn</span><br></pre></td></tr></table></figure>
<h3 id="测试访问">测试访问</h3><p>本地测试即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn co svn://<span class="number">127.0</span>.<span class="number">0.1</span>/project1 --username hwangjr --password hwangjr</span><br></pre></td></tr></table></figure></p>
<h3 id="新增一个版本库">新增一个版本库</h3><p>本次配置可管理多个版本库，且用户共用，新增一个版本库很简单：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/svn/repos/project2</span><br><span class="line">svnadmin create /home/svn/repos/project2</span><br><span class="line">rm -rf /home/svn/repos/project2/conf/passwd /home/svn/repos/project2/conf/authz</span><br><span class="line">cp /home/svn/conf/svnserve.conf /home/svn/repos/project2/conf/</span><br></pre></td></tr></table></figure></p>
<p>此版本库已经新增完毕，如果需要初始化目录，则可采用上面方式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn import /home/svn/projectTemp/  file:///home/svn/repos/project2 -m <span class="string">'init svn folder'</span></span><br></pre></td></tr></table></figure></p>
<p>可编辑<code>/home/svn/conf/passwd</code>来新增/删除用户，可编辑<code>/home/svn/conf/authz</code>来控制权限。举个authz栗子：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[project1:/]</span><br><span class="line"><span class="comment">@dev = rw</span></span><br><span class="line"><span class="keyword">*</span> =</span><br><span class="line"></span><br><span class="line">[project2:/]</span><br><span class="line"><span class="comment">@dev = rw</span></span><br><span class="line"><span class="keyword">*</span> =</span><br></pre></td></tr></table></figure></p>
<h3 id="自启动">自启动</h3><p>通过服务来启动即可，编辑<code>vim /etc/init.d/svnserve</code>，修改OPTIONS为<code>-r /home/svn/repos</code>，片段为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### <span class="operator"><span class="keyword">END</span> INIT INFO</span><br><span class="line"></span><br><span class="line">OPTIONS=<span class="string">"-r /home/svn/repos"</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">Source</span> <span class="keyword">function</span> <span class="keyword">library</span>.</span><br><span class="line">. /etc/rc.<span class="keyword">d</span>/init.<span class="keyword">d</span>/functions</span></span><br></pre></td></tr></table></figure></p>
<p>设置服务自启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig svnserve on</span><br></pre></td></tr></table></figure></p>
<h3 id="防火墙">防火墙</h3><p>如果对防火墙有疑问，可以参考另一篇iptables，开放所需端口即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -tlnp | grep svn</span><br><span class="line"><span class="comment"># 开放端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport <span class="number">3690</span> -j ACCEPT <span class="comment"># SVN</span></span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<p>或者编辑配置文件：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -m tcp --dport <span class="number">3690</span> -j <span class="constant">ACCEPT</span></span><br><span class="line"></span>service iptables restart</span><br></pre></td></tr></table></figure></p>
<h2 id="常用配置">常用配置</h2><h3 id="强制提交写LOG">强制提交写LOG</h3><p>配置pre-comit文件，要求用户提交前必须写LOG。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/repos/project1/hooks</span><br><span class="line"><span class="keyword">vim</span> <span class="keyword">pre</span>-commit</span><br><span class="line">chmod +<span class="keyword">x</span> <span class="keyword">pre</span>-commit</span><br></pre></td></tr></table></figure></p>
<p>pre-commit文件内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">TXN=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">SVNLOOK=/usr/bin/svnlook</span><br><span class="line">LOGMSG=`<span class="variable">$SVNLOOK</span> <span class="built_in">log</span> -t <span class="string">"<span class="variable">$TXN</span>"</span> <span class="string">"<span class="variable">$REPOS</span>"</span> | grep <span class="string">"[a-zA-Z0-9]"</span> | wc -c`</span><br><span class="line"><span class="comment"># 5(要求的LOG长度，依实际需要修改)</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$LOGMSG</span>"</span> <span class="operator">-lt</span> <span class="number">5</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"\nEmpty log message not allowed. Commit aborted!"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span></span><br><span class="line"><span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<h3 id="可修改LOG">可修改LOG</h3><p>配置pre-revprop-change文件，此文件在show log中修改log时会运行，得到修改的权限，否则会报错：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DAV request failed; it’s possible that the repository’s pre-revprop-<span class="operator"><span class="keyword">change</span> hook either <span class="keyword">failed</span> <span class="keyword">or</span> <span class="keyword">is</span> non-existent. <span class="keyword">At</span> <span class="keyword">least</span> one property <span class="keyword">change</span> <span class="keyword">failed</span>;</span> repository is unchanged</span><br></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/repos/project1/hooks/</span><br><span class="line"><span class="keyword">vim</span> <span class="keyword">pre</span>-revprop-<span class="keyword">change</span></span><br><span class="line">chmod +<span class="keyword">x</span> <span class="keyword">pre</span>-revprop-<span class="keyword">change</span></span><br></pre></td></tr></table></figure>
<p>文件内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">USER=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">PROPNAME=<span class="string">"<span class="variable">$4</span>"</span></span><br><span class="line"><span class="keyword">if</span> [<span class="string">"<span class="variable">$PROPNAME</span>"</span> = <span class="string">"svn:log"</span>];<span class="keyword">then</span> <span class="built_in">exit</span> <span class="number">0</span>;<span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="HTTP服务器（未进行验证_）">HTTP服务器（未进行验证 ）</h2><h3 id="转换密码">转换密码</h3><p>HTTP不支持明文，Perl脚本来进行转化密码，脚本目录下会多一个<code>webpasswd</code>文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/svn/conf/</span><br><span class="line">vim ptopw.pl</span><br><span class="line">chmod +x ptopw.pl</span><br><span class="line">./ptopw.pl</span><br></pre></td></tr></table></figure></p>
<p>脚本内容：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> warnings;</span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"></span><br><span class="line"><span class="comment">#open the svn passwd file</span></span><br><span class="line"><span class="keyword">open</span> (FILE, <span class="string">"../conf/passwd"</span>) <span class="keyword">or</span> <span class="keyword">die</span> (<span class="string">"Cannot open the passwd file!!!\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the apache passwd file</span></span><br><span class="line"><span class="keyword">open</span> (OUT_FILE, <span class="string">"&gt;webpasswd"</span>) <span class="keyword">or</span> <span class="keyword">die</span> (<span class="string">"Cannot open the webpasswd file!!!\n"</span>);</span><br><span class="line"><span class="keyword">close</span> (OUT_FILE);</span><br><span class="line"></span><br><span class="line"><span class="comment">#begin</span></span><br><span class="line"><span class="keyword">foreach</span> (&lt;FILE&gt;) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_</span> =~ <span class="regexp">m/^[^#].*=/</span>) &#123;</span><br><span class="line"><span class="variable">$_</span> =~ <span class="regexp">s/=//</span>;</span><br><span class="line"><span class="string">`htpasswd -b webpasswd $_`</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改httpd配置">修改httpd配置</h3><p>编辑<code>/etc/httpd/conf/httpd.conf</code>，在末尾添加svn：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /repos&gt;</span><br><span class="line">DAV svn</span><br><span class="line">SVNPath /home/svn/repos/</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName <span class="string">"svn for repos"</span></span><br><span class="line">AuthUserFile /home/svn/conf/webpasswd</span><br><span class="line">AuthzSVNAccessFile /home/svn/conf/authz</span><br><span class="line">Satisfy all</span><br><span class="line">Require valid-user</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改权限">修改权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R apache.apache /home/svn/repos</span><br></pre></td></tr></table></figure>
<h3 id="重启服务">重启服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/httpd restart</span><br></pre></td></tr></table></figure>
<h3 id="测试">测试</h3><p>浏览器打开<code>http://ip/repos/server</code>测试。</p>
<h2 id="邮件提醒（未验证）">邮件提醒（未验证）</h2><ul>
<li><p>安装Perl模块Module::Build</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/D/DA/DAGOLDEN/Module-Build-0.36_11.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Module-Build-0.36_11.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Module-Build-0.36_11</span></span><br><span class="line"><span class="preprocessor"># perl Build.PL</span></span><br><span class="line"><span class="preprocessor"># ./Build</span></span><br><span class="line"><span class="preprocessor"># ./Build test</span></span><br><span class="line"><span class="preprocessor"># ./Build install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块Authen::SASL</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/G/GB/GBARR/Authen-SASL-2.15.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Authen-SASL-2.15.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Authen-SASL-2.15</span></span><br><span class="line"><span class="preprocessor"># perl Makefile.PL</span></span><br><span class="line"><span class="preprocessor"># make test</span></span><br><span class="line"><span class="preprocessor"># make install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块Net::SMTP_auth</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/A/AP/APLEINER/Net-SMTP_auth-0.08.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf Net-SMTP_auth-0.08.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd Net-SMTP_auth-0.08</span></span><br><span class="line"><span class="preprocessor"># perl Makefile.PL</span></span><br><span class="line"><span class="preprocessor"># make test</span></span><br><span class="line"><span class="preprocessor"># make install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Perl模块SVN::Notify</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http://search.cpan.org/CPAN/authors/id/D/DW/DWHEELER/SVN-Notify-2.80.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar xvf SVN-Notify-2.80.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd SVN-Notify-2.80</span></span><br><span class="line"><span class="preprocessor"># perl Build.PL</span></span><br><span class="line"><span class="preprocessor"># ./Build</span></span><br><span class="line"><span class="preprocessor"># ./Build test</span></span><br><span class="line"><span class="preprocessor"># ./Build install</span></span><br><span class="line"><span class="preprocessor"># cd ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动邮件服务器</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service sendmail restart</span></span><br><span class="line"><span class="keyword">Shutting</span> down sendmail:                                   <span class="sqbracket"> [FAILED]</span></span><br><span class="line"><span class="keyword">Starting</span> sendmail:                                        <span class="sqbracket"> [  OK  ]</span></span><br><span class="line"><span class="keyword">Starting</span> sm-client:                                       <span class="sqbracket"> [  OK  ]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置自动发邮件脚本<br>修改post-commit脚本，以支持邮件通知功能。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd /home/svn/repos/project1/hooks/</span></span><br><span class="line"><span class="preprocessor"># vim post-commit</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">REPOS=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REV=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line">/usr/bin/svnnotify –repos-path “<span class="variable">$1</span>″ –revision “<span class="variable">$2</span>″ –to huangjianrong2010@gmail.com –from project1@svn.com –handler “HTML::ColorDiff”  –with-diff –smtp localhost –smtp-user root –smtp-pass passwd -c “UTF-<span class="number">8</span>″ -g zh_CN -o raw –svnlook /usr/bin/svnlook –subject-prefix ‘[SVN Update]‘</span><br></pre></td></tr></table></figure></p>
<p>to参数代表接收邮件的地址，可以有多个。from参数是虚拟的，代表你的发送地址，一般情况下，这个参数 不重要，但如果接收者的邮件服务器有反垃圾邮件的功能，需要判定源地址的话，这个参数是否合法就显得很重要了</p>
<p>再给该脚本添加可执行权限<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># chmod +x post-commit</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>再次提交时，就会给指定邮件地址发信了。ALL DONE！</li>
</ul>
<h2 id="备份管理">备份管理</h2><p>采用简单方式，定时备份仓库目录。</p>
<ul>
<li><p>新建备份目录</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /home/svn/backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写备份脚本</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /home/svn/scripts</span><br><span class="line"><span class="keyword">vim</span> backup.<span class="keyword">sh</span></span><br><span class="line">chmod +<span class="keyword">x</span> backup.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>backup.sh内容：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cd /home/svn/repos</span><br><span class="line">now=`/bin/date +%Y%m%d`</span><br><span class="line">/bin/tar czvf <span class="string">"project_backup_$now.tar.gz"</span> project1/ &amp;&amp; rm -rf /home/svn/backup/* &amp;&amp; /bin/mv project_backup_*.tar.gz /home/svn/backup/</span><br><span class="line"><span class="keyword">if</span> [ $? == <span class="number">0</span> ]</span><br><span class="line">then</span><br><span class="line"><span class="literal">result</span>=”<span class="type">OK</span>!!”</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="literal">result</span>=”<span class="type">False</span>!!”</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment">#send mail to administrator</span></span><br><span class="line">/bin/mail mail@gmail.com -s “project_backup_$now” &lt;&lt;<span class="type">MESSAGE</span></span><br><span class="line"><span class="type">Result</span>: `/bin/echo $<span class="literal">result</span>`</span><br><span class="line"><span class="type">MESSAGE</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>设置每日执行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输入：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 每晚<span class="number">23</span>点备份</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * * /home/svn/scripts/backup.sh</span><br></pre></td></tr></table></figure></p>
<h2 id="svnstat分析svn数据（未验证）">svnstat分析svn数据（未验证）</h2><ul>
<li><p>安装JAVA</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x jre-xxx-rpm<span class="class">.bin</span></span><br><span class="line">./jre-xxx-rpm.bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载svnstat</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/iweb.dl.sourceforge.net/project</span><span class="regexp">/svnstat/svnstat</span><span class="regexp">/Release-1.1-beta/</span><span class="constant">SvnStat</span>-<span class="number">1.1</span>-beta.zip</span><br><span class="line">unzip <span class="constant">SvnStat</span>-<span class="number">1.1</span>-beta.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn co <span class="string">svn:</span><span class="comment">//ip/project1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成数据</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pwd</span></span><br><span class="line"># /root</span><br><span class="line">svn <span class="keyword">log</span> project1 -v -xml -non-interactive &gt; project1.<span class="literal">log</span></span><br><span class="line"><span class="keyword">cd</span> SvnStat-1.1-beta</span><br><span class="line">java -classpath SvnStat-all.jar <span class="keyword">de</span>.agentlab.svnstat.SvnStat -jar SvnStat-all.jar -r /root/project.<span class="keyword">log</span> -<span class="keyword">d</span> /<span class="keyword">var</span>/www/html/</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<br>打开浏览器即可查看</p>
</li>
</ul>
<h2 id="statsvn分析svn数据（未验证）">statsvn分析svn数据（未验证）</h2><ul>
<li><p>下载statsvn</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//downloads.sourceforge.net/project/statsvn/statsvn/0.7.0/statsvn-0.7.0.zip?use_mirror=jaist</span></span><br><span class="line">unzip statsvn-<span class="number">0.7</span><span class="number">.0</span>.zip</span><br><span class="line">cd statsvn-<span class="number">0.7</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成statsvn数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/var/</span>www<span class="regexp">/html/</span>statsvn</span><br><span class="line">java -jar statsvn.jar -verbose -output-dir <span class="regexp">/var/</span>www<span class="regexp">/html/</span>statsvn<span class="regexp">/ /</span>root<span class="regexp">/project.log /</span>root<span class="regexp">/project</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<br>打开浏览器查看</p>
</li>
</ul>
<h2 id="配置codestriker（未验证）">配置codestriker（未验证）</h2><ul>
<li><p>依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -MCPAN <span class="operator">-e</span> <span class="string">'install "Template"'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># wget http:<span class="comment">//downloads.sourceforge.net/project/codestriker/codestriker/1.9.10/codestriker-1.9.10.tar.gz?use_mirror=jaist&amp;ts=1279246587</span></span></span><br><span class="line"><span class="preprocessor"># mkdir /var/www/codestriker</span></span><br><span class="line"><span class="preprocessor"># cd /var/www/codestriker</span></span><br><span class="line"><span class="preprocessor"># tar xvf /path/codestriker-<span class="number">1.9</span><span class="number">.10</span>.tar.gz</span></span><br><span class="line"><span class="preprocessor"># chown -R apache.apache codestriker-<span class="number">1.9</span><span class="number">.10</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置数据库</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># service mysqld restart</span></span><br><span class="line"><span class="preprocessor"># mysql -uroot mysql</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>执行:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> codestrikerdb <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8;</span></span><br><span class="line"><span class="operator"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span>,<span class="keyword">UPDATE</span>,<span class="keyword">DELETE</span>,<span class="keyword">INDEX</span>,<span class="keyword">ALTER</span>,<span class="keyword">CREATE</span>,<span class="keyword">DROP</span>,<span class="keyword">REFERENCES</span> <span class="keyword">ON</span> codestrikerdb.* <span class="keyword">TO</span> codestriker@localhost <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> ‘cspasswd’;</span></span><br><span class="line"><span class="operator"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span></span><br><span class="line">quit</span><br></pre></td></tr></table></figure></p>
<ul>
<li>配置codestriker<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd codestriker-<span class="number">1.9</span><span class="number">.10</span>/</span></span><br><span class="line"><span class="preprocessor"># vim codestriker.conf</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意以下几点(详细可查看codestriker的安装文档)<br>a.数据库的用户名密码要配对<br>b.svn的数据仓库要配对，如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@valid</span>_repositories =</span><br><span class="line">(</span><br><span class="line"><span class="symbol">'svn</span>:file:<span class="comment">///home/svn/repos/project1',</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>执行安装脚本</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> bin/</span><br><span class="line">./install.<span class="keyword">pl</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置http支持</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">vim</span> /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在最后面加上如下内容:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Alias <span class="regexp">/codestriker/</span>  <span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/cgi-bin/</span></span><br><span class="line">Alias <span class="regexp">/codestrikerhtml/</span>  <span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/html/</span></span><br><span class="line"></span><br><span class="line">&lt;Directory “<span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/cgi-bin/</span>”&gt;</span><br><span class="line">SetHandler perl-script</span><br><span class="line">PerlHandler <span class="string">ModPerl:</span>:Registry</span><br><span class="line">Options +ExecCGI</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory “<span class="regexp">/var/</span>www<span class="regexp">/codestriker/</span>codestriker-<span class="number">1.9</span><span class="number">.10</span><span class="regexp">/html/</span>”&gt;</span><br><span class="line">AllowOverride None</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>查看<br>重启httpd服务：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">service</span> httpd restart</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>浏览器输入<code>http://ip/codestriker/codestriker.pl</code>。</p>
<h2 id="REFS">REFS</h2><p><a href="http://www.ha97.com/4467.html" target="_blank" rel="external">CentOS Linux搭建SVN Server配置详解</a><br><a href="http://www.hi-docs.com/article/detail-MTA4.html" target="_blank" rel="external">Centos 6.5+ 搭建SVN服务器（实用简写版）-LINUX技术文章,经验分享,HI-DOCS</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/23/CentOS6-5-配置Subversion/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/09/Supervisor-Basic-Usage/" title="Supervisor Basic Usage" itemprop="url">Supervisor Basic Usage</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-10-09T06:38:05.000Z" itemprop="datePublished"> 发表于 2015-10-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://supervisord.org/" target="_blank" rel="external">Supervisor</a> is a process control system, it is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.</p>
<p>It shares some of the same goals of programs like <a href="http://supervisord.org/glossary.html#term-launchd" target="_blank" rel="external">launchd</a>, <a href="http://supervisord.org/glossary.html#term-daemontools" target="_blank" rel="external">daemontools</a>, and <a href="http://supervisord.org/glossary.html#term-runit" target="_blank" rel="external">runit</a>. Unlike some of these programs, it is not meant to be run as a substitute for init as “process id 1”. Instead it is meant to be used to control processes related to a project or a customer, and is meant to start like any other program at boot time.</p>
<h2 id="Install">Install</h2><p>Sample for centos:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Maybe u need to install python-setuptools or pip</span></span><br><span class="line"><span class="comment">## yum install python-setuptools &amp;&amp; easy_install pip</span></span><br><span class="line">easy_install supervisor</span><br><span class="line"><span class="comment">## or </span></span><br><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure></p>
<h2 id="Commands">Commands</h2><p>This is some common commands:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for all service</span></span><br><span class="line">supervisorctl start all</span><br><span class="line">supervisorctl stop all</span><br><span class="line">supervisorctl restart all</span><br><span class="line"></span><br><span class="line"><span class="comment"># for service 'ss'</span></span><br><span class="line">supervisorctl stop ss</span><br><span class="line">supervisorctl start ss</span><br><span class="line">supervisorctl restart ss</span><br></pre></td></tr></table></figure></p>
<h2 id="Usage">Usage</h2><p><strong>STEP 1: Init the config file </strong></p>
<p>First of all, we need a config file, supervisor provider us a sample:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## This will create a supervisord.conf file under /etc folder</span></span><br><span class="line"><span class="built_in">echo</span>_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure></p>
<p><strong>STEP 2: Setup config </strong></p>
<p>Second, we need to config the file, add the code below to the end of conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if this config is not correct, it may occur supervisor start fail</span></span><br><span class="line">[program:ss]</span><br><span class="line"><span class="built_in">command</span> = ssserver -c /etc/ss.json</span><br><span class="line">user = root</span><br><span class="line">autostart = <span class="literal">true</span></span><br><span class="line">autorestart = <span class="literal">true</span></span><br><span class="line">stderr_logfile = /var/<span class="built_in">log</span>/supervisor/ss.stderr.log</span><br><span class="line">stdout_logfile = /var/<span class="built_in">log</span>/supervisor/ss.stdout.log</span><br></pre></td></tr></table></figure></p>
<p>More info see : <a href="http://supervisord.org/configuration.html#programx-section" target="_blank" rel="external">Configuration File — Supervisor 3.1.3 documentation</a></p>
<p><strong>STEP 3: Run Supervisor</strong></p>
<p>Finally, run the supervisor:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run supervisor with conf file</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># run without conf file, will search for the default conf file by:</span></span><br><span class="line"><span class="comment"># $CWD/supervisord.conf</span></span><br><span class="line"><span class="comment"># $CWD/etc/supervisord.conf</span></span><br><span class="line"><span class="comment"># /etc/supervisord.conf</span></span><br><span class="line">supervisord</span><br></pre></td></tr></table></figure></p>
<p>If we modify the conf file, we also can update the conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure></p>
<h2 id="Run_on_startup">Run on startup</h2><p>If you are using a distribution-packaged version of Supervisor, it should already be integrated into the service management infrastructure of your distribution.</p>
<p>There are user-contributed scripts for various operating systems at: <a href="https://github.com/Supervisor/initscripts" target="_blank" rel="external">Supervisor/initscripts</a></p>
<p>OR :<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># add this before exit</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure></p>
<h2 id="Manage_on_web">Manage on web</h2><p>U can manage the service remote, just modify the conf file:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line">port=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9001</span>        ; (ip_address:port specifier, *:port <span class="keyword">for</span> all iface)</span><br><span class="line">username=user              ; (default is no username (open server))</span><br><span class="line">password=<span class="number">123</span>               ; (default is no password (open server))</span><br></pre></td></tr></table></figure></p>
<p>and reload conf:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl reload</span><br></pre></td></tr></table></figure></p>
<h2 id="END">END</h2><p>Just so easy, Supervisor is very fantastic, enjoy it.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/09/Supervisor-Basic-Usage/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/21/将SOCKET代理转化为HTTP代理/" title="将SOCKET代理转化为HTTP代理" itemprop="url">将SOCKET代理转化为HTTP代理</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-08-21T07:39:01.000Z" itemprop="datePublished"> 发表于 2015-08-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景">背景</h2><p>众所周知，中国伟大的墙阻碍了很多前进的脚步，特别是ANDROID SDK的更新（node啥的都不说了）。特别是最近管控比较严，就只能使用朋友的SOCKET5的服务器代理，而ANDROID SDK是无法使用SOCKET5代理，只支持HTTP代理，类似<a href="http://www.androiddevtools.cn/" target="_blank" rel="external">AndroidDevTools</a>的站点也不是很好使了，只能寻找SOCKET5转换成HTTP的方式。</p>
<h2 id="SOCKET转HTTP">SOCKET转HTTP</h2><h3 id="DeleGate介绍">DeleGate介绍</h3><p>这里要使用到<a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>软件，支持各个平台。<br><a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>是一个多平台的简单代理服务器软件，通过本地建立各种代理服务器，包括HTTP，FTP，SOCKET等。</p>
<blockquote>
<p>This is a private and voluntary site that is independent of AIST, for providing support information and redistribution of DeleGate, a general purpose proxy server software developed in AIST and, more specifically, for providing voluntary-based support for users in forums, supplementary contents for guide, some experimental services and demonstrations, as well as contents mirroring some of those in the official site of DeleGate of AIST. </p>
</blockquote>
<h3 id="安装软件">安装软件</h3><p>新版没有找到源码，但是<a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a>提供了编译之后的可执行程序。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://delegate.hpcc.jp/pub/DeleGate/bin/linux/<span class="number">9.9</span>.<span class="number">13</span>/linux2.<span class="number">6</span>-dg9_9_13.tar.gz</span><br><span class="line">tar xzf linux2.<span class="number">6</span>-dg9_9_13.tar.gz</span><br><span class="line"><span class="built_in">cd</span> dg9_9_13</span><br><span class="line">tree .</span><br></pre></td></tr></table></figure></p>
<p>在bin目录下就是可执行程序和配置文件，整个文件目录很简洁，在subin里面也提供了setup-subin.sh脚本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">│   ├── dg9_9_13</span><br><span class="line">│   ├── dg9_9_13.conf</span><br><span class="line">subin</span><br><span class="line">│   ├── dgbind</span><br><span class="line">│   ├── dgchroot</span><br><span class="line">│   ├── dgcpnod</span><br><span class="line">│   ├── dgdate</span><br><span class="line">│   ├── dgforkpty</span><br><span class="line">│   ├── dgpam</span><br><span class="line">│   └── setup-subin.sh</span><br></pre></td></tr></table></figure></p>
<p>setup-subin.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">SUBINS=<span class="string">"dgpam dgbind dgchroot dgcpnod"</span></span><br><span class="line">sudo sh -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">  su root -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">  su root -c <span class="string">"chown root <span class="variable">$SUBINS</span>; chmod 6550 <span class="variable">$SUBINS</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">ls <span class="operator">-l</span> <span class="variable">$SUBINS</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用">使用</h3><p>使用方式也很简单，通过编辑bin目录下的conf文件来完成，这里以SOCKET转HTTP为例，具体需求自己查看配置文件。<br>编辑dg9_9_13.conf，新增：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mail-address of the administrator of this DeleGat</span></span><br><span class="line">ADMIN=email@email.com</span><br><span class="line"><span class="comment"># the protocol DeleGate speaks with its clients</span></span><br><span class="line">SERVER=http</span><br><span class="line"><span class="comment"># the entrance port on which DeleGate waits clients</span></span><br><span class="line">-P8080</span><br><span class="line"><span class="comment"># forwarding to a SOCKS server</span></span><br><span class="line">SOCKS=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>配置完成后，直接执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./dg9_9_13</span><br><span class="line"><span class="comment"># 如果没有权限，给权限即可</span></span><br><span class="line">sudo chmod +x dg9_9_13</span><br></pre></td></tr></table></figure></p>
<p>查看是否在运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep dg9</span><br><span class="line">hwangjr   <span class="number">4595</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">53340</span>  <span class="number">3436</span> ?        Ss   <span class="number">11</span>:<span class="number">10</span>   <span class="number">0</span>:<span class="number">00</span> ./dg9_9_13 -&#123;<span class="number">000</span>&#125;[RPM=<span class="number">0.00</span>(<span class="number">0.0</span> <span class="number">0.0</span> <span class="number">0.0</span>),IDLE=<span class="number">15</span>s]-P8080 -- --------------------</span><br><span class="line">hwangjr   <span class="number">4601</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">15952</span>   <span class="number">940</span> pts/<span class="number">14</span>   S+   <span class="number">11</span>:<span class="number">10</span>   <span class="number">0</span>:<span class="number">00</span> grep --color=auto dg9</span><br></pre></td></tr></table></figure></p>
<p>停止运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./dg9_9_13 -P8080 -F<span class="built_in">kill</span></span><br><span class="line"><span class="comment"># 暴力</span></span><br><span class="line"><span class="built_in">kill</span> -<span class="number">9</span> <span class="number">4595</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置ANDROID_SDK">配置ANDROID SDK</h3><p>回到我们的场景，配置ANDROID SDK，基本按照我们的思路，直接配置本地的路由和端口即可。<br>打开ANDROID SDK，Tools -&gt; Options，配置HTTP PROXY SERVER为：127.0.0.1，端口为8080，然后即可畅游谷歌网络。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">12</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52791</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">15</span> INFO     connecting dl-ssl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52796</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">17</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52799</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">03</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52809</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">57</span> INFO     connecting dl.google.com:<span class="number">80</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52821</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">08</span>-<span class="number">21</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">02</span> INFO     connecting ssl.google-analytics.com:<span class="number">443</span> from <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">52962</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ShadowSocks">ShadowSocks</h3><p>顺带简单介绍下<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks/shadowsocks</a>，其功能在官网已经介绍：</p>
<blockquote>
<p>A fast tunnel proxy that helps you bypass firewalls.<br>Features:<br>TCP &amp; UDP support<br>User management API<br>TCP Fast Open<br>Workers and graceful restart<br>Destination IP blacklist</p>
</blockquote>
<p>安装（ubuntu）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-pip</span><br><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure></p>
<p>使用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">usage: sslocal [OPTION]...</span><br><span class="line">A fast tunnel proxy that helps you bypass firewalls.</span><br><span class="line"></span><br><span class="line">You can supply configurations via either config file or <span class="built_in">command</span> line arguments.</span><br><span class="line"></span><br><span class="line">Proxy options:</span><br><span class="line">  -c CONFIG              path to config file</span><br><span class="line">  <span class="operator">-s</span> SERVER_ADDR         server address</span><br><span class="line">  -p SERVER_PORT         server port, default: <span class="number">8388</span></span><br><span class="line">  -b LOCAL_ADDR          <span class="built_in">local</span> binding address, default: <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">  <span class="operator">-l</span> LOCAL_PORT          <span class="built_in">local</span> port, default: <span class="number">1080</span></span><br><span class="line">  -k PASSWORD            password</span><br><span class="line">  -m METHOD              encryption method, default: aes-<span class="number">256</span>-cfb</span><br><span class="line">  -t TIMEOUT             timeout <span class="keyword">in</span> seconds, default: <span class="number">300</span></span><br><span class="line">  --fast-open            use TCP_FASTOPEN, requires Linux <span class="number">3.7</span>+</span><br><span class="line"></span><br><span class="line">General options:</span><br><span class="line">  -h, --help             show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  <span class="operator">-d</span> start/stop/restart  daemon mode</span><br><span class="line">  --pid-file PID_FILE    pid file <span class="keyword">for</span> daemon mode</span><br><span class="line">  --log-file LOG_FILE    <span class="built_in">log</span> file <span class="keyword">for</span> daemon mode</span><br><span class="line">  --user USER            username to run as</span><br><span class="line">  -v, -vv                verbose mode</span><br><span class="line">  -q, -qq                quiet mode, only show warnings/errors</span><br><span class="line">  --version              show version information</span><br><span class="line"></span><br><span class="line">Online <span class="built_in">help</span>: &lt;https://github.com/shadowsocks/shadowsocks&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">sudo sslocal <span class="operator">-s</span> SERVER_ADDR -p SERVER_PORT -b LOCAL_ADDR <span class="operator">-l</span> LOCAL_PORT -k PASSWORD -m METHOD</span><br><span class="line"></span><br><span class="line"><span class="comment"># LOG</span></span><br><span class="line">sudo less /var/<span class="built_in">log</span>/shadowsocks.log</span><br></pre></td></tr></table></figure>
<p>更多详细可以参考文档<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks/shadowsocks</a>。</p>
<h2 id="总结">总结</h2><p>伟大的墙。</p>
<h2 id="REF">REF</h2><p><a href="http://delegate.org/delegate/" target="_blank" rel="external">DeleGate Support Site</a><br><a href="http://www.delegate.org/documents/" target="_blank" rel="external">Documents on DeleGate</a><br><a href="ftp://ftp.delegate.org/pub/DeleGate/" target="_blank" rel="external">FTP on DeleGate</a><br><a href="http://www.delegate.org/delegate/build.shtml" target="_blank" rel="external">Building DeleGate</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/08/21/将SOCKET代理转化为HTTP代理/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/Books/" title="Books">Books<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CI/" title="CI">CI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/tech/" title="tech">tech<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/创业/" title="创业">创业<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/tech/" title="tech">tech<sup>23</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/创业/" title="创业">创业<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ci/" title="ci">ci<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Books/" title="Books">Books<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://blog.hwangjr.com" target="_blank" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, Welcome to my blog. <br/>
			I&#39;m HwangJR, Tech change the world.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1234193120" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/hwangjr" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/4827228" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/HuangJR" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/https://facebook.com/jr.hwang.2010" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		
		
		<a href="https://www.zhihu.com/people/hwangjr" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		<a href="https://plus.google.com/+JianrongHuang?rel=author" target="_blank" class="icon-google_plus" title="Google+"></a>
		
		
		<a href="mailto:huangjianrong2010@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="HwangJR">HwangJR</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'HwangJR';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-63911310-1', 'hwangjr.github.io');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<script>
var option = {
  engineKey: '6e8f6d9aa88722365432'
};
(function(w,d,t,u,n,s,e){
  s = d.createElement(t);
  s.src = u;
  s.async = 1;
  w[n] = function(r){
    w[n].opts = r;
  };
  e = d.getElementsByTagName(t)[0];
  e.parentNode.insertBefore(s, e);
})(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
_ts(option);
</script>

<!-- Tiny_search End -->

  </body>
 </html>
