
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>HwangJR&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="HwangJR">
    

    
    <meta name="description" content="Some stuff about tech etc..">
<meta property="og:type" content="website">
<meta property="og:title" content="HwangJR's Blog">
<meta property="og:url" content="https://hwangjr.github.io/index.html">
<meta property="og:site_name" content="HwangJR's Blog">
<meta property="og:description" content="Some stuff about tech etc..">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HwangJR's Blog">
<meta name="twitter:description" content="Some stuff about tech etc..">
<meta name="twitter:creator" content="@HuangJR">
<link rel="publisher" href="+JianrongHuang">

    
    <link rel="alternative" href="/atom.xml" title="HwangJR&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HwangJR&#39;s Blog" title="HwangJR&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a></h1>
				<h2 class="blog-motto">Life is wonderful!</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="ts-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/10/AI-Appreciative-Inquiry-欣赏式探询-初探/" title="AI(Appreciative Inquiry / 欣赏式探询) 初探" itemprop="url">AI(Appreciative Inquiry / 欣赏式探询) 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-05-10T07:37:11.000Z" itemprop="datePublished"> 发表于 2016-05-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction">Introduction</h1><p>欣赏式探询（Appreciative Inquiry），就是搜寻组织内以及其他相关群体世界中最好、最美的一面，由此实现个人与群体、成员与组织的共同发展。</p>
<p>过去，在组织发展领域，无论是企业管理者还是管理顾问，都是从缺陷着手，去寻找组织当中哪里有问题，什么是弱点或短板，然后着手去修正。而欣赏式探询中没有否定、批评和教育，取而代之的是，新知探索、梦想构筑和愿景设计。</p>
<p>欣赏式探询的核心理念是：每一个充满活力的组织系统都有许多尚未开发的、激动人心的积极资产。将这些资产组合到一起，就能找到“积极的变革核心（Positive Change Core）”，这是让“欣赏式探询”真正起作用的因素。将“积极变革核心”的能量直接释放于任何一项变革进程，就会发现：即便是那些从前认为绝不可能发生的变化，突然之间也有了转机。在这里看不到任何外力的压迫作用，完全是内在自发的自由民主式过程。</p>
<p>A（Appreciative）：双重含义，1为赏识、鉴赏、感激；二为增值、涨价。同义词包括：重视（value）、奖赏（prize）、尊重（esteem）、荣誉（honor）。<br>I（Inquiry）：双重含义，1为探索和发现的行为；二为提问，对发现新的潜力与可能性保持开放。同义词包括：发现（discover）、搜索（search）、系统地探索（systematically explore）、研究（study）。</p>
<p>解决问题（组织是等着被解决的问题）：<br>指出问题 -&gt; 分析成因 -&gt; 分析可能的解决方案 -&gt; 行动计划（改进方案）</p>
<p>欣赏式探询（组织是应该被拥抱的奇迹）：<br>欣赏和重视（“现在”最好的） -&gt; 想象（可能会是什么） -&gt; 讨论（应该是什么） -&gt; 创新打造（将会是什么）</p>
<p>思维的转变：<br>No problem can be solved from the same level of consciousness that created it. We must learn to see the world anew.<br>同一个观念并不能解决任何由它引起的问题，我们必须学会用新的眼光去看这个世界。<br>There are only two ways to live your life. One is as though nothing is a miracle. The other is as though everything is a miracle.<br>有两种对待生活的方法，一是把什么都不看成奇迹，一是把什么都看成奇迹。<br>— 爱因斯坦</p>
<p>AI是围绕优势建立的变革方式<br>AI是一种自觉的革命范式<br>AI秉承“精诚合作、共同发展”的理念，将人群组织或社区视为一个有机的生命体，通过系统地发现赋予并激活组织生命最大效率与能力的经济、生态和人性方面的优势，谋求个人、组织及其外部世界的美好未来。</p>
<h1 id="五大原则">五大原则</h1><h2 id="诠释原则（Constructionist_Principle）">诠释原则（Constructionist Principle）</h2><p>地图不等于强域；看到的现实是来自于我们的选择与诠释</p>
<p>组织的前途命运与组织成员的知识经验是交织在一起的，要想成为一个高效的经理人、领导者或者变革家，就一定要擅于像对待有机人体那样，去理解、解读和分析自己的组织。</p>
<h2 id="诗歌原则（Poetic_Principle）">诗歌原则（Poetic Principle）</h2><p>注意力就是能量；专注在成功，就会创造出更多成功</p>
<p>我们与其将人类社会组织比作一部机器，到不如说它是一本打开的书。一个组织的故事，是由它的所有成员持续不断共同写就的。而且，在这一“写作”过程中，过去、现在、未来无始无终，学习、感悟和判解也永不停息。这就恰好像人们对一段曼妙诗篇、经文的注解，永远没有尽头，不断有新的内容加入。</p>
<h2 id="并发原则（Principle_of_Simultaneity）">并发原则（Principle of Simultaneity）</h2><p>改变发生在我们提问的同时；提问就是介入、就是引导</p>
<p>欣赏式探询理论认为问询和变革并非是两个相对独立的时间过程，而是同时发生的。问询伊始，正常的发展过程即受到干涉，发展轨迹即受到影响。发生变革所需的火种，也就是人们谈论思考的话题、人们学习探索的新知，以及人们对话展望的动因，在提出问题的那一刹那就产生了。</p>
<h2 id="预想原则（Anticipatory_Principle）">预想原则（Anticipatory Principle）</h2><p>人往内在的未来形象移动，正向的未来形象，激发正向的行动</p>
<p>预想原则关于组织生活的一个基本观点，正是那些描绘出来的未来图景，在指导组织、机体当下的实践活动。就像电影放映机总要投向前方的荧屏，人类系统的“放映机”亦永远投向未来与愿景。在人们所用的隐喻里和语言中，随处可见未来的影子，这使得未来成为一股作用于现实的强大的动员力量。</p>
<h2 id="积极原则（Positive_Principle）">积极原则（Positive Principle）</h2><p>发展强项比矫正弱点更有效果</p>
<p>这项原则不像其他原则那么抽象，它从肯定式探询多年的实践中来。我们发现：在工作中，提问的方式愈加积极，我们的变革努力将愈加成功与持久。而用那种世界充满矛盾的消极态度提问，结果往往是于事无补。我们如果能够像谦恭的门徒那样，永远保持积极的探询之心，将变得更加强壮、聪慧与高效。</p>
<h2 id="整体性原则（Wholeness_Principle）（新增）">整体性原则（Wholeness Principle）（新增）</h2><p>我们都是更大整体的一部分，整体大于部分的总和</p>
<h2 id="预演性原则（Enactment_Principle）（新增）">预演性原则（Enactment Principle）（新增）</h2><p>试着先成为我们想看到的那个改变；彩排未来，借假修真</p>
<h2 id="自主性原则（Free_Choice_Principle）（新增）">自主性原则（Free Choice Principle）（新增）</h2><p>自由让人们选择将更有责任感；自主性激发卓越及正想改变</p>
<h1 id="4D">4D</h1><p>新知探索（Discovery）：是什么使生命生机盎然？肯定。揭示正面的能力，发现积极变革核心，动员整个系统，使所有利益相关者都参与进来。找出各种优势和最佳实践及其相互关系。确定“我们过去和现在最为成功的要素”。调动整个系统，进入积极探询的变革核心。</p>
<p>梦想梦想（Dream）：我们期待发生什么？预想结果。如何应用“积极变革核心”去创造企业的未来，结合发现的潜能和更高的目标，诸如“我们存在于世所欲为何”，创造一个清晰的结果导向的愿景。基于业已发现的潜能，围绕更高的追求，构筑清晰的梦境。例如，问一问自己：“今天的世界要求我们如何应对明天的挑战？”“通过今天的不懈努力，明天的我们又将会变成怎样？”</p>
<p>组织设计（Design）：理想的状况是什么？共同构建。在现实中如何创造理想的组织、架构和系统，理清理想中的组织所需具备的各种条件，进行组织设计，以使人们可以利用并放大“积极的变革核心”，实现全新的梦想。就如何构建理想化组织，提出各种建议。在这样的组织内，每一名成员要既能自由释放推动组织变革的积极潜能，又能自由实现自己构筑的梦想。</p>
<p>把握命运（Destiny）：如何授权、学习与调整？维持。增强整个系统的“肯定能力”（Affirmative Capability）。使其树立希望，维持持续进行积极变革和改善绩效的动力。进一步强化整个系统积极肯定的性征，满怀希望和动力，去实现更为远大的组织目标。在此过程中，组织成员的学习、调整和提高此时已经成为自觉的行为习惯，就好像爵士乐队的即兴演。</p>
<h1 id="例子">例子</h1><h2 id="Check_In">Check In</h2><p>姓名、心情、期待<br>我们所关注的事情，最终一定会实现。</p>
<h2 id="参与原则">参与原则</h2><ol>
<li>真诚倾听</li>
<li>做自己的老师</li>
<li>yes … and …</li>
<li>看待彼此都是一个宝藏</li>
<li>打开心扉<br>重视彼此的差异是非常重要的。</li>
</ol>
<h2 id="AI_Workshop_Agenda">AI Workshop Agenda</h2><ol>
<li>Check-in &amp; warm-up</li>
<li>画出你人生闪光点（包括个人成长过程和职业生涯）（探索）</li>
<li>结对互相介绍你的个人闪光点</li>
<li>石头汤的故事</li>
<li>高峰访谈个人梦想和目标（梦想 &amp; 设计 &amp; 实现）</li>
<li>团队目标探索</li>
<li>实现当下：团队目标。实现三部曲</li>
<li>总结你的一句人生信念或格言</li>
</ol>
<p>当人们能够带着他们的过去（已知）向未来（未知）进发，他们就会更有信心，也更自在。</p>
<p><strong>欣赏式访谈（Appreciate interview）</strong></p>
<ol>
<li>一对一的深度对话，涉及巅峰体验、珍视的事物、希望和梦想</li>
<li>访谈要领：星探心态、闪光时刻的画面、挖掘宝藏、聆听 + 探询</li>
</ol>
<p>如果我们要带着过去的一部分走向未来，那就应该带最好的那一部分。</p>
<h2 id="石头汤">石头汤</h2><p>我们相信，一块石头，也能煮出一锅鲜美可口的汤；我们相信，每个人都有光，每个人都蕴藏极大潜能。不是石头神奇，而是当人们愿意聚在一起，而且一起相信，一起投入，魔法就会无处不在。</p>
<p>在每个社会、组织或团队，一定有某些行的通的运作方法。</p>
<h2 id="团队目标探索">团队目标探索</h2><ol>
<li>分组，每组2-3人</li>
<li>回顾过去团队成功的经验和闪光的时刻（探索）</li>
<li>小组总结团队目标（梦想）</li>
<li>如果你确定那是你想要的未来，此时此刻的你想要问自己或问团队的一句话是什么？</li>
<li>整个团队发表，投票探索团队目标（设计 &amp; 实现）</li>
</ol>
<p>只要对团队或组织提出问题，都会在某个方面影响这个团队。</p>
<p>实境是当下创造出来的，而且没一个当下都有多重的实境。<br>我们所使用的语言，创造出我们的实境。</p>
<h2 id="另一个小例子">另一个小例子</h2><p>在每次的会议上，让大家围坐成一圈，各自就下面几个议题，依四个层次发表个人的感想。如果参与者不想发言也不勉强。</p>
<p>首先，由主持人自己先陈述，他自己感觉有哪些事做得很好，好在哪里？包括不为人知的准备工作。接着，由其他的参与者对于主持人发言进行回馈，他有哪些表现得很好，好在哪里？然后，再由主持人自己总结，如果下一次再有机会，他会做什么不同的“变化”？最后，由其他的参与者对于主持人的总结进行反馈，如果下一次再有机会，自己又应该做什么不同的变化？</p>
<p>经过以上四个步骤，不但激励了主持人朝向开放进步发展，更塑造了集体正向思考的氛围，减少了竞争和批判，增进了了解和合作。如此，人人主动，真诚地为愿景服务，在日积月累之下，组织文化得以正向能量转化，开放智慧所引动的凝聚力才真正发挥1+1&gt;2的效果。</p>
<p>可见，在欣赏式探询的组织内，组织成员互相欣赏对方的优点和长处，采用积极肯定的态度，去分享对方的人生梦想和终极关怀，大家同心同德，携手共同创造一个崭新的世界，一个更加美好的世界。而“欣赏式探询”尤为突出的地方在于，它能够鼓动组织中的人们提出“积极的问题”，激发集体智慧，它是以激发、动员、探询优势为导向的积极的变革模式。</p>
<h1 id="AI的八个假设">AI的八个假设</h1><ol>
<li>在每个社会、组织或团队，一定有某些行的通的运作方法</li>
<li>我们所关注的事情，最终一定会实现</li>
<li>实境是当下创造出来的，而且每一个当下都有多重的实境</li>
<li>只要对团队或组织提出问题，都会在某个方面影响这个团队</li>
<li>当人们能够带着他们的过去（已知）向未来（未知）进发，他们就会更有信心，也更自在</li>
<li>如果我们要带着过去一部分走向未来，那就应该带最好的那一部分</li>
<li>重视彼此的差异，是非常重要的</li>
<li>我们所使用的语言，创造出我们的实境</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a><a href="/tags/scrum/">scrum</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/10/AI-Appreciative-Inquiry-欣赏式探询-初探/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/10/SSH的公钥/" title="SSH的公钥" itemprop="url">SSH的公钥</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-05-10T07:36:01.000Z" itemprop="datePublished"> 发表于 2016-05-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>在开发中，经常在客户端生成密钥和公钥（<code>ssh-keygen -t rsa</code>），将生成的公钥内容追加到服务器的<code>~/.ssh/authorized_keys</code>文件中，并重新加载服务器sshd服务。其中<code>gitolite</code>就是使用这种机制。但是我们在配置时候，经常会遇到问题，配置完成之后，还需要输入密码，下面针对这个问题，进行分析排查。</p>
<h1 id="打怪兽">打怪兽</h1><h2 id="怪兽显形">怪兽显形</h2><p>还记得年轻时候，搭建了个<code>gitolite</code>服务，近期新配了本本，安装<code>openSUSE</code>系统，在原来<code>Ubuntu</code>上拷贝密钥到新本本发现无法正常clone，需要输入密码，由此展开一场惊心动魄的排查战争。</p>
<h2 id="怪兽跟踪">怪兽跟踪</h2><h3 id="第一步，gitolite">第一步，<code>gitolite</code></h3><p>由于是在<code>gitolite</code>上引起的错误，自然而然谷歌关于<code>gitolite</code>相关帖子，发现内容内容针对性不多，而且大部分是权限。仔细再次阅读<code>gitolite</code>的<code>readme</code>，会发现其实是通过在<code>~/.ssh/authorized_keys</code>里面加入公钥来达到通信，那么简单，应该就是<code>ssh</code>连接出现问题了。</p>
<p>在此期间发现<a href="http://gitolite.com/gitolite/sts.html#stsapp1" target="_blank" rel="external">ssh troubleshooting and tips</a>：</p>
<blockquote>
<p>This is a quick checklist:</p>
<ul>
<li><p>Make sure you’re being asked for a password and not a passphrase. Do not confuse or mistake a prompt saying <code>Enter passphrase for key &#39;/home/sitaram/.ssh/id_rsa&#39;:</code> for a password prompt from the remote server!<br>When you create an ssh keypair using <code>ssh-keygen</code>, you have the option of protecting it with a passphrase. When you subsequently use that keypair to access a remote host, your local ssh client needs to unlock the corresponding private key, and ssh will probably ask for the passphrase you set when you created the keypair.<br>You have two choices to avoid this prompt every time you try to use the private key. The first is to create keypairs without a passphrase (just hit enter when prompted for one). <strong>Be sure to add a passphrase later, once everything is working, using <code>ssh-keygen -p</code></strong>.<br>The second is to use <code>ssh-agent</code> (or <code>keychain</code>, which in turn uses <code>ssh-agent</code>) or something like that to manage your keys. Other than discussing one more potential trouble-spot with ssh-agent (see below), further discussion of ssh-agent/keychain is out of scope of this page.</p>
</li>
<li><p>Ssh is very sensitive to permissions. An extremely conservative setup is given below, but be sure to do this on <strong>both the client and the server</strong>:</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd <span class="variable">$HOME</span></span><br><span class="line">&gt; chmod go-rwx .</span><br><span class="line">&gt; chmod -R go-rwx .ssh</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Actually, every component of the path to <code>~/.ssh/authorized_keys</code> all the way upto the root directory must be at least <code>chmod go-w</code>. So be sure to check <code>/</code> and <code>/home</code> also.</p>
</li>
<li>While you’re doing this, make sure the owner and group info for each of these components are correct. <code>ls -ald ~ ~/.ssh ~/.ssh/authorized_keys</code> will tell you what they are.</li>
<li>You may also want to check <code>/etc/ssh/sshd_config</code> to see if the “git” user is allowed to login at all. For example, if that file contains an <code>AllowUsers</code> config entry, then only users mentioned in that line are allowed to log in!</li>
<li>While you’re in there, check that file does NOT have a setting for <code>AuthorizedKeysFile</code>. See <code>man sshd_config</code> for details. This setting is a show stopper for gitolite to use ssh.</li>
<li>Some OSs/distributions require that the “git” user should have a password and/or not be a locked account. You may want to check that as well.</li>
<li>If your server is running SELinux, and you install gitolite to <code>/var/gitolite</code> or another location unsupported by default SELinux policies, then SELinux will prevent sshd from reading <code>.ssh/authorized_keys</code>. Consider installing gitolite to <code>/var/lib/gitolite</code>, which is a supported location by default SELinux policies.</li>
<li>If all that fails, log onto the server as root, <code>cd /var/log</code>, and look for a file called <code>auth.log</code> or <code>secure</code> or some such name. Look inside this file for messages matching the approximate time of your last attempt to login, to see if they tell you what is the problem.</li>
</ul>
</blockquote>
<h3 id="第二步，ssh配置">第二步，<code>ssh</code>配置</h3><p>在此期间做了几件事：</p>
<ul>
<li>在<code>openSUSE</code>上安装虚拟机<code>Ubuntu</code>并进行<code>clone</code>，发现正常</li>
<li>在<code>openSUSE</code>上生成密钥，并拷贝到<code>Ubuntu</code>上，发现正常</li>
</ul>
<p>由此判断，问题在<code>openSUSE</code>系统配置上，检查<code>/etc/ssh/ssh_config</code>文件配置，并与<code>Ubuntu</code>配置进行判断，并没有发现特殊配置，且修改为一致也无法解决此问题。</p>
<p>进行大规模尝试，包括将<code>.ssh</code>权限修改为<code>0700</code>，<code>authorized_keys</code>和<code>id_rsa.pub</code>权限修改为<code>0644</code>，<code>id_rsa</code>为<code>0600</code>，但是不是权限问题。<br>进行排查是否是群组权限问题，通过修改用户群组，并未发现问题。</p>
<h3 id="第三步，大招">第三步，大招</h3><p>经过上面进行解决之后，均无法发现问题，陷入疑惑，并进行咨询，排查信息。因为<code>gitolite</code>其实也是通过<code>ssh</code>来进行验证，那么其实是可以通过下面代码来进行验证并查看记录：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -vvt git@xxx<span class="class">.xxx</span><span class="class">.xxx</span><span class="class">.xxx</span></span><br><span class="line">ssh -v git@xxx<span class="class">.xxx</span><span class="class">.xxx</span><span class="class">.xxx</span></span><br></pre></td></tr></table></figure></p>
<p>排查发现，会默认寻找<code>id_rsa</code>进行公钥验证，而在ubuntu上，会对公钥进行轮询并进行验证，在<code>openSUSE</code>上将密钥修改为<code>id_rsa</code>成功！</p>
<p><strong>原来是这个基本问题，被自己蠢哭了！！！</strong></p>
<h2 id="解决">解决</h2><p>简单处理，新增<code>~/.ssh/config</code>文件，并针对各个key进行配置，上配置模板。<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host github.com  <span class="comment">##主机别名</span></span><br><span class="line">    Hostname github.com  <span class="comment">##主机真实地址</span></span><br><span class="line">    PreferredAuthentications publickey</span><br><span class="line">    IdentityFile ~/.ssh/git/tudouya_id_rsa</span><br><span class="line">    <span class="built_in">User</span> <span class="built_in">user</span></span><br><span class="line">    Port port</span><br></pre></td></tr></table></figure></p>
<p>或者使用<code>ssh-agent</code>来解决。</p>
<h2 id="配置">配置</h2><p><code>ssh</code>配置文件为<code>/etc/ssh/ssh_config</code>，<code>sshd</code>配置<code>/etc/ssh/sshd_config</code>，参数配置：</p>
<p><strong>Port 22 </strong><br>“Port”设置sshd监听的端口号。</p>
<p><strong>ListenAddress 192.168.1.1 </strong><br>“ListenAddress”设置sshd服务器绑定的IP地址。</p>
<p><strong>HostKey /etc/ssh/ssh_host_key</strong><br>“HostKey”设置包含计算机私人密匙的文件。</p>
<p><strong>ServerKeyBits 1024 </strong><br>“ServerKeyBits”定义服务器密匙的位数。</p>
<p><strong>LoginGraceTime 600 </strong><br>“LoginGraceTime”设置如果用户不能成功登录，在切断连接之前服务器需要等待的时间（以秒为单位）。</p>
<p><strong>KeyRegenerationInterval 3600 </strong><br>“KeyRegenerationInterval”设置在多少秒之后自动重新生成服务器的密匙（如果使用密匙）。重新生成密匙是为了防止用盗用的密匙解密被截获的信息。</p>
<p><strong>PermitRootLogin no </strong><br>“PermitRootLogin”设置root能不能用ssh登录。这个选项一定不要设成“yes”。</p>
<p><strong>IgnoreRhosts yes </strong><br>“IgnoreRhosts”设置验证的时候是否使用“rhosts”和“shosts”文件。</p>
<p><strong>IgnoreUserKnownHosts yes </strong><br>“IgnoreUserKnownHosts”设置ssh daemon是否在进行RhostsRSAAuthentication安全验证的时候忽略用户的“$HOME/.ssh/known_hosts”</p>
<p><strong>StrictModes yes </strong><br>“StrictModes”设置ssh在接收登录请求之前是否检查用户家目录和rhosts文件的权限和所有权。这通常是必要的，因为新手经常会把自己的目录和文件设成任何人都有写权限。</p>
<p><strong>X11Forwarding no </strong><br>“X11Forwarding”设置是否允许X11转发。</p>
<p><strong>PrintMotd yes </strong><br>“PrintMotd”设置sshd是否在用户登录的时候显示“/etc/motd”中的信息。</p>
<p><strong>SyslogFacility AUTH </strong><br>“SyslogFacility”设置在记录来自sshd的消息的时候，是否给出“facility code”。</p>
<p><strong>LogLevel INFO </strong><br>“LogLevel”设置记录sshd日志消息的层次。INFO是一个好的选择。查看sshd的man帮助页，已获取更多的信息。</p>
<p><strong>RhostsAuthentication no </strong><br>“RhostsAuthentication”设置只用rhosts或“/etc/hosts.equiv”进行安全验证是否已经足够了。</p>
<p><strong>RhostsRSAAuthentication no </strong><br>“RhostsRSA”设置是否允许用rhosts或“/etc/hosts.equiv”加上RSA进行安全验证。</p>
<p><strong>RSAAuthentication yes </strong><br>“RSAAuthentication”设置是否允许只有RSA安全验证。</p>
<p><strong>PasswordAuthentication yes </strong><br>“PasswordAuthentication”设置是否允许口令验证。</p>
<p><strong>PermitEmptyPasswords no </strong><br>“PermitEmptyPasswords”设置是否允许用口令为空的帐号登录。</p>
<p><strong>AllowUsers admin </strong><br>“AllowUsers”的后面可以跟着任意的数量的用户名的匹配串（patterns）或user@host这样的匹配串，这些字符串用空格隔开。主机名可以是DNS名或IP地址。</p>
<h1 id="后记">后记</h1><p><code>SSH</code>是很强大而安全的工具，使用它，了解它，完成各种任务！！！</p>
<h1 id="REF">REF</h1><p><a href="http://gitolite.com/gitolite/sts.html#stsapp1" target="_blank" rel="external">ssh troubleshooting and tips</a><br><a href="http://www.robotgoblin.co.uk/blog/2012/07/24/managing-multiple-ssh-keys/" target="_blank" rel="external">Managing Multiple SSH Keys » Robot Goblin</a><br><a href="http://www.ibm.com/developerworks/cn/aix/library/au-sshsecurity/" target="_blank" rel="external">SSH 安全性和配置入门</a><br><a href="https://ruby-china.org/topics/14182" target="_blank" rel="external">SSH 上传公钥到服务器后还需要密码 » 社区 » Ruby China</a><br><a href="http://www.php101.cn/2014/10/12/%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90ssh-key%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AAssh-key/" target="_blank" rel="external">如何生成ssh key以及使用多个ssh key | php101</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/10/SSH的公钥/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/10/XMind-In-OpenSUSE/" title="XMind In OpenSUSE" itemprop="url">XMind In OpenSUSE</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-05-10T07:34:41.000Z" itemprop="datePublished"> 发表于 2016-05-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Installation">Installation</h1><h2 id="Install_with_deb_package">Install with deb package</h2><p>Xmind does not provide a rpm package for Fedora user. you can install xmind in Fedora with debian deb package.<br><strong>A:</strong> download xmind deb package from ‘<a href="http://www.xmind.net/downloads/" target="_blank" rel="external">http://www.xmind.net/downloads/</a>‘<br><strong>B:</strong> uncompress deb package with ar: “ar -x xmind-x.x.x.xx.deb”<br><strong>C:</strong> Now we get 2 tar.gz package call ‘control.tar.gz’ and ‘data.tar.gz’<br><strong>D:</strong> untar data.tar.gz: “tar xf data.tar.gz”<br><strong>E:</strong> got a ‘usr’ dir in $PWD, cd $PWD/usr/local dir, copy ‘xmind’ dir to ‘/opt/‘, copy ‘share’ dir to ‘/usr’<br><strong>F:</strong> untar control.tar.gz: “tar xf control.tar.gz”<br><strong>G:</strong> got a shell script called ‘postinst’, execute ‘postinst’: “sh postinst”<br><strong>H:</strong> edit ‘/usr/share/applications/xmind.desktop’, change ‘/usr/local’ to ‘/opt’.<br><strong>I:</strong> Done, enjoy your xmind.</p>
<h2 id="Make_a_RPM_Package_(Alien)">Make a RPM Package (Alien)</h2><p>Install Alien (Need to jump on the <a href="https://software.opensuse.org/download.html?project=home%3AKAMiKAZOW&amp;package=alien" target="_blank" rel="external">Kamikaz Repo</a> of the openSUSE factory):<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zypper addrepo <span class="symbol">http:</span>/<span class="regexp">/download.opensuse.org/repositories</span><span class="regexp">/home:KAMiKAZOW/open</span>SUSE_Leap_42.<span class="number">1</span>/<span class="symbol">home:</span><span class="constant">KAMiKAZOW</span>.repo</span><br><span class="line">zypper refresh</span><br><span class="line">zypper install alien</span><br></pre></td></tr></table></figure></p>
<p>Then convert <code>deb</code> to <code>rpm</code>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># alien -r --scripts</span></span><br><span class="line">sudo alien -r -c xmind-<span class="number">7</span>-update1-linux_amd64.deb</span><br><span class="line">sudo zypper in xmind-<span class="number">7</span>-update1-linux_amd64.rpm</span><br></pre></td></tr></table></figure></p>
<p><strong>TIPS1</strong><br>if this situation occurs:<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Package</span> build failed. Here<span class="attribute">'s</span> the log <span class="keyword">of</span> the command (cd xmind-<span class="number">3.6</span>.<span class="number">1</span>; rpmbuild <span class="comment">--buildroot='/home/hwangjr/xmind-3.6.1' -bb --target x86_64 'xmind-3.6.1-2.spec'):</span></span><br><span class="line">sh: rpmbuild: command <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure></p>
<p>then:<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zypper <span class="keyword">install</span> rpmbuild</span><br></pre></td></tr></table></figure></p>
<p><strong>TIPS2</strong><br>Apart from differences in desktop environments, one fundamental difference between Debian and Red Hat derived distributions (including SuSE) is whereas 64-bit libraries are installed under /lib and /usr/lib in Debian, they’re under /lib64 and /usr/lib64 in Red Hat. As a result some packages may refuse to install because they’re looking in the wrong place for their dependencies. This wasn’t an issue with Xmind because of its implementation as an Eclipse workbench application, and Red Hat’s locating of its 64-bit java binaries under <code>/usr/lib/jvm</code>.</p>
<p><strong>TIPS3</strong><br>if this occurs while installation:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Problem: nothing provides <span class="function"><span class="title">osgi</span><span class="params">(org.eclipse.ui.themes)</span></span> needed by xmind-<span class="number">3.6</span>.<span class="number">1</span>-<span class="number">2</span><span class="class">.x86_64</span></span><br><span class="line"> Solution <span class="number">1</span>: do not install xmind-<span class="number">3.6</span>.<span class="number">1</span>-<span class="number">2</span><span class="class">.x86_64</span></span><br><span class="line"> Solution <span class="number">2</span>: break xmind-<span class="number">3.6</span>.<span class="number">1</span>-<span class="number">2</span><span class="class">.x86_64</span> by ignoring some of its dependencies</span><br></pre></td></tr></table></figure></p>
<p>just ignore it ~</p>
<h1 id="REF">REF</h1><p><a href="http://www.xmind.net/m/JKm6/" target="_blank" rel="external">Install Xmind in Fedora with deb package</a><br><a href="http://tunnelix.com/converting-a-deb-into-rpm-using-alien-on-opensuse/" target="_blank" rel="external">Converting a deb into rpm using alien on openSUSE – Through out the tunnel</a><br><a href="https://onemoretech.wordpress.com/2014/03/25/alien-invasions-making-an-xmind-rpm/" target="_blank" rel="external">alien invasions: making an xmind rpm | onemoretech</a><br><a href="http://www.groesch.net/2014-02-08/alien-deb-rpm.html" target="_blank" rel="external">Thorsten Grösch - openSUSE &amp; xmind: converting deb packages to rpm</a><br><a href="http://forums.fedoraforum.org/showthread.php?t=308234" target="_blank" rel="external">Installing XMind7 - where do I find osgi? - FedoraForum.org</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/10/XMind-In-OpenSUSE/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/02/Android-HotFix方案/" title="Android HotFix方案" itemprop="url">Android HotFix方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-03-02T12:14:44.000Z" itemprop="datePublished"> 发表于 2016-03-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>随着开发需求的不断迫切，目前开源已经涌现了很多Hot Fix项目，但是从方案上来说，主要是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的<a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>；以方法hook，从Field切入的<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">AndFix</a>；<a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">Dex分包</a>的<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>。而相同原理的不同实现有很多，这里就不再累赘。这三个实现原理截然不同，各有各自优缺点，让我们走近这几个方案。</p>
<h1 id="方案揭秘">方案揭秘</h1><h2 id="Dexposed">Dexposed</h2><p><a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">alibaba/dexposed</a>是基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">rovo89/Xposed</a>的AOP框架，方法级别粒度，而且不仅可以Hot Fix，还可进行AOP编程、插桩、Hook等功能。</p>
<p>Xposed是需要ROOT权限，因为其要修改其他应用及系统行为，而对于单个应用而言，不需要ROOT。Xposed基本原理是：通过修改Dalvik运行时的Zygote进程，使用Xposed Bridge来hook方法并注入自身代码，实现非侵入式的Runtime修改。包括小米（<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_dalvik.cpp" target="_blank" rel="external">onVmCreated方法</a>），也利用此特性，做了自定义主题、沉浸式状态栏等功能。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called very early during VM startup. */</span></span><br><span class="line"><span class="literal">void</span> onVmCreated(JNIEnv* env) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="subst">!</span>initMemberOffsets(env))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    jclass classMiuiResources = env<span class="subst">-&gt;</span>FindClass(CLASS_MIUI_RESOURCES);</span><br><span class="line">    <span class="keyword">if</span> (classMiuiResources != <span class="built_in">NULL</span>) &#123;</span><br><span class="line">        ClassObject* clazz = (ClassObject*)dvmDecodeIndirectRef(dvmThreadSelf(), classMiuiResources);</span><br><span class="line">        <span class="keyword">if</span> (dvmIsFinalClass(clazz)) &#123;</span><br><span class="line">            ALOGD(<span class="string">"Removing final flag for class '%s'"</span>, CLASS_MIUI_RESOURCES);</span><br><span class="line">            clazz<span class="subst">-&gt;</span>accessFlags <span class="subst">&amp;</span>= ~ACC_FINAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    env<span class="subst">-&gt;</span>ExceptionClear();</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>应用启动时，会fork zygote进程，装载class和invoke各种初始化方法，Xposed就是在这个过程替换了app_process，hook各个入口方法，加载XposedBridge.jar提供动态hook基础，具体查看<a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="external">XposedBridge</a>。</p>
<p>具体的Native实现则是在<a href="https://github.com/rovo89/Xposed/blob/master/libxposed_common.cpp" target="_blank" rel="external">libxposed_common.cpp</a>里面，根据系统版本进行分发到libxposed_dalvik或libxposed_art，记录下原来方法信息，将方法指针指向hookedMethodCallback，从而达到劫持目的。</p>
<p>此方式只能对JAVA方法做拦截，不支持C方法。如果线上RELEASE版本进行混淆，patch也是一个痛苦事情，反射和内部类、包名和内部类冲突等处理很繁琐。</p>
<p>针对Xposed<strong>不支持ART</strong>这个事情，现在应该已经解决了，具体移步<a href="https://github.com/rovo89/android_art" target="_blank" rel="external">rovo89/android_art</a>。</p>
<h2 id="AndFix">AndFix</h2><p>简单来说，主要通过补丁工具，利用注解等，描述其与要打补丁的类和方法的对应关系，之后在应用中，加载并替换方法的信息和指针，从而达到热修复目的。里面的实现可能还涉及到其他的部分，比如Security检查、PATCH覆盖等。</p>
<p>化繁为简，直接上核心代码，先以ART（不同版本差异不大，以6.0为例）为例：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> replace_6_0(JNIEnv* env, jobject src, jobject dest) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* smeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(src);</span><br><span class="line"></span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>* dmeth =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtMethod</span>*) env<span class="subst">-&gt;</span>FromReflectedMethod(dest);</span><br><span class="line"></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>class_loader_; <span class="comment">//for plugin classloader</span></span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_ =</span><br><span class="line">			smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>clinit_thread_id_;</span><br><span class="line">	dmeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_ = smeth<span class="subst">-&gt;</span>declaring_class_<span class="subst">-&gt;</span>status_-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改原方法属性为补丁方法</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>declaring_class_ = dmeth<span class="subst">-&gt;</span>declaring_class_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_types_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_types_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>access_flags_ = dmeth<span class="subst">-&gt;</span>access_flags_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_ = dmeth<span class="subst">-&gt;</span>dex_cache_resolved_methods_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_code_item_offset_ = dmeth<span class="subst">-&gt;</span>dex_code_item_offset_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>method_index_ = dmeth<span class="subst">-&gt;</span>method_index_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>dex_method_index_ = dmeth<span class="subst">-&gt;</span>dex_method_index_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改实现指针</span></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_interpreter_;</span><br><span class="line"></span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_jni_;</span><br><span class="line">	smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_ =</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_;</span><br><span class="line"></span><br><span class="line">	LOGD(<span class="string">"replace_6_0: %d , %d"</span>,</span><br><span class="line">			smeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_,</span><br><span class="line">			dmeth<span class="subst">-&gt;</span>ptr_sized_fields_<span class="built_in">.</span>entry_point_from_quick_compiled_code_);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将方法修改为PUBLIC</span></span><br><span class="line"><span class="literal">void</span> setFieldFlag_6_0(JNIEnv* env, jobject field) &#123;</span><br><span class="line">	art<span class="tag">::mirror</span><span class="tag">::ArtField</span>* artField =</span><br><span class="line">			(art<span class="tag">::mirror</span><span class="tag">::ArtField</span>*) env<span class="subst">-&gt;</span>FromReflectedField(field);</span><br><span class="line">	artField<span class="subst">-&gt;</span>access_flags_ = artField<span class="subst">-&gt;</span>access_flags_ <span class="subst">&amp;</span> (~<span class="number">0x0002</span>) | <span class="number">0x0001</span>;</span><br><span class="line">	LOGD(<span class="string">"setFieldFlag_6_0: %d "</span>, artField<span class="subst">-&gt;</span>access_flags_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Dalvik上的实现略有不同，先指向到<code>dalvik_dispatcher</code>，之后在里面进行补丁方法的调用和返回，也就是通过JNI Bridge来指向补丁方法。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="type">void</span> __attribute__ ((visibility (<span class="string">"hidden"</span>))) dalvik_replaceMethod(</span><br><span class="line">		<span class="type">JNIEnv</span>* env, jobject src, jobject dest) &#123;</span><br><span class="line">	jobject clazz = env-&gt;<span class="type">CallObjectMethod</span>(dest, jClassMethod);</span><br><span class="line">	<span class="type">ClassObject</span>* clz = (<span class="type">ClassObject</span>*) dvmDecodeIndirectRef_fnPtr(</span><br><span class="line">			dvmThreadSelf_fnPtr(), clazz);</span><br><span class="line">	clz-&gt;status = <span class="type">CLASS_INITIALIZED</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(src);</span><br><span class="line">	<span class="type">Method</span>* target = (<span class="type">Method</span>*) env-&gt;<span class="type">FromReflectedMethod</span>(dest);</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvikMethod: %s"</span>, meth-&gt;name);</span><br><span class="line"></span><br><span class="line">	meth-&gt;jniArgInfo = <span class="number">0x80000000</span>;</span><br><span class="line">	meth-&gt;accessFlags |= <span class="type">ACC_NATIVE</span>;</span><br><span class="line"></span><br><span class="line">    // 将目标方法赋值到附带值上</span><br><span class="line">	<span class="type">int</span> argsSize = dvmComputeMethodArgsSize_fnPtr(meth);</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth))</span><br><span class="line">		argsSize++;</span><br><span class="line">	meth-&gt;registersSize = meth-&gt;insSize = argsSize;</span><br><span class="line">	meth-&gt;insns = (<span class="type">void</span>*) target;</span><br><span class="line"></span><br><span class="line">    // 指向本地的dispatcher方法</span><br><span class="line">	meth-&gt;nativeFunc = dalvik_dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> dalvik_dispatcher(<span class="keyword">const</span> u4* args, jvalue* pResult,</span><br><span class="line">		<span class="keyword">const</span> <span class="type">Method</span>* <span class="keyword">method</span>, <span class="type">void</span>* self) &#123;</span><br><span class="line">	<span class="type">ClassObject</span>* returnType;</span><br><span class="line">	jvalue <span class="literal">result</span>;</span><br><span class="line">	<span class="type">ArrayObject</span>* argArray;</span><br><span class="line"></span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher source method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line">	<span class="type">Method</span>* meth = (<span class="type">Method</span>*) <span class="keyword">method</span>-&gt;insns;</span><br><span class="line">	meth-&gt;accessFlags = meth-&gt;accessFlags | <span class="type">ACC_PUBLIC</span>;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher target method: %s %s"</span>, <span class="keyword">method</span>-&gt;name,</span><br><span class="line">			<span class="keyword">method</span>-&gt;shorty);</span><br><span class="line"></span><br><span class="line">	returnType = dvmGetBoxedReturnType_fnPtr(<span class="keyword">method</span>);</span><br><span class="line">	<span class="keyword">if</span> (returnType == <span class="type">NULL</span>) &#123;</span><br><span class="line">		assert(dvmCheckException_fnPtr(self));</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">LOGD</span>(<span class="string">"dalvik_dispatcher start call-&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    // 是否静态方法</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth)) &#123;</span><br><span class="line">		<span class="type">Object</span>* thisObj = (<span class="type">Object</span>*) args[<span class="number">0</span>];</span><br><span class="line">		<span class="type">ClassObject</span>* tmp = thisObj-&gt;clazz;</span><br><span class="line">		thisObj-&gt;clazz = meth-&gt;clazz;</span><br><span class="line">		argArray = boxMethodArgs(meth, args + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line"></span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, thisObj,</span><br><span class="line">				argArray);</span><br><span class="line"></span><br><span class="line">		thisObj-&gt;clazz = tmp;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		argArray = boxMethodArgs(meth, args);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			goto bail;</span><br><span class="line">        // 调用</span><br><span class="line">		dvmCallMethod_fnPtr(self, (<span class="type">Method</span>*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;<span class="literal">result</span>, <span class="type">NULL</span>,</span><br><span class="line">				argArray);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dvmCheckException_fnPtr(self)) &#123;</span><br><span class="line">		<span class="type">Object</span>* excep = dvmGetException_fnPtr(self);</span><br><span class="line">		jni_env-&gt;<span class="type">Throw</span>((jthrowable) excep);</span><br><span class="line">		goto bail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (returnType-&gt;primitiveType == <span class="type">PRIM_VOID</span>) &#123;</span><br><span class="line">		<span class="type">LOGD</span>(<span class="string">"+++ ignoring return to void"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">result</span>.l == <span class="type">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (dvmIsPrimitiveClass(returnType)) &#123;</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">NPEClazz</span>, <span class="string">"null result when primitive expected"</span>);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">		pResult-&gt;l = <span class="type">NULL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!dvmUnboxPrimitive_fnPtr(<span class="literal">result</span>.l, returnType, pResult)) &#123;</span><br><span class="line">			<span class="type">char</span> msg[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			snprintf(msg, sizeof(msg) - <span class="number">1</span>, <span class="string">"%s!=%s\0"</span>,</span><br><span class="line">					((<span class="type">Object</span>*) <span class="literal">result</span>.l)-&gt;clazz-&gt;descriptor,</span><br><span class="line">					returnType-&gt;descriptor);</span><br><span class="line">			jni_env-&gt;<span class="type">ThrowNew</span>(<span class="type">CastEClazz</span>, msg);</span><br><span class="line">			goto bail;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bail: dvmReleaseTrackedAlloc_fnPtr((<span class="type">Object</span>*) argArray, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Multiple_Dex">Multiple Dex</h2><p>Multiple Dex的方案原来是为了突破65535的限制，其就是将多个Dex放到应用的ClassLoader之中，从而使所有的Dex的类都能被找到。实际上，在<code>findClass</code>过程中，如果重复的类，参照下面的类加载的实现，是会使用第一个找到的类。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">Class</span> <span class="title">findClass</span>(<span class="title">String</span> <span class="title">name</span>, <span class="title">List</span>&lt;<span class="title">Throwable</span>&gt; <span class="title">suppressed</span>) &#123;  </span></span><br><span class="line">    <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">        DexFile dex = element.dexFile;</span><br><span class="line">        <span class="keyword">if</span> (dex != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">Class</span> <span class="title">clazz</span> = <span class="title">dex</span>.<span class="title">loadClassBinaryName</span>(<span class="title">name</span>, <span class="title">definingContext</span>, <span class="title">suppressed</span>);</span></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="literal">null</span>) &#123;  </span><br><span class="line">        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而方法过多的原因其实也很明显：因为在Dalvik指令集里，调用方法的<code>invoke-kind</code>指令中，method reference index只给了16bits，最多能调用65535个方法，所以在生成Dex文件的过程中，当方法数超过65535就会报错。</p>
<blockquote>
<p>This number is significant in that it represents the total number of references that can be invoked by the code within a single Dalvik Executable (dex) bytecode file.</p>
</blockquote>
<p>该方法就是从这入手，将问题修复后，放到一个单独的Dex中，通过反射插入到<code>dexElements</code>数组的最前面，完成虚拟机打补丁的操作。</p>
<p>在此方案中，有一个问题就是，在运行加载类的时候会报<code>preverified</code>错误，在<code>DexPrepare.cpp</code>中，将Dex转化为ODex过程中，会在<code>DexVerify.cpp</code>中进行校验，验证如果直接引用到的类和clazz是否在同一个Dex，如果是则会打上<code>CLASS_ISPREVERIFIED</code>标志。通过在所有类（Application除外，此时还没加载自定义代码）的构造函数中插入一个对在单独Dex类的引用，来解决此问题。在空间中，是使用<code>javaassist</code>进行编译时字节码插入。</p>
<blockquote>
<p>当一个apk在安装的时候，apk中的classes.dex会被虚拟机(dexopt)优化成odex文件，然后才会拿去执行。<br>虚拟机在启动的时候，会有许多的启动参数，其中一项就是verify选项，当verify选项被打开的时候，就会执行dvmVerifyClass进行类的校验，如果dvmVerifyClass校验类成功，那么这个类会被打上CLASS_ISPREVERIFIED的标志。<br>怎么样算是校验类成功？如果static方法、private方法、构造函数等，其中的直接引用（第一层关系）到的类都在同一个Dex文件中，那么该类就会被打上CLASS_ISPREVERIFIED标志。<br>我们要做的就是，阻止该类打上CLASS_ISPREVERIFIED的标志。否则加载其他Dex的时候会报错。<br>注意下，是阻止引用者的类，也就是说，假设你的app里面有个类叫做LoadBugClass，再其内部引用了BugClass。发布过程中发现BugClass有编写错误，那么想要发布一个新的BugClass类，那么你就要阻止LoadBugClass这个类打上CLASS_ISPREVERIFIED的标志。<br>你在生成apk之前，就需要阻止相关类打上CLASS_ISPREVERIFIED的标志了。对于如何阻止，可让LoadBugClass在构造方法中，去引用别的dex文件，比如：hack.dex中的某个类即可。<br>空间使用的是在字节码插入代码,而不是源代码插入，使用的是javaassist库来进行字节码插入的。</p>
</blockquote>
<p>需要做的两件事：1、动态改变BaseDexClassLoader对象间接引用的dexElements；2、在app打包的时候，阻止相关类去打上CLASS_ISPREVERIFIED标志。</p>
<p>另外混淆问题，需要保存每个版本的<code>mapping</code>混淆文件，后续编译用相同的<code>mapping</code>文件，保证混淆过后类名始终一致。</p>
<p>此方式无法在已经加载好的类中实现动态替换，所以需要在类加载之前替换。也就是补丁下载下来之后，需要等待用户重启应用才可完成补丁效果。</p>
<p>目前开源实现有：<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>，<a href="https://github.com/dodola/HotFix" target="_blank" rel="external">HotFix</a>，<a href="https://github.com/bunnyblue/DroidFix" target="_blank" rel="external">DroidFix</a>，其各个版本也有做相应的兼容。</p>
<h1 id="方案对比">方案对比</h1><ol>
<li>Dexposed方法生成补丁难度较大，需要反射写混淆后的代码，粒度太细，如果替换方法很多的话，工作量巨大。</li>
<li>AndFix支持2.3 - 6.0系统，但JNI不像JAVA那样标准，所以偶尔会有未知的机型异常。从实现来说，类似Dexposed，通过JNI来替代方法，更加简洁的完成补丁修复，应用PATCH不需要重启。但由于实现上直接跳过了类初始化，设置为初始化完毕，所以静态函数、静态成员、构造函数都会出现问题，复杂的类<code>Class.forName</code>很可能直接崩溃。</li>
<li>Multiple Dex方案支持2.3 - 6.0系统，对启动速度会有略微影响，而且只能下次启动生效。</li>
</ol>
<p>相比而言，Multiple Dex方案较为可靠，但是如果Dex文件较为庞大，启动速度会变慢；而AndFix则适用于应用不重启即可修复，且方法够简单；Dexposed方案较为复杂，暂不考虑。</p>
<h1 id="REF">REF</h1><p><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=63&amp;highlight=ClassLoader" target="_blank" rel="external">当dex分包遇上NoClassDefFoundError&amp;ClassNotFoundException</a><br><a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank" rel="external">让App像Web一样发布新版本</a><br><a href="http://blog.zhaiyifan.cn/2015/11/20/HotPatchCompare/" target="_blank" rel="external">各大热补丁方案分析和比较</a><br><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a&amp;scene=1&amp;srcid=1106Imu9ZgwybID13e7y2nEi#wechat_redirect" target="_blank" rel="external">安卓App热补丁动态修复技术介绍</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/49883661" target="_blank" rel="external">Android 热补丁动态修复框架小结</a><br><a href="https://github.com/dodola/HotFix" target="_blank" rel="external">dodola/HotFix: 安卓App热补丁动态修复框架</a><br><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external">美团Android DEX自动拆包及动态加载简介</a><br><a href="https://m.oschina.net/blog/308583" target="_blank" rel="external">Android dex分包方案</a><br><a href="http://www.gitzx.com/android-inject-hook/" target="_blank" rel="external">Android下的挂钩(hook)和代码注入(inject)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/02/Android-HotFix方案/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/27/调试Android应用/" title="调试Android应用" itemprop="url">调试Android应用</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-27T02:05:43.000Z" itemprop="datePublished"> 发表于 2016-01-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>需要针对已经发布的Release包进行调试，而要调试应用程序，需要满足：</p>
<ol>
<li>应用Manifest文件中Application标签包含属性<code>android:debuggable=&quot;true&quot;</code></li>
<li><code>/default.prop</code>中<code>ro.debuggable</code>值为1</li>
</ol>
<p>针对上面限制，可选方案有：</p>
<ol>
<li>反编译应用修改Manifest，插入<code>android:debuggable=&quot;true&quot;</code></li>
<li>修改<code>boot.img</code>，将<code>ro.debuggable</code>修改为1</li>
<li>利用<a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed</a>进行hook并debug应用</li>
</ol>
<h1 id="实践">实践</h1><h2 id="使用Debuggable属性">使用<code>Debuggable</code>属性</h2><p>从官方文档可以看出（<a href="http://developer.android.com/intl/zh-cn/guide/topics/manifest/application-element.html#debug" target="_blank" rel="external">application</a>）：</p>
<blockquote>
<p>android:debuggable<br>Whether or not the application can be debugged, even when running on a device in user mode — “true” if it can be, and “false” if not. The default value is “false”.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">application</span></span><br><span class="line">	<span class="attribute">android:icon</span>=<span class="value">"@drawable/ic_launcher"</span></span><br><span class="line">	<span class="attribute">android:label</span>=<span class="value">"@string/app_name"</span></span><br><span class="line">	<span class="attribute">android:theme</span>=<span class="value">"@style/AppTheme"</span> </span><br><span class="line">	<span class="attribute">android:debuggable</span>=<span class="value">"true"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>正常情况下，IDE会根据自身的打包来配置debug属性，因此在Manifest中最好<strong>不</strong>设置<code>debuggable</code>属性，而由打包方式来决定。查看具体的APK的信息：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 查看应用信息，可查看android:debuggable，<span class="number">0x0</span>为false，<span class="number">0xffffffff</span>为true</span></span><br><span class="line">aapt <span class="built_in">list</span> -v -a apk.apk</span><br></pre></td></tr></table></figure></p>
<p>在应用中也可判断是否<code>debug</code>状态：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 自身应用</span><br><span class="line">public static boolean isDebuggable(Context context) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		ApplicationInfo info = context.getApplicationInfo();</span><br><span class="line">		return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 其他应用</span><br><span class="line">public static boolean isDebuggable(Context context,String packageName) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		PackageInfo pkgInfo = context.getPackageManager().getPackageInfo(packageName, 1);</span><br><span class="line">		if (pkgInfo != null ) &#123;</span><br><span class="line">			ApplicationInfo info = pkgInfo.applicationInfo;</span><br><span class="line">			return (info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>有的时候，我们还需要一些其他的方式或手段：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反编译apk，可修改smali及资源等</span></span><br><span class="line">apktool d apk.apk</span><br><span class="line"><span class="comment"># 修改Manifest，新增debuggable</span></span><br><span class="line">vim apk/AndroidManifest.xml</span><br><span class="line"><span class="comment"># 重新打包，apk文件在dist目录中，也可指定apk文件</span></span><br><span class="line">apktool b apk</span><br><span class="line"><span class="comment"># 更多信息</span></span><br><span class="line">apktool -h</span><br><span class="line"><span class="comment"># debug签名，也可自行指定签名，密码android</span></span><br><span class="line">jarsigner -verbose -keystore ~/.android/debug.keystore -signedjar new.apk apk.apk androiddebugkey</span><br><span class="line"><span class="comment"># 查看签名</span></span><br><span class="line">keytool -list -alias androiddebugkey -keystore &lt;path_to_debug_keystore&gt;.keystore -storepass android -keypass android</span><br><span class="line"><span class="comment"># 有时需要系统签名，系统签名官方git有提供([security at master · android](https://github.com/android/platform_build/tree/master/target/product/security))</span></span><br><span class="line">java -jar signapk.jar platform.x509.pem platform.pk8 apk/dist/apk.apk new_sys.apk</span><br></pre></td></tr></table></figure></p>
<h2 id="使用build-prop属性">使用<code>build.prop</code>属性</h2><p>有一种是重新打包<code>boot.img</code>，简单思路就是解包<code>boot.img</code>，修改<code>ramdisk</code>中的<code>default.prop</code>，再打包并刷机。因为<code>boot.img</code>会在开机自动覆盖，所以只能通过刷<code>boot</code>来搞定。具体可以搜索相关解包教程。</p>
<p>另外一种要涉及重新编译<code>boot.img</code>，不同的版本源码编译不一样。更多可以参考：<a href="https://source.android.com/" target="_blank" rel="external">Android Open Source Project</a>。<br>ADB权限管理：</p>
<ol>
<li>4.2.2版本，针对连接设备需要使用者进行确认，且分设备与MAC进行管理</li>
<li>4.2等设备有针对ADB管理的开发者模式，通过该模式对ADB的DEBUG进行权限管理</li>
<li>开源版本，针对<code>eng/userdebug/user</code>进行管理与开放adb权限</li>
</ol>
<p>从系统编译和编译环境控制来说，通过property进行管理，主要为<code>ro.debuggable</code>和<code>system/core/rootdir/init.usb.rc</code>中<code>sys.usb.config</code>里包含对adb选项。</p>
<p>简单编译可通过查找：</p>
<ol>
<li><code>ro.debuggable</code>相关的环境变量，比如<code>enable_target_debugging</code></li>
<li>查找init.rc中权限改变</li>
<li>添加开发者模式进行管理</li>
</ol>
<p>在系统编译时，有几个编译选项：</p>
<ol>
<li>eng：编译时默认选项</li>
<li>user：产品生成发布版</li>
<li>userdebug：与user版本相同，添加adb服务</li>
</ol>
<p>在4.4源码上进行相关参数的搜索（<code>ro.secure</code>，<code>ro.debuggable</code>，<code>ro.kernel.android.checkjni</code>）：<br><strong><code>ro.secure</code></strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/services/</span>java<span class="regexp">/com/</span>android<span class="regexp">/server/</span>wm/WindowManagerService.<span class="string">java:</span>    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_SECURE = <span class="string">"ro.secure"</span>;</span><br><span class="line">.<span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>net<span class="regexp">/http/</span>AndroidHttpClient.<span class="string">java:</span>                <span class="comment">// Never print auth token -- we used to check ro.secure=0 to</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> * binary tree.  For instance, <span class="string">"ro.secure"</span>=<span class="string">"1"</span> could be stored <span class="keyword">as</span> <span class="string">follows:</span></span><br><span class="line">.<span class="regexp">/bionic/</span>libc<span class="regexp">/bionic/</span>system_properties.<span class="string">c:</span> *                     v        v            v     +--------&gt;| ro.secure |</span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">1</span></span><br><span class="line">.<span class="regexp">/build/</span>core/main.<span class="string">mk:</span>  ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=<span class="number">0</span></span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=0&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/build/</span>core<span class="regexp">/build-system.html:        &lt;li&gt;&lt;code&gt;ro.secure=1&lt;/</span>code&gt;</span><br><span class="line">.<span class="regexp">/system/</span>core<span class="regexp">/adb/</span>adb.<span class="string">c:</span>   <span class="comment">/* run adbd in secure mode if ro.secure is set and</span><br><span class="line">./system/core/adb/adb.c:        property_get("ro.secure", value, "1");</span><br><span class="line">./system/core/adb/adb.c:            // don't run as root if ro.secure is set...</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>build/xxx：环境设置</li>
<li>system/xxx/adb.c：如果=1,adb root将无法成功. 还有其它的附加条件除外.</li>
<li>WindowManagerService：用于管理viewserver(Hierarchy Viewer)</li>
<li>AndroidHttpClient：在=1时,不会在log中dump auth token</li>
<li>bionic/xxx/system_properties.c：介绍properties存储结构时用的例子</li>
</ul>
<p><strong><code>ro.debuggable</code></strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">./bootable/recovery/adb_install.cpp:    int len = property_get("ro.debuggable", value, NULL);</span><br><span class="line">./bootable/recovery/etc/init.rc:on property:ro.debuggable=1</span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=0<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/build-system.html:        <span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable=1<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0</span><br><span class="line">./build/core/main.mk:  ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1</span><br><span class="line">./build/tools/post_process_props.py:  # If ro.debuggable is 1, then enable adb on USB by default</span><br><span class="line">./build/tools/post_process_props.py:  if prop.get("ro.debuggable") == "1":</span><br><span class="line">./dalvik/docs/debugger.html:for all applications when the system property <span class="tag">&lt;<span class="title">code</span>&gt;</span>ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./dalvik/docs/debugger.html:is set to <span class="tag">&lt;/<span class="title">code</span>&gt;</span>1<span class="tag">&lt;/<span class="title">code</span>&gt;</span> (use <span class="tag">&lt;<span class="title">code</span>&gt;</span>adb shell getprop ro.debuggable<span class="tag">&lt;/<span class="title">code</span>&gt;</span></span><br><span class="line">./device/samsung/manta/init.manta.rc:on property:ro.debuggable=1</span><br><span class="line">./external/libnfc-nxp/Linux_x86/phDal4Nfc.c:    property_get("ro.debuggable", value, "");</span><br><span class="line">./external/openssh/servconf.c:  /* Allow root login if ro.debuggable is set */</span><br><span class="line">./external/openssh/servconf.c:  property_get("ro.debuggable", value, "");</span><br><span class="line">./frameworks/av/services/audioflinger/AudioFlinger.cpp:    (void) property_get("ro.debuggable", value, "0");</span><br><span class="line">./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java:        return "1".equals(SystemProperties.get("ro.debuggable")) &amp;&amp;</span><br><span class="line">./frameworks/base/core/java/android/os/Build.java:            SystemProperties.getInt("ro.debuggable", 0) == 1;</span><br><span class="line">./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java:        if ("1".equals(SystemProperties.get("ro.debuggable"))) </span><span class="expression">&#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/core</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/os</span><span class="end-block">/ZygoteConnection.java</span>:     * <span class="variable"><span class="keyword">If</span></span> <span class="string">"ro.debuggable"</span> <span class="variable">is</span> <span class="string">"1"</span>, <span class="variable">all</span> <span class="variable">apps</span> <span class="variable">are</span> <span class="variable">debuggable.</span> <span class="variable">Otherwise</span>,</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/policy</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/internal</span><span class="end-block">/policy</span><span class="end-block">/impl</span><span class="end-block">/PhoneWindowManager.java</span>:        <span class="variable">mEnableShiftMenuBugReports</span> = <span class="string">"1"</span><span class="variable">.equals</span>(<span class="variable">SystemProperties.get</span>(<span class="string">"ro.debuggable"</span>));</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/BootReceiver.java</span>:        <span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1 ? 98304 : 65536;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/am</span><span class="end-block">/ActivityManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/base</span><span class="end-block">/services</span><span class="end-block">/java</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/server</span><span class="end-block">/wm</span><span class="end-block">/WindowManagerService.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">String</span> <span class="variable">SYSTEM</span>_<span class="variable">DEBUGGABLE</span> = <span class="string">"ro.debuggable"</span>;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/frameworks</span><span class="end-block">/native</span><span class="end-block">/opengl</span><span class="end-block">/libs</span><span class="end-block">/EGL</span><span class="end-block">/egl.cpp</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/AudioRouter.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/BluetoothPhoneService.java</span>:            &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallCommandService.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallController.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallHandlerServiceProxy.java</span>:            <span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallLogger.java</span>:        (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallModeler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallNotifier.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallStateMonitor.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCache.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CallerInfoCacheUpdateReceiver.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/CdmaDisplayInfo.java</span>:    <span class="variable">private</span> <span class="variable">static</span> <span class="variable">final</span> <span class="variable">boolean</span> <span class="variable">DBG</span> = (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:                    &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)) &#123;</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/InCallScreenShowActivation.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/NotificationMgr.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/OutgoingCallBroadcaster.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   (<span class="variable">PhoneApp.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1)</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/PhoneGlobals.java</span>:     *   1 <span class="variable">-</span> <span class="variable">normal</span> <span class="variable">debug</span> <span class="variable">logging</span> <span class="variable"><span class="keyword">if</span></span> <span class="variable">ro.debuggable</span> <span class="variable">is</span> <span class="variable">set</span> (<span class="variable">which</span> <span class="variable">is</span> <span class="variable">true</span> <span class="variable">in</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/RespondViaSmsManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/Ringer.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/SipCallOptionHandler.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/packages</span><span class="end-block">/services</span><span class="end-block">/Telephony</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/phone</span><span class="end-block">/WiredHeadsetManager.java</span>:            (<span class="variable">PhoneGlobals.DBG</span>_<span class="variable">LEVEL</span> &gt;= 1) &amp;&amp; (<span class="variable">SystemProperties.getInt</span>(<span class="string">"ro.debuggable"</span>, 0) == 1);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/sdk</span><span class="end-block">/eclipse</span><span class="end-block">/plugins</span><span class="end-block">/com.android.ide.eclipse.adt</span><span class="end-block">/src</span><span class="end-block">/com</span><span class="end-block">/android</span><span class="end-block">/ide</span><span class="end-block">/eclipse</span><span class="end-block">/adt</span><span class="end-block">/internal</span><span class="end-block">/launch</span><span class="end-block">/AndroidLaunchController.java</span>:                        /<span class="end-block">/ because am -D does not check for ro.debuggable and the</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:            <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/adb.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/adb</span><span class="end-block">/services.c</span>:        <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">""</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/debuggerd</span><span class="end-block">/tombstone.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/include</span><span class="end-block">/cutils</span><span class="end-block">/trace.h</span>: * <span class="variable">level</span> <span class="variable">tracing</span> <span class="variable">is</span> <span class="variable">not</span> <span class="variable">allowed</span> <span class="variable">unless</span> <span class="variable">the</span> <span class="variable">ro.debuggable</span> <span class="variable">system</span> <span class="variable">property</span> <span class="variable">is</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/init</span><span class="end-block">/property</span>_<span class="variable">service.c</span>:    <span class="variable">ret</span> = <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">debuggable</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:    <span class="variable">property</span>_<span class="variable">get</span>(<span class="string">"ro.debuggable"</span>, <span class="variable">value</span>, <span class="string">"0"</span>);</span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/libcutils</span><span class="end-block">/trace.c</span>:/<span class="end-block">/ application-level tracing is allowed when the ro.debuggable system property</span></span><br><span class="line"><span class="variable">.</span><span class="end-block">/system</span><span class="end-block">/core</span><span class="end-block">/rootdir</span><span class="end-block">/init.rc</span>:<span class="variable">on</span> <span class="variable">property</span>:<span class="variable">ro.debuggable</span>=1</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./bootable/recovery/adb_install.cpp：debuggable 开启时,才可以成功重启adb</li>
<li>./build/xxxx：debuggable 数据设置</li>
<li>./dalvik/xxx：在dalvik中,如果debuggable为0, 仅AndroidManifest.xml中含有debuggable 才会支持jdwp调试</li>
<li>./external/libnfc-nxp/Linux_x86/phDal4Nfc.c：NFC调试支持开关</li>
<li>./external/openssh/servconf.c：openssh 允许root访问开关</li>
<li>./frameworks/av/services/audioflinger/AudioFlinger.cpp：Audio Debug 开关</li>
<li>./frameworks/base/core/java/android/net/SSLCertificateSocketFactory.java：SSL check 开关</li>
<li>./frameworks/base/core/java/android/os/Build.java：IS_DEBUGGABLE环境变量控制</li>
<li>./frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java：App debuggable 开关, 如果=1, 所有应用都将进行debug支持</li>
<li>./frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java：mEnableShiftMenuBugReports 支持</li>
<li>./frameworks/base/services/java/com/android/server/BootReceiver.java：logged event size 控制, =1 存储量大</li>
<li>./frameworks/base/services/java/com/android/server/am/ActivityManagerService.java：系统DEBUG状态，包括do bug report, OpenGLTrace, App Profile, App Heap Dump</li>
<li>./frameworks/base/services/java/com/android/server/wm/WindowManagerService.java：系统DEBUG状态，与ro.secure 一起管理viewserver</li>
<li>./frameworks/native/opengl/libs/EGL/egl.cpp：EGL debug</li>
<li>LOGD 开关：<br>./packages/services/Telephony/src/com/android/phone/AudioRouter.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothManager.java:<br>./packages/services/Telephony/src/com/android/phone/BluetoothPhoneService.java<br>./packages/services/Telephony/src/com/android/phone/CallCommandService.java<br>./packages/services/Telephony/src/com/android/phone/CallController.java<br>./packages/services/Telephony/src/com/android/phone/CallHandlerServiceProxy.java<br>./packages/services/Telephony/src/com/android/phone/CallLogger.java<br>./packages/services/Telephony/src/com/android/phone/CallModeler.java<br>./packages/services/Telephony/src/com/android/phone/CallNotifier.java<br>./packages/services/Telephony/src/com/android/phone/CallStateMonitor.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCache.java<br>./packages/services/Telephony/src/com/android/phone/CallerInfoCacheUpdateReceiver.java<br>./packages/services/Telephony/src/com/android/phone/CdmaDisplayInfo.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/InCallScreenShowActivation.java<br>./packages/services/Telephony/src/com/android/phone/NotificationMgr.java<br>./packages/services/Telephony/src/com/android/phone/OutgoingCallBroadcaster.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/PhoneGlobals.java<br>./packages/services/Telephony/src/com/android/phone/RespondViaSmsManager.java<br>./packages/services/Telephony/src/com/android/phone/Ringer.java<br>./packages/services/Telephony/src/com/android/phone/SipCallOptionHandler.java<br>./packages/services/Telephony/src/com/android/phone/WiredHeadsetManager.java</li>
<li>./sdk/eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/launch/AndroidLaunchController.java：ADT app debug launcher 支持</li>
<li>./system/core/adb/adb.c：adb root permission</li>
<li>./system/core/adb/services.c：adb root permission</li>
<li>./system/core/debuggerd/tombstone.c：dump_crash want log if =1</li>
<li>./system/core/init/property_service.c：Allow local property overwrite ro.debuggerd value</li>
<li>./system/core/libcutils/trace.c：app trace on/off</li>
<li>./system/core/rootdir/init.rc：adbd服务开启控制</li>
</ul>
<p><strong><code>ro.kernel.android.checkjni</code></strong><br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./frameworks/<span class="keyword">base/core/jni/AndroidRuntime.cpp: </span>       property_get(<span class="string">"ro.kernel.android.checkjni"</span>, propBuf, <span class="string">""</span>)<span class="comment">;</span></span><br><span class="line">./dalvik/docs/embedded-vm-control.html:first is &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;. </span> This is set <span class="keyword">by </span>the</span><br><span class="line">./dalvik/docs/embedded-vm-control.html:of this overrides the value from &lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni&lt;/code&gt;.</span><br><span class="line"></span>./<span class="keyword">build/core/main.mk: </span> <span class="keyword">ADDITIONAL_BUILD_PROPERTIES </span>+= ro.kernel.<span class="keyword">android.checkjni=1</span><br><span class="line"></span>./<span class="keyword">build/core/build-system.html: </span>       &lt;li&gt;&lt;<span class="preprocessor">code</span>&gt;ro.kernel.<span class="keyword">android.checkjni=1&lt;/code&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>./frameworks/base/core/jni/AndroidRuntime.cpp：checkJNI value load</li>
<li>dalvik/xxx：Java VM CheckJNI on/off</li>
<li>build/xxx：checkJNI 状态设置</li>
</ul>
<p>基本来说，<code>ro.secure</code>主要是系统安全相关属性开关，包括：</p>
<ul>
<li>adb的root权限</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统各个模块的敏感信息输出</li>
</ul>
<p><code>ro.debuggable</code>主要是系统debug信息开关，包括：</p>
<ul>
<li>adb管理，是否可root，是否开机运行</li>
<li>view server(Hierarchy Viewer)的开关</li>
<li>系统debug信息开关，包括应用内部log、audio debug, ssl check, nfc, opengl elg等信息打印、系统各应用级别状态，包括profile, jdwp-debug, heap dump, opengl trace等</li>
</ul>
<p><code>ro.kernel.android.checkjni</code>主要是Java VM checkJNI的开关</p>
<h2 id="Xposed进行HOOK"><code>Xposed</code>进行HOOK</h2><p>从上面的两个方案来看，debug都太过麻烦，还有一个简单的方式，那就是利用开源的Xposed框架进行hook。使用这一利器之前需要先root系统。用一句话来解释Xposed：</p>
<blockquote>
<p>利用JNI作为一个中转，将所有对于被hook的方法统一进入Xposed管理器，管理器再进行hook的前后调用。Xposed 调用非JVM JNI标准接口，需要准确调用dalvik/art中的方法调用，完成对原函数的调用。</p>
</blockquote>
<p>当我们设置<code>android:debuggable=&quot;true&quot;</code>时候，应用即可进行调试，而且可以进行JDWP连接进行调试。开启新应用时，Dalvik VM会forked/started新的线程，并开启debug，这时JDWP线程知道是否开启。我们跟踪<code>android.os.Process.start()</code>方法会发现，这是一个<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ProcessStartResult start(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span><br><span class="line">                              <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span><br><span class="line">                              <span class="built_in">int</span> uid, <span class="built_in">int</span> gid, <span class="built_in">int</span>[] gids,</span><br><span class="line">                              <span class="built_in">int</span> debugFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">                              <span class="built_in">int</span> targetSdkVersion,</span><br><span class="line">                              <span class="keyword">String</span> seInfo,</span><br><span class="line">                              <span class="keyword">String</span>[] zygoteArgs) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids, debugFlags, mountExternal, targetSdkVersion, seInfo, zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.e(LOG_TAG,</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续跟踪会发现，在<code>startViaZygote</code>方法中对<code>DEBUG_ENABLE_DEBUGGER</code>进行判断：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="number">0</span>) &#123;</span><br><span class="line">	argsForZygote.add(<span class="string">"--enable-debugger"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来就简单了，利用反射获得这个<code>start</code>的方法，并进行hook即可，代码为（完整项目查看<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里演示了两个hook的方式，更多可以参阅文档</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneDebug</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> debugApps = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG_ENABLE_DEBUGGER = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- handle package: "</span> + loadPackageParam.packageName + <span class="string">" process: "</span> + loadPackageParam.processName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (loadPackageParam.appInfo == <span class="keyword">null</span> ||</span><br><span class="line">                (loadPackageParam.appInfo.flags &amp; (ApplicationInfo.FLAG_SYSTEM | ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"-- appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method start = Process.class.getMethod(</span><br><span class="line">                    <span class="string">"start"</span>, String.class, String.class, Integer.TYPE, Integer.TYPE, <span class="keyword">int</span>[].class,</span><br><span class="line">                    Integer.TYPE, Integer.TYPE, Integer.TYPE, String.class, String[].class);</span><br><span class="line">            XposedBridge.log(<span class="string">"-- start hook, appInfo: "</span> + loadPackageParam.appInfo);</span><br><span class="line">            XposedBridge.hookMethod(start, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (debugApps) &#123;</span><br><span class="line">                        <span class="keyword">int</span> id = <span class="number">5</span>;</span><br><span class="line">                        <span class="keyword">int</span> flags = (Integer) methodHookParam.args[id];</span><br><span class="line">                        <span class="keyword">if</span> ((flags &amp; DEBUG_ENABLE_DEBUGGER) == <span class="number">0</span>) &#123;</span><br><span class="line">                            flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                        &#125;</span><br><span class="line">                        methodHookParam.args[id] = flags;</span><br><span class="line">                        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">                            XposedBridge.log(<span class="string">"set debuggable flags to: "</span> + flags);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">        XposedBridge.hookAllMethods(Process.class, "start", new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                if (debugApps) &#123;</span><br><span class="line">                    int id = 5;</span><br><span class="line">                    int flags = (Integer) param.args[id];</span><br><span class="line">                    if ((flags &amp; DEBUG_ENABLE_DEBUGGER) == 0) &#123;</span><br><span class="line">                        flags |= DEBUG_ENABLE_DEBUGGER;</span><br><span class="line">                    &#125;</span><br><span class="line">                    param.args[id] = flags;</span><br><span class="line">                    if (BuildConfig.DEBUG) &#123;</span><br><span class="line">                        XposedBridge.log("set debuggable flags to: " + flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);*/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="简要介绍Xposed插件开发流程">简要介绍Xposed插件开发流程</h3><p>在Android Studio上大概过程为（完整代码：<a href="https://github.com/AndroidKnife/XposedDebug" target="_blank" rel="external">AndroidKnife/XposedDebug</a>）：</p>
<ol>
<li>创建工程，可以无Activity</li>
<li>下载<a href="http://forum.xda-developers.com/xposed/xposed-api-changelog-developer-news-t2714067" target="_blank" rel="external">Xposed API</a> XposedBridgeApi-xx.jar，并将其放入<code>libs</code>目录</li>
<li>修改Manifest，新增三个<code>meta-data</code>标签（详细看下面代码）</li>
<li>实现<code>IXposedHookLoadPackage</code>接口及具体hook逻辑</li>
<li>在<code>assets/xposed_init</code>配置声明需要加载到<code>XposedInstaller</code>的入口</li>
<li>ALL DONE。<br>更多可以查看<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial" target="_blank" rel="external">Development tutorial</a>。</li>
</ol>
<p>运行Xposed插件，需要：</p>
<ol>
<li>安装<a href="http://repo.xposed.info/module/de.robv.android.xposed.installer" target="_blank" rel="external">Xposed Installer</a></li>
<li>手机root</li>
</ol>
<p>AndroidManifest.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">package</span>=<span class="value">"com.hwangjr.xposed.mods.phonedebug"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span></span><br><span class="line">        <span class="attribute">android:allowBackup</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:supportsRtl</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedmodule"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposeddescription"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"Phone Debugger! (ro.debuggable or android:debuggable)"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"xposedminversion"</span></span><br><span class="line">            <span class="attribute">android:value</span>=<span class="value">"54"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>assets/xposed_init</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="class">.hwangjr</span><span class="class">.xposed</span><span class="class">.mods</span><span class="class">.phonedebug</span><span class="class">.PhoneDebug</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://repo.xposed.info/" target="_blank" rel="external">Xposed Module Repository</a><br><a href="https://labs.mwrinfosecurity.com/blog/2013/11/29/debug-all-the-android-things/" target="_blank" rel="external">Debug All the Android Things - mwrlabs</a><br><a href="http://blog.csdn.net/hunanwy/article/details/9200673" target="_blank" rel="external">Android USER 版本与ENG 版本的差异—MTK官方解释 - hunanwy的专栏 - 博客频道 - CSDN.NET</a><br><a href="http://www.codefrom.com/c/49" target="_blank" rel="external">Xposed插件开发基础篇｜码源</a><br><a href="http://forum.xda-developers.com/" target="_blank" rel="external">Android Forum for Mobile Phones, Tablets, Watches &amp; Android App Development - XDA Forums</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/27/调试Android应用/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git设置白名单/" title="Git设置白名单" itemprop="url">Git设置白名单</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:20:39.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p><code>.gitignore</code>可以设置过滤文件，此文件还可以用来设置白名单。</p>
<h1 id="白名单">白名单</h1><p>简单粗暴上菜（要解决此目录下的子目录也要过滤问题）：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore everything</span></span><br><span class="line"><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># white list anything that's a directort</span></span><br><span class="line">!<span class="keyword">*</span>/</span><br><span class="line"><span class="comment"># add all the file types you don't want miss</span></span><br><span class="line">!<span class="keyword">*</span>.txt</span><br><span class="line">!<span class="keyword">*</span>.etc</span><br></pre></td></tr></table></figure></p>
<p>ALL DONE!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git设置白名单/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git无法提交目录/" title="Git无法提交目录" itemprop="url">Git无法提交目录</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:18:16.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>初始化时，可能需要提交空目录，但是Git是针对文件变动进行跟踪，不对目录进行跟踪。所以一个目录如果没有文件，即使<code>git add</code>此目录，也无法进行提交。</p>
<h1 id="Solution">Solution</h1><p>简单做法是，在空目录下新建一个文件。此文件可能是：</p>
<ol>
<li><code>.gitignore</code>文件</li>
<li><code>.gitkeep</code>或<code>.keep</code>文件</li>
<li>其他空文件</li>
</ol>
<p><code>.gitignore</code>文件内容可以是：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 忽略所有文件</span></span><br><span class="line">*</span><br><span class="line"><span class="preprocessor"># 除了gitignore文件</span></span><br><span class="line">!.gitignore</span><br></pre></td></tr></table></figure></p>
<p>之后进行<code>git add</code>即可。</p>
<h1 id="脚本">脚本</h1><p>懒人脚本，其实就是一行命令，查找当前目录，如果为空则添加空文件（忽略.git目录）：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . <span class="string">\(</span> -type d -empty <span class="string">\)</span> -<span class="keyword">and</span> <span class="string">\(</span> -<span class="keyword">not</span> -regex .<span class="pi">/\.git.* \) -exec touch &#123;&#125;/</span>.gitkeep <span class="string">\;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Ref">Ref</h1><p><a href="http://blog.csdn.net/zhaodezhong/article/details/7774869" target="_blank" rel="external">git 保存空目录</a><br><a href="http://www.oschina.net/question/114628_125642" target="_blank" rel="external">eclipse 工程下新建文件夹无法上传至Git仓库</a><br><a href="https://segmentfault.com/q/1010000000663317" target="_blank" rel="external">gitignore 添加空目录</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git无法提交目录/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/Git多个远程仓库进行管理/" title="Git多个远程仓库进行管理" itemprop="url">Git多个远程仓库进行管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:17:39.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>现在免费代码托管平台很多，有时需要多个远程库同时进行PUSH，这时如何处理。</p>
<p>举个糖炒栗子，本地创建git仓库后，在GitHub上创建一个仓库，并在GitCoffee上也有远程仓库，此时如何同步，狡兔三窟。可作为代码备份和远程协作。</p>
<h1 id="新增远程仓库">新增远程仓库</h1><h2 id="一次PUSH多个仓库更新">一次PUSH多个仓库更新</h2><p>直接在<code>origin</code>或现有远程仓库上添加远程仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 远程仓库</span><br></pre></td></tr></table></figure></p>
<p>如果提示<code>fatal: remote origin already exists</code>，先删除再添加：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="comment"># 不推荐此方法</span></span><br><span class="line">git remote rm origin</span><br></pre></td></tr></table></figure></p>
<p>也可以直接修改config方法，修改<code>.git/config</code>文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">url = 远程仓库</span><br></pre></td></tr></table></figure></p>
<h2 id="分开PUSH管理多个仓库">分开PUSH管理多个仓库</h2><p>上面那个方法比较方便，可以PUSH到多个URL上。但是有时我们的RSA KEY不一样，会导致无法PUSH，这时可以新增一个远程仓库。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增</span></span><br><span class="line">git remote add newpush 远程仓库</span><br><span class="line"><span class="comment"># push到新增远程仓库的master分支</span></span><br><span class="line">git push newpush master</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">git remote -v</span><br></pre></td></tr></table></figure></p>
<p>直接编辑<code>.git/config</code>也是一个方式。</p>
<h2 id="脚本">脚本</h2><p>也就诞生了懒人脚本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to origin master'</span></span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Push to newpush master'</span></span><br><span class="line">git push newpush master</span><br></pre></td></tr></table></figure></p>
<h1 id="REF">REF</h1><p><a href="http://www.xiaoleilu.com/push-multi-repo/" target="_blank" rel="external">Git push到多个远程库</a><br><a href="http://higrid.net/hi/docs/git-pull-push-from-multiple-remote-locations" target="_blank" rel="external">git与多个远程仓库同步</a><br><a href="http://www.v2ex.com/t/37919#reply8" target="_blank" rel="external">有没有可能同时把代码提交到两个git代码托管的服务器上？ - V2EX</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/Git多个远程仓库进行管理/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/使用Gitolite搭建Git服务器/" title="使用Gitolite搭建Git服务器" itemprop="url">使用Gitolite搭建Git服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T11:16:25.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>搭建Git服务器作为代码管理工具。</p>
<h1 id="搭建">搭建</h1><h2 id="软件安装">软件安装</h2><p>基于：</p>
<ul>
<li>CentOS 7</li>
<li>Git 1.8.3<br>直接用yum安装，如果需要最新版本，请编译安装。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git -y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="添加用户">添加用户</h2><p>添加一个新用户来跑git服务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adduser git</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">useradd <span class="operator">-s</span> /sbin/nologin -g git git</span><br><span class="line"><span class="comment"># /etc/passwd can checkout the users and group</span></span><br><span class="line">w git</span><br><span class="line">groups git</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化仓库">初始化仓库</h2><p>选择目录并初始化仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> path/git</span><br><span class="line">git init --bare project.git</span><br><span class="line">chown -R git project.git</span><br></pre></td></tr></table></figure></p>
<h2 id="禁用远程登陆">禁用远程登陆</h2><p>禁止用户通过git账户登陆。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/passwd</span><br><span class="line"><span class="comment"># modify the bash</span></span><br><span class="line">git:xxxxxxxxx:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure></p>
<h2 id="配置客户端key">配置客户端key</h2><p>客户端生成rsa key：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">cat .ssh/id_rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>将生成的<code>id_rsa.pub</code>复制到服务器上，修改<code>.ssh/authorized_keys</code>文件。</p>
<h2 id="DONE">DONE</h2><p>现在即可在本地进行<code>check out</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@ip:/path/git/project.git</span><br></pre></td></tr></table></figure></p>
<h1 id="使用Gitolite">使用Gitolite</h1><h2 id="背景-1">背景</h2><p>这是Git服务器管理软件，还有很多选择，自己决定。这里使用<a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>。</p>
<blockquote>
<p><a href="https://about.gitlab.com/" target="_blank" rel="external">GitLab</a> : GitLab includes git repository management, code reviews, issue tracking, wikis and much more. GitLab comes with GitLab CI, an easy to use continuous integration and deployment tool.<br><a href="https://www.scm-manager.org/" target="_blank" rel="external">SCM-Manager</a> : The easiest way to share and manage your Git, Mercurial and Subversion repositories over http.<br><a href="https://www.gerritcodereview.com/" target="_blank" rel="external">Gerrit Code Review</a> + <a href="http://gitblit.com/" target="_blank" rel="external">Gitblit</a> : Gerrit provides web based code review and repository management for the Git version control system. Gitblit is an open-source, pure Java stack for managing, viewing, and serving Git repositories. It’s designed primarily as a tool for small workgroups who want to host centralized repositories.<br><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a> + <a href="http://git-scm.com/book/ch4-6.html" target="_blank" rel="external">Git - Smart HTTP</a> : Gitolite allows you to setup git hosting on a central server, with fine-grained access control and many more powerful features.<br><a href="https://gogs.io/" target="_blank" rel="external">Gogs</a> : Gogs (Go Git Service) is a painless self-hosted Git service.<br><a href="http://www.getgitorious.com/" target="_blank" rel="external">Gitorious</a> : Run Gitorious yourself — get started with free, open source Git hosting and collaboration today.<br><a href="https://tuleap.net/" target="_blank" rel="external">Tuleap</a> OR <a href="https://github.com/Enalean/tuleap" target="_blank" rel="external">Tuleap Github</a> : Traditional development, Requirement Management, Agile Development, IT Service management… Tuleap makes software projects more productive, collaborative and industrialized.<br><a href="http://phabricator.org/" target="_blank" rel="external">Phabricator</a> OR <a href="https://github.com/phacility/phabricator" target="_blank" rel="external">phacility/phabricator</a> : Phabricator is a collection of open source web applications that help software companies build better software.<br><a href="https://github.com/gitbucket/gitbucket" target="_blank" rel="external">gitbucket/gitbucket</a> : GitBucket is a GitHub clone powered by Scala which has easy installation and high extensibility.<br><a href="http://gitlist.org/" target="_blank" rel="external">GitList</a> OR <a href="https://github.com/klaussilveira/gitlist" target="_blank" rel="external">klaussilveira/gitlist</a> : GitList allows you to browse repositories using your favorite browser, viewing files under different revisions, commit history and diffs. GitList is free and open source software, written in PHP, on top of Silex and the Twig template engine.<br><a href="http://git.zx2c4.com/cgit/about/" target="_blank" rel="external">cgit</a> : A hyperfast web frontend for git repositories written in C.<br><a href="https://github.com/mensi/cydra/" target="_blank" rel="external">mensi/cydra</a> : <strong>SEEMS DEAD</strong>. Cydra is a platform for project hosting written in Python. It has an extensible architecture to facilitate integration of 3rd party software such as version control systems and project management tools.<br><a href="https://github.com/tv42/gitosis" target="_blank" rel="external">tv42/gitosis</a> : <strong>SEEMS DEAD</strong>. Manage git repositories, provide access to them over SSH, with tight access control and not needing shell accounts.<br><a href="https://github.com/jakubgarfield/Bonobo-Git-Server" target="_blank" rel="external">jakubgarfield/Bonobo-Git-Server</a> : Bonobo Git Server for Windows is a web application you can install on your IIS and easily manage and connect to your git repositories.</p>
</blockquote>
<h2 id="安装前">安装前</h2><ol>
<li>安装git</li>
<li>创建git用户组和git用户</li>
<li>创建管理员密钥</li>
<li>将公钥上传到git服务器中</li>
</ol>
<p>其中，创建管理员密钥：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"git-admin"</span></span><br></pre></td></tr></table></figure></p>
<p>并将git-admin.pub上传到服务器（可使用<code>scp</code>，如有问题，可能是firewall问题）。</p>
<h2 id="安装">安装</h2><ol>
<li>创建git用户下bin目录</li>
<li>clone gitolite并安装</li>
<li>使用公钥初始化gitolite</li>
</ol>
<p><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">Gitolite</a>安装很简单，可以查看官方文档：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su git</span><br><span class="line">mkdir -p ~/bin</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/sitaramc/gitolite</span><br><span class="line">gitolite/install --help</span><br><span class="line">gitolite/install -ln ~/bin</span><br><span class="line"><span class="comment"># make sure you have the path in $HOME/bin</span></span><br><span class="line"><span class="built_in">source</span> .bash_profile</span><br></pre></td></tr></table></figure></p>
<p>初始化gitolite：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitolite setup -pk git-admin.pub</span><br></pre></td></tr></table></figure></p>
<h2 id="添加gitolite用户和仓库">添加gitolite用户和仓库</h2><p>不需要手动在<code>git</code>服务器中添加新用户或新仓库。因为gitolite的用户，仓库和权限规则是使用一个名为<code>gitolite-admin</code>的特殊仓库进行维护，需通过修改该仓库并合并<code>push</code>到服务器中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@host:gitolite-admin</span><br></pre></td></tr></table></figure></p>
<p>Clone后，看到两个目录<code>conf</code>和<code>keydir</code>，<code>conf/gitolite.conf</code>用于修改仓库及用户权限，<code>keydir</code>用于存放用户公钥。<br>新增<code>hwangjr</code>用户：</p>
<ol>
<li>将其公钥（hwangjr.pub）添加到<code>keydir</code>目录</li>
<li>修改<code>conf/gitolite.conf</code>文件，新增仓库和用户权限：<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repo <span class="keyword">project</span></span><br><span class="line">	RW+ = hwangjr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用其他权限：RW, R等</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>修改完上传服务器即可：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_ins">add</span> conf</span><br><span class="line">git <span class="built_ins">add</span> keydir</span><br><span class="line">git commit -m '<span class="built_ins">add</span> repo project, <span class="built_ins">add</span> <span class="built_ins">user</span> hwangjr'</span><br><span class="line">git push</span><br></pre></td></tr></table></figure></p>
<p><code>PUSH</code>成功之后，服务器会自动创建新的仓库并将用户密钥加入<code>.ssh/authorized_keys</code>文件中。</p>
<h2 id="更多配置">更多配置</h2><p><code>gitolite</code>权限管理很完备，在此给出一些配置方案：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repo project</span><br><span class="line">    RW+                     =   hwangjr</span><br><span class="line">    -   master              =   hwangjr</span><br><span class="line">    -   refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    RW                      =   hwangjr</span><br><span class="line">    RW  refs/tags/v[<span class="number">0</span>-<span class="number">9</span>]    =   hwangjr</span><br><span class="line">    R                       =   hwangjr</span><br></pre></td></tr></table></figure></p>
<p>上面配置即：</p>
<ul>
<li>RW+ ： 能够对仓库进行所有的操作。</li>
<li><ul>
<li>master : 能够创建和推送任何名字不为master的分支，并能够添加任何不以v+数字开头的tag。</li>
</ul>
</li>
<li><ul>
<li>refs/tags/v[0-9] : 能够添加任何以v+数字开头的tag。</li>
</ul>
</li>
<li>R : 能够进行clone和fetch操作。</li>
</ul>
<p>还可以添加组进行管理（<strong>@all</strong>为特殊组，表示所有用户）：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@staff</span>      =   hwangjr hwangjr1 hwangjr2</span><br><span class="line"><span class="variable">@interns</span>    =   hwangjr</span><br><span class="line"><span class="variable">@all-devs</span>   =   <span class="variable">@staff</span> <span class="variable">@interns</span></span><br><span class="line"></span><br><span class="line">repo secret</span><br><span class="line">    RW      =   <span class="variable">@staff</span></span><br><span class="line"></span><br><span class="line">repo project</span><br><span class="line">    RW+     =   <span class="variable">@staff</span></span><br><span class="line">    RW      =   <span class="variable">@interns</span></span><br></pre></td></tr></table></figure></p>
<p>更多查看：<a href="http://gitolite.com/gitolite/gitolite.html" target="_blank" rel="external">gitolite all-in-one page</a>。</p>
<h1 id="QUESTION">QUESTION</h1><h2 id="安装过程遇到cant_locate_Data/Dumper-pm">安装过程遇到cant locate Data/Dumper.pm</h2><p>在安装过程中，可能会遇到错误：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gitolite/install -h</span><br><span class="line">Can't locate Data/Dumper.pm <span class="keyword">in</span> @INC (@INC <span class="keyword">contains</span>: /home/git/gitolite/src/lib /usr/<span class="keyword">local</span>/lib64/perl5 /usr/<span class="keyword">local</span>/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) <span class="keyword">at</span> /home/git/gitolite/src/lib/Gitolite/Common.pm line <span class="number">61.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at /home/git/gitolite/src/lib/Gitolite/Common.pm line 61.</span></span><br><span class="line">Compilation failed <span class="keyword">in</span> require <span class="keyword">at</span> gitolite/install line <span class="number">15.</span></span><br><span class="line">BEGIN failed<span class="comment">--compilation aborted at gitolite/install line 15.</span></span><br></pre></td></tr></table></figure></p>
<p>这是因为缺少包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install perl-Data-Dumper</span><br></pre></td></tr></table></figure></p>
<h2 id="Clone_gitolite-admin时提示需要输入密码">Clone gitolite-admin时提示需要输入密码</h2><p>在clone gitolite-admin时，会提示输入密码：</p>
<ol>
<li>在服务端生成rsa key</li>
<li>在服务端进行clone</li>
</ol>
<p>此时会出现此错误，使用其他机器即可（需要复制rsa key到其他机器）。</p>
<h1 id="Ref">Ref</h1><p><a href="http://wenzhiquan.github.io/blog/2014/10/14/fedora_20_install_gitolite/" target="_blank" rel="external">Fedora 20 安装gitolite</a><br><a href="https://github.com/sitaramc/gitolite" target="_blank" rel="external">sitaramc/gitolite</a><br><a href="http://gitolite.com/gitolite/install.html" target="_blank" rel="external">install and setup</a><br><a href="http://www.loushi135.com/articles/2015/09/21/1442848708235.html" target="_blank" rel="external">centos git服务器安装与gitolite用户权限管理 - 思迁</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Git/">Git</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Git/">Git</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/使用Gitolite搭建Git服务器/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/23/自动清理tmp文件/" title="自动清理tmp文件" itemprop="url">自动清理tmp文件</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/+JianrongHuang?rel=author" title="HwangJR" target="_blank" itemprop="author">HwangJR</a>
		
  <p class="article-time">
    <time datetime="2015-12-23T11:03:26.000Z" itemprop="datePublished"> 发表于 2015-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="背景">背景</h1><p>在<code>supervisor</code>默认配置中，其启动的<code>sock</code>等都会放到<code>tmp</code>目录，而<code>tmp</code>目录会自动清理导致无法使用<code>supervisorctl</code>命令，此时：</p>
<ol>
<li>修改<code>supervisor.conf</code>文件，修改到<code>/var/run/</code>及<code>/var/log/</code>目录，具体配置就不进行贴了，简单直接搜索<code>tmp</code>进行修改即可。</li>
<li>重启<code>supervisor</code>服务，记得<code>kill</code>原来服务。</li>
</ol>
<p>但是，为什么系统会自动清理<code>tmp</code>目录呢？</p>
<h1 id="RHEL\CentOS\Fedora系统">RHEL\CentOS\Fedora系统</h1><p>在<code>CentOS 6</code>中，使用<code>tmpwatch</code>命令进行删除。</p>
<blockquote>
<p>tmpwatch - removes files which haven’t been accessed for a period of time</p>
<p>tmpwatch [-u|-m|-c] [-MUadfqstvx] [—verbose] [—force] [—all] [—nodirs] [—nosymlinks] [—test] [—fuser] [—quiet] [—atime|—mtime|—ctime] [—dirmtime] [—exclude path] [—exclude-user user] time dirs</p>
</blockquote>
<p>在<code>/etc/cron.daily/</code>目录下会生成<code>tmpwatch</code>文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh&#10;flags=-umc&#10;/usr/sbin/tmpwatch &#34;$flags&#34; -x /tmp/.X11-unix -x /tmp/.XIM-unix \&#10;        -x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix \&#10;        -X &#39;/tmp/hsperfdata_*&#39; 10d /tmp&#10;/usr/sbin/tmpwatch &#34;$flags&#34; 30d /var/tmp&#10;for d in /var/&#123;cache/man,catman&#125;/&#123;cat?,X11R6/cat?,local/cat?&#125;; do&#10;    if [ -d &#34;$d&#34; ]; then&#10;        /usr/sbin/tmpwatch &#34;$flags&#34; -f 30d &#34;$d&#34;&#10;    fi&#10;done</span><br></pre></td></tr></table></figure></p>
<p>将自动删除240小时未访问文件，<code>tmpwatch</code>工具可以从指定目录递归搜索并删除一段时间未访问文件。<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">u, --atime 基于访问时间来删除文件，默认的。</span><br><span class="line"></span>-<span class="ruby">m, --mtime 基于修改时间来删除文件。</span><br><span class="line"></span>-<span class="ruby">c, --ctime 基于创建时间来删除文件，对于目录，基于mtime。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">M</span>, --dirmtime 删除目录基于目录的修改时间而不是访问时间。</span><br><span class="line"></span>-<span class="ruby">a, --all 删除所有的文件类型，不只是普通文件，符号链接和目录。</span><br><span class="line"></span>-<span class="ruby">d, --nodirs 不尝试删除目录，即使是空目录。</span><br><span class="line"></span>-<span class="ruby">d, --nosymlinks 不尝试删除符号链接。</span><br><span class="line"></span>-<span class="ruby">f, --force 强制删除。</span><br><span class="line"></span>-<span class="ruby">q, --quiet 只报告错误信息。</span><br><span class="line"></span>-<span class="ruby">s, --fuser 如果文件已经是打开状态在删除前，尝试使用“定影”命令。默认不启用。</span><br><span class="line"></span>-<span class="ruby">t, --test 仅作测试，并不真的删除文件或目录。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">U</span>, --exclude-user=user 不删除属于谁的文件。</span><br><span class="line"></span>-<span class="ruby">v, --verbose 打印详细信息。</span><br><span class="line"></span>-<span class="ruby">x, --exclude=path 排除路径，如果路径是一个目录，它包含的所有文件被排除了。如果路径不存在，它必须是一个绝对路径不包含符号链接。</span><br><span class="line"></span>-<span class="ruby"><span class="constant">X</span>, --exclude-pattern=pattern 排除某规则下的路径。</span></span><br></pre></td></tr></table></figure></p>
<h2 id="CentOS_7">CentOS 7</h2><p>在<code>CentOS 7</code>中会注意到一点，在系统中默认会清理<code>tmp</code>目录，而且没有安装<code>tmpwatch</code>，那么<code>CentOS 7</code>中是通过什么来实现的呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># systemctl status systemd-tmpfiles-clean.service</span></span><br><span class="line">systemd-tmpfiles-clean.service - Cleanup of Temporary Directories</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/systemd-tmpfiles-clean.service; <span class="keyword">static</span>)</span><br><span class="line">   Active: inactive (dead) since Thu <span class="number">2015</span>-<span class="number">12</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> HKT; <span class="number">5</span>h <span class="number">12</span>min ago</span><br><span class="line">     Docs: man:tmpfiles.d(<span class="number">5</span>)</span><br><span class="line">           man:systemd-tmpfiles(<span class="number">8</span>)</span><br><span class="line">  Process: <span class="number">6523</span> ExecStart=/usr/bin/systemd-tmpfiles --clean (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"> Main PID: <span class="number">6523</span> (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line"></span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Starting Cleanup of Temporary Directories...</span><br><span class="line">Dec <span class="number">10</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">02</span> hwangjr systemd[<span class="number">1</span>]: Started Cleanup of Temporary Directories.</span><br></pre></td></tr></table></figure></p>
<p>没错，就是通过这个服务来实现的，此服务为<code>/usr/lib/systemd/system/systemd-tmpfiles-clean.service</code>。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.service </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="setting">DefaultDependencies=<span class="value"><span class="keyword">no</span></span></span></span><br><span class="line"><span class="setting">Wants=<span class="value">local-fs.target</span></span></span><br><span class="line"><span class="setting">After=<span class="value">systemd-readahead-collect.service systemd-readahead-replay.service local-fs.target</span></span></span><br><span class="line"><span class="setting">Before=<span class="value">sysinit.target shutdown.target</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/usr/local/lib/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/etc/tmpfiles.d</span></span></span><br><span class="line"><span class="setting">ConditionDirectoryNotEmpty=<span class="value">|/run/tmpfiles.d</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Type=<span class="value">oneshot</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/bin/systemd-tmpfiles --clean</span></span></span><br><span class="line"><span class="setting">IOSchedulingClass=<span class="value">idle</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/systemd-tmpfiles-clean.timer </span></span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="title"></span><br><span class="line">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Daily Cleanup of Temporary Directories</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">man:tmpfiles.d(<span class="number">5</span>) man:systemd-tmpfiles(<span class="number">8</span>)</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Timer]</span></span><br><span class="line"><span class="setting">OnBootSec=<span class="value"><span class="number">15</span>min</span></span></span><br><span class="line"><span class="setting">OnUnitActiveSec=<span class="value"><span class="number">1</span>d</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到在启动15分钟之后会清理，每隔1天清理一次。更多详细信息<a href="http://www.freedesktop.org/software/systemd/man/systemd-tmpfiles.html" target="_blank" rel="external">systemd-tmpfiles</a>。</p>
<h1 id="Debian\Ubuntu系统">Debian\Ubuntu系统</h1><p>在<code>Ubuntu</code>系统中每次开机会进行清除，具体配置为<code>rcS</code>文件的<code>TMPTIME</code>值。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/<span class="keyword">default</span>/rcS</span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># /etc/default/rcS</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Default settings for the scripts in /etc/rcS.d/</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># For information about these variables see the rcS(5) manual page.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># This file belongs to the "initscripts" package.</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># delete files in /tmp during boot older than x days.</span></span><br><span class="line"><span class="preprocessor"># '0' means always, -1 or 'infinite' disables the feature</span></span><br><span class="line"><span class="preprocessor">#TMPTIME=0</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># spawn sulogin during boot, continue normal boot if not used in 30 seconds</span></span><br><span class="line"><span class="preprocessor">#SULOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># do not allow users to log in until the boot has completed</span></span><br><span class="line"><span class="preprocessor">#DELAYLOGIN=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># assume that the BIOS clock is set to UTC time (recommended)</span></span><br><span class="line">UTC=yes</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># be more verbose during the boot process</span></span><br><span class="line"><span class="preprocessor">#VERBOSE=no</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># automatically repair filesystems with inconsistencies during boot</span></span><br><span class="line"><span class="preprocessor">#FSCKFIX=no</span></span><br></pre></td></tr></table></figure></p>
<p>也就是在x天启动之后会自动清理<code>tmp</code>目录，0代表一直清理，-1代表取消此特性。</p>
<h1 id="注意点">注意点</h1><h2 id="supervisor">supervisor</h2><p>修改默认配置的<code>/tmp/</code>目录为<code>/var/run/</code>和<code>/var/log</code>目录。</p>
<h2 id="mysql">mysql</h2><p>默认将<code>pid</code>和<code>socket</code>创建在<code>tmp</code>目录，将两个此文件排除在外，否则<code>mysql</code>重启或使用<code>socket</code>登陆时提示找不到文件，可通过<code>-U mysql</code>。</p>
<h1 id="REF">REF</h1><p><a href="http://www.oss4aix.org/download/SRPMS/tmpwatch/" target="_blank" rel="external">Index of /download/SRPMS/tmpwatch</a><br><a href="https://git.centos.org/summary/?r=rpms/tmpwatch" target="_blank" rel="external">rpms/tmpwatch - git.centos.org</a><br><a href="http://www.ttlsa.com/linux/the-tmp-directory-is-automatically-cleared-and-the-tmpwatch-command/" target="_blank" rel="external">tmp目录自动清除和tmpwatch命令 - 运维生存时间</a><br><a href="http://www.opsers.org/base/clean-up-on-the-linux-system-tmp-folder-you-may-want-to-know.html" target="_blank" rel="external">关于Linux系统清理/tmp/文件夹，你可能想知道的 | 羽飞博客</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/tech/">tech</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/23/自动清理tmp文件/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/Books/" title="Books">Books<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CI/" title="CI">CI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Git/" title="Git">Git<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/创业/" title="创业">创业<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/tech/" title="tech">tech<sup>34</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Git/" title="Git">Git<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/创业/" title="创业">创业<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ci/" title="ci">ci<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Books/" title="Books">Books<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/scrum/" title="scrum">scrum<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://blog.hwangjr.com" target="_blank" title="HwangJR&#39;s Blog">HwangJR&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, Welcome to my blog. <br/>
			I&#39;m HwangJR, Tech change the world.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1234193120" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/hwangjr" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/4827228" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/HuangJR" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/https://facebook.com/jr.hwang.2010" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		
		
		<a href="https://www.zhihu.com/people/hwangjr" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		<a href="https://plus.google.com/+JianrongHuang?rel=author" target="_blank" class="icon-google_plus" title="Google+"></a>
		
		
		<a href="mailto:huangjianrong2010@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="HwangJR">HwangJR</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'HwangJR';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-63911310-1', 'hwangjr.github.io');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<script>
var option = {
  engineKey: '6e8f6d9aa88722365432'
};
(function(w,d,t,u,n,s,e){
  s = d.createElement(t);
  s.src = u;
  s.async = 1;
  w[n] = function(r){
    w[n].opts = r;
  };
  e = d.getElementsByTagName(t)[0];
  e.parentNode.insertBefore(s, e);
})(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
_ts(option);
</script>

<!-- Tiny_search End -->

  </body>
 </html>
